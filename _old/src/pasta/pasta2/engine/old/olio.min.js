(function(){define(["scripts/aglio","scripts/jsutil"],function(a){var c,b;b=function(d){return typeof d==="function"};c=(function(){function d(e,g,f){this.aglio=e;this.stateFunc=g;this.essence=f;this.yarn=this.aglio.yarn;this.quantum=this.aglio.quantum;if(!(this.essence!=null)){this.essence={}}this.essence.index=-1;if(!(this.essence.state!=null)){this.essence.state={}}if(!(this.essence.state.end!=null)){this.essence.state.end={}}if(!(this.essence.state.entangle!=null)){this.essence.state.entangle={}}}d.prototype.next=function(){var e,f,g,h;g=this.essence.index;f=g>=this.yarn.length?null:g<0?null:this.yarn[g];h=f!=null?f.type:void 0;e=(function(){switch(h){case"entangle":return this.entangle(this.essence.state.entangle,f.quantumState);case"end":return this.entangle(this.essence.state.end,this.stateFunc)}}).call(this);if(!(e!=null)){e=g+1}if(e>=this.yarn.length){e=0}this.essence.index=e;return this.essence.knot=this.yarn[e]};d.prototype.entangle=function(i,h){var e,f,g;g=b(h)?h(this.essence):h;f=this.quantum[g];if(!(f!=null)){return void 0}e=f.random();i.item=e;return e.index};return d})();return c})}).call(this);