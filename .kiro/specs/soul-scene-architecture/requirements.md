# Requirements Document

## Introduction

本仕様は、SOUL.mdの改訂として、シーン関数のLuaコード実行アーキテクチャに関する新章を追加することを目的とする。現状のSOUL.mdでは「4. 辞書アーキテクチャ」でシーン辞書・単語辞書のデータ構造を説明しているが、**シーン関数がLuaコードとしてどのように実行されるか**、つまりシナリオ実行時の各要素（シーン、アクター、アクション）がどのように連携するかについて触れられていない。

### 設計哲学の核心：映画撮影のメタファー

pastaは「台本DSL」として設計されており、映画撮影に喩えるなら：

- **シーン** = 台本（脚本）
- **アクター** = 役者
- **アクション** = 演技（「アクション！」の掛け声で始まる実行）

この3要素の関係性は、pastaの実行モデルの本質である。シーンは静的な台本であり、それを実行（「アクション！」）することでアクターが動き出し、会話や演技が生成される。

本改訂により、「辞書」（静的データ構造）と「Phase 0」（開発状況）の間に「シーン実行アーキテクチャ」（動的実行モデル）を挿入し、この映画撮影メタファーを明確に文書化する。

## Project Description (Input)

SOUL.mdの改訂。
シーン関数に登場する各要素について、Luaコード部のアーキテクチャについて触れられていない。シーン関数のシナリオに沿って、アクションする関係について記載する。辞書の次の章が良いと思われる。

## Requirements

### Requirement 1: 映画撮影メタファーの明示化

**Objective:** pastaプロジェクトの設計思想を理解したい開発者として、シーン・アクター・アクションの3要素関係を映画撮影メタファーで理解したい。これにより、pastaの実行モデルの本質を直感的に把握できる。

#### Acceptance Criteria

1. 新セクションは、pastaを「台本DSL」として位置づけ、映画撮影メタファーを明示すること
2. 新セクションは、シーン（台本）・アクター（役者）・アクション（演技）の3要素関係を説明すること
3. 新セクションは、「アクション！」による実行開始の概念を説明すること

### Requirement 2: 新章「シーン実行アーキテクチャ」の追加

**Objective:** pastaプロジェクトの設計を理解したい開発者として、シーン関数の実行モデルを理解したい。これにより、DSL設計とLuaランタイムの関係を把握できる。

#### Acceptance Criteria

1. SOUL.mdは、「4. 辞書アーキテクチャ」と「5. Phase 0: あるべき基盤」の間に、新しいセクション「4.5 シーン実行アーキテクチャ」を含むこと
2. シーン関数が実行されるとき、SOUL.mdはシーンエントリーから出力生成までの実行フローを説明すること
3. 新セクションは、DSL要素とそのLuaコード表現との関係を説明すること

### Requirement 3: シーン関数の構造説明

**Objective:** スクリプト作者として、シーン関数がLuaコードにどうトランスパイルされるかを理解したい。これにより、デバッグや最適化が容易になる。

#### Acceptance Criteria

1. 新セクションは、各シーンがcoroutine/yieldパターンを持つLua関数になることを説明すること
2. 新セクションは、シーン関数のシグネチャと戻り値の動作を説明すること
3. 新セクションは、DSLからLuaへの変換を示す簡単な例を含むこと

### Requirement 4: アクター発話の実行モデル

**Objective:** 開発者として、アクター発話行がどのようにLuaアクションに変換されるかを理解したい。これにより、出力イベントの流れを把握できる。

#### Acceptance Criteria

1. 新セクションは、アクター発話がScriptEvent出力をyieldすることを説明すること
2. 新セクションは、talkアクションのシーケンス（アクター選択、サーフェス切替、テキスト出力）を説明すること
3. アクター発話行が実行されるとき、ドキュメントはイベント発行フローを説明すること

### Requirement 5: シーン呼び出し（Call/Jump）の実行モデル

**Objective:** 開発者として、Call/Jumpがどのように制御フローを実現するかを理解したい。これにより、シーン間の関係を正しく設計できる。

#### Acceptance Criteria

1. 新セクションは、Callを復帰を伴うサブルーチン呼び出しとして説明すること
2. 新セクションは、Jumpセマンティクスのための末尾呼び出し最適化を説明すること
3. シーンからシーンへ遷移するとき、ドキュメントは実行スタックの動作を明確にすること

### Requirement 5: シーン呼び出し（Call/Jump）の実行モデル

**Objective:** 開発者として、Call/Jumpがどのように制御フローを実現するかを理解したい。これにより、シーン間の関係を正しく設計できる。

#### Acceptance Criteria

1. 新セクションは、Callを復帰を伴うサブルーチン呼び出しとして説明すること
2. 新セクションは、Jumpセマンティクスのための末尾呼び出し最適化を説明すること
3. シーンからシーンへ遷移するとき、ドキュメントは実行スタックの動作を明確にすること

### Requirement 6: 単語展開の実行モデル

**Objective:** スクリプト作者として、単語参照（@単語名）がどのタイミングで解決されるかを理解したい。これにより、動的な会話生成を正しく活用できる。

#### Acceptance Criteria

1. 新セクションは、単語展開を実行時のLua関数呼び出しとして説明すること
2. 新セクションは、実行時のランダム選択メカニズムを説明すること
3. 新セクションは、スコープ解決順序（アクター → シーン → グローバル）を明確にすること

### Requirement 6: 単語展開の実行モデル

**Objective:** スクリプト作者として、単語参照（@単語名）がどのタイミングで解決されるかを理解したい。これにより、動的な会話生成を正しく活用できる。

#### Acceptance Criteria

1. 新セクションは、単語展開を実行時のLua関数呼び出しとして説明すること
2. 新セクションは、実行時のランダム選択メカニズムを説明すること
3. 新セクションは、スコープ解決順序（アクター → シーン → グローバル）を明確にすること

### Requirement 7: ドキュメントヒエラルキー整合性

**Objective:** プロジェクト管理者として、SOUL.mdの改訂がドキュメント全体の一貫性を保つことを確認したい。

#### Acceptance Criteria

1. 新セクションは、SPECIFICATION.mdの技術詳細と整合すること
2. 新セクションは、既存SOUL.mdセクションと一貫した用語を使用すること
3. 新セクションは、SOUL.mdにふさわしい哲学的・アーキテクチャ的レベルを維持すること（実装詳細ではない）
