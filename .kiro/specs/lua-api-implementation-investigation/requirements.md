# Requirements Document

## Project Description (Input)
ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆsample.generated.luaï¼‰ã‹ã‚‰å‘¼ã°ã‚Œã¦ã„ã‚‹å„é–¢æ•°ã«ã¤ã„ã¦ã€Luaå´ã®å®Ÿè£…çŠ¶æ³ã‚’å¾¹åº•çš„ã«èª¿æŸ»ã—ã€ãƒ¬ãƒãƒ¼ãƒˆã™ã‚‹ã€‚actã«ã¤ã„ã¦ã¯ACTOR_IMPLã‚’èª¿æŸ»å¯¾è±¡ã¨ã™ã‚‹ã€‚

---

# èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ: Lua API å®Ÿè£…çŠ¶æ³

## 1. èª¿æŸ»å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

- **å¯¾è±¡**: [sample.generated.lua](../../../crates/pasta_lua/tests/fixtures/sample.generated.lua)
- **èª¿æŸ»æ—¥**: 2026-01-28
- **èª¿æŸ»ç¯„å›²**: ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ç”Ÿæˆã‚³ãƒ¼ãƒ‰ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹PASTA/ACT API

---

## 2. APIå‘¼ã³å‡ºã—ä¸€è¦§ã¨å®Ÿè£…çŠ¶æ³

### 2.1 PASTAãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«APIï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰

| API                        | å‘¼ã³å‡ºã—ä¾‹                     | å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«                                                             | å®Ÿè£…çŠ¶æ…‹   |
| -------------------------- | ------------------------------ | ------------------------------------------------------------------------ | ---------- |
| `PASTA.create_actor(name)` | `PASTA.create_actor("ã•ãã‚‰")` | [actor.lua#L70](../../../crates/pasta_lua/scripts/pasta/actor.lua#L70)   | âœ… å®Œå…¨å®Ÿè£… |
| `PASTA.create_scene(name)` | `PASTA.create_scene("ãƒ¡ã‚¤ãƒ³")` | [scene.lua#L128](../../../crates/pasta_lua/scripts/pasta/scene.lua#L128) | âœ… å®Œå…¨å®Ÿè£… |
| `PASTA.create_word(key)`   | `PASTA.create_word("æŒ¨æ‹¶")`    | [word.lua#L122](../../../crates/pasta_lua/scripts/pasta/word.lua#L122)   | âœ… å®Œå…¨å®Ÿè£… |

### 2.2 ACTOR_IMPLï¼ˆã‚¢ã‚¯ã‚¿ãƒ¼å®Ÿè£…ï¼‰

| API                      | å‘¼ã³å‡ºã—ä¾‹                  | å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«                                                           | å®Ÿè£…çŠ¶æ…‹   |
| ------------------------ | --------------------------- | ---------------------------------------------------------------------- | ---------- |
| `ACTOR:create_word(key)` | `ACTOR:create_word("é€šå¸¸")` | [actor.lua#L58](../../../crates/pasta_lua/scripts/pasta/actor.lua#L58) | âœ… å®Œå…¨å®Ÿè£… |
| `WordBuilder:entry(...)` | `:entry([=[\s[0]]=])`       | [actor.lua#L38](../../../crates/pasta_lua/scripts/pasta/actor.lua#L38) | âœ… å®Œå…¨å®Ÿè£… |

### 2.3 SCENE_TABLE_IMPLï¼ˆã‚·ãƒ¼ãƒ³å®Ÿè£…ï¼‰

| API                      | å‘¼ã³å‡ºã—ä¾‹                  | å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«                                                           | å®Ÿè£…çŠ¶æ…‹   |
| ------------------------ | --------------------------- | ---------------------------------------------------------------------- | ---------- |
| `SCENE:create_word(key)` | `SCENE:create_word("å ´æ‰€")` | [scene.lua#L23](../../../crates/pasta_lua/scripts/pasta/scene.lua#L23) | âœ… å®Œå…¨å®Ÿè£… |
| `SCENE.__global_name__`  | ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‚ç…§              | [scene.lua#L73](../../../crates/pasta_lua/scripts/pasta/scene.lua#L73) | âœ… å®Œå…¨å®Ÿè£… |

### 2.4 ACT_IMPLï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…ï¼‰âš ï¸ é‡å¤§ãªå•é¡Œã‚ã‚Š

| API                       | å‘¼ã³å‡ºã—ä¾‹ï¼ˆç”Ÿæˆã‚³ãƒ¼ãƒ‰ï¼‰             | å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«                                                         | å®Ÿè£…çŠ¶æ…‹               |
| ------------------------- | ------------------------------------ | -------------------------------------------------------------------- | ---------------------- |
| `act:init_scene(SCENE)`   | `act:init_scene(SCENE)`              | [act.lua#L58](../../../crates/pasta_lua/scripts/pasta/act.lua#L58)   | âœ… å®Œå…¨å®Ÿè£…             |
| `act:clear_spot()`        | `act:clear_spot()`                   | [act.lua#L143](../../../crates/pasta_lua/scripts/pasta/act.lua#L143) | âœ… å®Œå…¨å®Ÿè£…             |
| `act:set_spot(name, num)` | `act:set_spot("ã•ãã‚‰", 0)`          | [act.lua#L133](../../../crates/pasta_lua/scripts/pasta/act.lua#L133) | âœ… å®Œå…¨å®Ÿè£…             |
| `act:call(...)`           | `act:call(global, local, opts, ...)` | [act.lua#L113](../../../crates/pasta_lua/scripts/pasta/act.lua#L113) | âŒ **ã‚·ã‚°ãƒãƒãƒ£ä¸ä¸€è‡´** |
| `act:word(name)`          | `act:word("å ´æ‰€")`                   | [act.lua#L88](../../../crates/pasta_lua/scripts/pasta/act.lua#L88)   | âš ï¸ éƒ¨åˆ†å®Ÿè£…             |

### 2.5 PROXY_IMPLï¼ˆã‚¢ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ã‚­ã‚·å®Ÿè£…ï¼‰

| API                | å‘¼ã³å‡ºã—ä¾‹                | å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«                                                             | å®Ÿè£…çŠ¶æ…‹                            |
| ------------------ | ------------------------- | ------------------------------------------------------------------------ | ----------------------------------- |
| `act.{actor}`      | `act.ã•ãã‚‰`              | [act.lua#L22](../../../crates/pasta_lua/scripts/pasta/act.lua#L22)       | âœ… å®Œå…¨å®Ÿè£…                          |
| `proxy:talk(text)` | `act.ã•ãã‚‰:talk("...")`  | [actor.lua#L105](../../../crates/pasta_lua/scripts/pasta/actor.lua#L105) | âœ… å®Œå…¨å®Ÿè£…                          |
| `proxy:word(name)` | `act.ã•ãã‚‰:word("é€šå¸¸")` | [actor.lua#L163](../../../crates/pasta_lua/scripts/pasta/actor.lua#L163) | âœ… å®Œå…¨å®Ÿè£…ï¼ˆ6ãƒ¬ãƒ™ãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ |

---

## 3. é‡å¤§ãªå•é¡Œç‚¹

### 3.1 âŒ `act:call` ã‚·ã‚°ãƒãƒãƒ£ä¸ä¸€è‡´

**ç”Ÿæˆã‚³ãƒ¼ãƒ‰ï¼ˆsample.generated.luaï¼‰:**
```lua
act:call(SCENE.__global_name__, "ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èªå‘¼ã³å‡ºã—", {}, table.unpack(args))
-- å¼•æ•°: (global_name: string, local_name: string, opts: table, ...args)
```

**å®Ÿè£…ï¼ˆact.lua#L113-L120ï¼‰:**
```lua
function ACT_IMPL.call(self, search_result, opts, ...)
    local global_name, local_name = search_result[1], search_result[2]
    -- æœŸå¾…: search_result = {global_name, local_name} ã®é…åˆ—å½¢å¼
```

**å•é¡Œ**: ç”Ÿæˆã‚³ãƒ¼ãƒ‰ã¯`(global_name, local_name, opts, ...)`å½¢å¼ã§å‘¼ã³å‡ºã—ã¦ã„ã‚‹ãŒã€å®Ÿè£…ã¯`({global_name, local_name}, opts, ...)`é…åˆ—å½¢å¼ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ã€‚

**å½±éŸ¿åº¦**: ğŸ”´ è‡´å‘½çš„ - ã‚·ãƒ¼ãƒ³å‘¼ã³å‡ºã—ãŒå…¨ã¦å¤±æ•—ã™ã‚‹

### 3.2 âš ï¸ `act:word` ä¸å®Œå…¨å®Ÿè£…

**å®Ÿè£…ï¼ˆact.lua#L88-L97ï¼‰:**
```lua
function ACT_IMPL.word(self, name)
    -- Level 2: SCENEfield
    if self.current_scene and self.current_scene[name] then
        return self.current_scene[name]
    end
    -- Level 3: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ¼ãƒ³åã§ã®æ¤œç´¢ï¼ˆRusté–¢æ•°å‘¼ã³å‡ºã—äºˆå®šï¼‰
    -- Level 4: å…¨ä½“æ¤œç´¢ï¼ˆRusté–¢æ•°å‘¼ã³å‡ºã—äºˆå®šï¼‰
    return nil -- TODO: Rust search_word çµ±åˆ
```

**å•é¡Œ**: 2ãƒ¬ãƒ™ãƒ«ã¾ã§ã®æ¤œç´¢ã®ã¿å®Ÿè£…ã€‚ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èªè¾æ›¸ã¸ã®æ¤œç´¢æœªå®Ÿè£…ã€‚

**å½±éŸ¿åº¦**: ğŸŸ¡ ä¸­ç¨‹åº¦ - ã‚·ãƒ¼ãƒ³ãƒ­ãƒ¼ã‚«ãƒ«å˜èªã®ã¿å‹•ä½œã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èªã¯å¤±æ•—

### 3.3 âš ï¸ `SCENE.é–¢æ•°` å‘¼ã³å‡ºã—ã§ `ctx` æœªå®šç¾©

**ç”Ÿæˆã‚³ãƒ¼ãƒ‰:**
```lua
save.ã‚°ãƒ­ãƒ¼ãƒãƒ« = SCENE.é–¢æ•°(ctx, 2 + 1)
```

**å•é¡Œ**: `ctx`å¤‰æ•°ãŒã‚¹ã‚³ãƒ¼ãƒ—å†…ã«å­˜åœ¨ã—ãªã„ã€‚ãŠãã‚‰ã`act`ã®èª¤ã‚Šã‹ã€ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ã®ãƒã‚°ã€‚

**å½±éŸ¿åº¦**: ğŸŸ¡ ä¸­ç¨‹åº¦ - ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°å‘¼ã³å‡ºã—æ™‚ã«ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚¨ãƒ©ãƒ¼

---

## 4. å®Ÿè£…å“è³ªã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª         | å®Œå…¨å®Ÿè£… | éƒ¨åˆ†å®Ÿè£… | æœªå®Ÿè£… | åˆè¨ˆ   |
| ---------------- | -------- | -------- | ------ | ------ |
| PASTA API        | 3        | 0        | 0      | 3      |
| ACTOR_IMPL       | 2        | 0        | 0      | 2      |
| SCENE_TABLE_IMPL | 2        | 0        | 0      | 2      |
| ACT_IMPL         | 3        | 1        | 1      | 5      |
| PROXY_IMPL       | 3        | 0        | 0      | 3      |
| **åˆè¨ˆ**         | **13**   | **1**    | **1**  | **15** |

**å®Ÿè£…ç‡**: 86.7%ï¼ˆ13/15 å®Œå…¨å®Ÿè£…ï¼‰

---

## 5. æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### å„ªå…ˆåº¦: ç·Šæ€¥ ğŸ”´

1. **`act:call` ã‚·ã‚°ãƒãƒãƒ£ä¿®æ­£**
   - é¸æŠè‚¢A: `act.lua`ã‚’ä¿®æ­£ã—ã¦ç”Ÿæˆã‚³ãƒ¼ãƒ‰å½¢å¼ã«åˆã‚ã›ã‚‹
   - é¸æŠè‚¢B: ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ã‚’ä¿®æ­£ã—ã¦å®Ÿè£…å½¢å¼ã«åˆã‚ã›ã‚‹
   - **æ¨å¥¨**: é¸æŠè‚¢Aï¼ˆæ—¢å­˜ç”Ÿæˆã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ç¶­æŒï¼‰

### å„ªå…ˆåº¦: é«˜ ğŸŸ¡

2. **`act:word` å®Œå…¨å®Ÿè£…**
   - ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èªè¾æ›¸ï¼ˆ`WORD.get_global_words()`ï¼‰ã¸ã®æ¤œç´¢è¿½åŠ 
   - `PROXY_IMPL.word`ã®6ãƒ¬ãƒ™ãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯æµç”¨å¯èƒ½

3. **`ctx`å¤‰æ•°å•é¡Œã®èª¿æŸ»**
   - ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©å‡ºåŠ›ã®æ¤œè¨¼
   - `SCENE.é–¢æ•°`å‘¼ã³å‡ºã—æ™‚ã®ç¬¬1å¼•æ•°ä»•æ§˜ç¢ºå®š

---

## 6. é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ«                                                         | å½¹å‰²                       |
| ---------------------------------------------------------------- | -------------------------- |
| [init.lua](../../../crates/pasta_lua/scripts/pasta/init.lua)     | å…¬é–‹APIã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ  |
| [act.lua](../../../crates/pasta_lua/scripts/pasta/act.lua)       | ACT_IMPLå®Ÿè£…               |
| [actor.lua](../../../crates/pasta_lua/scripts/pasta/actor.lua)   | ACTOR_IMPL, PROXY_IMPLå®Ÿè£… |
| [scene.lua](../../../crates/pasta_lua/scripts/pasta/scene.lua)   | SCENE_TABLE_IMPLå®Ÿè£…       |
| [word.lua](../../../crates/pasta_lua/scripts/pasta/word.lua)     | WordBuilderå®Ÿè£…            |
| [ctx.lua](../../../crates/pasta_lua/scripts/pasta/ctx.lua)       | CTXç’°å¢ƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ        |
| [store.lua](../../../crates/pasta_lua/scripts/pasta/store.lua)   | ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢               |
| [global.lua](../../../crates/pasta_lua/scripts/pasta/global.lua) | ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ãƒ†ãƒ¼ãƒ–ãƒ«     |
| [save.lua](../../../crates/pasta_lua/scripts/pasta/save.lua)     | æ°¸ç¶šåŒ–ãƒ‡ãƒ¼ã‚¿               |

---

## Requirementsï¼ˆEARSå½¢å¼ï¼‰

### Requirement 1: act:call ã‚·ã‚°ãƒãƒãƒ£çµ±ä¸€

When ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ãŒ `act:call` ã‚’ç”Ÿæˆã™ã‚‹, the ACT_IMPL shall ç”Ÿæˆã‚³ãƒ¼ãƒ‰å½¢å¼ `(global_name, local_name, opts, ...)` ã‚’å—ã‘å…¥ã‚Œã¦ã‚·ãƒ¼ãƒ³é–¢æ•°ã‚’å‘¼ã³å‡ºã™ã€‚

**å—ã‘å…¥ã‚ŒåŸºæº–**:
- `act:call(SCENE.__global_name__, "ãƒ­ãƒ¼ã‚«ãƒ«å", {}, ...)` å½¢å¼ã§æ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨
- æ—¢å­˜ã®ç”Ÿæˆã‚³ãƒ¼ãƒ‰ï¼ˆsample.generated.luaï¼‰ãŒãã®ã¾ã¾å‹•ä½œã™ã‚‹ã“ã¨

### Requirement 2: act:word å®Œå…¨å®Ÿè£…

When `act:word(name)` ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹, the ACT_IMPL shall ä»¥ä¸‹ã®é †åºã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢ã‚’è¡Œã†:
1. ã‚·ãƒ¼ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®å®Œå…¨ä¸€è‡´
2. ã‚·ãƒ¼ãƒ³ãƒ­ãƒ¼ã‚«ãƒ«å˜èªè¾æ›¸ï¼ˆå‰æ–¹ä¸€è‡´ï¼‰
3. ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èªè¾æ›¸ï¼ˆå‰æ–¹ä¸€è‡´ï¼‰

**å—ã‘å…¥ã‚ŒåŸºæº–**:
- ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èª `act:word("æŒ¨æ‹¶")` ãŒè§£æ±ºã•ã‚Œã‚‹ã“ã¨
- ã‚·ãƒ¼ãƒ³ãƒ­ãƒ¼ã‚«ãƒ«å˜èªãŒå„ªå…ˆã•ã‚Œã‚‹ã“ã¨

### Requirement 3: SCENE.é–¢æ•° å¼•æ•°ä»•æ§˜ç¢ºå®š

When ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã‚·ãƒ¼ãƒ³é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹, the ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ© shall é©åˆ‡ãªç¬¬1å¼•æ•°ï¼ˆ`act`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‚’æ¸¡ã™ã€‚

**å—ã‘å…¥ã‚ŒåŸºæº–**:
- `SCENE.é–¢æ•°(act, value, ...)` å½¢å¼ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨
- `ctx`ã¸ã®ç›´æ¥å‚ç…§ã¯ä½¿ç”¨ã—ãªã„ã“ã¨

