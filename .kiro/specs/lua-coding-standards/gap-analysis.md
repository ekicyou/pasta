# ギャップ分析: lua-coding-standards

## 1. 現状調査

### 1.1 ドメイン関連アセット

#### Luaスクリプトファイル（対象）
| ファイル | 行数 | 責務 | 現状 |
|----------|------|------|------|
| `scripts/pasta/init.lua` | 42 | 公開APIモジュール | ✅ @module あり |
| `scripts/pasta/act.lua` | 130 | アクションオブジェクト | ✅ 型注釈充実 |
| `scripts/pasta/actor.lua` | 212 | アクターモジュール | ⚠️ 一部不完全 |
| `scripts/pasta/ctx.lua` | 65 | 環境コンテキスト | ✅ @module/@class あり |
| `scripts/pasta/scene.lua` | 122 | シーンレジストリ | ⚠️ 一部関数に注釈なし |
| `scripts/pasta/store.lua` | 38 | データストア | ✅ 循環参照回避パターン |
| `scripts/pasta/word.lua` | 124 | 単語レジストリ | ✅ ビルダーパターン実装 |
| `scripts/pasta/global.lua` | 15 | グローバル関数 | ✅ シンプル |

#### テストフレームワーク（scriptlibs/lua_test）
| ファイル | 責務 | 備考 |
|----------|------|------|
| `test.lua` | describe/test ランナー | 234行、BDD風 |
| `expect.lua` | アサーションライブラリ | 390行、Jest風 |
| `toDebugString.lua` | デバッグ出力 | ユーティリティ |

#### 既存テストスペック
- `lua_specs/actor_word_spec.lua` - アクター単語辞書テスト
- `lua_specs/transpiler_spec.lua` - トランスパイラーテスト

### 1.2 確認された規約パターン

#### 命名規約（現状）
| 対象 | パターン | 例 | 準拠率 |
|------|----------|-----|--------|
| モジュールテーブル | UPPER_CASE | `ACT`, `CTX`, `STORE`, `MOD` | ✅ 100% |
| ローカル変数 | snake_case | `scene_func`, `global_name` | ✅ 95% |
| プライベート関数 | snake_case (アンダースコアなし) | `resolve_value` | ⚠️ 不統一 |
| メタテーブル | 名前+`_mt` | `scene_table_mt` | ⚠️ 1例のみ |
| クラス風テーブル | PascalCase | `WordBuilder`, `ActorWordBuilder` | ✅ 100% |

#### モジュール構造パターン（現状）
```
正規パターン（全ファイル準拠）:
1. --- @module 宣言
2. local dependencies = require(...)
3. local MOD/NAME = {}
4. -- 実装
5. return MOD/NAME
```

#### EmmyLua型注釈（現状）
| アノテーション | 使用数 | 完全性 |
|----------------|--------|--------|
| `@module` | 8/8 | ✅ 完全 |
| `@class` | 5 | ⚠️ 一部欠落 |
| `@field` | 多数 | ⚠️ 不完全 |
| `@param` | 多数 | ⚠️ 一部関数で欠落 |
| `@return` | 多数 | ⚠️ 一部関数で欠落 |
| `@vararg` | 2 | ⚠️ 非標準形式 |

### 1.3 確認された課題

#### 命名の不整合
1. **プライベート関数**: `_` プレフィックスが使用されていない
   - `resolve_value`, `search_prefix_lua` (actor.lua内のlocal関数)
2. **メタテーブル命名**: 統一されていない
   - `scene_table_mt` vs `WordBuilder.__index`

#### 型注釈の不完全性
1. **`@vararg`が非標準**: `--- @vararg string` は EmmyLua 非準拠
   - 正: `--- @param ... string`
2. **一部public関数に注釈なし**:
   - `STORE.reset()` (store.lua)
   - `MOD.get_or_increment_counter()` (scene.lua)

#### エラーハンドリング
1. **nilチェックは実施** - guard clause パターン使用済み
2. **pcallは未使用** - 現状では不要（内部API中心）
3. **サイレントnilリターン**: 一部で暗黙的nil返却あり
   - `ACT:word()` の Level 3/4 TODO コメント

## 2. 要件対応ギャップ

### Requirement 1: コーディング規約ドキュメント
| 項目 | 現状 | ギャップ |
|------|------|----------|
| `lua-coding.md` | **Missing** | 新規作成必要 |
| ステアリング配置 | 未配置 | `.kiro/steering/` に追加 |

### Requirement 2: 命名規約
| 項目 | 現状 | ギャップ |
|------|------|----------|
| snake_case（変数/関数） | ✅ 準拠 | 軽微な不整合 |
| UPPER_CASE（モジュール） | ✅ 準拠 | なし |
| `_IMPL`サフィックス | ❌ PascalCase使用 | **全クラスで修正必要**（WordBuilder→WORD_BUILDER_IMPL等） |
| `_` プレフィックス | **Missing** | ドキュメント化＋リファクタ |
| 日本語識別子 | ✅ 使用中 | ドキュメント化のみ |
| PascalCase禁止 | ❌ 違反 | WordBuilder, ActorWordBuilder等を修正必要 |

### Requirement 3: モジュール構造
| 項目 | 現状 | ギャップ |
|------|------|----------|
| 単一MODテーブル | ✅ 準拠 | なし |
| require上部配置 | ✅ 準拠 | なし |
| return下部配置 | ✅ 準拠 | なし |
| STOREパターン | ✅ 実装済み | ドキュメント化 |
| テンプレート | **Missing** | 規約に追加 |

### Requirement 4: クラス設計パターン
| 項目 | 現状 | ギャップ |
|------|------|----------|
| MODULE/MODULE_IMPL分離 | ❌ 未実施 | **全クラスでリファクタ必要** |
| MODULE.new()コンストラクタ | ⚠️ 一部のみ | CTXは準拠、他は修正必要 |
| 明示的self+ドット構文 | ❌ コロン構文使用 | **全ファイルで変換必要** |
| シングルトンパターン | ⚠️ 混在 | STOREは正当、他は整理必要 |

### Requirement 5: EmmyLua型アノテーション
| 項目 | 現状 | ギャップ |
|------|------|----------|
| `@module` | ✅ 全ファイル | なし |
| `@class` | ⚠️ 不完全 | 補完必要 |
| `@param`/`@return` | ⚠️ 不完全 | 補完必要 |
| `@field` | ⚠️ 不完全 | 補完必要 |
| `@vararg`形式 | ❌ 非標準 | 修正必要（2箇所）→ `@param ...` へ |

### Requirement 6: エラーハンドリング
| 項目 | 現状 | ギャップ |
|------|------|----------|
| nilチェック | ✅ 実施中 | パターン文書化 |
| guard clause | ✅ 使用中 | パターン文書化 |
| pcall | 未使用 | 必要時のパターン文書化 |
| サイレントnil禁止 | ⚠️ 一部違反 | ドキュメント化 |

### Requirement 7: Pasta固有規約
| 項目 | 現状 | ギャップ |
|------|------|----------|
| PASTA API | コード内にコメント | **規約ドキュメント化必要** |
| CTXパターン | コード内にコメント | **規約ドキュメント化必要** |
| ACTパターン | コード内にコメント | **規約ドキュメント化必要** |
| PROXYパターン | コード内にコメント | **規約ドキュメント化必要** |
| STOREパターン | コード内にコメント | **規約ドキュメント化必要** |

### Requirement 8: リファクタリング
| 項目 | 現状 | ギャップ |
|------|------|----------|
| EmmyLua補完 | 不完全 | **修正必要**（8ファイル） |
| ドキュメント補完 | 不完全 | **修正必要**（複数関数） |
| 命名規約準拠 | ほぼ準拠 | **軽微な修正** |
| クラス設計パターン適用 | ❌ 未実施 | **全クラスでリファクタ必要** |
| コロン構文→ドット構文 | ❌ 未実施 | **全ファイルで変換必要** |
| 動作保証 | テスト存在 | テスト実行確認 |

### Requirement 9: テスト/Lint規約
| 項目 | 現状 | ギャップ |
|------|------|----------|
| lua_testパターン | 実装済み | **ドキュメント化必要** |
| ファイル命名 | `*_spec.lua` | ドキュメント化 |
| describe/itパターン | 使用中 | ドキュメント化 |
| luacheck | 未導入 | **Research Needed** |

## 3. 実装アプローチオプション

### Option A: ドキュメントファースト（推奨）
**概要**: まず規約ドキュメントを作成し、その後リファクタリング

**手順**:
1. `.kiro/steering/lua-coding.md` 作成
2. 既存パターンを規約として文書化
3. リファクタリング対象を特定
4. 段階的にコード修正

**Trade-offs**:
- ✅ 規約が先にあることでリファクタリングの指針が明確
- ✅ レビュー可能な中間成果物
- ✅ 規約承認後にコード修正で手戻り削減
- ❌ 2段階作業で期間が長い

### Option B: 一括実装
**概要**: 規約ドキュメントとリファクタリングを同時実施

**Trade-offs**:
- ✅ 1回の実装で完了
- ❌ 規約変更時に手戻りリスク
- ❌ レビュー負荷が高い

### Option C: ハイブリッド（推奨代替案）
**概要**: 規約の骨格を作成→1ファイルで検証→規約確定→残りをリファクタ

**手順**:
1. 規約ドキュメント骨格作成
2. `store.lua`（最小ファイル）でパイロット適用
3. フィードバック反映して規約確定
4. 残り7ファイルをリファクタリング

**Trade-offs**:
- ✅ 早期検証で規約の実用性確認
- ✅ 段階的リスク軽減
- ❌ パイロット選定の判断必要

## 4. 複雑性とリスク評価

### 工数見積もり: **S（1-3日）**
**理由**:
- 既存パターンが既に良好
- 新規コード作成なし（ドキュメント＋軽微なリファクタ）
- テストフレームワーク既存

### リスク: **Low**
**理由**:
- 既存テストで動作保証可能
- 機能変更なし（リファクタリングのみ）
- 既知のパターン適用

## 5. 設計フェーズへの推奨事項

### 推奨アプローチ
**Option A: ドキュメントファースト**を推奨

### 主要決定事項
1. **規約ドキュメント構成**: 8セクション（要件1-8に対応）
2. **リファクタリング範囲**: 8ファイル（scripts/pasta/*.lua）
3. **テスト戦略**: 既存テスト実行でリグレッション確認

### 要調査事項（Research Needed）
1. **luacheck導入**: CI統合可能か？設定ファイル形式は？
2. **EmmyLua互換性**: VS Code + sumneko lua-language-server との互換性確認

### ファイル変更リスト（予定）
| カテゴリ | ファイル | 変更種別 |
|----------|----------|----------|
| 新規 | `.kiro/steering/lua-coding.md` | 作成 |
| 修正 | `scripts/pasta/actor.lua` | 型注釈補完 |
| 修正 | `scripts/pasta/word.lua` | @vararg修正 |
| 修正 | `scripts/pasta/scene.lua` | 型注釈補完 |
| 修正 | `scripts/pasta/store.lua` | 型注釈補完 |
| 軽微 | その他4ファイル | 一貫性調整 |
