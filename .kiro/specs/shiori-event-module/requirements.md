# Requirements Document

## Introduction

本ドキュメントは `pasta.shiori.event` モジュールの要件を定義する。SHIORI イベントの振り分けとハンドラ登録の仕組みを提供し、ゴースト開発者が簡潔にイベントハンドラを定義できる基盤を提供する。

### 背景

- **対象ファイル**:
  - `crates/pasta_lua/scripts/pasta/shiori/event/init.lua`（イベント振り分け）
  - `crates/pasta_lua/scripts/pasta/shiori/event/register.lua`（ハンドラ登録テーブル）
- **依存モジュール**: `pasta.shiori.res`（レスポンス組み立て、作成済み）
- **プロトコル**: SHIORI/3.0（伺か用ゴースト通信プロトコル）

### スコープ

**含む**:
- イベントハンドラ登録テーブル（REG）
- イベント振り分け機構（EVENT.fire）
- 未登録イベント用デフォルトハンドラ（EVENT.no_entry）
- xpcallによるエラーキャッチとエラーレスポンス変換

**含まない**:
- `data` 引数（状態管理）
- 外部ファイルからの自動登録機構
- シーン検索・実行機能
- ウェイト処理やトーク処理

---

## Requirements

### Requirement 1: ハンドラ登録テーブル（register.lua）

**Objective:** ゴースト開発者として、イベントハンドラを簡潔に登録できるテーブルを使用することで、SHIORIイベントへの応答を直感的に定義したい。

#### Acceptance Criteria

1. The REG module shall export an empty table named `REG` as the module return value.
2. The REG module shall include LuaDoc annotations (`--- @module pasta.shiori.event.register`) at the file header.
3. The REG module shall allow handler registration via direct table assignment (`REG.EventName = function(req) ... end`).
4. The REG module shall not provide special registration functions (テーブル直接代入のLuaらしいスタイル).
5. The REG module shall follow the lua-coding steering conventions for module structure.

---

### Requirement 2: イベント振り分けモジュール構造（init.lua）

**Objective:** 開発者として、Luaコーディング規約に準拠したモジュール構造を持つことで、保守性と一貫性を確保したい。

#### Acceptance Criteria

1. The EVENT module shall export a table named `EVENT` as the module return value.
2. The EVENT module shall include LuaDoc annotations (`--- @module pasta.shiori.event`) at the file header.
3. The EVENT module shall require `pasta.shiori.event.register` as `REG`.
4. The EVENT module shall require `pasta.shiori.res` as `RES`.
5. The EVENT module shall follow the lua-coding steering conventions for module structure.

---

### Requirement 3: デフォルトハンドラ（no_entry）

**Objective:** 開発者として、未登録イベントに対して適切な204レスポンスを返すことで、SHIORIプロトコルに準拠した応答を保証したい。

#### Acceptance Criteria

1. The EVENT module shall provide `EVENT.no_entry(req)` function as the default handler for unregistered events.
2. When `EVENT.no_entry(req)` is called, the EVENT module shall return `RES.no_content()` (204 No Content).
3. The EVENT module shall include LuaDoc annotations for `EVENT.no_entry` describing its purpose and return value.

---

### Requirement 4: イベント振り分け（fire）

**Objective:** 開発者として、リクエストの `req.id` に基づいて適切なハンドラを呼び出すことで、イベント処理を自動的に振り分けたい。

#### Acceptance Criteria

1. The EVENT module shall provide `EVENT.fire(req)` function for event dispatching.
2. When `EVENT.fire(req)` is called, the EVENT module shall lookup handler via `REG[req.id]`.
3. When registered handler exists for `req.id`, the EVENT module shall invoke that handler with `req` argument.
4. When no handler is registered for `req.id`, the EVENT module shall invoke `EVENT.no_entry(req)`.
5. When `req.id` is `nil` or missing, the EVENT module shall invoke `EVENT.no_entry(req)` (defensive programming).
6. The EVENT module shall include LuaDoc annotations for `EVENT.fire` describing parameters and return value.

---

### Requirement 5: エラーハンドリング

**Objective:** 開発者として、ハンドラ内で発生したエラーをキャッチし500レスポンスに変換することで、例外が上位に伝播せず安定した応答を保証したい。

#### Acceptance Criteria

1. The EVENT module shall wrap handler execution in `xpcall` with `debug.traceback` as error handler.
2. When handler executes successfully, the EVENT module shall return the handler's result directly.
3. When handler throws an error, the EVENT module shall extract the first line of the traceback (error message only) to avoid protocol violations.
4. When handler throws an error, the EVENT module shall pass the extracted error message to `RES.err()` (nil handling is delegated to RES.err).
5. The EVENT module shall ensure exceptions never propagate beyond `EVENT.fire()`.
6. The EVENT module shall apply `xpcall` only at the `EVENT.fire` level (ハンドラ内部の末尾再帰を妨げない設計).

---

### Requirement 6: ハンドラシグネチャ

**Objective:** ゴースト開発者として、統一されたハンドラシグネチャを使用することで、一貫性のあるイベント処理コードを記述したい。

#### Acceptance Criteria

1. When registering a handler, the developer shall define a function with signature `function(req) -> string`.
2. The EVENT module shall pass the `req` table unchanged to registered handlers.
3. When handler returns a value, the EVENT module shall return that value as the SHIORI response.
4. The EVENT module shall document expected handler signature in module header comments.

---

### Requirement 7: リクエストテーブル構造

**Objective:** 開発者として、Rust側から渡されるリクエストテーブルの構造を理解することで、適切にイベントハンドラを実装したい。

**Note:** このリクエストテーブルは `pasta_shiori::lua_request::parse_request()` により既に生成される。本要件はドキュメント整備のみ。

#### Acceptance Criteria

1. The EVENT module documentation shall describe expected `req` table structure generated by Rust.
2. The EVENT module shall document that `req.id` contains the event name string (例: `"OnBoot"`, `"OnClose"`).
3. The EVENT module shall document that `req` tables contain at minimum: `method`, `version`, `id`, `charset`, `sender`, `reference` fields.
4. The EVENT module shall not modify the `req` table passed to handlers (read-only contract).

---

### Requirement 8: モジュール公開API

**Objective:** 開発者として、明確な公開APIを持つことで、モジュールの正しい使用方法を理解したい。

#### Acceptance Criteria

1. The EVENT module shall expose exactly two public functions: `EVENT.fire` and `EVENT.no_entry`.
2. The REG module shall be accessible via `require("pasta.shiori.event.register")` for handler registration.
3. The EVENT module shall be accessible via `require("pasta.shiori.event")` for event dispatching.
4. The EVENT module shall not expose internal implementation details.

---

### Requirement 9: 使用例ドキュメント

**Objective:** ゴースト開発者として、EVENT.fireの使用例を理解することで、イベントハンドリングの実装方法を把握したい。

#### Acceptance Criteria

1. The EVENT module documentation shall include usage examples for handler registration.
2. The EVENT module documentation shall include usage examples for event dispatching with `EVENT.fire(req)`.
3. The EVENT module documentation shall clarify that actual integration with SHIORI.request is handled by Rust side (pasta_shiori).
4. The EVENT module documentation shall provide example req table structure for testing purposes.

---
