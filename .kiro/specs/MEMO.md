# LLM参照を禁じる。このドキュメントは人間用です。LLMは参考にせず、書き込みも禁止

## 要件定義分析後の質問（保存用テンプレート）

要件定義及びギャップ分析レポートを踏まえて、修正点・疑問点・不安点などを作業として収拾せよ。自明な修正点は修正してコミット。開発者への確認が少しでも必要な項目については、1 議題ずつディスカッションを進行せよ。議題が１つクローズするごとに更新しコミット、次の議題に移れ。更新するときは、これまでの議論で明らかになった点を書くとともに、不要になった要件の集約・削除なども行い、次の議題の提示前に修正内容の要約を報告してくださいね。すべての議題が終了したら、次のコマンドを教えて。なお、MEMO.mdはLLM参照・変更禁止。

## 設計分析後の質問

設計及び設計分析レポートを踏まえて、修正点・疑問点・不安点などを作業として収拾せよ。自明な修正点は修正してコミット。開発者への確認が少しでも必要な項目については、1 議題ずつディスカッションを進行せよ。議題が１つクローズするごとに更新しコミット、次の議題に移れ。更新するときは、これまでの議論で明らかになった点を書くとともに、不要になった要件の集約・削除なども行い、次の議題の提示前に修正内容の要約を報告してくださいね。すべての議題が終了したら、次のコマンドを教えて。なお、MEMO.mdはLLM参照・変更禁止。

## /kiro-spec-init
/kiro-spec-init
ランタイム層からの参照がパーサー２、トランスパイラー２を呼び出すようになった。旧実装のパーサー、トランスパイラーについて、以下の手順で削除せよ。

１．パーサー、トランスパイラーのディレクトリを丸ごと
２．`cargo check`が通るまでソースコードを修正。
　　多分参照コードの削除だけでよいはずだが、注意して修正。
３．`cargo check --all`が通るまでソースコードを修正。
　　多分テストコードのコードの削除だけでよいはず。
４．全コミット。
５．`cargo test --all`が通るまでテスト修正。
６．全コミット。
７．パーサー２、トランスパイラー２のモジュール名から「２」を外す。
８．ビルドが通るまで修正
９．テストが通るまで修正
１０．全コミット。
１１．テストディレクトリに残っている、*.rs以外のファイルについて、残存テストから
　　　参照されていないものを削除。
１２．全テストが通ることを確認。
１３．全コミット

## さくらスクリプトコマンドregex（2026/1/8決定）

### 課題
さくらスクリプトのコマンド領域を正確にマッチするregexを特定する必要あり。
- \h, \s[10], \_s, \!, \& などのコマンド文字列
- [] パラメータ内に "" で囲った領域が存在する場合にも対応
- [""] 内に ] が含まれるケース（例：\s[surface,"]"]）でも正確に判定

### 結論

**推奨パターン（Rust regex クレート用）**

```rust
const SAKURA_SCRIPT_COMMAND: &str = r#"\\[a-zA-Z0-9_!&]+(?:\[(?:[^\]\\"]|"[^"]*"|\\.)* \])?)"#;
```

### パターン詳細

| 部分            | 説明                                         |
| --------------- | -------------------------------------------- |
| \\              | バックスラッシュ（エスケープ）               |
| [a-zA-Z0-9_!&]+ | コマンド文字（英数字、アンダースコア、!, &） |
| (?:\[...\])?    | オプションのパラメータ部分                   |
| [^\]\\"]        | ], \, " 以外の文字                           |
| "[^"]*"         | ダブルクォート文字列（"..." 形式）           |
| \\.             | エスケープシーケンス（\], \", \\ など）      |

### マッチ対象

- ✅ \h - 単純コマンド
- ✅ \s[10] - 数値パラメータ
- ✅ \s["表情"] - 文字列パラメータ
- ✅ \s[surface,"]"] - "]" を含む文字列
- ✅ \_s[0] - アンダースコア付きコマンド
- ✅ \! - 感嘆符コマンド
- ✅ \& - アンパサンドコマンド
- ✅ \![set,autosearch,0] - カンマ区切りパラメータ

### 非推奨パターン

SAKURA_SCRIPT_SIMPLE: r"\\[a-zA-Z0-9_!&]+(?:\[[^\]]*\])?"
- 理由：[] 内の "]" を誤判定する危険性あり
- 簡易判定のみに限定し、本実装では避けるべき
