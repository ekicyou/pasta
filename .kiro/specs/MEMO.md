# LLM参照を禁じる。このドキュメントは人間用です。LLMは参考にせず、書き込みも禁止

## 要件定義分析後の質問（保存用テンプレート）

要件定義及びギャップ分析レポートを踏まえて、修正点・疑問点・不安点などを作業として収拾せよ。自明な指摘は修正してコミット。設計判断となる項目は設計判断とする。最後に、開発者への確認が少しでも必要な項目（what/why があいまいな要件）については、1 議題ずつディスカッションを進行せよ。議題が１つクローズするごとに更新しコミット、次の議題に移れ。更新するときは、これまでの議論で明らかになった点を書くとともに、不要になった要件の集約・削除なども行い、次の議題の提示前に修正内容の要約を報告してくださいね。すべての議題が終了したら、次のコマンドを教えて。なお、MEMO.mdはLLM参照・変更禁止。

## 設計分析後の質問

設計及び設計分析レポートを踏まえて、修正点・疑問点・不安点などを作業として収拾せよ。自明な修正点は修正してコミット。開発者への確認が少しでも必要な項目（what / why / how があいまいな設計）については、1 議題ずつディスカッションを進行せよ。議題が１つクローズするごとに更新しコミット、次の議題に移れ。更新するときは、これまでの議論で明らかになった点を書くとともに、不要になった要件の集約・削除なども行い、次の議題の提示前に修正内容の要約を報告してくださいね。すべての議題が終了したら、次のコマンドを教えて。なお、MEMO.mdはLLM参照・変更禁止。

## 実装完了処理
ステアリング（workflow.md）を読み込んだら以下を実施。実装完了を承認します。完了フローを実施。お疲れ様でした！



/kiro-validate-design alpha04-sample-ghost
これまでの指摘に対応し、要件の追加修正を行った。設計ドキュメントについて全面改訂し、参照している要件番号などの整合性チェックを含め、設計を深掘りして見直してほしい。


## バルーン指定
スポット情報と一緒にバルーン指定を設定できた方がよいかもしれない。さくらスクリプト直接指定でもよいが。。。

## 濁点・半濁点のウェイト実装


## シーンをコルーチンとして実行できるようにする。
EVENT.fireで実行されたハンドラ関数が終了せず、サスペンド（続きのトークが存在）している場合に、次回のOnTalkイベントのタイミングでチェイントークが発動するようにする。

### EVENT.fire関数がコルーチンを処理するようにする
EVENT.fire内部をコルーチン化し、継続が残った場合、STORE.co_fireに保存する。

1. EVENT.fireが取得するhandlerは、CO.safe_wrap()でコルーチン関数した`co_handler`とすること（呼び出し先の仕様変更）
2. EVENT.fireは、`local co, value = co_handler(act)`を１回実行すること。
3. EVENT.fireは、co==nil（error）だった場合、error(value)を発行すること
4. EVENT.fireは、co=="yield"だった場合、STORE.co_handler = co_handlerを設定すること
5. EVENT.fireは、co=="return"だった場合、STORE.co_handler = nilを設定すること
6. EVENT.fireは、co=~nilだった場合、valueが有効な文字列であればRES.ok(value)、valueがnilまたは0文字長だった場合はRES.no_content()を返すこと

### EVENT.fire関数から呼び出される関数は、co_handlerを返すこと
1. 実際にシーン関数を実行せず、ハンドラを返すこと
2. ハンドラを返すときに、CO.safe_wrap()でコルーチン関数した`co_handler`とすること

### virtual_dispatcher.luaのdispatch()関数の改良
1. check_hour / check_talkは、シーン関数を実行するのではなく、シーン関数のハンドラを返す。
2. dispatch()関数は戻ってきたハンドラをそのまま返す。

### virtual_dispatcher.luaのcheck_talk()関数がSTORE.co_handlerを返すようにする
1. 発話出来るタイミングのとき、STORE.co_handlerを確認し、nilでなければSTORE.co_handlerを返す。
2. もしくは、 execute_scene("OnTalk", act)をco_handlerに変換して返す。

### シーン関数にact.yield()を含めてテストを行う。




/kiro-validate-gap alpha04-sample-ghost
現在の要件で再度ギャップ分析して欲しい。