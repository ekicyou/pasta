# LLM参照を禁じる。このドキュメントは人間用です。LLMは参考にせず、書き込みも禁止

## 要件定義分析後の質問

要件定義およびギャップ分析レポートを踏まえて、修正点・疑問点・不安点などを作業として収拾せよ。自明な指摘は修正してコミット。設計判断となる項目は設計判断とする。最後に、開発者への確認が少しでも必要な項目（what/whyがあいまいな要件）については、1議題ずつディスカッションを進行せよ。議題が1つクローズするごとに更新しコミット、次の議題に移れ。更新するときは、これまでの議論で明らかになった点を書くとともに、不要になった要件の集約・削除なども行い、次の議題の提示前に修正内容の要約を報告してくださいね。すべての議題が終了したら、次のコマンドを教えて。なお、MEMO.mdはLLM参照・変更禁止。

## 設計分析後の質問

設計および設計分析レポートを踏まえて、修正点・疑問点・不安点などを作業として収拾せよ。自明な修正点は修正してコミット。開発者への確認が少しでも必要な項目（what/why/howがあいまいな設計）については、1議題ずつディスカッションを進行せよ。議題が1つクローズするごとに更新しコミット、次の議題に移れ。更新するときは、これまでの議論で明らかになった点を書くとともに、不要になった要件の集約・削除なども行い、次の議題の提示前に修正内容の要約を報告してくださいね。すべての議題が終了したら、次のコマンドを教えて。なお、MEMO.mdはLLM参照・変更禁止。

## 実装完了処理
ステアリング（workflow.md）を読み込んだら以下を実施。実装完了を承認します。完了フローを実施。お疲れ様でした！




## バルーン指定
スポット情報と一緒にバルーン指定を設定できた方がよいかもしれない。さくらスクリプト直接指定でもよいが。。。

## 濁点・半濁点の、さくらスクリプトウェイト付与
会話スピードを自然に表現するために、テキストに適切なさくらスクリプトウェイトを付与したい。`@pasta_sakura_script_wait`rustモジュールを公開し、lua側からウェイトなしテキストとパラメーターを指定することで、ウェイト設定したさくらスクリプトを取得したい。

### builder.build(): トークン`talk`の処理
```lua
local WAIT = requre "@pasta_sakura_script_wait";

...
    -- talk（原文）を、ウエイト付きスクリプトに変換
    local script = WAIT.talk_to_script(actor, talk)
    -- この後、scriptを追加
```

### rust側公開関数 talk_to_script(actor, talk)
1. actorテーブルからウェイト値を取得する
2. talk文字列を分解し、適切なウェイトを挟んだスクリプトを作成する。
3. スクリプトを返す。

### actorオブジェクト（CONFIG.actor.XXX）より参照するパラメーター
1. actor.script_wait_（normal:通常）: 通常文字のウェイト(ms)、存在しなければ50
2. actor.script_wait_（濁点）       : 濁点検出ウェイト、存在しなければ1000
3. actor.script_wait_（半濁点）     : 半濁点検出ウェイト、存在しなければ500
4. actor.scrpit_wait_（感嘆詞）     : `！？!?`検出ウェイト、存在しなければ500
5. actor.scrpit_wait_（リーダー）   : `･・‥…`検出ウェイト、存在しなければ200

script_wait_XXXの名前は適切な短い英単語を割り当てる。

### talk文字列のトークン分解

入力talk文字列を文字種別ごとに分解すること。以下の分解ルールとする。

1. sakura_script: regexで`\\[0-9a-zA-Z_!]+(?:\[[^\]]*\])?` ですよね。これでいいかどうかは評価すること。
2. ぶら下げ文字ー濁点: `｡。．.`
3. ぶら下げ文字ー半濁点: `、，,・`
4. ぶら下げ文字ー感嘆詞: `？！!?`
5. ぶら下げ文字ーリーダー: `･・‥…`
6. 行頭禁則文字: `゛゜ヽヾゝゞ々ー）］｝」』):;]}｣､･ｰﾞﾟ`
7. 行末禁則文字: `（［｛「『([{｢`
8. 一般文字: その他全部

### ウェイトルール

1. sakura_script, 行末禁則文字はウェイトを入れない
2. 一般文字には1文字ずつ、直後に「通常文字のウェイト - 50ms」のウェイト（標準ウェイトが50msのため）。ただし、計算結果が0以下の時、ウェイトを入れない。
3. リーダー文字には1文字ずつ、一般文字と同じルールでウェイトを入れる。ウェイト量はリーダーウェイトを参照する。
4. ぶら下げ文字、行頭禁則文字が連続して続く間、ウェイトを入れない。
5. ぶら下げ文字、行頭禁則文字が終了したとき、対象文字のウェイトから最も大きい値-50msのウェイトを入れる。

例）`」」」！？。、`このとき、もっともウェイト量が大きいのは「。（濁点）」の1000であるため、`」」」！？。、\_w[950]`とする。

## 濁点・半濁点の、さくらスクリプトウェイト付与
会話スピードを自然に表現するために、テキストに適切なさくらスクリプトウェイトを付与したい。`@pasta_sakura_script_wait`rustモジュールを公開し、lua側からウェイトなしテキストとパラメーターを指定することで、ウェイト設定したさくらスクリプトを取得したい。

### builder.build(): トークン`talk`の処理
```lua
local WAIT = requre "@pasta_sakura_script_wait";

...
    -- talk（原文）を、ウエイト付きスクリプトに変換
    local script = WAIT.talk_to_script(actor, talk)
    -- この後、scriptを追加
```

### rust側公開関数 talk_to_script(actor, talk)
1. actorテーブルからウェイト値を取得する
2. talk文字列を分解し、適切なウェイトを挟んだスクリプトを作成する。
3. スクリプトを返す。

### actorオブジェクト（CONFIG.actor.XXX）より参照するパラメーター
1. actor.script_wait_（normal:通常）: 通常文字のウェイト(ms)、存在しなければ50
2. actor.script_wait_（濁点）       : 濁点検出ウェイト、存在しなければ1000
3. actor.script_wait_（半濁点）     : 半濁点検出ウェイト、存在しなければ500
4. actor.scrpit_wait_（感嘆詞）     : `！？!?`検出ウェイト、存在しなければ500
5. actor.scrpit_wait_（リーダー）   : `･・‥…`検出ウェイト、存在しなければ200

script_wait_XXXの名前は適切な短い英単語を割り当てる。

### talk文字列のトークン分解

入力talk文字列を文字種別ごとに分解すること。以下の分解ルールとする。

1. sakura_script: regexで`\\[0-9a-zA-Z_!]+(?:\[[^\]]*\])?` ですよね。これでいいかどうかは評価すること。
2. ぶら下げ文字ー濁点: `｡。．.`
3. ぶら下げ文字ー半濁点: `、，,・`
4. ぶら下げ文字ー感嘆詞: `？！!?`
5. ぶら下げ文字ーリーダー: `･・‥…`
6. 行頭禁則文字: `゛゜ヽヾゝゞ々ー）］｝」』):;]}｣､･ｰﾞﾟ`
7. 行末禁則文字: `（［｛「『([{｢`
8. 一般文字: その他全部

### ウェイトルール

1. sakura_script, 行末禁則文字はウェイトを入れない
2. 一般文字には1文字ずつ、直後に「通常文字のウェイト - 50ms」のウェイト（標準ウェイトが50msのため）。ただし、計算結果が0以下の時、ウェイトを入れない。
3. リーダー文字には1文字ずつ、一般文字と同じルールでウェイトを入れる。ウェイト量はリーダーウェイトを参照する。
4. ぶら下げ文字、行頭禁則文字が連続して続く間、ウェイトを入れない。
5. ぶら下げ文字、行頭禁則文字が終了したとき、対象文字のウェイトから最も大きい値-50msのウェイトを入れる。

例）`」」」！？。、`このとき、もっともウェイト量が大きいのは「。（濁点）」の1000であるため、`」」」！？。、\_w[950]`とする。

