# LLM参照を禁じる。このドキュメントは人間用です。LLMは参考にせず、書き込みも禁止

## 要件定義分析後の質問（保存用テンプレート）

要件定義及びギャップ分析レポートを踏まえて、修正点・疑問点・不安点などを作業として収拾せよ。自明な指摘は修正してコミット。設計判断となる項目は設計判断とする。最後に、開発者への確認が少しでも必要な項目については、1 議題ずつディスカッションを進行せよ。議題が１つクローズするごとに更新しコミット、次の議題に移れ。更新するときは、これまでの議論で明らかになった点を書くとともに、不要になった要件の集約・削除なども行い、次の議題の提示前に修正内容の要約を報告してくださいね。すべての議題が終了したら、次のコマンドを教えて。なお、MEMO.mdはLLM参照・変更禁止。

## 設計分析後の質問

設計及び設計分析レポートを踏まえて、修正点・疑問点・不安点などを作業として収拾せよ。自明な修正点は修正してコミット。開発者への確認が少しでも必要な項目については、1 議題ずつディスカッションを進行せよ。議題が１つクローズするごとに更新しコミット、次の議題に移れ。更新するときは、これまでの議論で明らかになった点を書くとともに、不要になった要件の集約・削除なども行い、次の議題の提示前に修正内容の要約を報告してくださいね。すべての議題が終了したら、次のコマンドを教えて。なお、MEMO.mdはLLM参照・変更禁止。

# アクター単語辞書の相談

## 相談内容
アクター単語辞書の概念を整理したい。

## 単語辞書の概要

### 例
```pasta
　＠人物男：松岡修造、羽生譲
　＠人物女：松田聖子、松任谷由実

...
　　さくら：＠人物　を10年ぶりに見たよ。
　うにゅう：何もかも懐かしい……。
```

### 何をしているか
`＠人物`が現れたときに、「人物」で前方一致してマッチした単語登録から、
1つをランダムに選んで置き換える機能。ランダムトークの生成に利用する。

### 置き換え結果
```pasta
　　さくら：松岡修造を10年ぶりに見たよ。
　うにゅう：何もかも懐かしい……。
```

## 現在の実装
シーンの登録単語を見て、存在すればシーン単語から、
存在しなければグローバルに登録された単語から、単語を検索して
置換する。

## 新たな実装
アクター単語辞書の概念を追加する。アクター辞書は以下の通り。

```pasta
％さくら
　＠通常　　　：\s[0]
　＠照れ　　　：\s[1]
　＠驚き　　　：\s[2]
　＠ぐんにょり：\s[3]
　＠怒り　　　：\s[4]
```lua
function ACTOR.笑い(ctx, value, ...)
    return [=[(笑)]=]
end
```


％うにゅう
　＠通常　：\s[10]
　＠刮目　：\s[11]

...
　　さくら：＠通常　いい天気だね。
　うにゅう：＠通常　とってつけたような挨拶やね。
```

このとき、以下のように置換される。

```pasta
　　さくら：\s[0]いい天気だね。
　うにゅう：\s[10]とってつけたような挨拶やね。
```

アクターが「さくら」の時は「さくら」の単語辞書から、
アクターが「うにゅう」の時は「うにゅう」の単語辞書から、
単語置き換えが行われる。

## 単語置き換えの優先順位
単語置き換えが行われるときの優先順位

1. アクターの同名関数（完全一致する関数名に限る）
2. アクターの単語辞書
3. シーンの同名関数（完全一致する関数名に限る）
4. シーンの単辞書
5. グローバルの同名関数（完全一致する関数名に限る）
6. グローバルの単語辞書





## /kiro-spec-init
/kiro-spec-init
pasta_luaに、`Pasta-DSL`⇒`トランスパイル.lua`のキャッシュファイル生成機能を実装する。

### 対象
基本的にはpasta_luaのreadme.mdに記載されているディレクトリ構成に従う。

| 参照先                                                   | 役割                                                           |
| :------------------------------------------------------- | :------------------------------------------------------------- |
| `dic/`+`**/*.pasta`                                      | 入力                                                           |
| `profile/pasta/cache/lua/` + `pasta/scene/` + `**/*.lua` | 出力                                                           |
| `profile/pasta/cache/lua/` + `pasta/scene_dic.lua`       | 全`キャッシュ.lua`モジュールをrequreしてシーン初期化を呼び出す |

### トランスパイルルール
1. `トランスパイル.pasta`と`トランスパイル.lua`のファイルタイムスタンプを確認し、pastaの方が新しければトランスパイル。
2. `scene_dic.lua`は常に作り直す。「1」のチェック対象になった全ファイルをrequreする。例：`dic/scene1.pasta`⇒`requre "pasta.scene.scene1"`
3. `scene_dic.lua`の末尾は固定で`requre("pasta").finalize_scene()``シーン.lua`をすべて読み込んだときに実施し、シーンテーブルの初期化を呼び出す。

### ローダーに対する最終処理
`main.lua`に、`requre "pasta.scene_dic"`を追加するか、rustのloader側でトランスパイル後に明示的にrequreして読み込み処理をキックする。どちらにするかは設計判断でよい。

### finalize_scene関数について（スコープ外）
シーン収集処理について、現在はトランスパイル処理に並行して行っているが、今後`finalize_scene()`関数を経由して呼び出されるrust関数にて行う。finalize_scene関数の実体について、実装は別仕様にて行い、本仕様では扱わない。

### 本仕様完成後の流れ（スコープ外）
現在の設計はluaへの依存が少なめだが、スクリプト言語検討の結果lua以外の選択肢がないことが判明した。したがって、今後は積極的にlua実装への依存を進めていく。

1. `finalize_scene()`の実体を実装（シーン辞書・単語辞書・アクター辞書の構築）
2. シーン辞書・単語辞書・アクター辞書の実装をluaに寄せる、lua側にも機能を割り振る
3. `pasta_shiori`に、shioriイベントに対する実装を行う。
