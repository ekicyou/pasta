# LLM参照を禁じる。このドキュメントは人間用です。LLMは参考にせず、書き込みも禁止

## 要件定義分析後の質問

要件定義およびギャップ分析レポートを踏まえて、修正点・疑問点・不安点などを作業として収拾せよ。自明な指摘は修正してコミット。設計判断となる項目は設計判断とする。最後に、開発者への確認が少しでも必要な項目（what/whyがあいまいな要件）については、1議題ずつディスカッションを進行せよ。議題が1つクローズするごとに更新しコミット、次の議題に移れ。更新するときは、これまでの議論で明らかになった点を書くとともに、不要になった要件の集約・削除なども行い、次の議題の提示前に修正内容の要約を報告してくださいね。すべての議題が終了したら、次のコマンドを教えて。なお、MEMO.mdはLLM参照・変更禁止。

## 設計分析後の質問

設計および設計分析レポートを踏まえて、修正点・疑問点・不安点などを作業として収拾せよ。自明な修正点は修正してコミット。開発者への確認が少しでも必要な項目（what/why/howがあいまいな設計）については、1議題ずつディスカッションを進行せよ。議題が1つクローズするごとに更新しコミット、次の議題に移れ。更新するときは、これまでの議論で明らかになった点を書くとともに、不要になった要件の集約・削除なども行い、次の議題の提示前に修正内容の要約を報告してくださいね。すべての議題が終了したら、次のコマンドを教えて。なお、MEMO.mdはLLM参照・変更禁止。

## 実装完了処理
ステアリング（workflow.md）を読み込んだら以下を実施。実装完了を承認します。完了フローを実施。お疲れ様でした！

## バルーン指定
スポット情報と一緒にバルーン指定を設定できた方がよいかもしれない。さくらスクリプト直接指定でもよいが。。。

## luaモジュールのパス解決方法をluaルールに準拠させる
main.luaの読み込みを、luaの検索パス設定の後、`require("main")`相当の処理で読み込むようにする。また、本番サンプルゴーストの検索パスに「ユーザー作成スクリプト」を追加する。中身のない`scripts/main.lua`を配置する。

これにより、ユーザーが`main.lua`を作成しなかったとき、空の`scripts/main.lua`が読み込まれる。ユーザーが自作スクリプトを「ユーザー作成スクリプト」に配置でき、pastaランタイムのモジュール挙動を上書きしたいときは同名モジュールを配置することで上書きを実施できる。

さらに、ローダーのlua初期化挙動を変更し、辞書登録のファイナライズ処理より、mainの解決を先に行うことでユーザースクリプトによる辞書登録を可能とする。

### デフォルトのrequre検索パスの追加
検索パスに「ユーザー作成スクリプト」を追加する。「pasta標準ランタイム」より先に解決することでユーザーによる上書きを許可し、ユーザーが「pasta標準ランタイム」を書き換える必要をなくす。

```toml
lua_search_paths = [
    "profile/pasta/save/lua",   # ユーザー保存スクリプト
    "user_scripts",              # ユーザー作成スクリプト
    "scripts",                   # pasta 標準ランタイム
    "profile/pasta/cache/lua",   # トランスパイル済みキャッシュ
    "scriptlibs",                # 追加ライブラリ
]
```

### main/pasta.scene_dic/pasta.shiori.entry/などのluaファイル読み込み方法
main.luaなど、luaコードの読み込みは、ファイルをrustで直接読み込むのではなく、`require("main")`相当のmlua関数またはコード実行でおこなう。luaの検索パスにより解決させる。同様の処理を行っている部分について、「&Luaとモジュール名を渡せばrequireしてくれる関数」を作るとよい。

### ローダーのlua初期化挙動変更
scene_dicによるファイナライズより先にmainを解決する。これにより、ユーザースクリプトによる`辞書.lua`の事前登録を可能とする。

1. （lua検索パスの解決やrust側モジュールのluaへの公開など）
2. pasta DSLのトランスパイル
3. **`require("main")`**
4. **`require("pasta.scene_dic")`**
5. （以降同じ）

手順3,4は1回のスクリプト実行で行ってもよいし、手順3,4を行う`pasta.ファイナライズ？`luaモジュールを用意する形でもよい。

### pasta_sample_ghost サンプルゴーストの修正
デフォルト検索パスの追加などの変更対応を、pasta_sample_ghost サンプルゴーストに反映させること。setup.batの実行で反映したゴーストが作成できること。

