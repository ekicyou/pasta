# Implementation Gap Analysis

## 1. Current State Investigation

### 1.1 Domain Assets

#### Existing Documentation Structure
- **pasta_lua/README.md**: クレート概要、ディレクトリ構成、設定ファイル（pasta.toml）説明
- **pasta_lua/LUA_API.md**: Rust→Lua公開API仕様書（モジュールカタログ、API仕様）
- **pasta_lua/scripts/README.md**: Luaランタイムライブラリの説明
- **pasta_lua/scriptlibs/README.md**: 外部Luaライブラリの説明

#### Key Observations
- **doc/ディレクトリ不在**: `crates/pasta_lua/doc/`は現在存在しない（新規作成）
- **既存ドキュメントの特徴**:
  - 構造化されたMarkdown（見出し階層、コードブロック、テーブル）
  - 日本語技術文書の慣例に従う
  - クロスリファレンス（§セクション参照）を活用
  - コード例とAPI仕様を明確に分離

### 1.2 Conventions Extracted

| 観点 | 規約 |
|------|------|
| **ファイル命名** | スネークケース（`snake_case`）、小文字英数字 |
| **日本語文書** | 技術用語は原文維持、説明は日本語 |
| **構造** | README.md as index、章ごとにファイル分割 |
| **コード例** | 原文のまま保持、翻訳不要 |
| **リンク** | Markdown相対リンク、セクションアンカー使用 |

### 1.3 Integration Surfaces

- **配置先**: `crates/pasta_lua/doc/lua55-manual/`（新規作成）
- **README連携**: `crates/pasta_lua/README.md`に参照リンク追加可能
- **利用シーン**: VS Code内での参照、開発者ドキュメント、Rustdoc補完

---

## 2. Requirements Feasibility Analysis

### 2.1 Technical Needs (from EARS Requirements)

#### Requirement 1: ドキュメント構造とフォーマット
- **必要要素**: Markdownファイル群、目次ファイル、相対リンク
- **実装ニーズ**: Webページ→Markdown変換、リンク正規化

#### Requirement 2: マニュアルセクション網羅性
- **必要要素**: 全9章 + 索引の完全な日本語訳
- **実装ニーズ**: 大規模翻訳作業（推定40,000単語以上）、セクション分割

#### Requirement 3: 翻訳品質
- **必要要素**: 用語対応表、API名・コード例の原文維持
- **実装ニーズ**: 翻訳品質管理、技術用語の一貫性

#### Requirement 4: ナビゲーションと検索性
- **必要要素**: 目次、パンくずリスト、索引、相互リンク
- **実装ニーズ**: リンク構造設計、セクションアンカー生成

#### Requirement 5: メンテナンス性
- **必要要素**: バージョン情報、ライセンス、翻訳元URL、シンプルな構造
- **実装ニーズ**: メタデータ記録、将来の差分管理を考慮した設計

#### Requirement 6: ライセンス遵守
- **必要要素**: Lua license (MIT)、著作権表示、非公式翻訳の明記
- **実装ニーズ**: ライセンス文書の組み込み

### 2.2 Implementation Gaps & Constraints

| カテゴリ | Gap/Constraint | 詳細 |
|---------|----------------|------|
| **Missing** | `doc/`ディレクトリ | 新規作成が必要 |
| **Missing** | 翻訳コンテンツ | 40,000語以上の手動翻訳または自動翻訳+レビュー |
| **Missing** | 用語対応表 | 技術用語の一貫性を保証するGLOSSARY.md |
| **Constraint** | 翻訳工数 | 大規模な翻訳作業（AIまたは人手） |
| **Constraint** | リンク整合性 | 内部リンクの正規化・検証が必要 |
| **Unknown** | 翻訳品質基準 | どのレベルまで品質を担保するか（機械翻訳後レビュー vs 全文人手翻訳） |

### 2.3 Complexity Signals

- **大規模翻訳作業**: 40,000語以上のマニュアル全体（9章+索引）
- **構造化HTML→Markdown変換**: セクション階層、リンク、コードブロックの保持
- **技術用語の一貫性**: 用語対応表の整備と適用
- **リンク整合性検証**: 章間リンク、セクションアンカーの正確性

---

## 3. Implementation Approach Options

### Option A: 段階的手動翻訳（推奨）

**Rationale**: 品質最優先、長期メンテナンスを考慮

**Approach**:
1. **Phase 1**: テンプレート構築
   - ディレクトリ構造作成（`crates/pasta_lua/doc/lua55-manual/`）
   - README.md（目次）、LICENSE.md、GLOSSARY.md作成
2. **Phase 2**: 主要章の翻訳（優先度順）
   - 2章 基本概念、3章 言語仕様、6章 標準ライブラリ（部分）
3. **Phase 3**: 残り章の翻訳
   - 1章、4章 C API、5章 補助ライブラリ、7章、8章、9章
4. **Phase 4**: 索引と相互リンク整備

**Trade-offs**:
- ✅ 高品質な翻訳が可能
- ✅ 用語の一貫性を人手で担保
- ✅ 段階的な納品が可能（Phase 2完了時点で部分公開）
- ❌ 工数が非常に大きい（推定40-80時間）
- ❌ 初回完了まで時間がかかる

### Option B: AI支援翻訳 + レビュー

**Rationale**: 工数削減、迅速な初期納品

**Approach**:
1. **Phase 1**: AIによる一括翻訳
   - Webページフェッチ（`fetch_webpage`）
   - LLM（Claude/ChatGPT）による全章翻訳
   - 用語対応表の自動生成
2. **Phase 2**: 人手レビュー
   - 技術用語の一貫性チェック
   - API名・コード例の原文維持確認
   - リンク整合性検証
3. **Phase 3**: 構造整備
   - 相互リンク、索引、目次の整備

**Trade-offs**:
- ✅ 初回納品が非常に早い（数時間～1日）
- ✅ 全章一括で進められる
- ❌ 翻訳品質のばらつき（レビューが必須）
- ❌ 技術用語の誤訳リスク
- ❌ LLMコンテキスト制限（章ごとに分割処理が必要）

### Option C: ハイブリッド（AI下書き + 段階的レビュー）

**Rationale**: スピードと品質のバランス

**Approach**:
1. **Phase 1**: AI下書き作成（全章）
   - LLMによる粗訳（用語対応表付き）
   - 構造とリンクの自動生成
2. **Phase 2**: 優先章の精密レビュー（2章、3章、6章）
   - 技術用語の人手修正
   - コード例・API名の検証
3. **Phase 3**: 残り章のレビュー（1章、4章、5章、7章、8章、9章）
4. **Phase 4**: 最終統合・索引整備

**Trade-offs**:
- ✅ 初期版が早く完成（1-2日）
- ✅ 優先度に応じた品質調整が可能
- ✅ 用語対応表を早期に確立
- ❌ Phase 2-3でレビュー工数が必要
- ❌ AI翻訳の品質依存

### Option D: AI多段階品質改善（採用）

**Rationale**: 開発者が英語レビュー不可のため、AI完結型で高品質を実現

**Approach**:
1. **Phase 1: AI一括翻訳** (2-4h)
   - LLM（Claude Sonnet 4.5）による全章翻訳
   - 用語対応表（GLOSSARY.md）初版作成
   - 構造とリンクの自動生成
2. **Phase 2: AI品質レビュー** (4-8h)
   - 技術用語の一貫性チェック（AIによる自己レビュー）
   - API名・コード例の原文維持確認
   - 用語対応表の更新・統一
3. **Phase 3: AIブラッシュアップ** (4-8h)
   - リンク整合性検証（章間リンク、セクションアンカー）
   - 表現の自然さ改善
   - 曖昧な訳語の再検討
4. **Phase 4: AI最終検証** (4-8h)
   - 全体整合性チェック（用語、フォーマット）
   - 索引・目次の最終調整
   - ライセンス・メタデータ確認

**Trade-offs**:
- ✅ 人間レビュー不要（開発者の英語力に依存しない）
- ✅ 複数回のAIレビューで品質向上
- ✅ 工数が予測可能（各Phase明確）
- ✅ 段階的な品質改善が可能
- ❌ AI依存リスク（技術用語の微妙なニュアンス）
- ❌ 工数がOption Bより増加（14-28h）
- ✅ Option Cと同程度の工数だが、人間レビュー不要で現実的

---

## 4. Effort & Risk Assessment

### Effort Estimation

| Approach | 工数 | 内訳 |
|----------|------|------|
| **Option A** | **XL (40-80h)** | 構造設計: 4h、翻訳: 30-70h、レビュー: 6-10h |
| **Option B** | **M (8-16h)** | AI翻訳: 2-4h、レビュー: 4-8h、構造整備: 2-4h |
| **Option C** | **L (16-32h)** | AI下書き: 2-4h、優先レビュー: 8-16h、残りレビュー: 4-8h、統合: 2-4h |
| **Option D (採用)** | **L (14-28h)** | AI一括翻訳: 2-4h、AI品質レビュー: 4-8h、AIブラッシュアップ: 4-8h、AI最終検証: 4-8h |

### Risk Assessment

| Approach | Risk Level | 主なリスク |
|----------|------------|-----------|
| **Option A** | **Low** | 工数超過リスク（翻訳量が予想以上） |
| **Option B** | **Medium** | 翻訳品質リスク（技術用語の誤訳、一貫性欠如） |
| **Option C** | **Medium** | AI品質依存リスク、レビュー工数見積もりミス |
| **Option D (採用)** | **Medium** | AI依存リスク（技術用語の微妙なニュアンス）、多段階処理の工数増加リスク |

---

## 5. Recommendations for Design Phase

### Preferred Approach: **Option D (AI多段階品質改善)** ← 採用決定

**理由**:
1. **開発者要件**: 英語レビューが不可能なため、人間レビュー不要の方式が必須
2. **品質担保**: 複数回のAIレビュー（品質レビュー→ブラッシュアップ→最終検証）で高品質実現
3. **スピード**: 初回版を2-4日で納品可能、最終版も1-2週間で完成
4. **用語統一**: AI生成の用語対応表を早期に確立し、Phase 2-4で段階的に改善
5. **工数現実性**: 14-28時間（Option Cと同等だが人間レビュー不要）

### Key Decisions for Design Phase

1. **翻訳方式の確定** ✅ 確定: Option D（AI多段階品質改善）
   - LLM選定（Claude Sonnet 4.5推奨：長文対応、技術翻訳品質）
   - 章ごとの分割方針（コンテキスト制限対応）
   - AI品質レビューフローの詳細設計

2. **用語対応表の整備** ✅ 確定: 網羅的（100語以上）、後から修正可能な原本
   - GLOSSARY.mdのフォーマット設計（English | 日本語 | 備考）
   - AI翻訳Phase 1で初版作成（100語以上）
   - Phase 2-4で段階的に洗練、人間による後続修正を想定
   - **独立性**: pasta_lua固有用語を一切含まない（Lua標準用語のみ）

3. **リンク設計**:
   - 章間リンク形式（相対パス）
   - セクションアンカー命名規則（`#2-basic-concepts`）
   - AI自動検証スクリプトの設計

4. **ファイル構成の詳細化**:
   - 章ごとのファイル名（`01-introduction.md`, `02-basic-concepts.md`など）
   - 大規模章（6章 標準ライブラリ）の分割判断

### Research Items

- **Research 1**: LLMの技術文書翻訳品質（サンプル翻訳で検証）
- **Research 2**: Lua公式マニュアルのHTML構造（セクション抽出方法）
- **Research 3**: Lua標準技術用語の網羅的リストアップ（GLOSSARY.md初版100語以上）

---

## 6. Summary

### Scope
Lua 5.5公式リファレンスマニュアル全9章+索引の日本語翻訳をMarkdown形式で`crates/pasta_lua/doc/lua55-manual/`に配置

### Challenges
1. **大規模翻訳**: 40,000語以上の技術文書
2. **技術用語の一貫性**: API名、予約語、コンテキスト依存用語の統一
3. **リンク整合性**: 章間リンク、セクションアンカーの正確性

### Recommendation
**AI多段階品質改善（Option D）** ← 採用確定
- AI一括翻訳 → AI品質レビュー → AIブラッシュアップ → AI最終検証
- 初回版: 2-4日、最終版: 1-2週間
- 工数: 14-28時間（人間レビュー不要）

### Next Steps
[設計フェーズ] `/kiro-spec-design lua55-reference-manual-ja`に進み、以下を詳細化：
1. AI多段階品質改善フロー設計（Phase 1-4の具体的手順）
2. AI品質レビュー基準（用語統一、技術的正確性）
3. 用語対応表（GLOSSARY.md）フォーマット
4. ファイル構成とリンク設計
5. AI自動検証スクリプト設計