## 6.6 – UTF-8サポート

このライブラリはUTF-8エンコーディングの基本的なサポートを提供します。すべての関数はテーブル `utf8` の内部に提供されます。このライブラリは、エンコーディングの処理以外のUnicodeサポートは提供しません。文字分類など、文字の意味を必要とする操作はスコープ外です。

特に明記されない限り、パラメータとしてバイト位置を期待するすべての関数は、指定された位置がバイトシーケンスの開始位置か、対象文字列の長さプラス1であると仮定します。文字列ライブラリと同様に、負のインデックスは文字列の末尾からカウントします。

バイトシーケンスを作成する関数は、元のUTF-8仕様で定義されているように、`0x7FFFFFFF` までのすべての値を受け入れます。これは最大6バイトのバイトシーケンスを意味します。

バイトシーケンスを解釈する関数は、有効なシーケンス（正しい形式で、冗長でない）のみを受け入れます。デフォルトでは、有効なUnicodeコードポイントになるバイトシーケンスのみを受け入れ、`10FFFF` より大きい値とサロゲートを拒否します。ブール引数 `lax` が利用可能な場合、これを指定するとこれらのチェックが解除され、`0x7FFFFFFF` までのすべての値が受け入れられます。（正しくない形式と冗長なシーケンスは引き続き拒否されます。）

---

### utf8.char (···)

0個以上の整数を受け取り、それぞれを対応するUTF-8バイトシーケンスに変換し、すべてのシーケンスを連結した文字列を返します。

---

### utf8.charpattern

パターン（関数ではなく文字列）"`[\0-\x7F\xC2-\xFD][\x80-\xBF]*`"（[§6.5.1](#651--パターン) 参照）は、対象が有効なUTF-8文字列であると仮定して、正確に1つのUTF-8バイトシーケンスにマッチします。

---

### utf8.codes (s [, lax])

以下の構文

```lua
for p, c in utf8.codes(s) do body end
```

が文字列 `s` 内のすべてのUTF-8文字に対して反復するような値を返します。`p` は各文字の位置（バイト単位）であり、`c` はコードポイントです。無効なバイトシーケンスに遭遇した場合、エラーを発生させます。

---

### utf8.codepoint (s [, i [, j [, lax]]])

バイト位置 `i` と `j`（両方を含む）の間で開始する `s` 内のすべての文字からコードポイント（整数として）を返します。`i` のデフォルトは 1、`j` のデフォルトは `i` です。無効なバイトシーケンスに遭遇した場合、エラーを発生させます。

---

### utf8.len (s [, i [, j [, lax]]])

位置 `i` と `j`（両方を含む）の間で開始する文字列 `s` 内のUTF-8文字の数を返します。`i` のデフォルトは 1、`j` のデフォルトは -1 です。無効なバイトシーケンスを見つけた場合、**fail** と最初の無効バイトの位置を返します。

---

### utf8.offset (s, n [, i])

`s` の `n` 番目の文字の位置（バイト位置 `i` からカウント）を2つの整数として返します：そのエンコーディングが開始するインデックス（バイト単位）と、終了するインデックス（バイト単位）です。

指定された文字が `s` の終端の直後にある場合、関数はそこに '`\0`' があるかのように振る舞います。指定された文字が対象内にも終端の直後にもない場合、関数は **fail** を返します。

負の `n` は位置 `i` より前の文字を取得します。`n` が非負の場合、`i` のデフォルトは 1 であり、それ以外の場合は `#s + 1` です。したがって、`utf8.offset(s,-n)` は文字列の末尾から `n` 番目の文字のオフセットを取得します。

特殊なケースとして、`n` が 0 の場合、関数は `s` の `i` 番目のバイトを含む文字のエンコーディングの開始と終了を返します。

この関数は `s` が有効なUTF-8文字列であると仮定します。
