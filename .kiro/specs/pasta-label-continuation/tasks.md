# 実装タスク: pasta-label-continuation

## タスク概要
無名「＊」グローバルシーンラベルの継続機能をパーサー層に実装する。同一ファイル内で最後に指定されたグローバルシーン名を継続利用可能にし、重複シーン定義の記述を簡潔化する。

**アーキテクチャスコープ**: Parser層のみ（Transpiler/Runtime層は無変更）  
**主要変更箇所**: `src/parser/pasta.pest`, `src/parser/mod.rs`

---

## タスクリスト

### 1. Pest文法拡張
- [x] 1.1 (P) global_labelルールでlabel_nameをオプション化
  - `global_label`ルール内の`label_name`を`label_name?`に変更
  - 無名「＊」行では`global_label_marker`の後ろがNEWLINEのみであることを文法で保証
  - 既存の名前付き「＊」構文との後方互換性を維持
  - _Requirements: 4.1, 4.2_

- [x] 1.2 (P) 文法変更の検証
  - Pest文法がコンパイル時エラーなくビルドされることを確認
  - `label_name?`構文がPest 2.8で正しく機能することを検証
  - 名前付き「＊」と無名「＊」の両方をパース可能であることをテスト
  - _Requirements: 4.1, 4.2_

### 2. パーサー層の実装
- [x] 2.1 parse_str関数にファイルスコープコンテキストを追加
  - `parse_str`関数内に`last_global_scene_name: Option<String>`変数を初期化（`None`）
  - `global_label`パース時に名前付きシーンを検出した場合、`last_global_scene_name`を更新
  - 各トップレベルラインのループ処理で、コンテキスト変数を適切に保持
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 2.2 parse_global_scene関数のシグネチャ拡張
  - `parse_global_scene`に`last_scene_name: Option<String>`パラメータを追加
  - `label_name`ルールの有無を判定し、無い場合は`last_scene_name`を使用
  - `last_scene_name`が`None`の場合は`PastaError::ParseError`を返す
  - 予約パターン（`__*__`）検証は既存ロジックを維持
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.1, 3.2_

- [x] 2.3 エラーメッセージの実装
  - 先頭無名「＊」のエラーメッセージを英語で実装（既存コード方針に準拠）
  - 名前付きシーン未出現時の無名「＊」エラーメッセージを実装
  - エラーに行番号、列番号、ファイル名、明確な説明を含める
  - _Requirements: 3.1, 3.2, 3.3_

### 3. テスト実装
- [x] 3.1 (P) ユニットテスト: parse_str（無名シーン）
  - 名前付き「＊」→無名「＊」の順でパースし、両SceneDefが正しいシーン名を持つことを検証
  - 連続する無名「＊」で同名が継続されることを検証
  - ファイル先頭の無名「＊」で`PastaError::ParseError`が返されることを検証
  - _Requirements: 1.1, 1.2, 2.1, 2.2, 2.3, 3.1_

- [x] 3.2 (P) ユニットテスト: parse_global_scene（コンテキスト）
  - `last_scene_name = Some("会話")`で無名「＊」をパース、`SceneDef.name == "会話"`を検証
  - `last_scene_name = None`で無名「＊」をパース、`Err(PastaError::ParseError)`を検証
  - エラーメッセージに行番号と明確な説明が含まれることを検証
  - _Requirements: 1.1, 3.1, 3.2, 3.3_

- [x] 3.3 (P) ユニットテスト: 文法検証
  - `global_label`ルールで`label_name?`が正しく機能することを検証
  - 無名「＊」行にコメントが混在した場合にPestエラーが発生することを検証
  - 名前付き「＊」が引き続き正常にパース可能であることを検証
  - _Requirements: 4.1, 4.2_

- [x] 3.4 統合テスト: E2Eパース
  - fixtureファイル（`tests/fixtures/unnamed_scene.pasta`）を作成し、複数の無名「＊」を含むDSLをパース
  - 無名「＊」が正しく補完され、ASTに明示的なシーン名が格納されることを検証
  - トランスパイラが重複シーン登録（連番付与）を正常に処理することを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 3.5 統合テスト: 後方互換性検証
  - 既存のfixtureファイル（`tests/fixtures/`内の全DSLファイル）が引き続き正常にパース可能であることを検証
  - `cargo test --all`が全て通過することを確認
  - 名前付き「＊」のみを使用したDSLが、パーサー拡張後も同一のASTを生成することを検証
  - _Requirements: 2.1, 2.2, 2.3, 4.2_

- [x] 3.6 統合テスト: エラーメッセージ検証
  - 先頭無名「＊」のfixtureファイルをパースし、エラーメッセージが行番号と明確な指示を含むことを検証
  - 名前付きシーン未出現時の無名「＊」ケースでエラーが適切に報告されることを検証
  - _Requirements: 3.1, 3.2, 3.3_

### 4. 統合と検証
- [x] 4.1 全テスト実行と品質確認
  - `cargo test --all`を実行し、全テストが通過することを確認
  - 新規テストと既存テストの両方が成功することを検証
  - リグレッションがないことを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 4.1, 4.2_

---

## 要件カバレッジ

| 要件ID | 要約 | 対応タスク |
|--------|------|-----------|
| 1.1 | 無名「＊」で直近シーン名を継続 | 2.2, 3.1, 3.2, 3.4, 4.1 |
| 1.2 | 連続する無名「＊」で同名を保持 | 2.2, 3.1, 3.4, 4.1 |
| 1.3 | 無名「＊」後のローカルシーン関連付け | 2.2, 3.4, 4.1 |
| 1.4 | 無名「＊」後の属性・アクション関連付け | 2.2, 3.4, 4.1 |
| 2.1 | 明示名でコンテキスト更新 | 2.1, 3.1, 3.5, 4.1 |
| 2.2 | 非シーン行でコンテキスト保持 | 2.1, 3.1, 3.5, 4.1 |
| 2.3 | 新ファイルでコンテキストリセット | 2.1, 3.1, 3.5, 4.1 |
| 3.1 | 先頭無名「＊」をエラー検出 | 2.2, 2.3, 3.1, 3.2, 3.6, 4.1 |
| 3.2 | 名前付きシーン未出現時エラー | 2.2, 2.3, 3.2, 3.6, 4.1 |
| 3.3 | エラーに行番号とメッセージ | 2.3, 3.2, 3.6, 4.1 |
| 4.1 | 無名「＊」行にコメント不可 | 1.1, 1.2, 3.3, 4.1 |
| 4.2 | 行頭コメントのみ有効 | 1.1, 1.2, 3.3, 3.5, 4.1 |

**全12要件が網羅されています。**

---

## タスク見積もり
- **合計**: 4メジャータスク、12サブタスク
- **想定作業時間**: サブタスクあたり1〜3時間
- **並列実行可能**: タスク1.1, 1.2（文法）とタスク3.1, 3.2, 3.3（単体テスト）は並列実行可能

---

## 次のステップ
タスクレビュー完了後、`/kiro-spec-impl pasta-label-continuation <task-number>` で実装を開始してください。
