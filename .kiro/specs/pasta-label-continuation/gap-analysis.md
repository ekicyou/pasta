# Implementation Gap Analysis: pasta-label-continuation

| 項目 | 内容 |
|------|------|
| **Feature Name** | pasta-label-continuation |
| **Analysis Date** | 2025-12-21 |
| **Analyzer** | GitHub Copilot |
| **Parent Spec** | なし (単独仕様) |
| **Priority** | P1 |

---

## 分析サマリー
- スコープ: グローバルシーン行(`＊`)のシーン名省略時に直近のシーン名を継続利用し、最初の省略はエラーにするパーサ拡張。
- 現状の文法はシーン名必須のため、省略形をパースできず要件1〜3がすべて未充足（[src/parser/pasta.pest](src/parser/pasta.pest)、[src/parser/mod.rs](src/parser/mod.rs)）。
- トランスパイラ/ランタイムは同名シーンの重複登録とカウンタ付与を既にサポートしており、パーサが正しくシーン名を決定すれば後段は再利用可能（[src/transpiler/scene_registry.rs](src/transpiler/scene_registry.rs)、[src/runtime/scene.rs](src/runtime/scene.rs)）。
- エラーメッセージはpest由来の汎用文言しかなく、要件3の診断メッセージ要件を満たしていない（[src/error.rs](src/error.rs)）。
- 推奨アプローチ: パーサを拡張し、文法を「シーン名省略可」にした上で、パース中に「直近のグローバルシーン名」を保持して補完。最初の省略時は`PastaError::ParseError`で明示的に報告。

---

## 1. Current State Investigation

### 1.1 既存アセットと責務

| モジュール | パス | 主な責務 | 継続利用 | 課題 |
|------------|------|----------|----------|------|
| パーサ文法 | [src/parser/pasta.pest](src/parser/pasta.pest) | グローバルシーンを `global_label_marker ~ label_name` として定義（シーン名必須） | ⚠ 要修正 | 省略形を拒否するため要件未充足 |
| パーサ実装 | [src/parser/mod.rs](src/parser/mod.rs) | `parse_str`でPastaFile生成、`parse_global_scene`でシーン名取得 | ⚠ 要修正 | 直近シーン名の保持/補完がない |
| トランスパイラ | [src/transpiler/scene_registry.rs](src/transpiler/scene_registry.rs) | `register_global`/`register_local` で同名シーンにカウンタ付与し登録 | ✅ 再利用 | 入力ASTに正しいシーン名があれば機能する |
| ランタイム | [src/runtime/scene.rs](src/runtime/scene.rs) | `SceneTable::from_scene_registry` で登録済みシーンを解決用テーブル化 | ✅ 再利用 | 追加対応不要 |
| エラー型 | [src/error.rs](src/error.rs) | `PastaError::ParseError` など構造化エラー | ⚠ 拡張検討 | 文脈付きエラー文言を追加する余地あり |

### 1.2 振る舞いと制約
- グローバルシーンはシーン名必須。省略するとpestの構文エラーで終了し、カスタム診断なし。
- パーサはファイル単位で実行されるが、ファイル内で「最後に見たグローバルシーン名」を保持する仕組みが存在しない。
- 重複シーン名はトランスパイラでカウンタ付与されるため、パーサが同名シーンを生成すれば後段で自然に複数バリアントを登録可能。

---

## 2. Requirements Feasibility & Gap Map

| 要件ID | 要件概要 | 既存資産 | 状態 |
|-------|---------|---------|------|
| 1 | 無名`＊`で直近グローバルシーン名を継承して登録 | 文法がシーン名必須 | ❌ Missing |
| 2 | 連続する無名`＊`でコンテキスト保持 | コンテキスト保持なし | ❌ Missing |
| 3 | 無名`＊`直後のローカルシーンを継承名に紐付け | パーサが名前を決めればトランスパイラが登録可 | ⚠ Constraint (前段依存) |
| 4 | 属性/アクション行を継続シーンとして解釈 | 同上 | ⚠ Constraint (前段依存) |
| 5 | 明示名`＊`でコンテキスト更新 | そもそも明示名必須 | ⚠ Constraint (要コンテキスト導入) |
| 6 | ファイル開始時にコンテキストをリセット | parse_strはファイル単位で新規だが状態を持たない | ✅ Reuse（コンテキスト導入時に初期化要） |
| 7 | 最初の無名`＊`で行番号付きエラー | pest汎用エラーのみ | ❌ Missing |

---

## 3. ギャップと制約の詳細
- **文法ギャップ**: `global_label` がシーン名必須のため、無名`＊`を受理できない（要件1,2,7未達）。
- **コンテキストギャップ**: パーサ内に「最後のグローバルシーン名」を保持する仕組みがない。無名`＊`出現時に補完もエラー判定もできない。
- **診断ギャップ**: pestのデフォルトエラーに依存しており、要件3で求める「行番号と明示メッセージ」不足。
- **後段依存**: トランスパイラ/ランタイムは入力ASTのシーン名に依存。パーサが正しく名を埋めれば追加改修不要。

---

## 4. 実装オプション

### Option A: パーサ拡張（推奨）
- **内容**: 文法を「シーン名省略可」に変更し、`parse_str` でファイル内の最後のグローバルシーン名を保持。`parse_global_scene` へコンテキスト引き渡しを追加し、無名時は補完、未定義なら `PastaError::ParseError` を発行。
- **利点**: 単一パスで完結、ASTが正規化され後段をそのまま再利用可能。エラー位置もspanから取得可能。
- **懸念**: 文法変更により曖昧性が増える可能性（無名行の誤認）。スコープ管理のためにインターフェース変更が必要。

### Option B: プレパース置換
- **内容**: pest解析前にテキストを1次スキャンし、無名`＊`行を直近シーン名で置換。最初の無名はそこでエラーにする。既存文法は変更しない。
- **利点**: 文法を触らず最小変更。
- **懸念**: 2重パースでメンテナンス負荷増。置換後の行番号ずれやスパン整合性が問題になりやすい。Runeブロックなど生文字列への干渉リスク。

### Option C: ハイブリッド
- **内容**: 文法に「無名シーン」トークンを追加し、パース後の正規化フェーズで名前解決する小フェーズを導入。
- **利点**: 文法で無名を明示しつつ、正規化で一括処理。
- **懸念**: ASTに一時的な「未解決シーン」状態が生じ、呼び出し側インターフェースが煩雑。

---

## 5. Effort / Risk 評価
- **Effort**: M（3–7日）— 文法変更 + パーサコンテキスト導入 + テスト追加で中程度。
- **Risk**: Medium — 文法の曖昧性増加とスパン整合性のリスク。テストで緩和可能。

---

## 6. Research Needed / Open Questions
- 無名`＊`の行に空白やインデントのみが付く場合の許容/禁止ルールを明文化するか。
- エラー文言の具体例（メッセージ定型）を仕様書に追記するか。
- 既存テストフィクスチャのうち、無名`＊`がコメント化された行を誤認しないよう追加ケースが必要か。
