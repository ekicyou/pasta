# 実装計画

## タスク概要

**合計**: 6 つのメジャータスク、17 個のサブタスク  
**カバレッジ**: すべての 9 要件（1, 2, 3, 4, 5, 6, 7, 8, 9）  
**推定工数**: 4-5 時間（メジャータスクあたり 1-3 時間）

---

## メジャータスク

### 1. シーン関数のシグネチャ変更とセッション初期化

- [ ] 1.1 (P) シーン関数のパラメータを `ctx` から `act` に変更
  - L253 の関数宣言のパラメータ名を変更
  - エントリーポイントと名前付きローカルシーンの関数命名パターン更新
  - すべてのアクターコンテキスト参照が新しい `act` パラメータを使用することを確認
  - `cargo build` を実行して文法を検証
  - _要件: 1, 2_

- [ ] 1.2 (P) `PASTA.create_session()` 呼び出しを `act:init_scene()` に置き換え
  - L278 の呼び出し形式を `act:init_scene(SCENE)` に更新
  - 戻り値の処理を 3 つ組から 2 つ組（save, var）に調整
  - init_scene の戻り値から save/var 変数が適切にキャプチャされることを確認
  - `cargo build` を実行して文法を検証
  - _要件: 2, 7_

- [ ] 1.3 `generate_local_scene()` 関数のドキュメント更新
  - 新しい `act` パラメータ規約を説明するドキュメント文字列を追加
  - 更新されたシグネチャを示す出力例を含める
  - init_scene 呼び出しパターンを文書化
  - _要件: 9_

### 2. スポット管理 API の変更

- [ ] 2.1 (P) `PASTA.clear_spot(ctx)` を `act:clear_spot()` に置き換え
  - L268 のメソッド呼び出し形式を更新
  - 呼び出しから `ctx` パラメータを削除
  - この変更が生成されたコード内で init_scene() の前に配置されることを確認
  - `cargo build` を実行して文法を検証
  - _要件: 3, 7_

- [ ] 2.2 (P) `PASTA.set_spot()` 呼び出しを `act:set_spot()` 形式に置き換え
  - L270 のメソッド呼び出し形式を更新
  - `ctx` パラメータを削除して引数位置を調整
  - clear_spot() 後に各アクターのスポットが正しい順序で設定されることを確認
  - `cargo build` を実行して文法を検証
  - _要件: 3, 7_

- [ ] 2.3 スポット管理ロジックのドキュメント更新
  - clear_spot と set_spot API についてのドキュメント文字列ノートを追加
  - generate_local_scene のドキュメントに新しい形式の例を含める
  - _要件: 9_

### 3. アクタープロキシ呼び出しパターン実装

- [ ] 3.1 (P) L510 で word() 呼び出しを talk() でラッピング
  - 出力形式を `act.actor:word()` から `act.actor:talk(act.actor:word())` に変更
  - 現在のアクターコンテキストが保持されることを確認
  - StringLiteralizer で word 名引数を literalize() で処理
  - `cargo build` を実行して文法を検証
  - _要件: 4, 7_

- [ ] 3.2 (P) L362 と L472 で word() 引数に StringLiteralizer を適用
  - L362 の VarSet word() 処理を更新して word 名を StringLiteralizer::literalize() でラップ
  - L472 の Action::WordRef 処理を更新して word 名を StringLiteralizer::literalize() でラップ
  - すべての文字列リテラルが統一して処理されることを確認
  - `cargo build` を実行して文法を検証
  - _要件: 7, 4_

- [ ] 3.3 アクタープロキシのドキュメント更新
  - word() ラッピングパターンを説明するドキュメント文字列を追加
  - talk() + word() ネストされた呼び出し形式を文書化
  - StringLiteralizer 要件の説明を含める
  - _要件: 9_

### 4. さくらスクリプトとエスケープ文字処理実装

- [ ] 4.1 (P) L509 でアクター範囲のさくらスクリプトを `act:sakura_script()` に置き換え
  - 出力形式をアクター範囲のメソッドから act 範囲のメソッドに変更
  - さくらスクリプトが単独で出力され、talk() でラップされないことを確認
  - スクリプトテキストの StringLiteralizer 処理を維持
  - `cargo build` を実行して文法を検証
  - _要件: 6, 7_

- [ ] 4.2 (P) L511 でエスケープ文字出力に StringLiteralizer を適用
  - Action::Escape マッチブランチを更新してエスケープ文字を StringLiteralizer::literalize() でラップ
  - 文字が出力前に適切にエスケープされることを確認
  - `cargo build` を実行して文法を検証
  - _要件: 7, 6_

- [ ] 4.3 さくらスクリプトのドキュメント更新
  - act:sakura_script() メソッドを説明するドキュメント文字列を追加
  - StringLiteralizer を使用したエスケープ文字処理を文書化
  - _要件: 9_

### 5. 新しい出力形式のテスト更新

- [ ] 5.1 トランスパイラー統合テストのアサーション更新
  - `transpiler_integration_test.rs` の既存テストケースを新しい出力形式に合わせて修正
  - シーンシグネチャのアサーション更新（ctx → act）
  - init_scene 呼び出し形式のアサーション更新
  - スポット管理メソッドのアサーション更新
  - テスト数を確認（約 20～25 個の影響を受けるテスト）
  - _要件: 8, 1, 2, 3_

- [ ] 5.2 アクタープロキシとさくらスクリプトのテストアサーション更新
  - word() ラッピングパターンのアサーション更新
  - act:sakura_script() 形式のアサーション更新
  - エスケープ文字処理のアサーション更新
  - すべての影響を受けるテストが成功することを確認
  - _要件: 8, 4, 6, 7_

- [ ] 5.3 フィクスチャファイルと期待出力の更新
  - `crates/pasta_lua/tests/fixtures/` のファイルを更新
  - `crates/pasta_lua/tests/lua_specs/` の Lua テスト期待値を更新
  - すべての期待出力が新しい API 形式を反映することを確認
  - `cargo test --lib` を実行して検証
  - _要件: 8_

- [ ] 5.4 (P) 完全なテストスイートを実行
  - `cargo test --all` を実行してリグレッションがないことを確認
  - すべての新しいアサーションが成功することを確認
  - 新しいコードパターンのテストカバレッジを確認
  - テスト失敗と必要な修正を文書化
  - _要件: 8_

### 6. コード生成の検証とドキュメント更新

- [ ] 6.1 (P) 生成 Lua コードの正確性を検証
  - 統合テストを実行して生成出力サンプルを確認
  - シーン関数シグネチャが期待形式と一致することを確認
  - API 呼び出し（init_scene, clear_spot, set_spot, sakura_script）が正しいことを確認
  - word() ラッピングとアクタープロキシ呼び出しが正しいことを確認
  - _要件: 1, 2, 3, 4, 5, 6, 7_

- [ ] 6.2 code_generator.rs モジュールドキュメント更新
  - 新しい機能の概要を含むモジュールレベルのドキュメント文字列を更新
  - generate_local_scene() と generate_action() のメソッドドキュメントを新しい形式に合わせて更新
  - 各主要変更の新しい出力形式を示す例を追加
  - StringLiteralizer 統一ルールが反映されるようにドキュメントを確認
  - _要件: 9_

- [ ] 6.3 最終検証とコミット
  - `cargo check --all` が成功することを確認
  - `cargo test --all` が成功してエラーがないことを確認
  - すべての変更が明確なコミットメッセージでコミットされていることを確認
  - 設計からの逸脱があれば実装ノートに記録
  - _要件: 1, 2, 3, 4, 5, 6, 7, 8, 9_

---

## 要件マッピング一覧

| 要件 | タスク | カバレッジ |
|------|--------|----------|
| 1 | 1.1, 5.1, 6.1 | シーンシグネチャ変更の実装と検証 |
| 2 | 1.2, 5.1, 6.1 | init_scene の実装と検証 |
| 3 | 2.1, 2.2, 5.1, 6.1 | スポット管理の実装と検証 |
| 4 | 3.1, 3.2, 5.2, 6.1 | アクタープロキシの実装と検証 |
| 5 | - | （既実装のため スキップ） |
| 6 | 4.1, 4.2, 5.2, 6.1 | さくらスクリプトの実装と検証 |
| 7 | 1.2, 2.1, 2.2, 3.1, 3.2, 4.1, 4.2, 6.1 | StringLiteralizer と変数アクセス全体 |
| 8 | 5.1, 5.2, 5.3, 5.4, 6.1 | テスト更新とカバレッジ |
| 9 | 1.3, 2.3, 3.3, 4.3, 6.2 | ドキュメント更新 |


