# Research Log

## 機能概要

**仕様名**: pasta-lua-cache-transpiler  
**フィーチャータイプ**: 既存システムの拡張（Extension）  
**調査日**: 2026-01-22

---

## 1. 技術整合性分析

### 1.1 既存技術スタックとの整合

| 技術要素     | プロジェクト標準 | 本機能での利用                   | 整合状態         |
| ------------ | ---------------- | -------------------------------- | ---------------- |
| Rust Edition | 2024             | 同一                             | ✅ 準拠           |
| エラー処理   | thiserror 2      | LoaderError 拡張                 | ✅ 準拠           |
| ロギング     | tracing 0.1      | debug!/info! マクロ              | ✅ 準拠           |
| ファイルI/O  | std::fs          | メタデータ取得、ファイル書き込み | ✅ 標準ライブラリ |
| パス操作     | std::path        | PathBuf, Path                    | ✅ 標準ライブラリ |
| 設定管理     | toml 0.9.8       | LoaderConfig 経由                | ✅ 既存活用       |

### 1.2 新規依存関係

**追加依存なし** - 全機能は標準ライブラリと既存依存で実装可能

### 1.3 ライセンス確認

**確認不要** - 新規外部依存なし

---

## 2. Discovery Findings

### 2.1 拡張ポイント分析

**統合アプローチ**: 新規コンポーネント（CacheManager）の追加

#### 変更対象ファイル

| ファイル                  | 変更種別 | 変更内容                                  |
| ------------------------- | -------- | ----------------------------------------- |
| `loader/mod.rs`           | 修正     | CacheManager統合、prepare_directories修正 |
| `loader/cache_manager.rs` | 新規     | キャッシュ管理ロジック                    |
| `runtime/mod.rs`          | 修正     | scene_dic.lua ロード処理追加              |

#### 既存パターンの活用

- **エラー型**: `LoaderError` への新規バリアント追加
- **ログ出力**: `tracing::debug!` / `tracing::info!` の統一利用
- **パス解決**: `LoaderConfig::transpiled_output_dir` の再利用
- **モジュール構成**: `loader/` サブモジュールとして配置

### 2.2 互換性確認

#### 後方互換性

| 既存API                         | 影響 | 対応               |
| ------------------------------- | ---- | ------------------ |
| `PastaLoader::load`             | なし | シグネチャ維持     |
| `PastaLoader::load_with_config` | なし | シグネチャ維持     |
| `TranspileResult` 構造体        | なし | フィールド追加なし |

#### 破壊的変更

- **cache/lua ディレクトリ削除の廃止**: 既存の挙動変更
  - 影響: キャッシュディレクトリが起動時にクリアされなくなる
  - 対応: Loaderテストで事前クリーンアップを追加

### 2.3 統合リスク評価

| リスク                               | 影響度 | 発生確率 | 緩和策                                       |
| ------------------------------------ | ------ | -------- | -------------------------------------------- |
| タイムスタンプ精度の差異（OS間）     | 低     | 低       | 秒単位比較で十分                             |
| 孤立キャッシュの蓄積                 | 低     | 中       | 警告ログで可視化、手動削除を推奨             |
| scene_dic.lua 構文エラー             | 中     | 低       | 生成ロジックのユニットテスト                 |
| 部分失敗時の不整合状態               | 中     | 低       | 失敗モジュールリストの報告                   |
| Phase 0 トランスパイル仕様変更の影響 | 高     | 高       | **キャッシュバージョン管理で自動無効化**     |

**Phase 0 リスクへの対応**:
- **キャッシュバージョン管理**: `.cache_version` ファイルで pasta_lua バージョンを記録
- **自動クリア**: バージョン不一致時に `remove_dir_all` で全クリア
- **トランスパイル仕様変更時**: Cargo.toml の version をインクリメントすることで、次回起動時に自動的にキャッシュクリア
- **Phase 0 完了後**: バージョン管理により、意図しない古いキャッシュ利用を防止

---

## 3. 設計決定の記録

### Decision 1: モジュール命名とディレクトリ構造

**選択**: Option A - ディレクトリ階層を再現

**理由**:
- Luaの`require`文による標準的なモジュール解決に準拠
- `pasta.scene.subdir.module` 形式のドット区切りパス
- `{transpiled_output_dir}/pasta/scene/{relative_path}.lua` への出力

**例**:
```
入力: dic/baseware/system.pasta
出力: profile/pasta/cache/lua/pasta/scene/baseware/system.lua
モジュール名: pasta.scene.baseware.system
```

### Decision 2: scene_dic.lua のロードタイミング

**選択**: Option 1 - Rust側で明示的にrequire

**理由**:
- シーン構築失敗の早期検出
- Rust側でのエラーハンドリング統一
- デバッグ時のスタックトレース明確化

**実装箇所**: `runtime/mod.rs::PastaLuaRuntime::new` または専用初期化メソッド

### Decision 3: キャッシュ削除ポリシー

**選択**: Option A - 削除処理の完全廃止

**理由**:
- 増分トランスパイルの前提条件
- ゴースト削除による意図しないキャッシュ保持は許容
- 手動削除を推奨するドキュメント提供

**影響**: Loaderテストの修正が必要

---

## 4. 技術仕様メモ

### 4.1 タイムスタンプ比較ロジック

```rust
use std::fs;
use std::time::SystemTime;

fn needs_transpile(source: &Path, cache: &Path) -> bool {
    let source_modified = fs::metadata(source)
        .and_then(|m| m.modified())
        .unwrap_or(SystemTime::UNIX_EPOCH);
    
    let cache_modified = fs::metadata(cache)
        .and_then(|m| m.modified())
        .ok();
    
    match cache_modified {
        Some(cache_time) => source_modified > cache_time,
        None => true, // キャッシュなし→トランスパイル必要
    }
}
```

### 4.2 scene_dic.lua 生成フォーマット

```lua
-- Auto-generated by pasta_lua CacheManager
-- Do not edit manually

require("pasta.scene.baseware.system")
require("pasta.scene.dialog.greet")
-- ... 全モジュール列挙

require("pasta").finalize_scene()
```

### 4.3 パス変換ロジック

```rust
/// dic/subdir/scene.pasta → pasta/scene/subdir/scene
fn source_to_module_path(source: &Path, base_dir: &Path) -> String {
    let relative = source.strip_prefix(base_dir)
        .unwrap_or(source);
    let without_ext = relative.with_extension("");
    
    // dic/subdir/scene → pasta/scene/subdir/scene
    let components: Vec<_> = without_ext
        .components()
        .skip(1) // "dic" をスキップ
        .map(|c| c.as_os_str().to_string_lossy())
        .collect();
    
    format!("pasta.scene.{}", components.join("."))
}
```

### 4.4 キャッシュバージョン管理

```rust
// .cache_version ファイルの内容例
0.1.0

// バージョンチェックロジック
const CACHE_VERSION_FILE: &str = ".cache_version";
const CURRENT_VERSION: &str = env!("CARGO_PKG_VERSION");

fn check_and_clear_if_outdated(cache_dir: &Path) -> Result<(), LoaderError> {
    let version_file = cache_dir.join(CACHE_VERSION_FILE);
    
    if version_file.exists() {
        let cached_version = fs::read_to_string(&version_file)?;
        
        if cached_version.trim() != CURRENT_VERSION {
            // バージョン不一致 → 全クリア
            if cache_dir.exists() {
                fs::remove_dir_all(cache_dir)?;
            }
        }
    }
    
    Ok(())
}
```

**Phase 0 対応の意義**:
- トランスパイル仕様変更時に Cargo.toml のバージョンをインクリメント
- 自動的に全キャッシュがクリアされ、不完全な実装の固定化を回避
- Phase 0 完了後も、破壊的変更時のキャッシュ管理に有効

---

## 5. テスト戦略メモ
        .map(|c| c.as_os_str().to_string_lossy())
        .collect();
    
    format!("pasta.scene.{}", components.join("."))
}
```

---

## 5. テスト戦略メモ

### ユニットテスト対象

1. `CacheManager::needs_transpile` - タイムスタンプ比較
2. `CacheManager::source_to_cache_path` - パス変換
3. `CacheManager::generate_scene_dic_content` - Lua生成
4. エラー伝播の確認

### 統合テスト対象

1. 増分トランスパイル動作確認（変更ファイルのみ再トランスパイル）
2. scene_dic.lua の自動ロード
3. 部分失敗時のサマリー報告

---

## 6. 参考リンク

- [Rust std::fs::metadata](https://doc.rust-lang.org/std/fs/fn.metadata.html)
- [Lua require 関数](https://www.lua.org/manual/5.4/manual.html#pdf-require)
- 既存実装: [loader/mod.rs](../../crates/pasta_lua/src/loader/mod.rs)
