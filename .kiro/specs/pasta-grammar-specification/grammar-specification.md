# Pasta DSL 文法仕様書

このドキュメントは、Pasta スクリプト言語の完全な文法定義です。設計フェーズで詳細化され、実装フェーズで参照されます。

---

## 1. 文法モデルの基本原則

### 1.1 行指向文法
Pasta スクリプトは**行指向文法**です。行頭の数文字により行属性が確定します。

**例外**:
- Rune コードブロック：複数行にわたりコードブロックを形成する唯一の例外

### 1.2 ファイル構造（俯瞰）
```
ファイル
├─ グローバルラベル (＊ 或いは *)
│  ├─ ローカルラベル (・ 或いは -)
│  ├─ 発言行
│  ├─ 制御フロー行 (Call ＞, Jump ？)
│  ├─ 変数代入行 (＄)
│  ├─ 属性行 (＆)
│  ├─ 単語定義行 (＠)
│  └─ Rune コードブロック
├─ グローバル単語定義 (＠)
└─ コメント行 (＃)
```

---

## 2. キーワード・マーカー定義

### 2.1 基本要素

#### 改行（NEWLINE）
```
改行 ::= "\r\n" | "\n" | "\r"
```

**セマンティクス**:
- 行の終わりを明示する
- 行指向文法では改行により行属性が確定する
- すべての行要素は改行で終わる

#### 空白（WHITE_SPACE 文字クラス）
Pasta では空白をトークンとして扱う可能性があるため、Pest の `WHITE_SPACE` 文字クラスを使用します。ただし、Pasta は行指向文法であるため、改行文字（`\r`, `\n`）は空白から除外します。

**重要**: これは Pest の WHITESPACE ルール（トークン自動スキップ）ではなく、明示的に処理される文字クラスです。

**構成** (改行を除外):
- 半角スペース：` `（U+0020）
- タブ：`\t`（U+0009）
- 全角スペース：`　`（U+3000）
- その他 Unicode 空白：U+00A0, U+1680, U+2000-U+200A, U+202F, U+205F

**セマンティクス**:
- 空白が許可される文脈において、1つ以上の連続白文字（改行を除く）はすべて消費されて、1つの「空白」トークンとして扱われます
- 改行は意図的に除外され、行の区切り文字として機能します
- 空白は有効なトークン区切り文字であり、Pest の自動スキップ対象ではありません

#### コロン（Colon）
```
コロン ::= "：" | ":"
```

**セマンティクス**: キー・値ペア形式（key ： value）の汎用区切り文字

**設計原則**: コロンは**キー：バリュー関係**を表す場合にのみ使用します。比較・フィルター条件には比較演算子（＝、＞、＜など）を使用します。

**用途**:
- 変数代入：`＄var_name ： value`
- 単語定義：`＠word_name ： value1 value2`
- 属性定義：`＆key ： value`
- 発言行：`speaker ： speech_content`
- 引数リスト（関数呼び出し）：`＠func（arg1：value1　arg2：value2）`

#### 識別子（Identifier）
```
識別子 ::= { XID_START ~ XID_CONTINUE* }
```

**XID_START**: Unicode Identifier Start
- ASCII: `a-z`, `A-Z`, `_`
- 日本語: 平仮名、カタカナ、漢字、ハングル等

**XID_CONTINUE**: Unicode Identifier Continue
- XID_START の全て + ASCII digits + 結合記号

**制約**:
- 予約パターン `__*__` は未使用（システム予約）
- 例：`__start__`, `__word_test__`

#### インデント（Indent）
```
インデント ::= WHITE_SPACE+
```

**セマンティクス**: 行頭に存在する1つ以上の連続した空白文字。行がグローバルレベルか下層レベルかを区別します。

**重要**: インデントの有無のみが判定基準です。
- インデント深さの判定は**不要**。深さを測定・比較する必要はありません
- 単純な「有（any positive indent）/ 無（no indent）」のバイナリ判定で十分

**用途**:
- インデントなし = グローバルレベル（グローバルラベル、グローバル単語定義など）
- インデントあり（深さ問わず） = 下層レベル（グローバルラベル直下のすべての行）

**定義の参照**: [2.1 空白（WHITE_SPACE 文字クラス）](#空白white_space-文字クラス)に定義されるWHITE_SPACE文字クラスを使用。

**例**:
```
＊会話               ← インデントなし（グローバルレベル）
  ＆author：Alice    ← インデントあり（下層レベル）
  ・選択肢1         ← インデントあり（下層レベル）
  Alice：おはよう    ← インデントあり（下層レベル）
```

---

### 2.2 ラベル・マーカー

#### グローバルラベル（Global Label Marker）
```
グローバルラベルマーカー ::= "＊" | "*"
使用例: ＊会話 或いは *conversation
```

#### ローカルラベル（Local Label Marker）
```
ローカルラベルマーカー ::= "・" | "-"
使用例: ・選択肢1 或いは -choice1
```

#### 属性（Attribute Marker）
```
属性マーカー ::= "＆" | "&"
使用例: ＆author：Alice
```

---

### 2.3 変数・関数

#### 単語登録・参照・呼び出し（At Marker）
```
マーカー ::= "＠" | "@"
```

**3つの用法**:

| 用法 | 構文 | 説明 |
|------|------|------|
| 単語登録 | `＠word_name：value1　value2` | グローバル単語辞書に登録 |
| 単語参照 | `＠word_name` | 登録済み単語値を参照 |
| 単語参照（動的） | `＠＄var_name` | 変数値を単語名として間接参照 |
| 関数呼び出し | `＠func_name()` | 関数を呼び出し（引数なし） |
| 関数呼び出し（引数付き） | `＠func_name（arg1：val1　arg2：val2）` | 名前付き引数で呼び出し |

#### 変数宣言・代入（Dollar Marker）
```
マーカー ::= "＄" | "$"
使用例: ＄my_var ： 10
```

#### 変数スコープ修飾子
```
スコープ修飾 ::= グローバルラベルマーカー
使用例: ＄＊global_var  （グローバル変数）
       ＄local_var      （ローカル変数）
```

---

### 2.4 制御フロー

#### Call マーカー
```
Callマーカー ::= "＞" | ">"
```

**セマンティクス**: 指定ラベルを呼び出し、実行後に戻る

**構文**:
```
＞jump_target [＆filter1＝value1＆filter2＝value2...] [arg_list]
```

詳細は [4. Jump/Call の詳細仕様](#4-jumpcall-の詳細仕様) を参照

#### Jump マーカー
```
Jumpマーカー ::= "？" | "?"
```

**セマンティクス**: 指定ラベルにジャンプ（戻らない）

**構文**:
```
？jump_target [＆filter1＝value1＆filter2＝value2...] [arg_list]
```

詳細は [4. Jump/Call の詳細仕様](#4-jumpcall-の詳細仕様) を参照

---

### 2.5 音声・会話

#### Sakura スクリプト エスケープ
```
エスケープ ::= "\"
```

**重要**: Sakura スクリプトは半角ベースの記法です。エスケープ文字は厳密に半角バックスラッシュ（\）のみを使用します。

詳細は [5. Sakura スクリプト仕様](#5-sakura-スクリプト仕様) を参照

---

### 2.6 Rune コードブロック

#### ブロック開始
```
開始マーカー ::= "```" | "```rune"
```

**重要**: rune 接尾辞は任意。接尾辞を付ける場合、許可される値は「rune」のみ。

#### ブロック終了
```
終了マーカー ::= "```"
```

**セマンティクス**: 複数行にわたり Rune VM へ直接実行されるコード

**インデント**: Rune ブロックはインデント不要です。構造上は直前のグローバルラベルに属します（インデントの有無に関わらずグローバルラベル配下として扱われます）。

**処理モデル**:
- **パーサー層（Pest）**: Runeブロックの内容は透過的に処理されます。開始マーカー `\`\`\`` または `\`\`\`rune` と終了マーカー `\`\`\`` の間をそのまま抽出するのみで、内部の文法は検証しません。
- **トランスパイラー層**: 抽出されたRuneコード文字列が、「**正式なRune関数の羅列として成立する**」ことを検証・コンパイルします。
- **エラーハンドリング**: Rune文法に誤りがある場合、**トランスパイラー層以降でコンパイルエラーが発生**します。パーサー層ではエラーとなりません。

**例**:
````pasta
＊会話
```rune
let x = 10;
for i in 0..x {
  yield ctx.event("loop", i);
}
```
````

または：
````pasta
＊会話
```
let x = 10;
for i in 0..x {
  yield ctx.event("loop", i);
}
```
````

---

### 2.7 演算子

**設計原則**: すべての演算子は全角・半角の両方の形式を許容します。両者は同等に扱われます。

#### 算術演算子

| 演算 | 全角 | 半角 | 備考 |
|------|------|------|------|
| 加算 | 「＋」 | 「+」 | |
| 減算 | 「－」 | 「-」 | 数値の負号と区別注意 |
| 乗算 | 「＊」「×」 | 「*」 | 「＊」はラベルマーカーと同じ文字 |
| 除算 | 「／」「÷」 | 「/」 | |
| 剰余 | 「％」 | 「%」 | |

#### 比較演算子

**セマンティクス**: 全角・半角は同等に扱われます。

| 演算 | 全角 | 半角 | 備考 |
|------|------|------|------|
| 等値 | 「＝＝」 | 「==」 | |
| 不等 | 「！＝」 | 「!=」 | |
| より小さい | 「＜」 | 「<」 | |
| より大きい | 「＞」 | 「>」 | Jump マーカーと区別注意 |
| より小さいまたは等しい | 「＜＝」 | 「<=」 | |
| より大きいまたは等しい | 「＞＝」 | 「>=」 | |

#### 括弧

| 種類 | 全角 | 半角 |
|------|------|------|
| 左括弧 | 「（」 | 「(」 |
| 右括弧 | 「）」 | 「)」 |

---

### 2.8 リテラル・文字列

#### 日本語文字列
```
日本語文字列 ::= "「" ~ content ~ "」"
例: 「こんにちは」
```

#### 英語文字列
```
英語文字列 ::= "\"" ~ content ~ "\""
例: "Hello"
```

**エスケープ**: バックスラッシュ `\` でエスケープ可能
- `\n` → 改行
- `\\` → バックスラッシュ
- `\"` → ダブルクォート

#### 数値リテラル
```
数値 ::= ["-" | "－"] ~ 数字+ ~ ["." | "．" ~ 数字+]?

例:
  10
  -5
  3.14
  -2.5
```

**数字**: ASCII 数字（0-9）または全角数字（０-９）

---

### 2.9 単語値の区切り文字

#### 区切り文字
```
区切り ::= WHITE_SPACE+
```

**セマンティクス**: 単語定義の値リストを区切る。1つ以上の連続した空白文字。

**定義の参照**: [2.1 空白（WHITE_SPACE 文字クラス）](#空白white_space-文字クラス)に定義されるWHITE_SPACE文字クラスを使用。

**例**:
```
＠fruits：apple　banana　orange
＠numbers：1　2　3
＠items：value1  value2	value3
```

注：全角スペース「　」、半角スペース「 」、タブ「\t」など、いずれの空白文字でも区切り文字として機能します。

---

## 2.10 コメント

#### コメント行
```
コメント ::= "#" | "＃" ~ content ~ NEWLINE
```

**セマンティクス**: 行末までコメント（処理されない）

**例**:
```
# これはコメント
＃全角シャープでもOK
```

---

## 3. 行とブロック構造

### 2.11.1 行（Line）の定義

Pasta は行指向文法です。各行は改行（NEWLINE）で終わり、行頭の文字（マーカー）により行の型が決定されます。

**行の構成**:
```
行 ::= [インデント] マーカー 内容 NEWLINE
または
行 ::= [インデント] 内容 NEWLINE  （属性行、発言行など）
```

### 2.11.2 行の種類

インデントの有無で、行の構造を二分類します。

#### インデント不要の行構造（行頭にインデントなし）

| 行種 | マーカー | 説明 | 例 |
|------|---------|------|-----|
| グローバルラベル | `＊` または `*` | グローバルブロックを開始 | `＊会話` |
| グローバル単語定義 | `＠` または `@` | ファイル全体で参照可能な単語定義 | `＠fruits：apple　banana` |
| Rune ブロック | ``` ``` または ```rune``` | グローバルラベルに属する複数行コード（インデント不要） | ` ```rune ... ``` ` |
| コメント | `#` または `＃` | コメント（処理されない） | `# これはコメント` |

#### インデントが必要な行構造（行頭にインデントあり）

| 行種 | マーカー | 説明 | 例 |
|------|---------|------|-----|
| ローカルラベル | `・` または `-` | グローバルラベル配下のローカルブロック開始 | `  ・選択肢1` |
| 属性定義 | `＆` または `&` | ラベルにメタデータを付与 | `  ＆author：Alice` |
| 発言行 | （マーカーなし） | キャラクター発言 | `  Alice：こんにちは` |
| Call | `＞` または `>` | ラベルを呼び出し（戻る） | `  ＞ラベル名` |
| Jump | `？` または `?` | ラベルにジャンプ（戻らない） | `  ？ラベル名` |
| 変数代入 | `＄` または `$` | 変数を宣言・代入 | `  ＄my_var ： 10` |
| ローカル単語定義 | `＠` または `@` | 親ラベル内で参照可能な単語定義 | `  ＠fruits：apple　banana` |

注記: コメント行はインデントあり・なしの両方で許容されます（意味解釈は常に「コメント」）。

### 2.11.3 ブロック構造

Pasta スクリプトは階層的なブロック構造を持ちます。

#### グローバルブロック構造

```
グローバルブロック
  ├─ グローバル単語行（＠）*
  └─ グローバルラベルブロック（＊）+
```

**セマンティクス**:
- グローバル単語定義（0個以上）と グローバルラベルブロック（1個以上）で構成
- ファイルレベルのスコープを形成

#### グローバルラベルブロック構造

```
＊グローバル名
  ＆属性行 *
  [暗黙ローカル開始ブロック(__start__)]
  ・ローカルラベルブロック *
```

**構成要素**:
1. **グローバルラベル行**: `＊グローバル名`（宣言）
2. **属性行**: ０個以上の `＆key：value` （グローバルラベル全体のメタデータ）
3. **暗黙ローカル開始ブロック**: Rune ブロック、発言行、制御フロー行、変数代入行を格納可能（ローカルラベル宣言なし）
4. **ローカルブロック**: ０個以上の明示的ローカルラベルブロック（`・ローカルラベル`）

**暗黙ローカル開始ブロック（`__start__`）**:
- ローカルラベル名が `__start__` に相当する特別なブロック
- ローカルラベル宣言行は不要（暗黙的に開始）
- Jump/Call でグローバルラベルを呼び出す際に、`__start__` ブロックが実行される
- Rune ブロックはここに格納可能

#### ローカルブロック構造

```
・ローカル名
  [属性行 *]
  (変数代入行 | 会話行 | Call行)+
  (Jump行)*
```

**構成要素**:
1. **ローカルラベル行**: `・ローカル名`（宣言）
2. **属性行**: ０個以上の `＆key：value` （ローカルラベル全体のメタデータ）
3. **コンテンツ行**: １個以上の以下のいずれか
   - 変数代入行（`＄`）
   - 会話行（speaker：content）
   - Call 行（`＞`）
4. **Jump 行**: ０個以上の Jump 行（`？`）

**セマンティクス**:
- ローカルラベルの実行本体を構成
- ただし、最初の Jump 行が実行されるとローカルブロックから脱出（制御は Jump ターゲットへ）
- Call 行は実行後に当ローカルブロック内で処理を継続

#### Rune ブロックの配置

Rune ブロックは暗黙ローカル開始ブロック（`__start__`）内に配置されます。

```
＊グローバル名
  ```rune
  let x = 10;
  for i in 0..x { ... }
  ```
  Alice：こんにちは
```

**処理順序**:
- グローバルラベルが Call/Jump の対象になると、暗黙 `__start__` が実行される
- 暗黙 `__start__` 内の Rune ブロック（存在する場合）が最初に実行
- その後、同一ブロック内の発言行、Call 行が順に実行

**制約**:
- Rune ブロックはインデント不要（配置上は直前のグローバルラベル配下）
- 複数の Rune ブロックが暗黙 `__start__` 内に存在する場合、上から順に実行
- パーサーは内部を解釈しません。**トランスパイラーが正式なRune関数の羅列として検証**し、文法エラーはトランスパイラー層で報告されます

#### 例

**例1: 属性 + 暗黙ローカルスタート**
```
＊会話
  ＆author：Alice
  ```rune
  ctx.flag("talked", true);
  ```
  こんにちは
```

**例2: 属性 + ローカルラベルブロック**
```
＊選択肢
  ＆genre：choice
  ・選択肢1
    Alice：選択肢1を選びました
  ・選択肢2
    Alice：選択肢2を選びました
```

**例3: 暗黙スタート + 明示ローカルラベル**
```
＊複合シーン
  Alice：シーンが開始されました
  ・分岐A
    Bob：Aを選びました
  ・分岐B
    Bob：Bを選びました
```

### 2.11.4 インデント（Indentation）

インデントは行の属するレベルを示します。

**インデント規則**:
- インデントなし = グローバルレベル（グローバルラベル、グローバル単語定義など）
- インデントあり = 下層レベル（グローバルラベル直下のすべての行：ローカルラベル、属性行、発言行など）
- 例外: Rune ブロックはインデント不要だが、構造上は直前のグローバルラベルに属する

**重要**:
- インデント深さの判定は**不要**です
- パーサーは「行頭に空白があるか・ないか」のバイナリチェックのみで十分
- インデント深さを測定・比較・検証する必要はありません

**例**:
```
＊会話               ← インデントなし（グローバルレベル）
  ＆author：Alice    ← インデントあり（下層レベル）
  ・選択肢1         ← インデントあり（下層レベル）
  Alice：こんにちは ← インデントあり（下層レベル）

＠fruits：apple orange ← インデントなし（グローバルレベル）
```

---

## 4. Jump/Call の詳細仕様

### 4.1 Jump ターゲットの形式

Jump と Call は同じターゲット形式をサポート。以下の4パターンを区別：

#### パターン1: グローバルラベル参照
```
jump_target ::= グローバルラベルマーカー ~ ラベル名
例: ＊会話
   *conversation
```

**セマンティクス**: 指定名で始まるグローバルラベルの `__start__` に jump/call

#### パターン2: ローカルラベル参照
```
jump_target ::= ラベル名
例: 選択肢1
   choice1
```

**セマンティクス**: 現在のグローバルラベル内の指定ローカルラベルに jump/call

#### パターン3: 完全修飾ジャンプ
```
jump_target ::= グローバルラベルマーカー ~ グローバル名 ~ ローカルラベルマーカー ~ ローカル名
例: ＊会話・選択肢1
   *conversation・choice1
```

**セマンティクス**: 指定グローバルラベル内の指定ローカルラベルに jump/call

#### パターン4: 動的ターゲット
```
jump_target ::= マーカー ~ 変数名
例: ＠target_label
   @dynamic_choice
```

**セマンティクス**: 変数の値をラベル名として解決

---

### 4.2 フィルター（属性フィルター）

**構文**:
```
filter_list ::= ("＆" ~ key ~ 比較演算子 ~ value)+
現在: ＆key＝value
将来: ＆score＞50　＆level＜10　など比較演算子ベースに拡張予定

例: ＞ラベル名＆author＝Alice＆genre＝comedy
```

**セマンティクス**: ラベル選択時に属性で絞り込み（将来予約）

**設計原則**: フィルターは比較・条件判定のため、コロンではなく比較演算子（＝、＞、＜など）を使用

**現在**: フィルター機能は将来用に宣言; 現在は無視

---

### 4.3 引数リスト

**構文**:
```
arg_list ::= "（" ~ argument* ~ "）"
argument ::= 名前付き引数
名前付き引数 ::= name ~ "：" ~ value
区切り文字 ::= 空白（"　" | "\t" | " "）
```

**例**:
```
＠関数呼び出し（引数１：値１　引数２：値２）
＠calculate（x：10　y：20）
```

**実装状態**:
- ASTレベルでの解釈は対応
- トランスパイラー層以降の実装は順次対応予定

---

## 5. Sakura スクリプト仕様

### 5.1 概要
Sakura スクリプトは、会話テキスト内に埋め込まれる制御コマンド。バックスラッシュでエスケープされます。

### 5.2 エスケープ文字
```
エスケープ ::= "\"
```

**重要**: 厳密に半角バックスラッシュ（\）のみ。全角は不可。

### 5.3 Sakura コマンドの形式

| # | 形式 | 例 | 説明 |
|---|------|-----|------|
| 1 | 記号 + 文字 + 括弧 | `\s[0]`, `\![raise,event]` | イベント、状態遷移 |
| 2 | 記号 + 文字 + 数字 | `\w8`, `\c3` | タイミング制御（w=ウェイト） |
| 3 | アンダースコア + 文字 + 括弧 | `\_w[50]` | 拡張コマンド |
| 4 | 単一文字 | `\n`, `\0`, `\1` | 特殊文字（改行、ポーズ） |
| 5 | 単一数字 | `\0`, `\1` | ポーズレベル |

### 5.4 文字種

**Sakura 文字**:
- 半角: `a-z`, `A-Z`
- 全角: `ａ-ｚ`, `Ａ-Ｚ`

**Sakura 数字**:
- 半角: `0-9`
- 全角: `０-９`

**括弧**:
- 半角: `[`, `]`
- 全角: `［`, `］`

### 5.5 使用例

```
Alice：こんにちは\w8。\n返事してください。
Bob：\![happy]了解しました。
```

---

## 6. リテラル型

### 6.1 概要
変数、関数引数、属性値で使用可能な型。

### 6.2 型一覧

#### 文字列型
```
日本語文字列: 「こんにちは」
英語文字列: "Hello"
```

#### 数値型
```
整数: 10, -5, １０（全角）
浮動小数点: 3.14, -2.5
```

#### 変数参照
```
変数参照: @var_name, $local_var, $*global_var
```

#### 関数呼び出し
```
関数呼び出し: @func_name(), @add(1, 2)
```

---

## 7. 発言行（Speech Line）

### 7.1 基本構文
```
speaker ： speech_content [NEWLINE continuation_line*]
```

### 7.2 Speaker
**形式**: コロン前のテキスト（任意の非改行文字）

**例**:
```
Alice：...
キャラクターA：...
```

### 7.3 Speech Content
会話テキスト内に以下を埋め込み可能：

| 要素 | 例 |
|------|-----|
| 通常テキスト | `こんにちは` |
| 単語参照 | `＠word_name` |
| 単語参照（動的） | `＠＄var_name` |
| 変数参照 | `＠var_name` |
| 関数呼び出し | `＠func_name()` |
| Sakura スクリプト | `\n`, `\w8` |

### 7.4 行継続
複数行にわたる発言：

```
Alice：長い台詞は
  複数行に分けて
  記述できます
```

**セマンティクス**: インデント付き行は前行の続きとして連結

---

## 8. 属性（Attribute）

### 8.1 構文
```
属性行 ::= インデント ~ "＆" ~ key ~ "：" ~ value ~ NEWLINE
```

### 8.2 例
```
  ＆author：Alice
  ＆genre：comedy
  ＆priority：high
```

**セマンティクス**: グローバル或いはローカルラベルにメタデータを付与

---

## 9. 変数・スコープ

### 9.1 変数型

#### グローバル変数
```
宣言: ＄＊var_name ： value
参照: ＠＊var_name 或いは ＄＊var_name
```

**スコープ**: ファイル全体

#### ローカル変数
```
宣言: ＄var_name ： value
参照: ＠var_name 或いは ＄var_name
```

**スコープ**: 親ローカルラベル内

---

## 10. 単語定義（Word Definition）

### 10.1 グローバル単語定義
```
＠word_name ： value1　value2　...
```

**セマンティクス**: ファイル全体で参照可能な辞書エントリ

### 10.2 ローカル単語定義
```
  ＠word_name ： value1　value2　...
```

**セマンティクス**: 親ラベル内で参照可能

### 10.3 単語参照

**構文**:
```
会話行内: ＠word_name
Rune コード内: pasta::word_lookup(ctx, "word_name")
```

**スコープ解決ルール**:
- 単語参照にスコープ修飾子は不要
- `＠word_name` で、現在のグローバルラベルスコープ内のローカル単語 + グローバル単語の全候補から検索
- 異なるグローバルラベルスコープでは、同じ単語名でも異なる結果を返す可能性がある（ローカル単語が異なるため）

**動的単語参照**:
- `＠＄var_name` 形式で、変数値を単語名として間接参照可能
- セマンティクス：`＄var_name` で取得した値を単語名として `＠単語検索` を実行
- **実装状態**：文法定義済み、実装は将来予定

---

## 11. 未確定事項・検討中の仕様

### 11.1 Rune ブロック開始マーカー
- [ ] 「```rune」を必須にするか？
- [ ] 「```」だけでも許可するか？
- **現状**: pest 定義では両方許可

### 11.2 インライン単語参照の多段階解決
- [ ] 「＠＠word」のような2段階参照をサポートするか？
- [ ] 3段階以上（＠＠＠）も理論上可能か？
- **検討中**: MEMO.md「セレクター API」参照

### 11.3 チェーントーク
- [ ] Call/Jump 時に別トークへ移行する機能は実装済みか？
- [ ] 「＠chain」「＞chain」のような形式をサポートするか？
- **確認済みか**: 要件定義作成時に調査予定

### 11.4 ローカルラベルのパラメータ
```
  ・choice1 ＄$param1 ＄$param2
```
- [ ] パラメータ渡しの正確な形式と型チェック
- [ ] デフォルト値のサポート有無

### 11.5 フィルター機能の詳細
- [ ] 複数フィルター OR / AND 結合方法
- [ ] 将来の拡張予約だが、初期版での対応範囲

---

## 12. 参考資料

- `src/parser/pasta.pest` - PEG 文法定義
- `GRAMMAR.md` - ユーザー向けドキュメント（改訂予定）
- `pest-grammar-alignment-analysis.md` - 現状分析資料

---

**更新履歴**:

| 日付 | 版 | 変更 |
|------|-----|------|
| 2025-12-18 | 1.0 | 初版作成（ひな形） |

