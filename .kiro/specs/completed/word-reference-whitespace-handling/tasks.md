# 実装タスク: word-reference-whitespace-handling

**Feature**: word-reference-whitespace-handling  
**Phase**: Tasks  
**Updated**: 2025-12-21

---

## タスク概要

本実装では、単語参照（`＠単語名`）および変数参照（`＄変数名`）直後の空白が誤って出力される問題を修正します。修正は`src/parser/mod.rs`の`parse_speech_content()`関数のみに限定され、Pest文法は変更しません。

---

## 実装タスク

- [ ] 1. パーサー層の空白トリミングロジック実装
- [ ] 1.1 (P) parse_speech_content関数の修正
  - `parse_speech_content()`関数内のRule::text_part処理ブロックを修正
  - `parts.last()`で直前のSpeechPartを確認
  - WordExpansion/VarRefの場合、テキストの先頭空白を`trim_start()`で除去
  - 空文字列になったTextパートを`is_empty()`チェックでフィルタリング
  - さくらスクリプト（SakuraScript）および関数呼び出し（FuncCall）後のTextは変更しない
  - SPECIFICATION.md Line 769-801準拠のコメントを追加
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [ ] 2. テストスイートの作成
- [ ] 2.1 (P) 単語参照後の空白除去テスト
  - `tests/pasta_parser_speech_content_whitespace_test.rs`を新規作成
  - T1: 単語参照後の全角空白除去を検証（`＠場所　の天気`→ Text("の天気")）
  - T2: 変数参照後の半角空白除去を検証（`＄名前 さん`→ Text("さん")）
  - T3: 複数連続空白の除去を検証（`＠単語　 \tテキスト`→ Text("テキスト")）
  - T4: 空白のみの場合の空文字列フィルタリングを検証（`＠単語　＠単語`→ Textパートなし）
  - _Requirements: 1.1, 1.2, 1.3, 3.1, 3.2_

- [ ] 2.2 (P) エッジケースと既存動作の保持テスト
  - T5: インライン参照前の空白保持を検証（`テキスト　＠単語`→ Text("テキスト　")）
  - T6: さくらスクリプト直後の空白保持を検証（`\n　テキスト`→ Text("　テキスト")）
  - T7: 関数呼び出し直後の空白保持を検証（`＠func()　テキスト`→ Text("　テキスト")）
  - 連続するインライン参照のケース（`＠挨拶＠名前　さん`）
  - インライン参照のみの行のケース（`Bob：＠挨拶`）
  - 変数参照と単語参照の混在ケース（`＄名前　さん、＠挨拶　ございます`）
  - _Requirements: 1.5, 1.6, 3.1, 3.2_

- [ ] 3. リグレッションテストと統合検証
- [ ] 3.1 既存テストスイートの実行と修正
  - `cargo test --all`を実行
  - 失敗したテストがあれば原因を分析（仕様違反の期待値を持つテストは修正）
  - すべてのテストが成功することを確認
  - _Requirements: 3.3, 4.1_

- [ ] 3.2 フィクスチャファイルの出力検証
  - `tests/fixtures/comprehensive_control_flow.pasta`の出力を確認
  - 「さくら：＠場所　の天気は＠天気　だね。」のトランスパイル結果を検証
  - 期待される出力（空白を含まないTalkステートメント）と一致することを確認
  - _Requirements: 3.3, 3.4_

- [ ] 4. ドキュメント更新とコミット
- [ ] 4.1 (P) CHANGELOG.mdの更新
  - バグ修正として`CHANGELOG.md`に記載
  - 単語参照・変数参照後の空白処理がSPECIFICATION.md準拠になったことを明記
  - _Requirements: 4.1_

- [ ] 4.2 (P) コミットメッセージの作成
  - タイトル: `fix(parser): trim whitespace after word/var references`
  - 本文: 仕様準拠のバグ修正であることを明記
  - SPECIFICATION.md Line 769-801への参照を含める
  - _Requirements: 4.1_

---

## タスク依存関係

```
1.1 (パーサー修正)
 ↓
2.1 (空白除去テスト) || 2.2 (エッジケーステスト)  [並列可能]
 ↓
3.1 (リグレッションテスト) → 3.2 (フィクスチャ検証)
 ↓
4.1 (CHANGELOG) || 4.2 (コミットメッセージ)  [並列可能]
```

---

## 要件カバレッジ

| Requirement | Covered by Tasks | Status |
|-------------|------------------|--------|
| 1.1 | 1.1, 2.1 | ✅ |
| 1.2 | 1.1, 2.1 | ✅ |
| 1.3 | 1.1, 2.1 | ✅ |
| 1.4 | 1.1 | ✅ |
| 1.5 | 1.1, 2.2 | ✅ |
| 1.6 | 1.1, 2.2 | ✅ |
| 2.1 | 1.1 (ASTが正しければ自動) | ✅ |
| 2.2 | 1.1 (ASTが正しければ自動) | ✅ |
| 2.3 | 1.1 (ASTが正しければ自動) | ✅ |
| 2.4 | 1.1 (ASTが正しければ自動) | ✅ |
| 3.1 | 2.1 | ✅ |
| 3.2 | 2.1 | ✅ |
| 3.3 | 3.1 | ✅ |
| 3.4 | 3.2 | ✅ |
| 4.1 | 3.1, 4.1 | ✅ |
| 4.2 | 3.1, 4.1 | ✅ |
| 4.3 | 3.1, 4.1 | ✅ |

---

## タスクサイズ見積もり

| Task | 見積もり時間 |
|------|------------|
| 1.1 | 1.5時間 |
| 2.1 | 2時間 |
| 2.2 | 2時間 |
| 3.1 | 1時間 |
| 3.2 | 0.5時間 |
| 4.1 | 0.5時間 |
| 4.2 | 0.5時間 |
| **合計** | **約8時間** |

---

## 次のステップ

タスクをレビューし、準備が整ったら実装フェーズに進んでください：

```bash
# 特定のタスクを実装
/kiro-spec-impl word-reference-whitespace-handling 1.1

# 複数タスクを実装（慎重に使用）
/kiro-spec-impl word-reference-whitespace-handling 1.1,2.1

# すべての保留中タスクを実装（非推奨 - コンテキスト肥大化のため）
/kiro-spec-impl word-reference-whitespace-handling
```

**推奨**: タスク間でコンテキストをクリアし、各タスクに集中してください。
