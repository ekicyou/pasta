## 6.5 – 文字列操作（パートD: string.reverse-string.upper + パターン + Pack書式）

---

### string.reverse (s)

文字列 `s` を逆順にした文字列を返します。

---

### string.sub (s, i [, j])

`i` で始まり `j` まで続く `s` の部分文字列を返します。`i` と `j` は負の値も可能です。`j` が省略された場合、-1 と等しいと仮定されます（これは文字列の長さと同じです）。特に、呼び出し `string.sub(s,1,j)` は長さ `j` の `s` の接頭辞を返し、`string.sub(s,-i)`（正の `i` の場合）は長さ `i` の `s` の接尾辞を返します。

負のインデックスの変換後、`i` が 1 未満の場合、1 に修正されます。`j` が文字列の長さより大きい場合、その長さに修正されます。これらの修正後、`i` が `j` より大きい場合、関数は空文字列を返します。

---

### string.unpack (fmt, s [, pos])

フォーマット文字列 `fmt`（[§6.5.2](#652--packとunpackの書式文字列) 参照）に従って、文字列 `s`（[`string.pack`](#stringpack-fmt-v1-v2-) 参照）にパックされた値を返します。オプションの `pos` は `s` で読み取りを開始する位置を示します（デフォルトは 1）。読み取った値の後に、この関数は `s` 内の最初の未読バイトのインデックスも返します。

---

### string.upper (s)

文字列を受け取り、すべての小文字が大文字に変更されたこの文字列のコピーを返します。他のすべての文字は変更されません。小文字の定義は現在のロケールに依存します。

---

## 6.5.1 – パターン

Luaのパターンは通常の文字列で記述され、パターンマッチング関数 [`string.find`](#stringfind-s-pattern--init--plain)、[`string.gmatch`](#stringgmatch-s-pattern--init)、[`string.gsub`](#stringgsub-s-pattern-repl--n)、[`string.match`](#stringmatch-s-pattern--init) によってパターンとして解釈されます。このセクションでは、これらの文字列の構文と意味（つまり、何にマッチするか）について説明します。

### 文字クラス

*文字クラス*は文字の集合を表すために使用されます。文字クラスを記述する際には、以下の組み合わせが許可されています：

| パターン | 説明 |
|---------|------|
| **x** | （*x* がマジック文字 `^$()%.[]*+-?` でない場合）文字 *x* 自体を表す |
| **`.`** | （ドット）すべての文字を表す |
| **`%a`** | すべての文字（アルファベット）を表す |
| **`%c`** | すべての制御文字を表す |
| **`%d`** | すべての数字を表す |
| **`%g`** | スペースを除くすべての印刷可能文字を表す |
| **`%l`** | すべての小文字を表す |
| **`%p`** | すべての句読点文字を表す |
| **`%s`** | すべてのスペース文字を表す |
| **`%u`** | すべての大文字を表す |
| **`%w`** | すべての英数字を表す |
| **`%x`** | すべての16進数字を表す |
| **`%x`** | （*x* が任意の非英数字の場合）文字 *x* を表す。これはマジック文字をエスケープする標準的な方法。 |
| **`[set]`** | *set* 内のすべての文字の和集合であるクラスを表す |
| **`[^set]`** | *set* の補集合を表す |

**セットの詳細**: 範囲の終端文字を昇順で '`-`' で区切ることで、文字の範囲を指定できます。上記のすべてのクラス `%x` も *set* 内のコンポーネントとして使用できます。例えば、`[%w_]`（または `[_%w]`）はすべての英数字とアンダースコアを表し、`[0-7]` は8進数字を表し、`[0-7%l%-]` は8進数字と小文字と '`-`' 文字を表します。

閉じ角括弧をセットの最初の文字として配置することで、セット内に含めることができます。ハイフンをセットの最初または最後の文字として配置することで、セット内に含めることができます。

単一文字で表されるすべてのクラス（`%a`, `%c` など）について、対応する大文字はクラスの補集合を表します。例えば、`%S` はすべての非スペース文字を表します。

### パターン項目

*パターン項目*は以下のいずれかです：

| 項目 | 説明 |
|------|------|
| 単一の文字クラス | クラス内の任意の単一文字にマッチ |
| 文字クラス + `*` | クラス内の0個以上の文字のシーケンスにマッチ（最長マッチ） |
| 文字クラス + `+` | クラス内の1個以上の文字のシーケンスにマッチ（最長マッチ） |
| 文字クラス + `-` | クラス内の0個以上の文字のシーケンスにマッチ（最短マッチ） |
| 文字クラス + `?` | クラス内の文字の0回または1回の出現にマッチ |
| `%n` | （n は 1-9）n 番目のキャプチャされた文字列と等しい部分文字列にマッチ |
| `%bxy` | *x* で始まり *y* で終わり、*x* と *y* がバランスしている文字列にマッチ |
| `%f[set]` | *フロンティアパターン*：次の文字が *set* に属し、前の文字が *set* に属さない位置で空文字列にマッチ |

### パターン

*パターン*はパターン項目のシーケンスです。パターンの先頭にあるキャレット '`^`' はマッチを対象文字列の先頭にアンカーします。パターンの末尾にある '`$`' はマッチを対象文字列の末尾にアンカーします。他の位置では、'`^`' と '`$`' は特別な意味を持たず、自身を表します。

### キャプチャ

パターンは括弧で囲まれたサブパターンを含むことができます。これらは*キャプチャ*を記述します。マッチが成功すると、キャプチャにマッチした対象文字列の部分文字列が将来の使用のために格納（*キャプチャ*）されます。キャプチャは左括弧に従って番号付けされます。

例えば、パターン `"(a*(.)%w(%s*))"` では、`"a*(.)%w(%s*)"` にマッチする文字列の部分が最初のキャプチャとして格納され、番号 1 になります。"`.`" にマッチする文字は番号 2 でキャプチャされ、"`%s*`" にマッチする部分は番号 3 になります。

特殊なケースとして、キャプチャ `()` は現在の文字列位置（数値）をキャプチャします。

### 複数マッチ

関数 [`string.gsub`](#stringgsub-s-pattern-repl--n) とイテレータ [`string.gmatch`](#stringgmatch-s-pattern--init) は、対象内の与えられたパターンの複数の出現にマッチします。これらの関数では、新しいマッチは前のマッチの終了後少なくとも1バイト後に終了する場合にのみ有効と見なされます。言い換えれば、パターンマシンは別のマッチの直後に空文字列をマッチとして受け入れません。

---

## 6.5.2 – PackとUnpackの書式文字列

[`string.pack`](#stringpack-fmt-v1-v2-)、[`string.packsize`](#stringpacksize-fmt)、[`string.unpack`](#stringunpack-fmt-s--pos) への最初の引数は書式文字列で、作成または読み取られる構造のレイアウトを記述します。

書式文字列は変換オプションのシーケンスです。変換オプションは以下の通りです：

### エンディアンとアライメント

| オプション | 説明 |
|-----------|------|
| `<` | リトルエンディアンに設定 |
| `>` | ビッグエンディアンに設定 |
| `=` | ネイティブエンディアンに設定 |
| `![n]` | 最大アライメントを `n` に設定（デフォルトはネイティブアライメント） |

### 整数型

| オプション | 説明 |
|-----------|------|
| `b` | 符号付きバイト（`char`） |
| `B` | 符号なしバイト（`char`） |
| `h` | 符号付き `short`（ネイティブサイズ） |
| `H` | 符号なし `short`（ネイティブサイズ） |
| `l` | 符号付き `long`（ネイティブサイズ） |
| `L` | 符号なし `long`（ネイティブサイズ） |
| `j` | `lua_Integer` |
| `J` | `lua_Unsigned` |
| `T` | `size_t`（ネイティブサイズ） |
| `i[n]` | `n` バイトの符号付き `int`（デフォルトはネイティブサイズ） |
| `I[n]` | `n` バイトの符号なし `int`（デフォルトはネイティブサイズ） |

### 浮動小数点型

| オプション | 説明 |
|-----------|------|
| `f` | `float`（ネイティブサイズ） |
| `d` | `double`（ネイティブサイズ） |
| `n` | `lua_Number` |

### 文字列型

| オプション | 説明 |
|-----------|------|
| `cn` | `n` バイトの固定サイズ文字列 |
| `z` | ゼロ終端文字列 |
| `s[n]` | `n` バイトの符号なし整数としてコードされた長さが先行する文字列（デフォルトは `size_t`） |

### パディングとアライメント

| オプション | 説明 |
|-----------|------|
| `x` | 1バイトのパディング |
| `Xop` | オプション `op` に従ってアライメントする空の項目 |
| ` `（スペース） | 無視される |

### 注意事項

- "`[n]`" はオプションの整数を意味します
- オプション "`!n`", "`sn`", "`in`", "`In`" では、`n` は 1 から 16 までの任意の整数
- すべての整数オプションはオーバーフローをチェックします
- 任意の書式文字列は "`!1=`" が前置されたかのように開始します（アライメント 1、ネイティブエンディアン）
- すべてのパディングは [`string.pack`](#stringpack-fmt-v1-v2-) によってゼロで埋められ、[`string.unpack`](#stringunpack-fmt-s--pos) によって無視されます
