## 6.5 – 文字列操作（パートB: string.format-string.len）

---

### string.format (formatstring, ···)

最初の引数で与えられた説明に従って、可変数の引数をフォーマットしたバージョンを返します。最初の引数は文字列でなければなりません。フォーマット文字列は ISO C 関数 `sprintf` と同じルールに従います。

受け入れられる変換指定子は：`A`, `a`, `c`, `d`, `E`, `e`, `f`, `G`, `g`, `i`, `o`, `p`, `s`, `u`, `X`, `x`, `%`、およびCにはない指定子 `q` です。

受け入れられるフラグは：'`-`', '`+`', '`#`', '`0`', '` `'（スペース）です。幅と精度の両方は、存在する場合、2桁に制限されます。

**指定子 `q`**: ブール値、nil、数値、文字列を、結果がLuaソースコードで有効な定数になるようにフォーマットします。ブール値と nil は明らかな方法（`true`, `false`, `nil`）で書かれます。浮動小数点数は完全な精度を保持するために16進数で書かれます。文字列はダブルクォートの間に書かれ、Luaインタプリタによって安全に読み戻せるよう、必要に応じてエスケープシーケンスを使用します。

例：
```lua
string.format('%q', 'a string with "quotes" and \n new line')
```
は以下の文字列を生成する可能性があります：
```
"a string with \"quotes\" and \
 new line"
```

この指定子は修飾子（フラグ、幅、精度）をサポートしません。

**数値指定子**: `A`, `a`, `E`, `e`, `f`, `G`, `g` はすべて引数として数値を期待します。`c`, `d`, `i`, `o`, `u`, `X`, `x` は整数を期待します。LuaがC89コンパイラでコンパイルされている場合、指定子 `A` と `a`（16進浮動小数点数）は修飾子をサポートしません。

**指定子 `s`**: 文字列を期待します。引数が文字列でない場合、[`tostring`](#pdf-tostring) と同じルールに従って文字列に変換されます。指定子に修飾子がある場合、対応する文字列引数は埋め込みゼロを含んではいけません。

**指定子 `p`**: [`lua_topointer`](04-the-application-program-interface.md#lua_topointer) によって返されるポインタをフォーマットします。これにより、テーブル、ユーザーデータ、スレッド、文字列、関数に対する一意の文字列識別子が得られます。他の値（数値、nil、ブール値）については、この指定子はポインタ `NULL` を表す文字列になります。

---

### string.gmatch (s, pattern [, init])

呼び出されるたびに、文字列 `s` 上の `pattern`（[§6.5.1](#651--パターン) 参照）からの次のキャプチャを返すイテレータ関数を返します。`pattern` がキャプチャを指定しない場合、各呼び出しでマッチ全体が生成されます。3番目のオプションの数値引数 `init` は検索を開始する場所を指定します。デフォルト値は 1 で、負の値も可能です。

例として、以下のループは文字列 `s` からすべての単語を反復し、1行に1つずつ出力します：

```lua
s = "hello world from Lua"
for w in string.gmatch(s, "%a+") do
  print(w)
end
```

次の例は、与えられた文字列からすべての `key=value` ペアをテーブルに収集します：

```lua
t = {}
s = "from=world, to=Lua"
for k, v in string.gmatch(s, "(%w+)=(%w+)") do
  t[k] = v
end
```

この関数では、パターンの先頭にあるキャレット '`^`' はアンカーとして機能しません。これは反復を妨げるためです。

---

### string.gsub (s, pattern, repl [, n])

`s` のコピーを返し、`pattern`（[§6.5.1](#651--パターン) 参照）のすべての出現（または指定された場合は最初の `n` 個）が `repl` で指定された置換文字列に置き換えられます。`repl` は文字列、テーブル、または関数です。`gsub` は2番目の値として、発生したマッチの総数も返します。名前 `gsub` は *Global SUBstitution* に由来します。

**repl が文字列の場合**: その値が置換に使用されます。文字 `%` はエスケープ文字として機能します：`repl` 内の `%d`（d は 1 から 9）の形式のシーケンスは d 番目のキャプチャされた部分文字列の値を表し、シーケンス `%0` はマッチ全体を表し、シーケンス `%%` は単一の `%` を表します。

**repl がテーブルの場合**: 最初のキャプチャをキーとして使用して、マッチごとにテーブルがクエリされます。

**repl が関数の場合**: マッチが発生するたびにこの関数が呼び出され、すべてのキャプチャされた部分文字列が順番に引数として渡されます。

いずれの場合も、パターンがキャプチャを指定しない場合、パターン全体がキャプチャ内にあるかのように動作します。

テーブルクエリまたは関数呼び出しによって返された値が文字列または数値の場合、置換文字列として使用されます。そうでなければ、**false** または **nil** の場合、置換は行われません（つまり、元のマッチが文字列に保持されます）。

例：
```lua
x = string.gsub("hello world", "(%w+)", "%1 %1")
-- x="hello hello world world"

x = string.gsub("hello world", "%w+", "%0 %0", 1)
-- x="hello hello world"

x = string.gsub("hello world from Lua", "(%w+)%s*(%w+)", "%2 %1")
-- x="world hello Lua from"

x = string.gsub("home = $HOME, user = $USER", "%$(%w+)", os.getenv)
-- x="home = /home/roberto, user = roberto"

x = string.gsub("4+5 = $return 4+5$", "%$(.-)%$", function (s)
      return load(s)()
    end)
-- x="4+5 = 9"

local t = {name="lua", version="5.5"}
x = string.gsub("$name-$version.tar.gz", "%$(%w+)", t)
-- x="lua-5.5.tar.gz"
```

---

### string.len (s)

文字列を受け取り、その長さを返します。空文字列 `""` は長さ 0 です。埋め込みゼロもカウントされるので、`"a\000bc\000"` は長さ 5 です。
