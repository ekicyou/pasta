# 要件定義書

## プロジェクト説明（入力）

Pasta DSL の文法仕様が、現在の実装（pest 定義）と乖離しているため、文法設計を再度整理し直す必要があります。本要件定義では、権威的仕様書 **grammar-specification.md** の各章・各セクションを個別の要件項目として参照し、設計・タスク分解・実装において漏れが発生しないようにします。

**権威的仕様書**: `.kiro/specs/pasta-grammar-specification/grammar-specification.md`（全11章、約1210行）

**重要な注記**: 本仕様では、文法仕様の再検討・整理に伴う破壊的変更に対応するテストの修正・リグレッション対応もスコープに含めます。

**成果物**:
1. 正確な文法仕様 — pest 定義の詳細コメント化、または開発者向け技術リファレンス
2. GRAMMAR.md — 一般ユーザー向け文法説明ドキュメント（破壊的変更を反映）
3. テスト修正・リグレッション対応レポート — 破壊的変更に伴う既存テストの修正状況

---

## 文法仕様要件（grammar-specification.md 対応）

以下の要件は、grammar-specification.md の各章・各セクションを個別にトレースし、実装漏れを防止するための参照リストです。

---

### REQ-1: 文法モデルの基本原則（第1章）

**仕様参照**: grammar-specification.md §1

**目的**: Pasta DSL の基本文法モデルを正しく実装し、行指向文法の原則を維持する

#### REQ-1.1 行指向文法の実装
- **参照**: §1.1
- **受け入れ基準**:
  1. パーサーは行頭の数文字により行属性を確定すること
  2. 各行は NEWLINE で終わる構造であること
  3. 例外として Rune コードブロックのみ複数行にわたることを許容すること

#### REQ-1.2 ファイル構造の実装
- **参照**: §1.2
- **受け入れ基準**:
  1. ファイルはグローバルラベル、グローバル単語定義、コメント行で構成されること
  2. Rune コードブロックはグローバルラベル配下に配置されること

#### REQ-1.3 式の制約（設計方針）の実装
- **参照**: §1.3
- **受け入れ基準**:
  1. DSL 内で式（Expression）は記述できないこと
  2. 許可される値: リテラル値、関数呼び出し、単語参照
  3. 許可されない構文: `10 + 20 * 3`、`＄x > 5` などの算術・比較式
  4. 複雑なロジックは Rune ブロックで関数定義し、関数呼び出しで取得する設計であること

---

### REQ-2: キーワード・マーカー定義（第2章）

**仕様参照**: grammar-specification.md §2

**目的**: 全マーカー・キーワードを仕様通りに実装し、全角・半角の両対応を保証する

#### REQ-2.1 基本要素
- **参照**: §2.1

##### REQ-2.1.1 改行（NEWLINE）
- **受け入れ基準**: `\r\n`、`\n`、`\r` のいずれも改行として認識すること

##### REQ-2.1.2 空白（WHITE_SPACE 文字クラス）
- **受け入れ基準**:
  1. 半角スペース（U+0020）、タブ（U+0009）、全角スペース（U+3000）を空白として認識
  2. 改行文字は空白から除外されること
  3. 空白は Pest の自動スキップ対象ではなく、明示的に処理すること

##### REQ-2.1.3 コロン（Colon）
- **受け入れ基準**: `：`（全角）と `:`（半角）を同等に扱うこと

##### REQ-2.1.4 識別子（Identifier）
- **受け入れ基準**:
  1. XID_START + XID_CONTINUE* の Unicode 識別子規則に従うこと
  2. 予約パターン `__*__` はシステム予約として扱うこと
  3. 識別子は最長一致で切り出すこと

##### REQ-2.1.5 インデント（Indent）
- **受け入れ基準**:
  1. 行頭の連続空白をインデントとして認識すること
  2. インデント有無のバイナリ判定のみで、深さの判定は不要であること

#### REQ-2.2 ラベル・マーカー
- **参照**: §2.2

##### REQ-2.2.1 グローバルラベルマーカー
- **受け入れ基準**: `＊`（全角）と `*`（半角）を同等に扱うこと

##### REQ-2.2.2 ローカルラベルマーカー
- **受け入れ基準**: `・`（全角）と `-`（半角）を同等に扱うこと

##### REQ-2.2.3 属性マーカー
- **受け入れ基準**: `＆`（全角）と `&`（半角）を同等に扱うこと

#### REQ-2.3 変数・関数
- **参照**: §2.3

##### REQ-2.3.1 単語登録・参照・呼び出し（At Marker）
- **受け入れ基準**:
  1. `＠`（全角）と `@`（半角）を同等に扱うこと
  2. 単語登録: `＠word_name：value1　value2`
  3. 単語参照: `＠word_name`
  4. 動的参照: `＠＄var_name`（将来予約）
  5. 関数呼び出し: `＠func_name()` または `＠func_name（arg1：val1）`

##### REQ-2.3.2 変数宣言・代入（Dollar Marker）
- **受け入れ基準**: `＄`（全角）と `$`（半角）を同等に扱うこと

##### REQ-2.3.3 変数スコープ修飾子
- **受け入れ基準**:
  1. `＄＊var_name` はグローバル変数
  2. `＄var_name` はローカル変数

#### REQ-2.4 制御フロー
- **参照**: §2.4

##### REQ-2.4.1 Call マーカー
- **受け入れ基準**:
  1. `＞`（全角）と `>`（半角）を同等に扱うこと
  2. **Jump マーカー（`？`）は廃止**（破壊的変更）

#### REQ-2.5 音声・会話（Sakura スクリプト）
- **参照**: §2.5
- **受け入れ基準**:
  1. エスケープは厳密に半角バックスラッシュ `\` のみ
  2. 全角バックスラッシュ `＼` は不可

#### REQ-2.6 Rune コードブロック
- **参照**: §2.6
- **受け入れ基準**:
  1. 開始マーカー: ` ``` ` または ` ```rune `
  2. 終了マーカー: ` ``` `
  3. Rune ブロック内は関数定義（`fn ...`）のみ許可
  4. パーサーは内部を解釈せず透過、トランスパイラーで検証

#### REQ-2.7 演算子（将来予約）
- **参照**: §2.7
- **受け入れ基準**:
  1. 演算子は将来予約であり、現在は使用不可
  2. 全角・半角の両形式を定義しておくこと

#### REQ-2.8 リテラル・文字列
- **参照**: §2.8
- **受け入れ基準**:
  1. 日本語文字列: `「...」`
  2. 英語文字列: `"..."`（エスケープ対応）
  3. 数値リテラル: 整数・小数・負号対応

#### REQ-2.9 単語値の区切り文字
- **参照**: §2.9
- **受け入れ基準**: 単語定義の値リストは空白（全角・半角・タブ）で区切ること

#### REQ-2.10 コメント
- **参照**: §2.10
- **受け入れ基準**:
  1. `#`（半角）と `＃`（全角）を同等に扱うこと
  2. コメントはあらゆる位置に配置可能

---

### REQ-3: 行とブロック構造（第3章）

**仕様参照**: grammar-specification.md §3

**目的**: 行種別とブロック階層構造を正しく実装する

#### REQ-3.1 行の定義
- **参照**: §3（2.11.1）
- **受け入れ基準**: 各行は `[インデント] マーカー 内容 NEWLINE` の構造であること

#### REQ-3.2 行の種類
- **参照**: §3（2.11.2）

##### REQ-3.2.1 インデント不要の行
- **受け入れ基準**:
  1. グローバルラベル（`＊`）
  2. グローバル単語定義（`＠`）
  3. Rune ブロック（` ``` `）
  4. コメント（`#`）

##### REQ-3.2.2 インデント必要の行
- **受け入れ基準**:
  1. ローカルラベル（`・`）
  2. 属性定義（`＆`）
  3. アクション行（マーカーなし）
  4. Call（`＞`）
  5. 変数代入（`＄`）
  6. ローカル単語定義（`＠`）

#### REQ-3.3 ブロック構造
- **参照**: §3（2.11.3）

##### REQ-3.3.1 グローバルブロック構造
- **受け入れ基準**: グローバル単語行（0個以上）+ グローバルラベルブロック（1個以上）

##### REQ-3.3.2 グローバルラベルブロック構造
- **受け入れ基準**:
  1. グローバルラベル宣言（`＊name`）
  2. 属性行（0個以上）
  3. ローカル単語定義（0個以上）← **グローバルラベルスコープ**
  4. 暗黙ローカル開始ブロック（`__start__`）
  5. ローカルラベルブロック（0個以上）

##### REQ-3.3.3 ローカルブロック構造
- **受け入れ基準**:
  1. ローカルラベル宣言（`・name`）
  2. 属性行（0個以上）
  3. コンテンツ行（変数代入、アクション、Call）

##### REQ-3.3.4 Rune ブロックの配置
- **受け入れ基準**:
  1. Rune ブロックは暗黙 `__start__` 内に配置
  2. インデント不要だが構造上はグローバルラベル配下
  3. 関数定義（`fn`）のみ許可

#### REQ-3.4 インデント規則
- **参照**: §3（2.11.4）
- **受け入れ基準**:
  1. インデント有無のバイナリ判定のみ
  2. 深さの測定・比較は不要

---

### REQ-4: Call 詳細仕様（第4章）

**仕様参照**: grammar-specification.md §4

**目的**: Call の全ターゲット形式とオプション機能を正しく実装する

#### REQ-4.1 Call ターゲットの形式
- **参照**: §4.1

##### REQ-4.1.1 グローバルラベル参照
- **受け入れ基準**: `＞＊会話` 形式でグローバルラベルの `__start__` を呼び出すこと

##### REQ-4.1.2 ローカルラベル参照
- **受け入れ基準**: `＞選択肢1` 形式で現在のグローバルラベル内のローカルラベルを呼び出すこと

##### REQ-4.1.3 動的ターゲット
- **受け入れ基準**: `＞＄target_label` 形式で変数値をラベル名として解決すること

##### REQ-4.1.4 前方一致によるターゲット解決
- **参照**: §4.1.5
- **受け入れ基準**: ターゲット候補は前方一致で列挙されること

#### REQ-4.2 フィルター（属性フィルター）
- **参照**: §4.2
- **受け入れ基準**:
  1. 構文: `＞ラベル名＆key＝value`
  2. 現在は将来予約（無視）

#### REQ-4.3 引数リスト
- **参照**: §4.3
- **受け入れ基準**:
  1. 構文: `＠func（arg1：value1　arg2：value2）`
  2. 名前付き引数形式
  3. 区切りは空白

---

### REQ-5: リテラル型（第5章）

**仕様参照**: grammar-specification.md §5

**目的**: 型変換ルールを正しく実装する

#### REQ-5.1 概要
- **参照**: §5.1
- **受け入れ基準**: 変数、関数引数、属性値で使用可能な型を定義すること

#### REQ-5.2 型変換ルール
- **参照**: §5.2
- **受け入れ基準**:
  1. 優先順位: `true`/`false` → bool
  2. `「...」` → String
  3. 小数点あり → f64
  4. 数値（小数点なし）→ i64
  5. その他 → String

---

### REQ-6: アクション行（第6章）

**仕様参照**: grammar-specification.md §6

**目的**: アクション行の全機能（インライン要素、行継続、改行）を正しく実装する

#### REQ-6.1 基本構文
- **参照**: §6.1
- **受け入れ基準**: `actor ： action [NEWLINE continuation_line*]`

#### REQ-6.2 Actor（アクター）
- **参照**: §6.2
- **受け入れ基準**: コロン前のテキストをアクター名として認識すること

#### REQ-6.3 Action（インライン要素）
- **参照**: §6.3

##### REQ-6.3.1 インライン要素の実装
- **受け入れ基準**:
  1. 通常テキスト
  2. 単語参照（`＠word_name`）
  3. 動的単語参照（`＠＄var_name`）（将来予約）
  4. ＠エスケープ（`＠＠` → `＠`）
  5. 変数参照（`＄var_name`）
  6. 関数呼び出し（`＠func_name()`）
  7. Sakura スクリプト（`\n`, `\w8`, `\s[0]`）

##### REQ-6.3.2 インライン要素の区切り文字
- **受け入れ基準**:
  1. 空白はトークン区切りとして機能
  2. 空白なしの場合は最長一致で識別子を切り出す

#### REQ-6.4 行継続
- **参照**: §6.4
- **受け入れ基準**:
  1. インデント付き行は前行の続きとして連結
  2. 継続行は行マーカー（＄＠＞＆＊・）で始まってはならない

#### REQ-6.5 改行
- **参照**: §6.5

##### REQ-6.5.1 正規の改行（Sakura）
- **受け入れ基準**: `\n` は常に改行として解釈

##### REQ-6.5.2 糖衣構文（継続行内の空行）
- **受け入れ基準**: 継続行内の空行は改行として解釈

##### REQ-6.5.3 非継続領域の空行
- **受け入れ基準**: 継続行以外の空行は無視

---

### REQ-7: Sakura スクリプト仕様（第7章）

**仕様参照**: grammar-specification.md §7

**目的**: Sakura スクリプトを字句レベルで正しく透過処理する

#### REQ-7.1 概要
- **参照**: §7.1
- **受け入れ基準**: Sakura コマンドは字句のみ認識し、意味は解釈しないこと

#### REQ-7.2 エスケープ文字
- **参照**: §7.2
- **受け入れ基準**: 厳密に半角バックスラッシュ `\` のみ（**破壊的変更**: 全角不可）

#### REQ-7.3 コマンドの字句構造
- **参照**: §7.3
- **受け入れ基準**:
  1. `sakura_command ::= "\" ~ sakura_token ~ bracket_content?`
  2. `sakura_token ::= [!_a-zA-Z0-9]+`（ASCII のみ）
  3. `bracket_content ::= "[" ~ bracket_chars ~ "]"`
  4. `bracket_chars` は `\]` を許容（**破壊的変更**）

#### REQ-7.4 文字種
- **参照**: §7.4
- **受け入れ基準**:
  1. コマンドトークンは ASCII のみ
  2. 括弧は半角 `[]` のみ（**破壊的変更**: 全角不可）

---

### REQ-8: 属性（第8章）

**仕様参照**: grammar-specification.md §8

**目的**: 属性行の構文と配置ルールを正しく実装する

#### REQ-8.1 構文
- **参照**: §8.1
- **受け入れ基準**: `インデント ~ "＆" ~ key ~ "：" ~ value ~ NEWLINE`

#### REQ-8.2 配置ルール
- **参照**: §8.2
- **受け入れ基準**:
  1. 属性行はラベル定義の直後にのみ配置可能
  2. 複数配置可能

#### REQ-8.3 ファイルレベル属性（将来予約）
- **参照**: §8.3
- **受け入れ基準**:
  1. ファイル冒頭、グローバルラベル宣言より前に配置
  2. インデントなし
  3. 現在は将来予約

---

### REQ-9: 変数・スコープ（第9章）

**仕様参照**: grammar-specification.md §9

**目的**: 変数型とスコープを正しく実装する

#### REQ-9.1 変数型
- **参照**: §9.1

##### REQ-9.1.1 グローバル変数
- **受け入れ基準**:
  1. 宣言: `＄＊var_name ： value`
  2. スコープ: ファイル全体

##### REQ-9.1.2 ローカル変数
- **受け入れ基準**:
  1. 宣言: `＄var_name ： value`
  2. スコープ: 親ローカルラベル内

#### REQ-9.2 変数代入の制約
- **参照**: §9.2
- **受け入れ基準**:
  1. 許可される値: リテラル、単語参照、変数参照、関数呼び出し
  2. 許可されない: 式（`10 + 20`、`＄x > 5`）

---

### REQ-10: 単語定義（第10章）

**仕様参照**: grammar-specification.md §10

**目的**: 単語定義と参照を正しく実装する

#### REQ-10.1 グローバル単語定義
- **参照**: §10.1
- **受け入れ基準**:
  1. 構文: `＠word_name ： value1　value2`
  2. スコープ: ファイル全体

#### REQ-10.2 ローカル単語定義
- **参照**: §10.2
- **受け入れ基準**:
  1. 構文: `  ＠word_name ： value1　value2`（インデント付き）
  2. 配置: グローバルラベル配下、属性行の後、Rune ブロックの前
  3. スコープ: 当該グローバルラベル内の全ローカルラベルからアクセス可能

#### REQ-10.3 単語参照
- **参照**: §10.3
- **受け入れ基準**:
  1. 会話行内: `＠word_name`
  2. スコープ解決: ローカル単語 + グローバル単語から検索
  3. 動的単語参照（`＠＄var_name`）は将来予約

---

### REQ-11: 未確定事項・検討中の仕様（第11章）

**仕様参照**: grammar-specification.md §11

**目的**: 未確定事項の現状を把握し、将来予約として適切に扱う

#### REQ-11.1 未確定事項の認識
- **参照**: §11.2-11.20
- **受け入れ基準**:
  1. インライン単語参照の多段階解決（廃止）
  2. チェーントーク（DSL 非採用）
  3. ローカルラベルのパラメータ（将来検討）
  4. フィルター機能の詳細（初期版対応なし）
  5. 単語定義の値の型変換ルール（文字列のみ）
  6. 動的単語参照（文法予約のみ）
  7. Call の戻り値と変数代入（DSL 非定義）
  8. ローカル変数のスコープ詳細（トランスパイラ/ランタイム）
  9. 属性値の型解釈（5.2 のルールに従う）
  10. 前方一致時の複数候補選択ルール（DSL 非定義）
  11. 引数リストの値の型解釈（5.2 のルールに従う）
  12. 行継続のインデント深さ制約（不要）
  13. コメント行の配置可能位置（あらゆる位置）
  14. 識別子と予約語の制限（DSL 外）
  15. Sakura スクリプト括弧内のエスケープ（確定）
  16. ファイルエンコーディングと BOM（UTF-8 固定）
  17. ファイルレベル属性の継承詳細
  18. 空行の配置と解釈
  19. 全角・半角混在時の正規化

---

## 破壊的変更要件

### REQ-BC-1: Jump マーカー廃止

**影響範囲**:
- パーサー層: `jump_marker`、`jump_content` ルール削除
- AST: `Statement::Jump` 削除
- トランスパイラー: `pasta::jump()` 関数削除
- テストフィクスチャ: `？` → `＞` 置換

#### 受け入れ基準
1. pest 定義から Jump 関連ルールがすべて削除されていること
2. AST に `Statement::Jump` が存在しないこと
3. トランスパイラーで `pasta::jump()` が生成されないこと
4. テストフィクスチャに `？` が存在しないこと

### REQ-BC-2: Sakura スクリプト半角限定

**影響範囲**:
- パーサー層: `sakura_escape` 半角のみ
- パーサー層: `sakura_bracket_open/close` 半角のみ

#### 受け入れ基準
1. 全角バックスラッシュ `＼` がエスケープとして認識されないこと
2. 全角括弧 `［］` がコマンド括弧として認識されないこと

### REQ-BC-3: text_part バグ修正

**影響範囲**:
- パーサー層: `text_part` ルールに `dollar_marker` 除外追加

#### 受け入れ基準
1. `＄var_name` がインライン変数参照として正しく認識されること
2. `＄` が text_part に吸収されないこと

---

## 品質保証要件

### REQ-QA-1: Golden Test

**目的**: grammar-specification.md の全機能を包括する最小スクリプトで、全層（Parser・Transpiler・Runtime）の検証を行う

#### 受け入れ基準
1. Golden Test スクリプトが 19 の主要機能をカバーすること
2. Phase 1-3 の各段階で対応する層のテストが通過すること
3. Golden Test は Phase 1-3 全体を通じて修正しないこと

### REQ-QA-2: テスト層別化

**目的**: リグレッション発生箇所を層別に特定しやすくする

#### 受け入れ基準
1. テストファイルが `pasta_parser_*`、`pasta_transpiler_*`、`pasta_engine_*`、`pasta_integration_*` の命名規則に統一されること
2. 各層のテストが独立して実行可能であること

### REQ-QA-3: GRAMMAR.md 改訂

**目的**: 一般ユーザー向けドキュメントを新仕様に更新する

#### 受け入れ基準
1. Jump 記述がすべて削除されていること
2. Sakura スクリプトが半角限定であることが明記されていること
3. 各機能に 3 つ以上の実用的な例が含まれること

---

## スコープに関する特記事項

**破壊的変更への対応**:
- 本仕様の実装過程で、Pasta DSL の文法仕様に変更が加えられます
- 既存のテスト、テストフィクスチャ、トランスパイル結果が無効になる可能性があります
- テスト修正は本仕様のスコープに含まれ、修正後すべてのテストが成功する状態を目標とします

**リグレッション対応の複雑性**:
- テスト修正が大規模になる可能性があります（複数ファイル、多数のケース）
- 修正の優先順位付け、段階的対応は Phase 0-3 の設計に従います

**トレーサビリティ**:
- 各要件は grammar-specification.md の具体的なセクション番号を参照しています
- 設計・タスク分解・実装において、要件 ID（REQ-x.x.x）を参照することで漏れを防止します
