# 要件定義と設計の対応表

## 概要

本ドキュメントは、requirements.md の各要件項目と design.md の対応関係を示します。各要件に対して、設計での対応箇所または対応不要の理由を明記します。

---

## 凡例

| 記号 | 意味 |
|------|------|
| ✅ 設計対応 | design.md で明示的に対応している |
| 🟢 既存実装で対応済み | 既存の pest/AST 実装で正しく実装されており、破壊的変更なし。設計変更不要 |
| 🔵 Golden Test で検証 | Golden Test スクリプトで網羅的に検証される |
| ⏳ 将来予約 | 現在は実装不要、将来の拡張として予約 |

---

## 要件と設計の対応表

### REQ-1: 文法モデルの基本原則（第1章）

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-1.1 | 行指向文法の実装 | Golden Test | 🟢 既存実装で対応済み | 既存 pest 定義で正しく実装。破壊的変更なし |
| REQ-1.2 | ファイル構造の実装 | Golden Test | 🟢 既存実装で対応済み | 既存 pest 定義で正しく実装。破壊的変更なし |
| REQ-1.3 | 式の制約（設計方針）の実装 | Golden Test | 🟢 既存実装で対応済み | 既存 pest 定義で式を許可せず。破壊的変更なし |

**総評**: REQ-1 は既存実装で正しく動作しており、破壊的変更の対象外。Golden Test で検証される。

---

### REQ-2: キーワード・マーカー定義（第2章）

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-2.1.1 | 改行（NEWLINE） | Golden Test | 🟢 既存実装で対応済み | 既存 pest 定義で正しく実装 |
| REQ-2.1.2 | 空白（WHITE_SPACE） | Golden Test | 🟢 既存実装で対応済み | 既存 pest 定義で正しく実装 |
| REQ-2.1.3 | コロン（Colon） | Golden Test | 🟢 既存実装で対応済み | 全角・半角対応済み |
| REQ-2.1.4 | 識別子（Identifier） | Golden Test | 🟢 既存実装で対応済み | XID_START/CONTINUE 対応済み |
| REQ-2.1.5 | インデント（Indent） | Golden Test | 🟢 既存実装で対応済み | バイナリ判定対応済み |
| REQ-2.2.1 | グローバルラベルマーカー | Golden Test | 🟢 既存実装で対応済み | 全角・半角対応済み |
| REQ-2.2.2 | ローカルラベルマーカー | Golden Test | 🟢 既存実装で対応済み | 全角・半角対応済み |
| REQ-2.2.3 | 属性マーカー | Golden Test | 🟢 既存実装で対応済み | 全角・半角対応済み |
| REQ-2.3.1 | 単語登録・参照・呼び出し | Golden Test | 🟢 既存実装で対応済み | 全角・半角対応済み |
| REQ-2.3.2 | 変数宣言・代入 | Golden Test | 🟢 既存実装で対応済み | 全角・半角対応済み |
| REQ-2.3.3 | 変数スコープ修飾子 | Golden Test | 🟢 既存実装で対応済み | グローバル/ローカル対応済み |
| REQ-2.4.1 | Call マーカー | Phase 1: B1-B4 | ✅ 設計対応 | **Jump マーカー（`？`）廃止**（破壊的変更） |
| REQ-2.5 | Sakura エスケープ | Phase 1: A1 | ✅ 設計対応 | **半角バックスラッシュのみ**（破壊的変更） |
| REQ-2.6 | Rune コードブロック | Golden Test | 🟢 既存実装で対応済み | 既存 pest 定義で正しく実装 |
| REQ-2.7 | 演算子（将来予約） | — | ⏳ 将来予約 | 現在は使用不可、設計不要 |
| REQ-2.8 | リテラル・文字列 | Golden Test | 🟢 既存実装で対応済み | 日本語・英語文字列対応済み |
| REQ-2.9 | 単語値の区切り文字 | Golden Test | 🟢 既存実装で対応済み | 空白区切り対応済み |
| REQ-2.10 | コメント | Golden Test | 🟢 既存実装で対応済み | 全角・半角対応済み |

**総評**: REQ-2.4.1（Jump廃止）と REQ-2.5（Sakura半角限定）が破壊的変更として Phase 1 で対応。その他は既存実装で対応済み。

---

### REQ-3: 行とブロック構造（第3章）

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-3.1 | 行の定義 | Golden Test | 🟢 既存実装で対応済み | 行指向文法対応済み |
| REQ-3.2.1 | インデント不要の行 | Golden Test | 🟢 既存実装で対応済み | グローバルラベル等対応済み |
| REQ-3.2.2 | インデント必要の行 | Golden Test | 🟢 既存実装で対応済み | ローカルラベル等対応済み |
| REQ-3.3.1 | グローバルブロック構造 | Golden Test | 🟢 既存実装で対応済み | 正しく実装済み |
| REQ-3.3.2 | グローバルラベルブロック構造 | Golden Test | 🟢 既存実装で対応済み | 正しく実装済み |
| REQ-3.3.3 | ローカルブロック構造 | Golden Test | 🟢 既存実装で対応済み | 正しく実装済み |
| REQ-3.3.4 | Rune ブロックの配置 | Golden Test | 🟢 既存実装で対応済み | 正しく実装済み |
| REQ-3.4 | インデント規則 | Golden Test | 🟢 既存実装で対応済み | バイナリ判定対応済み |

**総評**: REQ-3 は既存実装で正しく動作しており、破壊的変更の対象外。

---

### REQ-4: Call 詳細仕様（第4章）

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-4.1.1 | グローバルラベル参照 | Golden Test | 🟢 既存実装で対応済み | `＞＊label` 対応済み |
| REQ-4.1.2 | ローカルラベル参照 | Golden Test | 🟢 既存実装で対応済み | `＞label` 対応済み |
| REQ-4.1.3 | 動的ターゲット | — | ⏳ 将来予約 | `＞＄var` は将来予約 |
| REQ-4.1.4 | 前方一致によるターゲット解決 | Golden Test | 🟢 既存実装で対応済み | トランスパイラ層で対応 |
| REQ-4.2 | フィルター（属性フィルター） | — | ⏳ 将来予約 | 構文のみ定義、実装は将来 |
| REQ-4.3 | 引数リスト | Golden Test | 🟢 既存実装で対応済み | 名前付き引数対応済み |

**総評**: REQ-4.1.1-4.1.2, 4.1.4, 4.3 は既存実装で対応済み。REQ-4.1.3, 4.2 は将来予約。

---

### REQ-5: リテラル型（第5章）

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-5.1 | 概要 | Golden Test | 🟢 既存実装で対応済み | 正しく実装済み |
| REQ-5.2 | 型変換ルール | Golden Test | 🟢 既存実装で対応済み | bool, String, f64, i64 対応済み |

**総評**: REQ-5 は既存実装で正しく動作しており、破壊的変更の対象外。

---

### REQ-6: アクション行（第6章）

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-6.1 | 基本構文 | Golden Test | 🟢 既存実装で対応済み | `actor：action` 対応済み |
| REQ-6.2 | Actor（アクター） | Golden Test | 🟢 既存実装で対応済み | 正しく実装済み |
| REQ-6.3.1 | インライン要素の実装 | Golden Test | 🟢 既存実装で対応済み | 単語参照、変数参照、関数呼び出し対応済み |
| REQ-6.3.2 | インライン要素の区切り文字 | Golden Test | 🟢 既存実装で対応済み | 空白区切り、最長一致対応済み |
| REQ-6.4 | 行継続 | Golden Test | 🟢 既存実装で対応済み | 複数行台詞対応済み |
| REQ-6.5.1 | 正規の改行（Sakura） | Golden Test | 🟢 既存実装で対応済み | `\n` 対応済み |
| REQ-6.5.2 | 糖衣構文（継続行内の空行） | Phase 1: D1 | ✅ 設計対応 | **継続行内空行の改行解釈**（AST/Transpiler で対応） |
| REQ-6.5.3 | 非継続領域の空行 | Golden Test | 🟢 既存実装で対応済み | 正しく無視される |
| REQ-BC-3 | text_part バグ修正 | Phase 1: C1 | ✅ 設計対応 | **`＄` が text_part に吸収されるバグ修正**（破壊的変更） |

**総評**: REQ-6.5.2（D1）と REQ-BC-3（C1）が設計で対応。その他は既存実装で対応済み。

---

### REQ-7: Sakura スクリプト仕様（第7章）

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-7.1 | 概要 | Golden Test | 🟢 既存実装で対応済み | 字句のみ認識、非解釈 |
| REQ-7.2 | エスケープ文字 | Phase 1: A1 | ✅ 設計対応 | **半角 `\` のみ**（破壊的変更） |
| REQ-7.3 | コマンドの字句構造 | Phase 1: A2, A3 | ✅ 設計対応 | **簡素化 + `\]` 許容**（破壊的変更） |
| REQ-7.4 | 文字種 | Phase 1: A4-A7 | ✅ 設計対応 | **半角括弧のみ、不要ルール削除**（破壊的変更） |

**総評**: REQ-7 は全体が破壊的変更として Phase 1（A1-A7）で対応。

---

### REQ-8: 属性（第8章）

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-8.1 | 構文 | Golden Test | 🟢 既存実装で対応済み | `＆key：value` 対応済み |
| REQ-8.2 | 配置ルール | Golden Test | 🟢 既存実装で対応済み | ラベル直後配置対応済み |
| REQ-8.3 | ファイルレベル属性（将来予約） | Golden Test | ⏳ 将来予約 | 構文のみ許容、実装は将来 |

**総評**: REQ-8.1-8.2 は既存実装で対応済み。REQ-8.3 は将来予約。

---

### REQ-9: 変数・スコープ（第9章）

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-9.1.1 | グローバル変数 | Golden Test | 🟢 既存実装で対応済み | `＄＊var` 対応済み |
| REQ-9.1.2 | ローカル変数 | Golden Test | 🟢 既存実装で対応済み | `＄var` 対応済み |
| REQ-9.2 | 変数代入の制約 | Golden Test | 🟢 既存実装で対応済み | 式不可、リテラル/関数呼び出しのみ対応済み |

**総評**: REQ-9 は既存実装で正しく動作しており、破壊的変更の対象外。

---

### REQ-10: 単語定義（第10章）

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-10.1 | グローバル単語定義 | Golden Test | 🟢 既存実装で対応済み | `＠word：values` 対応済み |
| REQ-10.2 | ローカル単語定義 | Golden Test | 🟢 既存実装で対応済み | グローバルラベルスコープ対応済み |
| REQ-10.3 | 単語参照 | Golden Test | 🟢 既存実装で対応済み | `＠word` 対応済み、動的参照は将来予約 |

**総評**: REQ-10 は既存実装で正しく動作しており、破壊的変更の対象外。

---

### REQ-11: 未確定事項・検討中の仕様（第11章）

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-11.1 | 未確定事項の認識 | — | ⏳ 将来予約 | 全19項目が将来予約として定義済み |

**総評**: REQ-11 は将来予約であり、現在の設計対象外。

---

### 破壊的変更要件

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-BC-1 | Jump マーカー廃止 | Phase 1: B1-B4<br>Phase 2: 2.1<br>Phase 3: 3.1, 3.4 | ✅ 設計対応 | Parser（B1-B4）、Transpiler（2.1）、Tests（3.1, 3.4）で全対応 |
| REQ-BC-2 | Sakura スクリプト半角限定 | Phase 1: A1-A7<br>Phase 3: 3.2, 3.3 | ✅ 設計対応 | Parser（A1-A7）、Tests（3.2）、GRAMMAR.md（3.3）で全対応 |
| REQ-BC-3 | text_part バグ修正 | Phase 1: C1 | ✅ 設計対応 | Parser（C1）で対応 |

**総評**: 破壊的変更要件は Phase 1-3 で完全に対応。

---

### 品質保証要件

| 要件ID | 要件名 | design.md 対応 | 対応状況 | 備考 |
|--------|--------|---------------|---------|------|
| REQ-QA-1 | Golden Test | Golden Test セクション | ✅ 設計対応 | 22機能カテゴリを包括的に検証 |
| REQ-QA-2 | テスト層別化 | Phase 0 | ✅ 設計対応 | 命名規則統一、約38ファイルリネーム |
| REQ-QA-3 | GRAMMAR.md 改訂 | Phase 3: 3.3 | ✅ 設計対応 | Jump削除、Sakura半角限定を反映 |

**総評**: 品質保証要件は Phase 0、Golden Test、Phase 3 で完全に対応。

---

## 全体サマリー

### 対応状況の集計

| カテゴリ | 要件数 | ✅ 設計対応 | 🟢 既存実装 | ⏳ 将来予約 | 合計 |
|---------|--------|------------|-----------|-----------|------|
| REQ-1（基本原則） | 3 | 0 | 3 | 0 | 3 |
| REQ-2（マーカー定義） | 16 | 2 | 13 | 1 | 16 |
| REQ-3（ブロック構造） | 8 | 0 | 8 | 0 | 8 |
| REQ-4（Call仕様） | 6 | 0 | 4 | 2 | 6 |
| REQ-5（リテラル型） | 2 | 0 | 2 | 0 | 2 |
| REQ-6（アクション行） | 9 | 2 | 7 | 0 | 9 |
| REQ-7（Sakura仕様） | 4 | 4 | 0 | 0 | 4 |
| REQ-8（属性） | 3 | 0 | 2 | 1 | 3 |
| REQ-9（変数・スコープ） | 3 | 0 | 3 | 0 | 3 |
| REQ-10（単語定義） | 3 | 0 | 3 | 0 | 3 |
| REQ-11（未確定事項） | 1 | 0 | 0 | 1 | 1 |
| REQ-BC（破壊的変更） | 3 | 3 | 0 | 0 | 3 |
| REQ-QA（品質保証） | 3 | 3 | 0 | 0 | 3 |
| **合計** | **64** | **14** | **45** | **5** | **64** |

### 設計対応の内訳

#### Phase 1（Parser 層）: 13項目

| 修正ID | 要件ID | 内容 |
|--------|--------|------|
| A1 | REQ-7.2, REQ-BC-2 | `sakura_escape` 半角のみ |
| A2 | REQ-7.3, REQ-BC-2 | `sakura_command` 簡素化 |
| A3 | REQ-7.3, REQ-BC-2 | `bracket_content` に `\]` 許容 |
| A4 | REQ-7.4, REQ-BC-2 | `sakura_bracket_open/close` 半角のみ |
| A5-A7 | REQ-7.4, REQ-BC-2 | 不要ルール削除 |
| B1-B4 | REQ-2.4.1, REQ-BC-1 | Jump マーカー・ルール削除 |
| C1 | REQ-BC-3 | `text_part` に `dollar_marker` 除外追加 |
| D1 | REQ-6.5.2 | 継続行内空行の対応 |

#### Phase 2（Transpiler 層）: 1項目

| 修正箇所 | 要件ID | 内容 |
|---------|--------|------|
| 2.1 | REQ-BC-1 | `Statement::Jump` 削除、`pasta::jump()` 削除 |

#### Phase 3（Runtime/Tests・ドキュメント）: 3項目

| 修正箇所 | 要件ID | 内容 |
|---------|--------|------|
| 3.1 | REQ-BC-1 | テストフィクスチャ `？` → `＞` 置換 |
| 3.2 | REQ-BC-2 | 全角 Sakura テストケース削除 |
| 3.3 | REQ-QA-3 | GRAMMAR.md 改訂 |

#### Phase 0（テスト層別化）: 1項目

| 修正箇所 | 要件ID | 内容 |
|---------|--------|------|
| 0.1-0.3 | REQ-QA-2 | テスト層別化、命名規則統一、グリーン確認 |

#### Phase 0.5（既存Parser実装の検証）: 全45項目の検証

| 対応箇所 | 要件ID | 内容 |
|---------|--------|------|
| 新規検証テスト | REQ-1 〜 REQ-10 | grammar-specification.md のみを根拠とした約100テストケース |
| `pasta_parser_spec_validation_test.rs` | 🟢 既存実装45項目 | 既存実装が仕様書通りに動作するかを検証 |

**重要**: Phase 0.5 は既存実装の検証フェーズです。既存テストコードを一切参照せず、grammar-specification.md の各章・各節のみを根拠として新規テストを作成します。これにより、「既存実装で対応済み」とした45項目が本当に正しく実装されているかを確認します。

#### Golden Test: 1項目

| 対応箇所 | 要件ID | 内容 |
|---------|--------|------|
| Golden Test | REQ-QA-1 | 22機能カテゴリの包括的検証スクリプト |

---

## 設計の網羅性評価

### ✅ 適切に対応されている項目（64項目中59項目、92.2%）

- **既存実装で対応済み**（45項目）: grammar-specification.md に基づき既に正しく実装されており、破壊的変更の対象外。Golden Test で検証される。
- **設計で明示的に対応**（14項目）: 破壊的変更として Phase 0-3 で段階的に実装される。

### ⏳ 将来予約として適切に扱われている項目（5項目、7.8%）

- REQ-2.7（演算子）
- REQ-4.1.3（動的ターゲット）
- REQ-4.2（フィルター）
- REQ-8.3（ファイルレベル属性）
- REQ-11（未確定事項19項目）

これらは grammar-specification.md で明示的に「将来予約」と定義されており、現在の設計対象外として適切。

### 🎯 設計漏れ: なし

全64要件項目について、適切な対応（既存実装・設計対応・将来予約）が確認されました。

---

## 結論

**requirements.md の全要件は design.md で適切に対応されています。**

- **既存実装で対応済み**: 45項目（70.3%）
- **設計で明示的に対応**: 14項目（21.9%）
- **将来予約として適切**: 5項目（7.8%）
- **設計漏れ**: 0項目（0%）

design.md は requirements.md の全要件を網羅しており、特に破壊的変更（Jump廃止、Sakura半角限定、text_partバグ修正）については Phase 1-3 で段階的かつ詳細に対応計画が策定されています。

### Phase 0.5 による検証強化

Phase 0.5（既存Parser実装の検証）では、「既存実装で対応済み」とした45項目について、以下の方針で検証を行います：

1. **既存テストコード非参照**: `tests/parser_*.rs` や `pasta.pest` を参照せず、grammar-specification.md のみを根拠とする
2. **網羅的テストケース**: REQ-1 〜 REQ-10 の全10章について、章ごとにモジュール化した約100テストケースを作成
3. **仕様書との整合性確認**: 既存実装が文法仕様書通りに動作するかを独立して検証

**期待される成果**:
- **全テスト通過**: 既存実装が仕様書通りであることが確認され、Phase 1 へ自信を持って進める
- **一部テスト失敗**: 既存実装と仕様書の乖離箇所が特定され、Phase 1 の修正項目に追加

この検証により、requirements-design-mapping.md で「🟢 既存実装で対応済み」とした判断の正当性が客観的に担保されます。
