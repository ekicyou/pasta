# Implementation Tasks: pasta-transpiler-pass2-output

## タスク概要

本実装は、Pasta DSLトランスパイラーのPass 2出力を修正し、設計仕様に準拠した2モジュール構成（`__pasta_trans2__` + `pasta`）を実現する。修正箇所は `transpile_pass2()` 1関数に限定され、コード重複を排除し、保守性と拡張性を向上させる。

---

## Implementation Tasks

### 1. __pasta_trans2__ モジュール生成機能の実装

- [ ] 1.1 (P) __pasta_trans2__ モジュールのコード生成ロジックを追加
  - `transpile_pass2()` 関数内に `__pasta_trans2__` モジュール生成コードを追加
  - モジュール宣言、`label_selector()` 関数定義、match式の骨格を出力
  - 既存の `writeln!` パターンを踏襲し、エラーハンドリングを統一
  - `LabelRegistry` から全ラベル情報を取得し、ID → 関数パスのマッピングを生成
  - デフォルトarmでエラークロージャ（`` _ => |_ctx, _args| { yield pasta_stdlib::Error(`ラベルID ${id} が見つかりませんでした。`); } ``）を出力
  - モジュール終了後に空行を挿入
  - _Requirements: 1, 2_

### 2. pasta モジュールの簡素化

- [ ] 2.1 (P) pasta モジュールをラッパー実装に変更
  - 既存の `jump()` 内 match ロジック（約20行）を削除
  - 既存の `call()` 内 match ロジック（約20行）を削除
  - 新規 `jump()` 実装: `label_selector()` 呼び出し + for ループの2-3行で構成
  - 新規 `call()` 実装: `jump()` と同じロジック（2-3行）
  - match ロジックやラベルマッピングを `pasta` モジュール内に含めない
  - _Requirements: 3_

### 3. テストフィクスチャの最終整理

- [ ] 3.1 comprehensive_control_flow.transpiled.rn を実際の出力に更新
  - 77-103行目の誤った `pub mod pasta` 実装（matchロジックを内包）を完全に削除
  - 説明用コメント（`// ❌ 間違った...`, `// ✅ 正しい...`）をすべて削除
  - トランスパイラーの実際の出力（タスク1.1, 2.1完了後）をフィクスチャに反映
  - 最終的なファイルがトランスパイラーが生成するコードと完全に一致することを確認
  - 正しい `pub mod __pasta_trans2__` と `pub mod pasta` 実装のみを含む
  - **注記**: タスク1.1, 2.1完了後、実際のトランスパイラー出力を取得してフィクスチャを更新
  - _Requirements: 4_

### 4. 単体テスト更新

- [ ] 4.1 (P) トランスパイラー出力の検証パターンを更新
  - `test_two_pass_transpiler_to_vec()`: `__pasta_trans2__` モジュール存在確認、`label_selector()` 関数確認、match式確認の3-4箇所を更新
  - `test_two_pass_transpiler_to_string()`: 同様の検証パターンを3-4箇所更新
  - `test_transpile_to_string_helper()`: 検証パターンを2-3箇所更新
  - `test_multiple_files_simulation()`: 検証パターンを2-3箇所更新
  - 既存の `assert!(output.contains("for a in crate::会話_1::__start__(ctx, args)"))` を新しいパターンに変更
  - _Requirements: 5_

### 5. 統合テスト実行と検証

- [ ] 5.1 全テストスイート実行と修正
  - `cargo test` で全単体テスト、統合テストを実行
  - テスト失敗がある場合、出力を目視確認し、検証パターンを調整
  - 4テストケースの連鎖的失敗に対応（段階的に修正）
  - 更新されたフィクスチャに基づいて、正しい出力が生成されることを確認
  - 全テストがパスすることを確認
  - _Requirements: 4, 5_

- [ ]* 5.2 Runeコンパイル検証テストの追加
  - 生成されたコードをRune VMでコンパイルし、構文エラーがないことを確認
  - 全関数が定義されていることを確認（関数呼び出しの解決が成功）
  - `pasta_stdlib::select_label_to_id()` はダミー実装のため、完全な実行検証は行わない
  - _Requirements: 5 (AC5は単体テスト・統合テストのパスを要求)_

---

## タスク実行ガイド

### 並列実行可能タスク
- タスク 1.1, 2.1, 4.1 は並列実行可能（独立したファイル・機能）
- タスク 3.1 は 1.1, 2.1 完了後に実施（実際の出力を反映）
- タスク 5.1 は全タスク完了後に実行（統合検証）
- タスク 5.2 はオプションのため、MVP完了後に実施可能

### 実行順序の推奨
1. タスク 1.1, 2.1, 4.1 を並行実施（トランスパイラー本体とテスト検証パターンの修正）
2. タスク 3.1 を実施（1.1, 2.1完了後、実際のトランスパイラー出力をフィクスチャに反映）
3. タスク 5.1 で統合検証（全体の動作確認）
4. タスク 5.2 は必要に応じて後で追加

### 重要な依存関係
- **タスク 3.1 は 1.1, 2.1 に依存**: トランスパイラーの修正完了後、実際の出力をフィクスチャに反映する必要がある

### 注意事項
- 修正箇所は `transpile_pass2()` 1関数に限定
- 生成コード長: 約70行（純増約20行、モジュール分割のオーバーヘッド含む）
- テストケースが連鎖的に失敗する可能性があるため、段階的に修正

---

## 完了条件

- ✅ `__pasta_trans2__` モジュールが生成される
- ✅ `label_selector()` 関数が関数ポインタを返すmatch式を含む
- ✅ `pasta::jump()`/`call()` が簡潔なラッパー実装（2-3行）
- ✅ テストフィクスチャから誤った実装が削除される
- ✅ 全単体テスト・統合テストがパスする
- ✅ 全5要件がカバーされる
