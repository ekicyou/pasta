# Implementation Plan: shiori-event-module

## Task Breakdown

### Phase 1: Core Module Implementation

- [x] 1. (P) ãƒãƒ³ãƒ‰ãƒ©ç™»éŒ²ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè£…
- [x] 1.1 (P) register.lua ã®åŸºæœ¬æ§‹é€ ã‚’ä½œæˆ
  - ç©ºã®REGãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
  - LuaDocã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ@module pasta.shiori.event.registerï¼‰ã‚’è¿½åŠ 
  - lua-coding.md ã®è¦ç´„ã«æº–æ‹ ï¼ˆUPPER_CASEã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ï¼‰
  - _Requirements: 1.1, 1.2, 1.5_

- [x] 1.2 (P) REGãƒ†ãƒ¼ãƒ–ãƒ«ã®å‹å®šç¾©ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
  - @type table<string, fun(req: table): string> ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
  - ä½¿ç”¨ä¾‹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã«è¨˜è¼‰ï¼ˆREG.EventName = function(req) ... end ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
  - _Requirements: 1.3, 1.4_

- [x] 2. ã‚¤ãƒ™ãƒ³ãƒˆæŒ¯ã‚Šåˆ†ã‘ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè£…
- [x] 2.1 init.lua ã®åŸºæœ¬æ§‹é€ ã¨requireæ–‡ã‚’ä½œæˆ
  - pasta.shiori.event.register ã‚’REGã¨ã—ã¦require
  - pasta.shiori.res ã‚’RESã¨ã—ã¦require
  - EVENTãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å®£è¨€
  - LuaDocã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ@module pasta.shiori.eventï¼‰ã‚’è¿½åŠ 
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 2.2 ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ³ãƒ‰ãƒ©ï¼ˆEVENT.no_entryï¼‰ã‚’å®Ÿè£…
  - RES.no_content() ã‚’è¿”ã™ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…
  - LuaDocã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ@param, @returnï¼‰ã‚’è¿½åŠ 
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 2.3 ã‚¤ãƒ™ãƒ³ãƒˆæŒ¯ã‚Šåˆ†ã‘é–¢æ•°ï¼ˆEVENT.fireï¼‰ã‚’å®Ÿè£…
  - REG[req.id] ã§ãƒãƒ³ãƒ‰ãƒ©ã‚’æ¤œç´¢ã€æœªç™»éŒ²æ™‚ã¯EVENT.no_entryã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  - req.id ãŒ nil ã®å ´åˆã‚‚ EVENT.no_entry ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆLuaæ¨™æº–æŒ™å‹•ï¼‰
  - LuaDocã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ@param req table, @return stringï¼‰ã‚’è¿½åŠ 
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [x] 2.4 xpcallã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…
  - ãƒãƒ³ãƒ‰ãƒ©å®Ÿè¡Œã‚’ xpcall ã§ãƒ©ãƒƒãƒ—ï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ã§æœ€åˆã®è¡Œã‚’æŠ½å‡ºï¼‰
  - æˆåŠŸæ™‚ã¯ãƒãƒ³ãƒ‰ãƒ©ã®çµæœã‚’ãã®ã¾ã¾è¿”å´
  - ã‚¨ãƒ©ãƒ¼æ™‚ã¯æœ€åˆã®è¡Œã‚’æŠ½å‡ºï¼ˆresult:match("^[^\n]+")ï¼‰
  - æŠ½å‡ºã—ãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆnil ã®å¯èƒ½æ€§ã‚ã‚Šï¼‰ã‚’ RES.err() ã«æ¸¡ã™ï¼ˆnil é˜²å¾¡ã¯ RES.err å´ã§å®Ÿæ–½ï¼‰
  - ğŸ“ Note: debug.traceback ã¯ mlua ã® StdLib::ALL_SAFE ã§åˆ©ç”¨ä¸å¯ã®ãŸã‚ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ã«å¤‰æ›´
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [x] 2.5 ãƒãƒ³ãƒ‰ãƒ©ã‚·ã‚°ãƒãƒãƒ£ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–
  - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã«æœŸå¾…ã•ã‚Œã‚‹ãƒãƒ³ãƒ‰ãƒ©ã‚·ã‚°ãƒãƒãƒ£ã‚’è¨˜è¼‰ï¼ˆfunction(req) -> stringï¼‰
  - reqãƒ†ãƒ¼ãƒ–ãƒ«ã®æ§‹é€ ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ï¼ˆid, method, version, charset, sender, reference, dicï¼‰
  - reqãƒ†ãƒ¼ãƒ–ãƒ«ãŒãƒãƒ³ãƒ‰ãƒ©å†…ã§å¤‰æ›´ã•ã‚Œãªã„ã“ã¨ã‚’æ˜è¨˜ï¼ˆread-onlyå¥‘ç´„ï¼‰
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4_

- [x] 2.6 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¬é–‹APIã®æœ€çµ‚ç¢ºèª
  - EVENT.fire ã¨ EVENT.no_entry ã®ã¿ãŒå…¬é–‹é–¢æ•°ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
  - å†…éƒ¨å®Ÿè£…è©³ç´°ãŒå…¬é–‹ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [x] 2.7 ä½¿ç”¨ä¾‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
  - ãƒãƒ³ãƒ‰ãƒ©ç™»éŒ²ã®ä¾‹ã‚’è¿½åŠ ï¼ˆREG.OnBoot, REG.OnClose ãªã©ï¼‰
  - EVENT.fire(req) ã®å‘¼ã³å‡ºã—ä¾‹ã‚’è¿½åŠ 
  - ãƒ†ã‚¹ãƒˆç”¨ req ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€å°æ§‹é€ ä¾‹ã‚’è¿½åŠ 
  - Rustå´çµ±åˆãŒåˆ¥é€”è¡Œã‚ã‚Œã‚‹ã“ã¨ã‚’æ˜è¨˜
  - _Requirements: 9.1, 9.2, 9.3, 9.4_

### Phase 2: Testing

- [x] 3. Unit ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…
- [x] 3.1 (P) REGãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ
  - shiori_event_test.rs ã« create_runtime_with_pasta_path() ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’è¿½åŠ 
  - REGãŒç©ºãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼ï¼ˆtest_reg_module_exports_empty_tableï¼‰
  - _Requirements: 1.1_

- [x] 3.2 (P) EVENT.fire ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ†ã‚¹ãƒˆã‚’ä½œæˆ
  - ç™»éŒ²æ¸ˆã¿ãƒãƒ³ãƒ‰ãƒ©ãŒæ­£ã—ãå‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ï¼ˆtest_event_fire_dispatches_registered_handlerï¼‰
  - ãƒãƒ³ãƒ‰ãƒ©ã®æˆ»ã‚Šå€¤ãŒãã®ã¾ã¾è¿”ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
  - _Requirements: 4.2, 4.3_

- [x] 3.3 (P) æœªç™»éŒ²ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ
  - æœªç™»éŒ²ã‚¤ãƒ™ãƒ³ãƒˆã§204ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼ï¼ˆtest_event_fire_returns_no_content_for_unregisteredï¼‰
  - req.id=nil ã®å ´åˆã‚‚204ã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼ï¼ˆtest_event_fire_handles_nil_idï¼‰
  - _Requirements: 4.4, 4.5_

- [x] 3.4 (P) ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ
  - ãƒãƒ³ãƒ‰ãƒ©å†…ã‚¨ãƒ©ãƒ¼ã§500ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ã‚’æ¤œè¨¼ï¼ˆtest_event_fire_catches_handler_errorï¼‰
  - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ”¹è¡ŒãŒå«ã¾ã‚Œãªã„ã“ã¨ã‚’æ¤œè¨¼ï¼ˆtest_error_message_no_newlineï¼‰
  - ç©ºã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ™‚ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’æ¤œè¨¼ï¼ˆtest_event_fire_handles_empty_error_messageï¼‰
  - ğŸ“ Note: mlua ã¯ error("") ã«ã‚‚ãƒ•ã‚¡ã‚¤ãƒ«ä½ç½®æƒ…å ±ã‚’è‡ªå‹•ä»˜åŠ ã™ã‚‹ãŸã‚ã€çœŸã«ç©ºã«ã¯ãªã‚‰ãªã„
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 4. Integration ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…
- [x] 4.1 RESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’ä½œæˆ
  - EVENT.fire ãŒ RES.ok, RES.no_content, RES.err ã‚’æ­£ã—ãä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¤œè¨¼ï¼ˆtest_event_module_with_res_moduleï¼‰
  - _Requirements: 3.2, 5.4_

- [x] 4.2 ãƒãƒ³ãƒ‰ãƒ©ç™»éŒ²ã‹ã‚‰å‘¼ã³å‡ºã—ã¾ã§ã®å®Œå…¨ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆã‚’ä½œæˆ
  - è¤‡æ•°ãƒãƒ³ãƒ‰ãƒ©ç™»éŒ² â†’ EVENT.fire å‘¼ã³å‡ºã— â†’ æ­£ã—ã„ãƒãƒ³ãƒ‰ãƒ©ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼ï¼ˆtest_handler_registration_and_dispatchï¼‰
  - _Requirements: 1.3, 4.1, 4.2, 4.3_

### Phase 3: Integration & Validation

- [x] 5. Rustå´çµ±åˆã®æº–å‚™ç¢ºèª
  - main.lua ã§ã® EVENT.fire(req) çµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ–‡æ›¸åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª âœ… (init.lua ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨˜è¼‰)
  - parse_request() ãŒç”Ÿæˆã™ã‚‹ req ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ãŒæ–‡æ›¸ã¨ä¸€è‡´ã™ã‚‹ã“ã¨ã‚’ç¢ºèª âœ… (init.lua ã« req æ§‹é€ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)
  - SHIORI.request â†’ EVENT.fire ã®ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒãƒ•ãƒ­ãƒ¼ãŒè¨­è¨ˆé€šã‚Šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª âœ… (è¨­è¨ˆé€šã‚Šã®å®Ÿè£…)
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 9.3_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 - 1.5 | 1.1, 1.2, 3.1 |
| 2.1 - 2.5 | 2.1 |
| 3.1 - 3.3 | 2.2, 4.1 |
| 4.1 - 4.6 | 2.3, 3.2, 3.3, 4.2 |
| 5.1 - 5.6 | 2.4, 3.4, 4.1 |
| 6.1 - 6.4 | 2.5 |
| 7.1 - 7.4 | 2.5, 5 |
| 8.1 - 8.4 | 2.6 |
| 9.1 - 9.4 | 2.7, 5 |

**Total Coverage**: 9 requirements â†’ 18 sub-tasks
