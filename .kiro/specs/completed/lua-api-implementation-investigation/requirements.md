# Requirements Document

## Project Description (Input)
ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆsample.generated.luaï¼‰ã‹ã‚‰å‘¼ã°ã‚Œã¦ã„ã‚‹å„é–¢æ•°ã«ã¤ã„ã¦ã€Luaå´ã®å®Ÿè£…çŠ¶æ³ã‚’å¾¹åº•çš„ã«èª¿æŸ»ã—ã€ãƒ¬ãƒãƒ¼ãƒˆã™ã‚‹ã€‚actã«ã¤ã„ã¦ã¯ACTOR_IMPLã‚’èª¿æŸ»å¯¾è±¡ã¨ã™ã‚‹ã€‚

---

# èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ: Lua API å®Ÿè£…çŠ¶æ³ï¼ˆæ›´æ–°ç‰ˆï¼‰

## 1. èª¿æŸ»å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

- **å¯¾è±¡**: [sample.generated.lua](../../../crates/pasta_lua/tests/fixtures/sample.generated.lua)
- **èª¿æŸ»æ—¥**: 2026-01-28ï¼ˆæ›´æ–°ï¼‰
- **èª¿æŸ»ç¯„å›²**: ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ç”Ÿæˆã‚³ãƒ¼ãƒ‰ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹PASTA/ACT API

---

## 2. APIå‘¼ã³å‡ºã—ä¸€è¦§ã¨å®Ÿè£…çŠ¶æ³

### 2.1 PASTAãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«APIï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰

| API                        | å‘¼ã³å‡ºã—ä¾‹                     | å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«                                                             | å®Ÿè£…çŠ¶æ…‹   |
| -------------------------- | ------------------------------ | ------------------------------------------------------------------------ | ---------- |
| `PASTA.create_actor(name)` | `PASTA.create_actor("ã•ãã‚‰")` | [actor.lua#L70](../../../crates/pasta_lua/scripts/pasta/actor.lua#L70)   | âœ… å®Œå…¨å®Ÿè£… |
| `PASTA.create_scene(name)` | `PASTA.create_scene("ãƒ¡ã‚¤ãƒ³")` | [scene.lua#L128](../../../crates/pasta_lua/scripts/pasta/scene.lua#L128) | âœ… å®Œå…¨å®Ÿè£… |
| `PASTA.create_word(key)`   | `PASTA.create_word("æŒ¨æ‹¶")`    | [word.lua#L122](../../../crates/pasta_lua/scripts/pasta/word.lua#L122)   | âœ… å®Œå…¨å®Ÿè£… |

### 2.2 ACTOR_IMPLï¼ˆã‚¢ã‚¯ã‚¿ãƒ¼å®Ÿè£…ï¼‰

| API                      | å‘¼ã³å‡ºã—ä¾‹                           | å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«                                                           | å®Ÿè£…çŠ¶æ…‹   |
| ------------------------ | ------------------------------------ | ---------------------------------------------------------------------- | ---------- |
| `ACTOR:create_word(key)` | `ACTOR:create_word("é€šå¸¸")`          | [actor.lua#L58](../../../crates/pasta_lua/scripts/pasta/actor.lua#L58) | âœ… å®Œå…¨å®Ÿè£… |
| `WordBuilder:entry(...)` | `:entry([=[\s[0]]=], [=[\s[100]]=])` | [actor.lua#L38](../../../crates/pasta_lua/scripts/pasta/actor.lua#L38) | âœ… å®Œå…¨å®Ÿè£… |

### 2.3 SCENE_TABLE_IMPLï¼ˆã‚·ãƒ¼ãƒ³å®Ÿè£…ï¼‰

| API                      | å‘¼ã³å‡ºã—ä¾‹                  | å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«                                                           | å®Ÿè£…çŠ¶æ…‹   |
| ------------------------ | --------------------------- | ---------------------------------------------------------------------- | ---------- |
| `SCENE:create_word(key)` | `SCENE:create_word("å ´æ‰€")` | [scene.lua#L23](../../../crates/pasta_lua/scripts/pasta/scene.lua#L23) | âœ… å®Œå…¨å®Ÿè£… |
| `SCENE.__global_name__`  | ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å‚ç…§              | [scene.lua#L73](../../../crates/pasta_lua/scripts/pasta/scene.lua#L73) | âœ… å®Œå…¨å®Ÿè£… |
| `SCENE.é–¢æ•°(act, ...)`   | ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°å‘¼ã³å‡ºã—    | -                                                                      | âœ… æ­£å¸¸å‹•ä½œ |

### 2.4 ACT_IMPLï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…ï¼‰âœ… å…¨ã¦å®Œå…¨å®Ÿè£…

| API                                 | å‘¼ã³å‡ºã—ä¾‹ï¼ˆç”Ÿæˆã‚³ãƒ¼ãƒ‰ï¼‰                                             | å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«                                                         | å®Ÿè£…çŠ¶æ…‹       |
| ----------------------------------- | -------------------------------------------------------------------- | -------------------------------------------------------------------- | -------------- |
| `act:init_scene(SCENE)`             | `act:init_scene(SCENE)`                                              | [act.lua#L58](../../../crates/pasta_lua/scripts/pasta/act.lua#L58)   | âœ… å®Œå…¨å®Ÿè£…     |
| `act:clear_spot()`                  | `act:clear_spot()`                                                   | [act.lua#L215](../../../crates/pasta_lua/scripts/pasta/act.lua#L215) | âœ… å®Œå…¨å®Ÿè£…     |
| `act:set_spot(name, num)`           | `act:set_spot("ã•ãã‚‰", 0)`                                          | [act.lua#L205](../../../crates/pasta_lua/scripts/pasta/act.lua#L205) | âœ… å®Œå…¨å®Ÿè£…     |
| `act:call(global, key, attrs, ...)` | `act:call(SCENE.__global_name__, "ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èªå‘¼ã³å‡ºã—", {}, ...)` | [act.lua#L160](../../../crates/pasta_lua/scripts/pasta/act.lua#L160) | âœ… **å®Œå…¨å®Ÿè£…** |
| `act:word(name)`                    | `act:word("å ´æ‰€")`                                                   | [act.lua#L93](../../../crates/pasta_lua/scripts/pasta/act.lua#L93)   | âœ… **å®Œå…¨å®Ÿè£…** |

### 2.5 PROXY_IMPLï¼ˆã‚¢ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ã‚­ã‚·å®Ÿè£…ï¼‰

| API                | å‘¼ã³å‡ºã—ä¾‹                | å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«                                                             | å®Ÿè£…çŠ¶æ…‹                            |
| ------------------ | ------------------------- | ------------------------------------------------------------------------ | ----------------------------------- |
| `act.{actor}`      | `act.ã•ãã‚‰`              | [act.lua#L22](../../../crates/pasta_lua/scripts/pasta/act.lua#L22)       | âœ… å®Œå…¨å®Ÿè£…                          |
| `proxy:talk(text)` | `act.ã•ãã‚‰:talk("...")`  | [actor.lua#L105](../../../crates/pasta_lua/scripts/pasta/actor.lua#L105) | âœ… å®Œå…¨å®Ÿè£…                          |
| `proxy:word(name)` | `act.ã•ãã‚‰:word("é€šå¸¸")` | [actor.lua#L163](../../../crates/pasta_lua/scripts/pasta/actor.lua#L163) | âœ… å®Œå…¨å®Ÿè£…ï¼ˆ6ãƒ¬ãƒ™ãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ |

---

## 3. å‰å›ã‹ã‚‰ã®æ”¹å–„ç‚¹

### 3.1 âœ… `act:call` ã‚·ã‚°ãƒãƒãƒ£ä¿®æ­£å®Œäº†

**å‰å›ã®å•é¡Œ**: ç”Ÿæˆã‚³ãƒ¼ãƒ‰ã¨å®Ÿè£…ã®ã‚·ã‚°ãƒãƒãƒ£ä¸ä¸€è‡´

**ä¿®æ­£å¾Œï¼ˆact.lua#L160-L196ï¼‰:**
```lua
function ACT_IMPL.call(self, global_scene_name, key, attrs, ...)
    local handler = nil
    -- Level 1: ã‚·ãƒ¼ãƒ³ãƒ­ãƒ¼ã‚«ãƒ«æ¤œç´¢
    -- Level 2: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚·ãƒ¼ãƒ³åã‚¹ã‚³ãƒ¼ãƒ—æ¤œç´¢
    -- Level 3: ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    -- Level 4: ã‚¹ã‚³ãƒ¼ãƒ—ãªã—å…¨ä½“æ¤œç´¢ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    if handler then
        return handler(self, ...)
    end
    return nil
end
```

**MEMO.mdä»•æ§˜ã¨ã®æ•´åˆæ€§**: âœ… å®Œå…¨æº–æ‹ 
- å…¥åŠ›å¼•æ•°: `self, global_scene_name, key, attrs, ...` âœ…
- 4æ®µéšæ¤œç´¢é †åº: âœ…
  1. `self.current_scene[key]` âœ…
  2. `SCENE.search(key, global_scene_name, attrs)` âœ…
  3. `GLOBAL[key]` âœ…
  4. `SCENE.search(key, nil, attrs)` âœ…
- handleræœªç™ºè¦‹æ™‚: ä½•ã‚‚ã—ãªã„ï¼ˆãƒ­ã‚°ã¯å°†æ¥å®Ÿè£…ï¼‰ âœ…

### 3.2 âœ… `act:word` å®Œå…¨å®Ÿè£…

**å‰å›ã®å•é¡Œ**: 2ãƒ¬ãƒ™ãƒ«æ¤œç´¢ã®ã¿ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«è¾æ›¸æœªå¯¾å¿œ

**ä¿®æ­£å¾Œï¼ˆact.lua#L93-L131ï¼‰:**
- 4ãƒ¬ãƒ™ãƒ«æ¤œç´¢å®Ÿè£…:
  1. ã‚·ãƒ¼ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«å®Œå…¨ä¸€è‡´
  2. GLOBALå®Œå…¨ä¸€è‡´
  3. ã‚·ãƒ¼ãƒ³ãƒ­ãƒ¼ã‚«ãƒ«è¾æ›¸å‰æ–¹ä¸€è‡´ï¼ˆ@pasta_searchä½¿ç”¨ï¼‰
  4. ã‚°ãƒ­ãƒ¼ãƒãƒ«è¾æ›¸å‰æ–¹ä¸€è‡´ï¼ˆ@pasta_searchä½¿ç”¨ï¼‰
- `WORD.resolve_value()` å…±é€šé–¢æ•°åˆ©ç”¨

### 3.3 âœ… `ctx`å¤‰æ•°å•é¡Œè§£æ¶ˆ

**å‰å›ã®å•é¡Œ**: `SCENE.é–¢æ•°(ctx, 2 + 1)` ã§ `ctx` ãŒã‚¹ã‚³ãƒ¼ãƒ—å¤–

**ä¿®æ­£å¾Œ**: `SCENE.é–¢æ•°(act, 2 + 1)` ã«ä¿®æ­£æ¸ˆã¿

### 3.4 âœ… `WORD.resolve_value` å…±é€šåŒ–

**è¿½åŠ ï¼ˆword.lua#L140-L156ï¼‰:**
```lua
function WORD.resolve_value(value, act)
    -- é–¢æ•°ãªã‚‰å®Ÿè¡Œã€é…åˆ—ãªã‚‰æœ€åˆã®è¦ç´ ã€ãã®ä»–ã¯ãã®ã¾ã¾
end
```

---

## 4. å®Ÿè£…å“è³ªã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª         | å®Œå…¨å®Ÿè£… | éƒ¨åˆ†å®Ÿè£… | æœªå®Ÿè£… | åˆè¨ˆ   |
| ---------------- | -------- | -------- | ------ | ------ |
| PASTA API        | 3        | 0        | 0      | 3      |
| ACTOR_IMPL       | 2        | 0        | 0      | 2      |
| SCENE_TABLE_IMPL | 3        | 0        | 0      | 3      |
| ACT_IMPL         | 5        | 0        | 0      | 5      |
| PROXY_IMPL       | 3        | 0        | 0      | 3      |
| **åˆè¨ˆ**         | **16**   | **0**    | **0**  | **16** |

**å®Ÿè£…ç‡**: 100%ï¼ˆ16/16 å®Œå…¨å®Ÿè£…ï¼‰ğŸ‰

---

## 5. æ®‹å­˜èª²é¡Œï¼ˆå°†æ¥å¯¾å¿œï¼‰

| é …ç›®                              | å„ªå…ˆåº¦ | å‚™è€ƒ                         |
| --------------------------------- | ------ | ---------------------------- |
| `act:call` ãƒãƒ³ãƒ‰ãƒ©ãƒ¼æœªç™ºè¦‹æ™‚ãƒ­ã‚° | ä½     | TODOã‚³ãƒ¡ãƒ³ãƒˆæ¸ˆã¿             |
| `attrs` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ´»ç”¨            | ä½     | å°†æ¥ã® `SCENE.search` æ‹¡å¼µç”¨ |

---

## 6. çµè«–

**å…¨ã¦ã®APIãŒå®Œå…¨å®Ÿè£…æ¸ˆã¿**ã§ã™ã€‚

`sample.generated.lua`ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹å…¨ã¦ã®é–¢æ•°ã«ã¤ã„ã¦ã€Luaå´ã®å®Ÿè£…ãŒå®Œäº†ã—ã¦ãŠã‚Šã€ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©å‡ºåŠ›ã¨ã®æ•´åˆæ€§ã‚‚å–ã‚Œã¦ã„ã¾ã™ã‚ã€‚

### æ¤œè¨¼æ¸ˆã¿æ©Ÿèƒ½
- âœ… ã‚¢ã‚¯ã‚¿ãƒ¼ä½œæˆãƒ»å˜èªç™»éŒ²
- âœ… ã‚·ãƒ¼ãƒ³ä½œæˆãƒ»ãƒ­ãƒ¼ã‚«ãƒ«å˜èªç™»éŒ²
- âœ… ã‚°ãƒ­ãƒ¼ãƒãƒ«å˜èªç™»éŒ²
- âœ… ã‚·ãƒ¼ãƒ³é–¢æ•°å®šç¾©ï¼ˆ`__start__`, `__xxx_N__`, ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©é–¢æ•°ï¼‰
- âœ… `act:init_scene` / `act:clear_spot` / `act:set_spot`
- âœ… `act:call` 4æ®µéšæ¤œç´¢
- âœ… `act:word` 4ãƒ¬ãƒ™ãƒ«æ¤œç´¢
- âœ… `act.{actor}:talk` / `act.{actor}:word` 6ãƒ¬ãƒ™ãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

---

## 7. é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ«                                                         | å½¹å‰²                           |
| ---------------------------------------------------------------- | ------------------------------ |
| [init.lua](../../../crates/pasta_lua/scripts/pasta/init.lua)     | å…¬é–‹APIã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ      |
| [act.lua](../../../crates/pasta_lua/scripts/pasta/act.lua)       | ACT_IMPLå®Ÿè£…                   |
| [actor.lua](../../../crates/pasta_lua/scripts/pasta/actor.lua)   | ACTOR_IMPL, PROXY_IMPLå®Ÿè£…     |
| [scene.lua](../../../crates/pasta_lua/scripts/pasta/scene.lua)   | SCENE_TABLE_IMPLå®Ÿè£…           |
| [word.lua](../../../crates/pasta_lua/scripts/pasta/word.lua)     | WordBuilder, resolve_valueå®Ÿè£… |
| [ctx.lua](../../../crates/pasta_lua/scripts/pasta/ctx.lua)       | CTXç’°å¢ƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ            |
| [store.lua](../../../crates/pasta_lua/scripts/pasta/store.lua)   | ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢                   |
| [global.lua](../../../crates/pasta_lua/scripts/pasta/global.lua) | ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ãƒ†ãƒ¼ãƒ–ãƒ«         |
| [save.lua](../../../crates/pasta_lua/scripts/pasta/save.lua)     | æ°¸ç¶šåŒ–ãƒ‡ãƒ¼ã‚¿                   |
