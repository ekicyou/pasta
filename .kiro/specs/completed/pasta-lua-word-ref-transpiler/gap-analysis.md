# å®Ÿè£…ã‚®ãƒ£ãƒƒãƒ—åˆ†æ: pasta-lua-word-ref-transpiler

**ä½œæˆæ—¥**: 2026-01-01  
**å¯¾è±¡ä»•æ§˜**: pasta-lua-word-ref-transpiler  
**åˆ†æè€…**: GitHub Copilot

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

- **ã‚¹ã‚³ãƒ¼ãƒ—**: pasta_lua ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ãƒ¼ã«ãŠã‘ã‚‹ `SetValue::WordRef`ï¼ˆ`ï¼„å¤‰æ•°ï¼ï¼ å˜èª`æ§‹æ–‡ï¼‰ã®Luaã‚³ãƒ¼ãƒ‰ç”Ÿæˆæ©Ÿèƒ½è¿½åŠ 
- **ç¾çŠ¶**: pasta_coreå´ã§ASTå®šç¾©æ¸ˆã¿ã€pasta_runeå´ã§å®Ÿè£…æ¸ˆã¿ã€pasta_luaå´ã¯æœªå®Ÿè£…ï¼ˆã‚¨ãƒ©ãƒ¼è¿”å´ã®ã¿ï¼‰
- **ä¸»è¦èª²é¡Œ**:
  1. pasta_lua ã® `generate_var_set()` ã« WordRef åˆ†å²ã‚’å®Ÿè£…ï¼ˆç¾åœ¨ã¯ unsupported ã‚¨ãƒ©ãƒ¼ï¼‰
  2. ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ `sample.lua` ã®æœŸå¾…å€¤æ›´æ–°ï¼ˆ`var.å ´æ‰€ = act:word("å ´æ‰€")` å½¢å¼ã‚’å«ã‚ã‚‹ï¼‰
  3. æ—¢å­˜ãƒ†ã‚¹ãƒˆã¨ã®æ•´åˆæ€§ç¶­æŒï¼ˆãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³é˜²æ­¢ï¼‰
- **æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: **Option A: æ—¢å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ‹¡å¼µ**ï¼ˆæ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã£ãŸæœ€å°å¤‰æ›´ï¼‰
- **è¦‹ç©ã‚‚ã‚Š**: **S (1-3æ—¥)** - æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã«æ²¿ã£ãŸå˜ç´”ãªåˆ†å²è¿½åŠ 
- **ãƒªã‚¹ã‚¯**: **Low** - pasta_runeå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå‚ç…§å¯èƒ½ã€æ˜ç¢ºãªä»•æ§˜ã€æ—¢å­˜ãƒ†ã‚¹ãƒˆåŸºç›¤å®Œå‚™

---

## 1. ç¾çŠ¶åˆ†æ

### 1.1 æ—¢å­˜å®Ÿè£…ã®ç¢ºèª

#### pasta_coreï¼ˆãƒ‘ãƒ¼ã‚µãƒ¼å±¤ï¼‰

**ASTå®šç¾©**: `crates/pasta_core/src/parser/ast.rs:671-677`

```rust
pub enum SetValue {
    Expr(Expr),
    WordRef { name: String },
}
```

âœ… **å®Œäº†**: ãƒ‘ãƒ¼ã‚µãƒ¼ã¯æ—¢ã« `ï¼„å¤‰æ•°ï¼ï¼ å˜èª` ã‚’ `SetValue::WordRef` ã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹å¯èƒ½

#### pasta_luaï¼ˆLua ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰

**å®Ÿè£…çŠ¶æ…‹**: `crates/pasta_lua/src/code_generator.rs:300-307`

```rust
SetValue::WordRef { name } => {
    return Err(TranspileError::unsupported(
        &var_set.span,
        &format!("WordRef '@{}' in VarSet is not yet implemented", name),
    ));
}
```

âŒ **æœªå®Ÿè£…**: ç¾åœ¨ã¯ unsupported ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ï¼ˆæœ¬ä»•æ§˜ã§å®Ÿè£…å¯¾è±¡ï¼‰

### 1.2 æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ‘ã‚¿ãƒ¼ãƒ³

#### å¤‰æ•°ä»£å…¥ï¼ˆSetValue::Exprï¼‰

ç¾åœ¨ã®å®Ÿè£…ï¼ˆ`code_generator.rs:295-299`ï¼‰:

```rust
SetValue::Expr(expr) => {
    self.write_indent()?;
    self.write_raw(&format!("{} = ", var_path))?;
    self.generate_expr(expr)?;
    writeln!(self.writer)?;
}
```

**ç”Ÿæˆä¾‹**:
```lua
var.ã‚«ã‚¦ãƒ³ã‚¿ = 10
save.ã‚°ãƒ­ãƒ¼ãƒãƒ« = SCENE:é–¢æ•°(ctx, 2 + 1)
```

#### WordRefå‚ç…§ï¼ˆAction::WordRefï¼‰

ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡Œã§ã®å˜èªå‚ç…§ã¯æ—¢ã«å®Ÿè£…æ¸ˆã¿:

```rust
// crates/pasta_lua/src/code_generator.rs (æ¨å®šå®Ÿè£…ç®‡æ‰€)
Action::WordRef { name } => {
    // act.actor:word("å˜èªå") å½¢å¼ã‚’ç”Ÿæˆ
}
```

**ç”Ÿæˆä¾‹**:
```lua
act.ã•ãã‚‰:word("å ´æ‰€")
```

### 1.3 ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®ç¾çŠ¶

#### sample.pasta (L52)

```pasta
ï¼„å ´æ‰€ï¼ï¼ å ´æ‰€
```

#### sample.lua æœŸå¾…å€¤ (L180)

```lua
--ã€€ã€€ã€€ï¼„å ´æ‰€ï¼ï¼ å ´æ‰€
var.å ´æ‰€ = act:word("å ´æ‰€")
```

âœ… **æœŸå¾…å€¤å®šç¾©æ¸ˆã¿**: ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã«ã¯æ—¢ã«æ­£è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¨˜è¿°ã•ã‚Œã¦ã„ã‚‹

#### çµ±åˆãƒ†ã‚¹ãƒˆ

`crates/pasta_lua/tests/transpiler_integration_test.rs:505-536`

- `test_transpile_sample_pasta_line_comparison()`: è¡Œå˜ä½ã®ä¸€è‡´ç‡ãƒ†ã‚¹ãƒˆ
- `test_transpile_reference_code_patterns()`: ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ†ã‚¹ãƒˆ

ç¾çŠ¶ã€WordRefå®Ÿè£…ãŒãªã„ãŸã‚ãƒ†ã‚¹ãƒˆã¯å¤±æ•—ã™ã‚‹è¦‹è¾¼ã¿ã€‚

---

## 2. è¦ä»¶ãƒãƒƒãƒ”ãƒ³ã‚°

### è¦ä»¶å……è¶³çŠ¶æ³

| è¦ä»¶ | æ—¢å­˜è³‡ç”£ | ã‚®ãƒ£ãƒƒãƒ— |
|------|---------|---------|
| **Req 1**: WordRefä»£å…¥ã®Luaã‚³ãƒ¼ãƒ‰ç”Ÿæˆ | âŒ æœªå®Ÿè£… | **Missing**: `generate_var_set()` ã« WordRef åˆ†å²è¿½åŠ  |
| **Req 2**: æ—¢å­˜Exprå‡¦ç†ã¨ã®äº’æ›æ€§ | âœ… å®Ÿè£…æ¸ˆã¿ | ãªã—ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ç¶­æŒï¼‰ |
| **Req 3**: ãƒ†ã‚¹ãƒˆæœŸå¾…å€¤æ›´æ–° | âš ï¸ æœŸå¾…å€¤ã¯å®šç¾©æ¸ˆã¿ | **Constraint**: ãƒ†ã‚¹ãƒˆã¯ç¾çŠ¶å¤±æ•—ã€å®Ÿè£…å¾Œã«åˆæ ¼äºˆå®š |
| **Req 4**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° | âœ… å®Ÿè£…æ¸ˆã¿ | ãªã—ï¼ˆVarScope::Args ãƒã‚§ãƒƒã‚¯ã¯æ—¢å­˜ï¼‰ |

### æŠ€è¡“è¦ä»¶ã®è©³ç´°

#### Requirement 1-1: Localå¤‰æ•°ã¸ã®WordRefä»£å…¥

**å¿…è¦ãªå®Ÿè£…**:
```rust
SetValue::WordRef { name } => {
    self.write_indent()?;
    self.write_raw(&format!("{} = act:word(\"{}\")", var_path, name))?;
    writeln!(self.writer)?;
}
```

**æœŸå¾…ã•ã‚Œã‚‹ç”Ÿæˆã‚³ãƒ¼ãƒ‰**:
```lua
var.å ´æ‰€ = act:word("å ´æ‰€")
```

#### Requirement 1-2: Globalå¤‰æ•°ã¸ã®WordRefä»£å…¥

**æ—¢å­˜ã® `var_path` åˆ†å²ã‚’æ´»ç”¨**:
```rust
let var_path = match var_set.scope {
    VarScope::Local => format!("var.{}", var_set.name),
    VarScope::Global => format!("save.{}", var_set.name),
    // ...
};
```

**æœŸå¾…ã•ã‚Œã‚‹ç”Ÿæˆã‚³ãƒ¼ãƒ‰**:
```lua
save.ã‚°ãƒ­ãƒ¼ãƒãƒ« = act:word("å˜èª")
```

#### Requirement 4: Argså¤‰æ•°ã¸ã®WordRefä»£å…¥ã‚¨ãƒ©ãƒ¼

**æ—¢å­˜å®Ÿè£…ã§å¯¾å¿œæ¸ˆã¿**:
```rust
VarScope::Args(_) => {
    return Err(TranspileError::invalid_ast(
        &var_set.span,
        "Cannot assign to scene argument",
    ));
}
```

âœ… **å¯¾å¿œä¸è¦**: æ—¢å­˜ã®ã‚¬ãƒ¼ãƒ‰ã§ Expr/WordRef ä¸¡æ–¹ã‚’ã‚«ãƒãƒ¼

---

## 3. å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®è©•ä¾¡

### Option A: æ—¢å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ‹¡å¼µï¼ˆæ¨å¥¨ âœ…ï¼‰

#### æ‹¡å¼µå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«

**`crates/pasta_lua/src/code_generator.rs`**

- `generate_var_set()` ãƒ¡ã‚½ãƒƒãƒ‰ã® `SetValue::WordRef` åˆ†å²ã‚’å®Ÿè£…

#### å¤‰æ›´å†…å®¹

**Before** (L300-307):
```rust
SetValue::WordRef { name } => {
    return Err(TranspileError::unsupported(
        &var_set.span,
        &format!("WordRef '@{}' in VarSet is not yet implemented", name),
    ));
}
```

**After**:
```rust
SetValue::WordRef { name } => {
    self.write_indent()?;
    self.write_raw(&format!("{} = act:word(\"{}\")", var_path, name))?;
    writeln!(self.writer)?;
}
```

#### å½±éŸ¿ç¯„å›²

- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«**: 1ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆcode_generator.rsï¼‰
- **å¤‰æ›´è¡Œæ•°**: ç´„5è¡Œï¼ˆã‚¨ãƒ©ãƒ¼è¿”å´ â†’ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«ç½®ãæ›ãˆï¼‰
- **æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿**: ãªã—ï¼ˆæ–°è¦åˆ†å²ã®è¿½åŠ ã®ã¿ï¼‰

#### Trade-offs

âœ… **Pros**:
- æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆSetValue::Exprï¼‰ã¨å®Œå…¨ã«ä¸¦è¡Œ
- æœ€å°å¤‰æ›´ï¼ˆå˜ä¸€ãƒ¡ã‚½ãƒƒãƒ‰å†…ã®åˆ†å²è¿½åŠ ï¼‰
- pasta_core ã®è¨­è¨ˆæ€æƒ³ã¨æ•´åˆ
- ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ `sample.lua` ã®æœŸå¾…å€¤ã¨ä¸€è‡´

âŒ **Cons**:
- ãªã—ï¼ˆæ˜ç¢ºãªä»•æ§˜ã€æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³è¸è¥²ï¼‰

#### äº’æ›æ€§æ¤œè¨¼

**æ—¢å­˜ãƒ†ã‚¹ãƒˆã¸ã®å½±éŸ¿**:
- `test_transpile_sample_pasta_line_comparison()`: ç¾åœ¨å¤±æ•— â†’ å®Ÿè£…å¾Œã«åˆæ ¼äºˆå®š
- ãã®ä»–ã®çµ±åˆãƒ†ã‚¹ãƒˆ: å½±éŸ¿ãªã—ï¼ˆWordRef ã‚’å«ã¾ãªã„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼‰

**å¾Œæ–¹äº’æ›æ€§**:
- å®Œå…¨äº’æ›ï¼ˆæ–°æ©Ÿèƒ½è¿½åŠ ã€æ—¢å­˜æŒ™å‹•å¤‰æ›´ãªã—ï¼‰

---

### Option B: æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ

**éæ¨å¥¨** âŒ

- **ç†ç”±**: WordRefä»£å…¥ã¯æ—¢å­˜ `generate_var_set()` ã®è²¬å‹™ç¯„å›²å†…
- **éå‰°è¨­è¨ˆ**: å˜ç´”ãªåˆ†å²è¿½åŠ ã§ååˆ†ãªæ©Ÿèƒ½ã«æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸è¦

---

### Option C: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

**éæ¨å¥¨** âŒ

- **ç†ç”±**: æœ¬æ©Ÿèƒ½ã¯å˜ç´”ã‹ã¤æ˜ç¢ºã€æ®µéšçš„å®Ÿè£…ã¯ä¸è¦
- **è¤‡é›‘åŒ–ãƒªã‚¹ã‚¯**: ä¸å®Œå…¨ãªä¸­é–“çŠ¶æ…‹ã‚’æŒã¤ãƒ¡ãƒªãƒƒãƒˆãªã—

---

## 4. æŠ€è¡“çš„èª¿æŸ»é …ç›®

### 4.1 Luaãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã® `act:word()` å®Ÿè£…

**å®Ÿè£…çŠ¶æ³**: âŒ **æœªå®Ÿè£…ï¼ˆåˆ¥ä»•æ§˜ã§å¯¾å¿œï¼‰**

- **ç¾çŠ¶**: `sample.lua` ã« `act:word("å ´æ‰€")` ã®ä½¿ç”¨ä¾‹ã‚ã‚Š
- **ã‚¹ã‚³ãƒ¼ãƒ—æ±ºå®š**:
  - âœ… æœ¬ä»•æ§˜: ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ï¼ˆLuaã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼‰ã®ã¿å®Ÿè£…
  - âŒ æœ¬ä»•æ§˜: Luaãƒ©ãƒ³ã‚¿ã‚¤ãƒ  `act:word()` ã¯å¯¾è±¡å¤–
  - ğŸ“‹ åˆ¥ä»•æ§˜: ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å®Ÿè£…ã¯ä»Šå¾Œã®ä»•æ§˜ã§å¯¾å¿œäºˆå®š

**æœ¬ä»•æ§˜ã¸ã®å½±éŸ¿**:
- ãƒ†ã‚¹ãƒˆã¯ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«çµæœã®æ–‡å­—åˆ—æ¯”è¼ƒã®ã¿å®Ÿæ–½
- Luaãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®å®Ÿè¡Œã¯æ¤œè¨¼å¯¾è±¡å¤–
- ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆã¯ `act:word()` ã®å®Ÿè£…çŠ¶æ³ã«ä¾å­˜ã›ãšåˆæ ¼å¯èƒ½

### 4.2 ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†

**èª¿æŸ»çµæœ**: âœ… **ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ä¸è¦**

- **æ–‡æ³•å®šç¾©**: `word_ref = { word_marker ~ id ~ s}` - XIDæº–æ‹ è­˜åˆ¥å­ã®ã¿
  - `id` ã¯ `XID_START + XID_CONTINUE*`ï¼ˆUnicode Extended Identifierï¼‰
  - Rust/JavaScriptè­˜åˆ¥å­ã¨åŒç­‰ã®åˆ¶ç´„
  - ç‰¹æ®Šæ–‡å­—ï¼ˆ`"`ã€`\`ç­‰ï¼‰ã¯æ–‡æ³•ãƒ¬ãƒ™ãƒ«ã§é™¤å¤–æ¸ˆã¿

- **æ—¢å­˜å®Ÿè£…ã®ä¸€è²«æ€§**:
  ```rust
  // code_generator.rs:402 - Action::WordRef ã®æ—¢å­˜å®Ÿè£…
  self.writeln(&format!("act.{}:word(\"{}\")", actor, word_name))?;
  ```
  ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãªã—ã§ç›´æ¥å‡ºåŠ›ï¼ˆæ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨åŒä¸€ï¼‰

**å®Ÿè£…æ–¹é‡**:
- ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ãªã—ã§ç›´æ¥ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã«åŒ…ã‚€
- æ—¢å­˜ã® `Action::WordRef` ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²

### 4.3 å®Ÿè£…ã®ä¸€è²«æ€§

**èª¿æŸ»å¿…è¦æ€§**: None

- **ç¾çŠ¶**: pasta_lua ãŒå”¯ä¸€ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆpasta_rune ã¯å»ƒæ­¢äºˆå®šï¼‰
- **è¨­è¨ˆæ€æƒ³**: pasta_core ã® AST å®šç¾©ã«æº–æ‹ 

**æ¨å¥¨å¯¾å¿œ**:
- pasta_lua ã®å®Ÿè£…ã«é›†ä¸­

---

## 5. å®Ÿè£…è¤‡é›‘åº¦ã¨ãƒªã‚¹ã‚¯è©•ä¾¡

### 5.1 å®Ÿè£…è¦æ¨¡

**Effort: S (1-3æ—¥)**

| ã‚¿ã‚¹ã‚¯ | è¦‹ç©ã‚‚ã‚Š |
|--------|---------|
| ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ  | 0.5æ—¥ |
| ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£æ¤œè¨¼ | 0.5æ—¥ |
| çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»ä¿®æ­£ | 1æ—¥ |
| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–° | 0.5æ—¥ |
| **åˆè¨ˆ** | **2-3æ—¥** |

**æ ¹æ‹ **:
- æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆSetValue::Exprï¼‰ã®5è¡Œè¤‡è£½ã§å®Œäº†
- ãƒ†ã‚¹ãƒˆæœŸå¾…å€¤ã¯æ—¢ã« `sample.lua` ã«è¨˜è¿°æ¸ˆã¿
- ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ç¯„å›²ãŒé™å®šçš„ï¼ˆVarSeté–¢é€£ã®ã¿ï¼‰

### 5.2 ãƒªã‚¹ã‚¯è©•ä¾¡

**Risk: Low**

| ãƒªã‚¹ã‚¯é …ç›® | è©•ä¾¡ | è»½æ¸›ç­– |
|-----------|------|-------|
| **æŠ€è¡“çš„è¤‡é›‘æ€§** | Low | pasta_rune ã®åŒç­‰å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‚ç…§å¯èƒ½ |
| **çµ±åˆãƒªã‚¹ã‚¯** | Low | æ—¢å­˜ã® `generate_var_set()` å†…ã®åˆ†å²è¿½åŠ ã®ã¿ |
| **ãƒ†ã‚¹ãƒˆå“è³ª** | Low | `sample.lua` ã®æœŸå¾…å€¤ãŒæ—¢ã«å®šç¾©æ¸ˆã¿ |
| **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** | None | ã‚³ãƒ¼ãƒ‰ç”Ÿæˆæ™‚ã®æ–‡å­—åˆ—å‡¦ç†ã®ã¿ã€å®Ÿè¡Œæ™‚å½±éŸ¿ãªã— |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | None | Lua VMã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ä¾å­˜ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆã®ã¿ |
| **Luaãƒ©ãƒ³ã‚¿ã‚¤ãƒ æœªå®Ÿè£…** | None | åˆ¥ä»•æ§˜å¯¾å¿œã€æœ¬ä»•æ§˜ã¯ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«ã®ã¿ |

**ç·åˆãƒªã‚¹ã‚¯**: Low  
**æ ¹æ‹ **: æ˜ç¢ºãªä»•æ§˜ã€æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³è¸è¥²ã€ãƒ†ã‚¹ãƒˆåŸºç›¤å®Œå‚™ã€pasta_lua ã«é›†ä¸­å¯èƒ½

---

## 6. è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºã¸ã®æ¨å¥¨äº‹é …

### 6.1 æ¨å¥¨å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

**Option A: æ—¢å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ‹¡å¼µ** âœ…

**ç†ç”±**:
1. æœ€å°å¤‰æ›´ã§è¦ä»¶ã‚’æº€ãŸã™
2. æ—¢å­˜ã® SetValue::Expr ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å®Œå…¨ã«ä¸¦è¡Œ
3. pasta_core ã® AST è¨­è¨ˆæ€æƒ³ã«æ²¿ã£ãŸè‡ªç„¶ãªæ‹¡å¼µ
4. ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®æœŸå¾…å€¤ã¨ä¸€è‡´

### 6.2 ä¸»è¦è¨­è¨ˆåˆ¤æ–­

| åˆ¤æ–­é …ç›® | æ¨å¥¨ | ä»£æ›¿æ¡ˆ |
|---------|------|-------|
| **ã‚³ãƒ¼ãƒ‰ç”Ÿæˆå½¢å¼** | `var.X = act:word("Y")` | ãªã—ï¼ˆsample.lua ã®æœŸå¾…å€¤ã«æº–æ‹ ï¼‰ |
| **ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†** | `name` ã‚’ãã®ã¾ã¾ä½¿ç”¨ | `name.escape_default()` é©ç”¨ |
| **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°** | æ—¢å­˜ã® VarScope::Args ãƒã‚§ãƒƒã‚¯æ´»ç”¨ | ãªã—ï¼ˆè¿½åŠ å®Ÿè£…ä¸è¦ï¼‰ |

### 6.3 è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºã®èª¿æŸ»äº‹é …

**Priority: Medium**
2. **ãƒ†ã‚¹ãƒˆæœŸå¾…å€¤ã®ç¶²ç¾…æ€§ç¢ºèª**
   - Localå¤‰æ•° WordRef: âœ… ç¢ºèªæ¸ˆã¿ï¼ˆ`var.å ´æ‰€ = act:word("å ´æ‰€")`ï¼‰
   - Globalå¤‰æ•° WordRef: â“ æœªç¢ºèªï¼ˆsample.pasta ã«è¿½åŠ ãŒå¿…è¦ã‹æ¤œè¨ï¼‰
   - ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹: âœ… ä¸è¦ï¼ˆæ—¢å­˜ã®Argsä»£å…¥ã‚¨ãƒ©ãƒ¼ã§å¯¾å¿œï¼‰
   - ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†: âœ… ä¸è¦ï¼ˆXIDè­˜åˆ¥å­ã®ãŸã‚æ–‡æ³•ãƒ¬ãƒ™ãƒ«ã§å®‰å…¨ï¼‰

**Priority: Low**
4. **Luaãƒ©ãƒ³ã‚¿ã‚¤ãƒ  `act:word()` å®Ÿè£…**
   - æœ¬ä»•æ§˜ã®å¯¾è±¡å¤–ï¼ˆåˆ¥ä»•æ§˜ã§å®Ÿè£…äºˆå®šï¼‰
   - ãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ«æ©Ÿèƒ½å®Ÿè£…å¾Œã«ç€æ‰‹æ¨å¥¨

**Note**: pasta_rune ã¯å»ƒæ­¢äºˆå®šã®ãŸã‚ã€æ¨ªå±•é–‹è¨ˆç”»ã¯ä¸è¦

---

## 7. æƒ³å®šã•ã‚Œã‚‹å®Ÿè£…ã‚¿ã‚¹ã‚¯ï¼ˆæ¦‚è¦ï¼‰

è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºã§è©³ç´°åŒ–äºˆå®š:

1. **ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…**
   - `code_generator.rs` ã® `generate_var_set()` ã‚’æ‹¡å¼µ
   - SetValue::WordRef åˆ†å²ã‚’è¿½åŠ 

2. **ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£æ¤œè¨¼**
   - `sample.lua` ã®æœŸå¾…å€¤ãŒæ­£ã—ã„ã“ã¨ã‚’ç¢ºèª
   - Globalå¤‰æ•° WordRef ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ ãŒå¿…è¦ã‹æ¤œè¨

3. **çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**
   - `test_transpile_sample_pasta_line_comparison()` ãŒåˆæ ¼ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
   - `test_transpile_reference_code_patterns()` ã®ã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Šã‚’ç¢ºèª

4. **ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ**
   - `cargo test -p pasta_lua` ã§å…¨ãƒ†ã‚¹ãƒˆåˆæ ¼ã‚’ç¢ºèª
   - æ—¢å­˜ã® Expr ä»£å…¥ãƒ†ã‚¹ãƒˆã«å½±éŸ¿ãŒãªã„ã“ã¨ã‚’ç¢ºèª

5. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°**
   - è©²å½“ç®‡æ‰€ã®ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°
   - å¿…è¦ã«å¿œã˜ã¦ä»•æ§˜æ›¸ï¼ˆSPECIFICATION.mdï¼‰ã¸ã®è¨˜è¼‰

---

## 8. çµè«–

### å®Ÿè£…ã®å®Ÿç¾å¯èƒ½æ€§

âœ… **é«˜ã„å®Ÿç¾å¯èƒ½æ€§**

- pasta_core ã®ASTå®šç¾©å®Œäº†
- pasta_rune ã®åŒç­‰å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³å‚ç…§å¯èƒ½
- ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®æœŸå¾…å€¤å®šç¾©æ¸ˆã¿
- æ—¢å­˜ã® VarSet å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²å¯èƒ½

### æ¨å¥¨ã•ã‚Œã‚‹æ¬¡ã‚¹ãƒ†ãƒƒãƒ—

1. **è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹**: `/kiro-spec-design pasta-lua-word-ref-transpiler`
   - Luaãƒ©ãƒ³ã‚¿ã‚¤ãƒ  `act:word()` å®Ÿè£…ç¢ºèª
   - ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´°è¨­è¨ˆ
   - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ç¶²ç¾…æ€§ç¢ºèª

2. **å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºæº–å‚™**:
   - ã‚¿ã‚¹ã‚¯åˆ†è§£ï¼ˆTask 1: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€Task 2: ãƒ†ã‚¹ãƒˆã€Task 3: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰
   - è¦‹ç©ã‚‚ã‚Š: S (2-3æ—¥)

3. **ãƒªã‚¹ã‚¯ç®¡ç†**:
   - Luaãƒ©ãƒ³ã‚¿ã‚¤ãƒ æœªå®Ÿè£…ã®å ´åˆã€ã‚¹ã‚³ãƒ¼ãƒ—èª¿æ•´ã¾ãŸã¯ãƒ©ãƒ³ã‚¿ã‚¤ãƒ å®Ÿè£…ã‚’è¿½åŠ 

---

## ä»˜éŒ²: å‚ç…§ã‚³ãƒ¼ãƒ‰

### A. pasta_core ASTå®šç¾©

`crates/pasta_core/src/parser/ast.rs:671-677`

`crates/pasta_lua/src/code_generator.rs:281-309`

```rust
fn generate_var_set(&mut self, var_set: &VarSet) -> Result<(), TranspileError> {
    let var_path = match var_set.scope {
        VarScope::Local => format!("var.{}", var_set.name),
        VarScope::Global => format!("save.{}", var_set.name),
        VarScope::Args(_) => {
            return Err(TranspileError::invalid_ast(
                &var_set.span,
                "Cannot assign to scene argument",
            ));
        }
    };

    match &var_set.value {
        SetValue::Expr(expr) => {
            self.write_indent()?;
            self.write_raw(&format!("{} = ", var_path))?;
            self.generate_expr(expr)?;
            writeln!(self.writer)?;
        }
        SetValue::WordRef { name } => {
            // âŒ æœªå®Ÿè£…ï¼ˆæœ¬ä»•æ§˜ã§å¯¾å¿œï¼‰
            return Err(TranspileError::unsupported(
                &var_set.span,
                &format!("WordRef '@{}' in VarSet is not yet implemented", name),
            ));
        }
    }

    Ok(())
}
```

### B. pasta_lua ç¾åœ¨ã®å®Ÿè£…

```rust
SetValue::WordRef { name } => {
    self.write_indent()?;
    self.write_raw(&format!("{} = act:word(\"{}\")", var_path, name))?;
    writeln!(self.writer)?;
}
```

### C. æœŸå¾…ã•ã‚Œã‚‹å®Ÿè£…ï¼ˆè¨­è¨ˆæ¡ˆï¼‰

`crates/pasta_lua/tests/fixtures/sample.lua:180`

```lua
--ã€€ã€€ã€€ï¼„å ´æ‰€ï¼ï¼ å ´æ‰€
var.å ´æ‰€ = act:word("å ´æ‰€")
```

### D. ãƒ†ã‚¹ãƒˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£æœŸå¾…å€¤
