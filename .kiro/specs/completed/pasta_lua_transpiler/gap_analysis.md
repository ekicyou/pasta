# å®Ÿè£…ã‚®ãƒ£ãƒƒãƒ—åˆ†æ

## æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€`pasta_lua_transpiler` ä»•æ§˜ã®å®Ÿè£…ã‚®ãƒ£ãƒƒãƒ—ã‚’åˆ†æã—ãŸã‚‚ã®ã§ã™ã€‚ç¾çŠ¶ã® `code_generator.rs` ã¨è¨­è¨ˆè¦æ±‚ã¨ã®ä¹–é›¢ã‚’ç‰¹å®šã—ã€å®Ÿè£…æˆ¦ç•¥ã‚’æç¤ºã—ã¾ã™ã€‚

**åˆ†æå¯¾è±¡:** `crates/pasta_lua/src/code_generator.rs` ã®Luaå‡ºåŠ›ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

**åˆ†æçµæœ:** 6ã¤ã®ç‰¹å®šã®Luaå‡ºåŠ›å¤‰æ›´ãŒå¿…è¦ï¼ˆè¡Œãƒ¬ãƒ™ãƒ«ã®ä¿®æ­£ï¼‰

---

## è¦ä»¶ã‹ã‚‰å®Ÿè£…ã¸ã®å¯¾å¿œ

### å¤‰æ›´æ¦‚è¦: 6ã¤ã®Luaå‡ºåŠ›ãƒ‘ã‚¿ãƒ¼ãƒ³ä¿®æ­£

| # | è¦ä»¶ | ç¾çŠ¶å‡ºåŠ› | è¨­è¨ˆå‡ºåŠ› | å¯¾è±¡è¡Œ | é›£åº¦ |
|---|------|---------|---------|-------|------|
| 1 | Req 1 | `function SCENE.__start__(ctx, ...)` | `function SCENE.__start__(act, ...)` | L253 | S |
| 2 | Req 2 | `PASTA.create_session(SCENE, ctx)` | `act:init_scene(SCENE)` | L278 | S |
| 3 | Req 3 | `PASTA.clear_spot(ctx)` | `act:clear_spot()` | L268 | S |
| 4 | Req 3 | `PASTA.set_spot(ctx, "name", idx)` | `act:set_spot("name", idx)` | L270 | S |
| 5 | Req 4 | `act.actor:word()` | `act.actor:talk(act.actor:word())` | L510 | S |
| 6 | Req 6 | `act.actor:talk(sakura_text)` | `act:sakura_script(text)` | L509 | M |

---

## è©³ç´°åˆ†æ

### å¤‰æ›´1: ã‚·ãƒ¼ãƒ³é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ã® `ctx` â†’ `act` å¤‰æ›´

**ä½ç½®:** [code_generator.rs L253](crates/pasta_lua/src/code_generator.rs#L253)

**ç¾çŠ¶:**
```lua
function SCENE.__start__(ctx, ...)
```

**è¨­è¨ˆ:**
```lua
function SCENE.__start__(act, ...)
```

**å®Ÿè£…:** æ–‡å­—åˆ—å†…ã® `ctx` ã‚’ `act` ã«ç½®æ›

**æ ¹æ‹ :** Requirement 1 - Act-firstã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¸ã®ç§»è¡Œ

---

### å¤‰æ›´2: ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ– `PASTA.create_session()` â†’ `act:init_scene()`

**ä½ç½®:** [code_generator.rs L278](crates/pasta_lua/src/code_generator.rs#L278)

**ç¾çŠ¶:**
```lua
local act, save, var = PASTA.create_session(SCENE, ctx)
```

**è¨­è¨ˆ:**
```lua
local save, var = act:init_scene(SCENE)
```

**å®Ÿè£…:**
- å‘¼ã³å‡ºã—å½¢å¼ã‚’ `PASTA.create_session(SCENE, ctx)` â†’ `act:init_scene(SCENE)` ã«å¤‰æ›´
- æˆ»ã‚Šå€¤æŸç¸›ã‚’ `act, save, var = ...` â†’ `save, var = ...` ã«å¤‰æ›´ï¼ˆ`act` ã¯æ—¢ã«ç¬¬1å¼•æ•°ï¼‰

**æ ¹æ‹ :** Requirement 2 - Act-firstãƒ‘ã‚¿ãƒ¼ãƒ³ã¸ã®çµ±ä¸€

**è¤‡é›‘åº¦:** Mï¼ˆæˆ»ã‚Šå€¤æ§‹é€ ã®å¤‰æ›´ï¼‰

---

### å¤‰æ›´3: ã‚¹ãƒãƒƒãƒˆç®¡ç† `PASTA.clear_spot()` â†’ `act:clear_spot()`

**ä½ç½®:** [code_generator.rs L268](crates/pasta_lua/src/code_generator.rs#L268)

**ç¾çŠ¶:**
```lua
PASTA.clear_spot(ctx)
```

**è¨­è¨ˆ:**
```lua
act:clear_spot()
```

**å®Ÿè£…:** å‘¼ã³å‡ºã—ã‚’ `PASTA.clear_spot(ctx)` â†’ `act:clear_spot()` ã«ç½®æ›

**æ ¹æ‹ :** Requirement 3 - ã‚¹ãƒãƒƒãƒˆç®¡ç†ã®actçµ±ä¸€

---

### å¤‰æ›´4: ã‚¹ãƒãƒƒãƒˆè¨­å®š `PASTA.set_spot()` â†’ `act:set_spot()`

**ä½ç½®:** [code_generator.rs L270](crates/pasta_lua/src/code_generator.rs#L270)

**ç¾çŠ¶:**
```lua
PASTA.set_spot(ctx, "actor_name", position_index)
```

**è¨­è¨ˆ:**
```lua
act:set_spot("actor_name", position_index)
```

**å®Ÿè£…:** å‘¼ã³å‡ºã—ã‚’å¤‰æ›´ã—ã€`ctx` å¼•æ•°ã‚’å‰Šé™¤

**æ ¹æ‹ :** Requirement 3 - ã‚¹ãƒãƒƒãƒˆç®¡ç†ã®actçµ±ä¸€

---

### å¤‰æ›´5: å˜èªå‚ç…§ã® talk ãƒ¡ã‚½ãƒƒãƒ‰ãƒ©ãƒƒãƒ”ãƒ³ã‚° `word()` â†’ `talk(word())`

**ä½ç½®:** [code_generator.rs L510](crates/pasta_lua/src/code_generator.rs#L510)

**ç¾çŠ¶:**
```lua
act.actor:word()
```

**è¨­è¨ˆ:**
```lua
act.actor:talk(act.actor:word())
```

**å®Ÿè£…:**
- `word()` å‘¼ã³å‡ºã—ã‚’ `act.actor:talk()` ãƒ¡ã‚½ãƒƒãƒ‰ã§ãƒ©ãƒƒãƒ”ãƒ³ã‚°
- ã‚°ãƒ­ãƒ¼ãƒãƒ« `talk` é–¢æ•°ã§ã¯ãªãã€ã‚¢ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ã‚­ã‚·ã®ãƒ¡ã‚½ãƒƒãƒ‰ `talk()` ã‚’ä½¿ç”¨
- è¦ªä»•æ§˜ã® word-search-only ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã†

**æ ¹æ‹ :** Requirement 4 - ã‚¢ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ã‚­ã‚·å‘¼ã³å‡ºã—ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå˜èªå‚ç…§ãƒ©ãƒƒãƒ”ãƒ³ã‚°ï¼‰

**Note:** è¦ªä»•æ§˜ design.md L891 ã®ä¾‹å‚ç…§
- `act.ã•ãã‚‰:talk(act.ã•ãã‚‰:word("ç¬‘é¡”"))` â€” word()ã¯æ¤œç´¢ã®ã¿ã€çµæœã‚’talk()ãƒ¡ã‚½ãƒƒãƒ‰ã«æ¸¡ã™

---

### å¤‰æ›´6: ã•ãã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆå°‚ç”¨ãƒ¡ã‚½ãƒƒãƒ‰ `act.actor:talk()` â†’ `act:sakura_script()`

**ä½ç½®:** [code_generator.rs L509](crates/pasta_lua/src/code_generator.rs#L509)

**ç¾çŠ¶:**
```lua
act.actor:talk(sakura_text)
```

**è¨­è¨ˆ:**
```lua
act:sakura_script(text)
```

**å®Ÿè£…:**
- SakuraScript ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ¤œå‡ºæ™‚ã®å‡ºåŠ›ã‚’å¤‰æ›´
- `act.actor:talk()` â†’ `act:sakura_script()` ã¸ç½®æ›
- text ã¯ StringLiteralizer çµŒç”±ã§å‡¦ç†ï¼ˆæ—¢å­˜ï¼‰

**æ ¹æ‹ :** Requirement 6 - ã•ãã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‡ºåŠ›ã®å¤‰æ›´

**è¤‡é›‘åº¦:** Mï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ†å²ã®è¿½åŠ åˆ¤å®šå¿…è¦ï¼‰

---

## ç¾çŠ¶åˆ†æ

### ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã®ç¾æ§‹é€ 

| ãƒ¡ã‚½ãƒƒãƒ‰ | è²¬å‹™ | é–¢é€£è¡Œ |
|---------|------|-------|
| `generate_local_scene()` | ã‚·ãƒ¼ãƒ³é–¢æ•°å‡ºåŠ› | L237-380 |
| `generate_action_line()` | ç™ºè©±è¡Œå‡¦ç† | L423-450 |
| `generate_action()` | å€‹åˆ¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç† | L453-540 |

### æ—¢ã«å®Ÿè£…æ¸ˆã¿ã®éƒ¨åˆ†

- âœ… L506: ã‚¢ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ã‚­ã‚·å‘¼ã³å‡ºã—ï¼ˆ`act.actor:talk()`ï¼‰
- âœ… L489-490: å¤‰æ•°ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆ`save.*`, `var.*`ï¼‰
- âœ… StringLiteralizer ã®å…¨èˆ¬çš„ãªä½¿ç”¨ï¼ˆæ—¢å­˜ãƒ†ã‚¹ãƒˆã§ç¢ºèªï¼‰

### ã‚®ãƒ£ãƒƒãƒ—ã®é›†ä¸­ç®‡æ‰€

6ã¤ã®å¤‰æ›´ã¯ã™ã¹ã¦ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã«è©²å½“ï¼š
- L253-278: ã‚·ãƒ¼ãƒ³é–¢æ•°ã‚·ã‚°ãƒãƒãƒ£ã¨åˆæœŸåŒ–ãƒ­ã‚¸ãƒƒã‚¯
- L268-270: ã‚¹ãƒãƒƒãƒˆç®¡ç†å‘¼ã³å‡ºã—
- L509-510: ã•ãã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ»å˜èªå‚ç…§ã®å‡ºåŠ›

---

## å®Ÿè£…ã‚ªãƒ—ã‚·ãƒ§ãƒ³

### Option A: è¡Œãƒ¬ãƒ™ãƒ«ä¿®æ­£ï¼ˆæ¨å¥¨ï¼‰

**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:** 6ã¤ã®å¤‰æ›´ã‚’å€‹åˆ¥ã®ç½®æ›æ“ä½œã§å®Ÿè£…

**å¤‰æ›´é †åº:**
1. L253: ã‚·ã‚°ãƒãƒãƒ£ `ctx` â†’ `act`
2. L268: `PASTA.clear_spot(ctx)` â†’ `act:clear_spot()`
3. L270: `PASTA.set_spot(ctx, ...)` â†’ `act:set_spot(...)`
4. L278: `PASTA.create_session()` â†’ `act:init_scene()` + æˆ»ã‚Šå€¤å¤‰æ›´
5. L510: `word()` â†’ `talk(word())`
6. L509: `act.actor:talk(sakura_text)` â†’ `act:sakura_script(text)`

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… å„å¤‰æ›´ãŒç‹¬ç«‹ï¼ˆé †åºä¾å­˜æ€§ä½ã„ï¼‰
- âœ… ãƒ†ã‚¹ãƒˆæ¤œè¨¼ãŒæ®µéšçš„ã«å¯èƒ½
- âœ… å•é¡Œç®‡æ‰€ã®ç‰¹å®šãŒå®¹æ˜“

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- âŒ è¤‡æ•°ã‚³ãƒŸãƒƒãƒˆå¿…è¦
- âŒ ä¸­é–“æ®µéšã§ãƒ†ã‚¹ãƒˆè½ã¡ã®å¯èƒ½æ€§

**æ¨å¥¨ç†ç”±:** è¡Œãƒ¬ãƒ™ãƒ«ã®å¤‰æ›´ã®ã¿ã§ã€ãƒ­ã‚¸ãƒƒã‚¯å†æ§‹æˆãªã—

---

### Option B: çµ±åˆä¿®æ­£

**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:** ã™ã¹ã¦ã®å¤‰æ›´ã‚’1åº¦ã® PR ã§å®Ÿè£…

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… å˜ä¸€ã‚³ãƒŸãƒƒãƒˆ

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**
- âŒ å¤§è¦æ¨¡å¤‰æ›´ã®åŒæ™‚æ¤œè¨¼ãŒå›°é›£
- âŒ ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ç‰¹å®šãŒé›£ã—ã„

---

## è¤‡é›‘åº¦è©•ä¾¡

### å·¥æ•°è¦‹ç©

| å¤‰æ›´ | å·¥æ•° | æ ¹æ‹  |
|------|------|------|
| 1-5ï¼ˆå„ã€…ï¼‰ | 0.5h | æ–‡å­—åˆ—ç½®æ› + ãƒ†ã‚¹ãƒˆç¢ºèª |
| 6ï¼ˆã•ãã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰ | 1h | ãƒ¡ã‚½ãƒƒãƒ‰åç½®æ› + åˆ†å²å‡¦ç†ç¢ºèª |
| ãƒ†ã‚¹ãƒˆæ›´æ–° | 1.5h | grep ç½®æ› + æ¤œè¨¼ |
| **åˆè¨ˆ** | **3.5h** | **å®Ÿè£…æ™‚é–“** |

### ãƒªã‚¹ã‚¯è©•ä¾¡

| ãƒªã‚¹ã‚¯ | å½±éŸ¿ | å¯¾ç­– |
|--------|------|------|
| å¤‰æ›´æ¼ã‚Œ | ä¸­ | grep ã§å…¨å¯¾è±¡è¡Œã‚’äº‹å‰æ¤œç´¢ |
| ãƒ†ã‚¹ãƒˆå¤±æ•— | ä½ | å„å¤‰æ›´å¾Œã« `cargo test --lib` å®Ÿè¡Œ |
| å‡ºåŠ›å½¢å¼ä¸æ­£ | ä½ | Luaæ§‹æ–‡æ¤œè¨¼ï¼ˆè¦ªä»•æ§˜ã¨ã®ç…§åˆï¼‰ |

**ç·åˆé›£åº¦:** Low-to-Mediumï¼ˆS/Mæ··åœ¨ï¼‰

---

## ãƒ†ã‚¹ãƒˆå¯¾å¿œ

### å½±éŸ¿å¯¾è±¡ãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `crates/pasta_lua/tests/transpiler_integration_test.rs`

**æ›´æ–°å¯¾è±¡ãƒ‘ã‚¿ãƒ¼ãƒ³:**
- ã‚·ã‚°ãƒãƒãƒ£: `function SCENE.__start__(ctx, ...)` â†’ `(act, ...)`
- init_scene: `PASTA.create_session(SCENE, ctx)` â†’ `act:init_scene(SCENE)`
- ã‚¹ãƒãƒƒãƒˆ: `PASTA.clear_spot(ctx)`, `PASTA.set_spot(ctx, ...)` â†’ actç‰ˆ
- ã•ãã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: å‡ºåŠ›å½¢å¼ç¢ºèª

**æ¦‚ç®—æ›´æ–°æ•°:** 20-25å€‹ãƒ†ã‚¹ãƒˆ

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæˆ¦ç•¥

**Phaseåˆ¥:**
1. å¤‰æ›´ 1-4 å®Œäº† â†’ åˆæœŸåŒ–é–¢é€£ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
2. å¤‰æ›´ 5-6 å®Œäº† â†’ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–¢é€£ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
3. ã™ã¹ã¦å®Œäº† â†’ `cargo test --all`

---

## å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: åŸºç¤ä¿®æ­£ï¼ˆæ¨å¥¨é–‹å§‹ç‚¹ï¼‰
- L253: ã‚·ã‚°ãƒãƒãƒ£å¤‰æ›´
- L268, L270: ã‚¹ãƒãƒƒãƒˆç®¡ç†

**æ™‚é–“:** 1h  
**ãƒ†ã‚¹ãƒˆ:** 5-8å€‹

### Phase 2: åˆæœŸåŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³
- L278: init_scene å¤‰æ›´

**æ™‚é–“:** 1h  
**ãƒ†ã‚¹ãƒˆ:** 3-5å€‹

### Phase 3: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‡ºåŠ›
- L509-510: ã•ãã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ»word å¤‰æ›´

**æ™‚é–“:** 1h  
**ãƒ†ã‚¹ãƒˆ:** 8-12å€‹

### Phase 4: ãƒ†ã‚¹ãƒˆçµ±åˆ
- å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ»ä¿®æ­£

**æ™‚é–“:** 0.5h  

---

## è¨­è¨ˆç¢ºèªé …ç›®

Design ãƒ•ã‚§ãƒ¼ã‚ºã§ä»¥ä¸‹ã‚’è¦ªä»•æ§˜ã¨ç¢ºèªï¼š

1. **å¤‰æ›´ 2ï¼ˆinit_sceneï¼‰ã®æˆ»ã‚Šå€¤å‹**
   - ç¾: `act, save, var = PASTA.create_session(SCENE, ctx)`
   - è¨­è¨ˆ: `save, var = act:init_scene(SCENE)`
   - ç¢ºèªé …ç›®: `save`, `var` ã¯ init_scene ã®æˆ»ã‚Šå€¤ã‹ï¼Ÿ

2. **å¤‰æ›´ 6ï¼ˆã•ãã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰ã®ãƒ¡ã‚½ãƒƒãƒ‰å**
   - ç¢ºèªé …ç›®: `act:sakura_script()` ã® Luaå®Ÿè£…äºˆå®š

3. **StringLiteralizer é©ç”¨ç®‡æ‰€**
   - ç¢ºèªæ¸ˆã¿: ã™ã¹ã¦ã®æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã§ä½¿ç”¨ï¼ˆçµ±ä¸€ãƒ«ãƒ¼ãƒ«ï¼‰

---

## æ¬¡ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… **ç¾åœ¨:** ã‚®ãƒ£ãƒƒãƒ—åˆ†æå®Œäº†ï¼ˆOption A æ¨å¥¨ï¼‰
2. â­ï¸ **Design ãƒ•ã‚§ãƒ¼ã‚º:** è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆï¼ˆ`/kiro-spec-design pasta_lua_transpiler`ï¼‰
3. ğŸ“‹ **Implementation:** Phase 1-4 ã«å¾“ã„æ®µéšçš„å®Ÿè£…

---

## å‚è€ƒè³‡æ–™

- **è¦ªä»•æ§˜:** [pasta_lua_design_refactor](/kiro/specs/completed/pasta_lua_design_refactor/)
- **ãƒ†ã‚¹ãƒˆ:** [transpiler_integration_test.rs](crates/pasta_lua/tests/transpiler_integration_test.rs)
- **ç¾å®Ÿè£…:** [code_generator.rs](crates/pasta_lua/src/code_generator.rs)
