# 実装タスク分解

## 概要

pasta-lua-output-normalization 機能の実装を以下の5つのメジャータスクに分解します。

- **総計**: 5つのメジャータスク、14個のサブタスク
- **要件カバレッジ**: 全13個の要件を網羅
- **平均タスク規模**: 各サブタスク 1-3 時間

---

## タスク一覧

- [x] 1. normalize_output ヘルパー関数の実装
- [x] 1.1 (P) normalize_output 関数の基本実装
  - 文字列の末尾から空白文字（スペース、タブ、改行）を除去するロジックを実装
  - Rust の `str::trim_end_matches()` を使用して CRLF/LF 両方に対応
  - 関数の戻り値が正確に1つの `\n` で終わるようにする
  - _Requirements: 1.1, 1.2, 3.2_

- [x] 1.2 (P) normalize_output 関数のユニットテスト
  - 空入力ケース: `normalize_output("") → "\n"`
  - 既存改行ケース: `normalize_output("code\n") → "code\n"`
  - 単一余剰行ケース: `normalize_output("code\n\n") → "code\n"`
  - 複数余剰行ケース: `normalize_output("code\n\n\n") → "code\n"`
  - 中間空行保持ケース: `normalize_output("a\n\nb\n\n") → "a\n\nb\n"`
  - CRLF 入力対応ケース: `normalize_output("code\r\n\r\n") → "code\n"` （環境依存確認）
  - _Requirements: 1.1, 1.2, 3.2_

- [x] 2. LuaTranspiler::transpile メソッドの拡張
- [x] 2.1 (P) 中間バッファの導入
  - `transpile()` メソッド内で `Vec<u8>` 型の中間バッファを作成
  - 既存の `LuaCodeGenerator` への参照を中間バッファに向ける
  - コード生成ロジック自体は変更しない（LuaCodeGenerator は変更なし）
  - _Requirements: 3.1, 1.3_

- [x] 2.2 (P) 正規化パスの統合
  - 中間バッファをから UTF-8 文字列に変換
  - 変換エラー発生時の対応: `TranspileError::invalid_utf8()` で失敗させる（設計確認）
  - 変換後の文字列に対して `normalize_output()` を呼び出す
  - 正規化後の結果を最終 Writer に書き込む
  - _Requirements: 3.1, 3.2, 1.1, 1.2_

- [x] 2.3 (P) メソッドシグネチャの整合性確認
  - `transpile()` メソッドのシグネチャは変更しない（互換性維持）
  - 戻り値の `TranspileContext` は既存通り返す
  - 既存のテストが引き続き動作することを確認
  - _Requirements: 1.3, 5.3_

- [x] 3. 統合テストの実行と検証
- [x] 3.1 (P) test_transpile_sample_pasta_line_comparison の実行
  - 既存の統合テストを実行し、`sample.pasta` トランスパイル出力が正規化されることを確認
  - 生成行数が114行であることを確認
  - 生成 Lua コードが `sample.expected.lua` と行単位で完全に一致することを確認
  - _Requirements: 4.1, 4.2, 4.3, 3.3_

- [x] 3.2 (P) test_transpile_sample_pasta_basic_output の再実行
  - 既存の基本出力テストが引き続き合格することを確認
  - シーン/アクター出力形式に変化がないことを確認
  - _Requirements: 5.3, 1.3_

- [x] 3.3 (P) test_transpile_reference_code_patterns の再実行
  - 参照実装パターンマッチテストが合格することを確認
  - コードパターンの整合性が保たれていることを確認
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 4. リグレッション検証
- [x] 4.1 cargo test --all による全テストスイート実行
  - pasta_core の全テストが合格することを確認
  - pasta_lua の全テストが合格することを確認
  - pasta_rune の全テストが合格することを確認（影響がないことを確認）
  - 既存の182テストすべてが合格することを確認
  - _Requirements: 5.1, 5.2_

- [x] 4.2 (P) リグレッション修正（必要な場合）
  - 新しくテストが失敗した場合、根本原因を特定
  - 実装の修正により既存の動作を復旧
  - 修正後に全テストが合格することを確認
  - _Requirements: 5.2_

- [x] 5. 最終検証と出力確認
- [x] 5.1 (P) sample.generated.lua の確認
  - `sample.generated.lua` が期待値と完全に一致することを確認（開発時に自動生成されるファイル）
  - 末尾に余計な空行がないことを確認
  - 行数が114行であることを確認
  - _Requirements: 3.3, 4.1, 4.2_

- [x] 5.2 (P) フォーマッティング一貫性の確認
  - 複数のシーン定義（メイン, 会話分岐）の `end` 前の改行が統一されていることを確認
  - すべてのアクター定義の `end` 前の改行が統一されていることを確認
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 5.3 実装完了報告
  - すべてのタスクが完了し、全テストが合格していることを確認
  - spec.json を確認し、phase が適切に更新されていることを確認
  - 実装サマリーを記録
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 4.1, 4.2, 4.3, 5.1, 5.2, 5.3_

---

## 実装順序と依存関係

### 実行順序
1. タスク 1 (normalize_output 実装): 基盤機能
2. タスク 2 (LuaTranspiler 統合): メイン機能統合
3. タスク 3-5 (検証): テスト確認とリグレッション検証

### 並列実行可能なタスク
- タスク 1.1, 1.2: 正規化関数開発（相互依存あり、順序: 1.1 → 1.2）
- タスク 2.1, 2.2, 2.3: トランスパイラー統合（順序: 2.1 → 2.2 → 2.3）
- タスク 3.1, 3.2, 3.3: 統合テスト実行（相互に独立）
- タスク 4.1, 4.2: リグレッション検証（条件付き: 4.1 → 4.2（失敗時））
- タスク 5.1, 5.2: 最終検証（相互に独立）
- タスク 5.3: 実装完了報告（最後）

### 実装者向けガイダンス

**各タスク実行時のコンテキスト管理**:
- 実装開始前（タスク 1.1）: コンテキストをクリアすることを推奨
- タスク 1.1 完了後: 次タスク実行前にコンテキストをクリア
- タスク 2.1 開始時: タスク 1.1, 1.2 完了を確認
- タスク 3 以降: 各テストタスク間でコンテキストをクリア

**テスト検証時の留意点**:
- `cargo test --all` は全クレートの全テストを実行（5-10 分程度）
- 初回実行時はビルドが走るため時間がかかる可能性がある
- 既存テスト失敗時は、本機能実装による変更が原因でないことを確認

---

## 品質基準

- ✅ 全要件がタスクにマッピングされている
- ✅ タスク依存関係が明確
- ✅ テスト戦略が充実
- ✅ リグレッション検証を含む
- ✅ 最終検証フェーズがある
