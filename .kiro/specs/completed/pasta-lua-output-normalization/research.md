# 調査・設計決定ログ

---
**目的**: 技術設計に影響を与える発見事項、アーキテクチャ調査、設計根拠を記録する。

**使用方法**:
- 発見フェーズ中の調査活動と結果を記録する。
- `design.md` には詳細すぎる設計決定のトレードオフを文書化する。
- 将来の監査や再利用のための参照と証拠を提供する。
---

## サマリー
- **機能名**: `pasta-lua-output-normalization`
- **発見スコープ**: Extension（既存システム拡張）
- **主要な発見事項**:
  1. 末尾空行は `generate_global_scene()` と `generate_actor()` の各終了時に `write_blank_line()` が呼ばれることに起因
  2. 出力正規化は `LuaTranspiler::transpile()` の終了時に実施すべき
  3. 既存のパターン（Write trait への書き込み）を維持しつつ、後処理で正規化可能

## 調査ログ
発見フェーズで実施した調査ステップとその結果を記録する。トピックごとにグループ化して可読性を向上させる。

### 末尾空行の発生箇所特定

- **コンテキスト**: テスト失敗メッセージで生成行数が期待値より2行多いことが判明
- **調査対象**: 
  - [code_generator.rs](../../crates/pasta_lua/src/code_generator.rs) - `generate_global_scene()`, `generate_actor()` メソッド
  - [transpiler.rs](../../crates/pasta_lua/src/transpiler.rs) - `transpile()` メソッド
- **発見事項**:
  - `generate_actor()` の最後（行123）で `write_blank_line()` が呼ばれる
  - `generate_global_scene()` の最後（行218-219）で `write_blank_line()` が呼ばれる
  - 最後のシーンでも空行が追加されるため、ファイル末尾に不要な空行が発生
- **影響**: 出力バッファ終了時に末尾空行を除去する正規化処理が必要

### 生成出力と期待出力の差分分析

- **コンテキスト**: `sample.generated.lua` vs `sample.expected.lua` の比較
- **調査対象**:
  - [sample.generated.lua](../../crates/pasta_lua/tests/fixtures/sample.generated.lua) - 生成出力
  - [sample.expected.lua](../../crates/pasta_lua/tests/fixtures/sample.expected.lua) - 期待出力
- **発見事項**:
  - 生成出力: 116行（末尾に空行2つ）
  - 期待出力: 114行（末尾に空行なし）
  - 差分は最後の `end` ブロック後の空行のみ
- **影響**: 末尾空行の正規化のみで解決可能

### 既存のコード生成パターン分析

- **コンテキスト**: 既存の設計パターンを理解し、拡張方針を決定
- **調査対象**:
  - `LuaCodeGenerator` struct と `Write` trait の使用パターン
  - `TranspilerConfig` による設定管理
- **発見事項**:
  - コード生成は `Write` trait を持つ任意のライターに出力
  - 現在のライターは `Vec<u8>` が使用される
  - ライターへの直接書き込み後に正規化を行うことは困難
  - 代替案: 中間バッファに書き込み、最終段階で正規化してからライターに出力
- **影響**: 設計方針として「後処理正規化」パターンを採用

## アーキテクチャパターン評価
検討した候補パターンとアプローチを列挙する。

| オプション              | 説明                                  | 強み                                 | リスク / 制限                                          | 備考     |
| ----------------------- | ------------------------------------- | ------------------------------------ | ------------------------------------------------------ | -------- |
| A. 後処理正規化         | transpile終了後に出力バッファを正規化 | 既存コードへの影響最小、局所的な変更 | 一時的なメモリ使用増加                                 | **採用** |
| B. 生成時抑制           | 最後のブロックで空行を追加しない      | メモリ効率が良い                     | 「最後のブロック」の判定が複雑、コード改変箇所が多い   | 不採用   |
| C. ストリーミング正規化 | 書き込み時にリアルタイムで正規化      | 即時処理                             | 複雑な状態管理が必要、Write trait のラッパー実装が必要 | 不採用   |

## 設計決定
`design.md` に影響を与える主要な決定を記録する。重要なトレードオフがある選択に焦点を当てる。

### 決定: 後処理正規化パターンの採用

- **コンテキスト**: 出力バッファの末尾空行を除去する必要がある
- **検討した代替案**:
  1. オプションA: transpile終了後に出力バッファを正規化
  2. オプションB: 各生成メソッドで「最後のブロック」かどうかを判定して空行を抑制
  3. オプションC: カスタムWriter実装でストリーミング正規化
- **選択されたアプローチ**: オプションA - 後処理正規化
- **根拠**:
  - 既存の `LuaCodeGenerator` コードに変更が不要
  - `LuaTranspiler::transpile()` メソッド内で局所的に実装可能
  - テスト可能性が高い（正規化関数を分離可能）
  - Rust標準ライブラリのみで実装可能（外部依存なし）
- **トレードオフ**:
  - 利点: 既存コードへの影響最小、単純な実装
  - 欠点: 一時的に中間バッファを使用（メモリ使用量増加）
- **フォローアップ**: 大規模ファイルのパフォーマンス影響を実装後に検証

### 決定: 正規化ロジックの実装場所

- **コンテキスト**: 正規化処理をどこに配置するか
- **検討した代替案**:
  1. `LuaTranspiler::transpile()` 内のインライン処理
  2. 別ユーティリティ関数として `string_utils.rs` に配置
  3. `LuaCodeGenerator` の新メソッドとして追加
- **選択されたアプローチ**: `LuaTranspiler::transpile()` 内 + プライベートヘルパー関数
- **根拠**:
  - 正規化はトランスパイラーの責務として適切
  - ヘルパー関数で単体テスト可能
  - 新規ファイル追加なし
- **トレードオフ**:
  - 利点: 変更箇所が1ファイルに集中
  - 欠点: 将来的に他のバックエンドで再利用する場合は移動が必要

## リスクと緩和策
- **リスク1**: 正規化が意図しない空行も削除する → **緩和**: 末尾のみを対象とし、コンテンツ内の空行は保持
- **リスク2**: 既存テストへの影響 → **緩和**: 既存テストは空行の厳密なチェックをしていないことを確認済み
- **リスク3**: パフォーマンス低下 → **緩和**: 実測で問題がなければ許容（典型的なファイルサイズは数KB）

## 参照
関連するドキュメント、標準、ADR、内部ガイドラインへのリンクを提供する。
- [Rust String::trim_end() 公式ドキュメント](https://doc.rust-lang.org/std/primitive.str.html#method.trim_end) - 末尾空白除去の標準メソッド
- [pasta_lua/src/transpiler.rs](../../crates/pasta_lua/src/transpiler.rs) - 変更対象ファイル
- [pasta_lua/src/code_generator.rs](../../crates/pasta_lua/src/code_generator.rs) - コード生成ロジック参照
