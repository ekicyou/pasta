# ギャップ分析レポート: surface-dictionary-sync

## 1. 現状調査

### 1.1 関連アセットマップ

| アセット | パス | 役割 |
|---------|------|------|
| **アクター辞書（Rust定数）** | `crates/pasta_sample_ghost/src/scripts.rs` | `ACTORS_PASTA` 定数（辞書の正本） |
| **起動スクリプト（Rust定数）** | `crates/pasta_sample_ghost/src/scripts.rs` | `BOOT_PASTA` 定数 |
| **トーク/時報（Rust定数）** | `crates/pasta_sample_ghost/src/scripts.rs` | `TALK_PASTA` 定数 |
| **クリック反応（Rust定数）** | `crates/pasta_sample_ghost/src/scripts.rs` | `CLICK_PASTA` 定数 |
| **画像生成** | `crates/pasta_sample_ghost/src/image_generator.rs` | `Expression` enum（9表情×2キャラ） |
| **生成済み .pasta** | `ghosts/hello-pasta/ghost/master/dic/*.pasta` | `scripts.rs` から生成されるファイル |
| **統合テスト** | `crates/pasta_sample_ghost/tests/integration_test.rs` | ファイル存在・内容検証 |
| **surfaces.txt** | `ghosts/hello-pasta/shell/master/surfaces.txt` | サーフェス番号↔画像マッピング |

### 1.2 現在の表情マッピング（`Expression` enum → surface offset → actors.pasta）

| # | `Expression` variant | 目の描画 | surface offset | 辞書の日本語名 |
|---|---------------------|----------|----------------|---------------|
| 0 | `Happy` | `^ ^` 笑顔 | 0 | `＠笑顔` |
| 1 | `Normal` | `- -` 通常 | 1 | `＠通常` |
| 2 | `Shy` | `> <` 照れ | 2 | `＠照れ` |
| 3 | `Surprised` | `o o` 驚き | 3 | `＠驚き` |
| 4 | `Crying` | `; ;` 泣き | 4 | `＠泣き` |
| 5 | `Confused` | `@ @` 困惑 | 5 | `＠困惑` |
| 6 | `Sparkle` | `* *` キラキラ | 6 | `＠キラキラ` |
| 7 | `Sleepy` | `= =` 眠い | 7 | `＠眠い` |
| 8 | `Angry` | `# #` 怒り | 8 | `＠怒り` |

### 1.3 不一致の詳細分析

#### `＠元気`（辞書未定義、スクリプトで男の子が多用）

使用箇所（計7箇所）:

| ファイル | 行内容 |
|---------|--------|
| boot.pasta | `男の子：＠元気　ぼくは男の子。ちゃんと使ってよね。` |
| talk.pasta | `男の子：＠元気　Lua 側も触ってみなよ。` |
| talk.pasta | `男の子：＠元気　しょうがないなあ。` |
| talk.pasta | `男の子：＠元気　もう　＄時１２　か、早いね。` |
| click.pasta | `男の子：＠元気　どうしたの？` |
| click.pasta | `男の子：＠元気　照れてるの？` |
| click.pasta | `男の子：＠元気　ふふん、ぼくのことが気になる？` |

→ 「元気」は男の子の**基本的なポジティブ表情**として頻繁に使用されている。

#### `＠考え`（辞書未定義、両アクターで使用）

使用箇所（計4箇所）:

| ファイル | 行内容 |
|---------|--------|
| talk.pasta | `女の子：＠考え　今日は何しようかな...` |
| talk.pasta | `男の子：＠考え　さあ、外見てないからわかんないや。` |
| talk.pasta | `女の子：＠考え　＄時１２　...時間が経つのって不思議だね。` |
| talk.pasta | `男の子：＠考え　哲学的だね。` |

→ 「考え」は**思索・疑問**の文脈で両アクターに使われている。

### 1.4 既存テストへの影響分析

| テストカテゴリ | 影響 | 詳細 |
|---------------|------|------|
| `runtime_e2e_test.rs` | **なし** | 独自フィクスチャ使用、sample ghost 非参照 |
| `actor_word_dictionary_test.rs` | **なし** | `＠通常`/`＠照れ` のみ使用 |
| `transpiler_snapshot_test.rs` | **なし** | `＠通常`/`＠照れ` のみ使用 |
| `sakura_script_integration_test.rs` | **なし** | `\s[0]` のみ（sample ghost 非参照） |
| pasta_sample_ghost `integration_test.rs` | **軽微** | `＠笑顔`/`＠怒り` の存在チェック（変更不要） |
| pasta_sample_ghost `scripts.rs` mod tests | **修正必要** | 定数が変わるため自動的に反映 |

**結論**: E2Eテスト・トランスパイラテスト・パーサーテストはサンプルゴーストと完全に独立しており、影響なし。修正対象は `pasta_sample_ghost` クレート内に閉じている。

### 1.5 既存規約・パターン

- **ソース→生成**: `scripts.rs` の `const` 文字列が唯一の正本（Single Source of Truth）
- **表情セットの対称性**: 女の子と男の子で同一の表情名セット（現在9種）
- **`Expression` enum と辞書の 1:1 対応**: 各 variant が surface offset を返し、辞書もその番号でサーフェスタグを定義
- **画像生成ロジックの拡張**: 新表情追加時は `Expression::all()` と `draw_expression()` match 式の拡張が必要

## 2. 要件実現可能性分析

### 要件→アセット マッピング

| 要件 | 関連アセット | ギャップ状態 |
|------|-------------|-------------|
| Req 1: 辞書と使用表情名の完全一致 | `scripts.rs` (ACTORS_PASTA, BOOT/TALK/CLICK_PASTA) | **Missing**: `＠元気`/`＠考え` が辞書に未定義 |
| Req 2: サーフェス番号と表情名の意味的対応 | `image_generator.rs` (Expression enum) | **Missing**: `元気`/`考え` に対応する variant なし |
| Req 3: ソースと生成物の一貫性 | `scripts.rs` → `ghosts/` | **Constraint**: 定数変更で自動反映されるが辞書未定義テストなし |
| Req 4: 既存テストとの互換性 | 全テストスイート | **OK**: 影響は pasta_sample_ghost 内に閉じる |

### 複雑性シグナル

- **単純なデータ修正**: 辞書エントリの追加/変更（テキスト操作）
- **画像生成ロジック**: 新表情の目描画ヘルパー関数追加（中程度）
- **テスト追加**: 辞書↔スクリプト一致検証テストの新規作成

## 3. 実装アプローチ選択肢

### Option A: 辞書に `＠元気`/`＠考え` を追加（辞書拡張アプローチ）

**概要**: 既存の9表情セットに `元気`/`考え` を追加し、11表情に拡張する。

**変更ファイル**:
- `image_generator.rs`: `Expression` enum に `Energetic`/`Thinking` 追加、`all()` を11要素に、`surface_offset()` 追加、`draw_expression()` に描画ロジック追加
- `scripts.rs`: `ACTORS_PASTA` に `＠元気`/`＠考え` のエントリ追加（新サーフェス番号割当）
- `surfaces.txt`: surface9, surface19（または別番号）追加
- テスト: `Expression::all()` が11になるアサーション更新

**サーフェス番号案**:
- 女の子: surface9（元気）, surface10は男の子開始なので不可 → 番号体系の再設計が必要
- **問題**: 現在 sakura=0-8, kero=10-18 で、9 は空き。ただし `元気`/`考え` 2つ追加すると 0-10 となり kero の 10 と衝突する

**トレードオフ**:
- ✅ スクリプト側の修正不要（表情名はそのまま）
- ✅ より豊かな表情バリエーション
- ❌ **サーフェス番号体系の再設計が必要**（sakura/kero の番号帯が衝突）
- ❌ 画像生成ロジックの追加（2つの新描画関数）
- ❌ 既存のサーフェス番号が変わる可能性 → surfaces.txt, actors.pasta 全体の変更

### Option B: スクリプトの表情名を既存辞書に合わせる（スクリプト修正アプローチ）

**概要**: `＠元気` を既存の近い表情名に置換、`＠考え` も同様に既存表情にマッピング。

**マッピング案**:
- `＠元気` → `＠笑顔`（Happy ^ ^）: 「元気」は明るい・ポジティブ → 笑顔が最も近い
- `＠考え` → `＠困惑`（Confused @ @）: 「考える」は疑問・思索 → 困惑がやや近い

**変更ファイル**:
- `scripts.rs`: BOOT_PASTA, TALK_PASTA, CLICK_PASTA 内の `＠元気` → `＠笑顔`（等）に置換

**トレードオフ**:
- ✅ 変更が最小限（テキスト置換のみ）
- ✅ サーフェス番号体系を維持
- ✅ 画像生成ロジック変更不要
- ❌ 「元気」→「笑顔」は意味的に完全一致ではない
- ❌ 「考え」→「困惑」は意味的にかなり乖離
- ❌ 表情バリエーションの縮小（9種のうち実質7種しか使い分けできない）

### Option C: ハイブリッド（辞書拡張 + 番号体系維持）

**概要**: 既存の未使用表情（`泣き`/`困惑`/`キラキラ`）を `元気`/`考え` に**置換**し、表情セットの合計数を9に維持する。

**マッピング案（設計判断が必要）**:

| offset | 現行 | 候補案 | 理由 |
|--------|------|--------|------|
| 0 | 笑顔 (^ ^) | 笑顔 | 維持 |
| 1 | 通常 (- -) | 通常 | 維持 |
| 2 | 照れ (> <) | 照れ | 維持 |
| 3 | 驚き (o o) | 驚き | 維持 |
| 4 | 泣き (; ;) | **考え** (? ?) | 泣き は未使用 → 考え に置換 |
| 5 | 困惑 (@ @) | **元気** (! !) | 困惑 は未使用 → 元気 に置換 |
| 6 | キラキラ (* *) | キラキラ | 維持 |
| 7 | 眠い (= =) | 眠い | 維持 |
| 8 | 怒り (# #) | 怒り | 維持 |

**変更ファイル**:
- `image_generator.rs`: `Expression` enum の `Crying`→`Thinking`, `Confused`→`Energetic` に rename、描画ロジック変更
- `scripts.rs`: `ACTORS_PASTA` の `＠泣き`→`＠考え`, `＠困惑`→`＠元気` に変更
- テスト: 表情名の更新

**トレードオフ**:
- ✅ サーフェス番号体系を完全維持（0-8, 10-18）
- ✅ 辞書とスクリプトが完全一致
- ✅ 画像の見た目と表情名が意味的に一致
- ✅ 表情数は9種を維持
- ❌ 「泣き」「困惑」を失う（ただし現在未使用）
- ❌ **置換対象の選択は設計判断**（開発者確認が必要）

## 4. 実装複雑性とリスク

### 工数見積り

| オプション | 工数 | 理由 |
|-----------|------|------|
| Option A | **M** (3-5日) | サーフェス番号体系の再設計、画像描画追加、全テスト更新 |
| Option B | **S** (1日) | テキスト置換のみ |
| Option C | **S** (1-2日) | enum rename + 辞書エントリ変更 + 描画ロジック調整 |

### リスク評価

| オプション | リスク | 理由 |
|-----------|--------|------|
| Option A | **Medium** | 番号体系変更による影響範囲が広い |
| Option B | **Low** | 変更最小、テスト影響なし |
| Option C | **Low** | 番号体系維持、影響は pasta_sample_ghost 内に閉じる |

## 5. 設計フェーズへの決定事項

### 採用アプローチ: Option B（スクリプト修正）

**開発者との合意事項**:

1. **Source of Truth の階層**: `image_generator.rs`（`Expression` enum）が生成するサーフェスが「憲法」。`image_generator.rs` に対応しない表情名は辞書に定義すべきでなく、スクリプトで使用するのは誤り
2. **actors.pasta は変更不要**: 既に `image_generator.rs` の9種 `Expression` variant と完全一致しており正しい
3. **修正対象はスクリプトのみ**: `scripts.rs` 内の `BOOT_PASTA` / `TALK_PASTA` / `CLICK_PASTA` で `＠元気`（7箇所）、`＠考え`（4箇所）を既存の辞書定義済み表情名に置換する

**設計フェーズで決定すべき残課題**:
- `＠元気` → どの既存表情名に置換するか（候補: `＠笑顔`）
- `＠考え` → どの既存表情名に置換するか（候補: `＠困惑` or 文脈ごとに異なる表情）

### 設計フェーズでの決定事項

1. **置換対象の確定**: 「泣き」「困惑」を置き換えるのが妥当か？他の未使用表情（キラキラ等）にすべきか？
2. **新表情の描画デザイン**: `元気` → `! !`（ビックリマーク）、`考え` → `? ?`（クエスチョンマーク）が直感的か？
3. **辞書↔スクリプト一致テスト**: 既存テスト拡張 or 新規テスト作成？

### Research Needed

- なし（全て既存コードベース内で解決可能）
