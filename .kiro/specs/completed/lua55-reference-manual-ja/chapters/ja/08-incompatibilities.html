<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Lua 5.5 Reference Manual - Chapter 08</title>
</head>
<body>
<h1>8 – <a name="8">以前のバージョンとの非互換性</a></h1>



<p>ここでは、Lua 5.3からLua 5.4にプログラムを移行する際に発生する可能性のある非互換性をリストします。</p><p>適切なオプションを使用してLuaをコンパイルすることにより、いくつかの非互換性を回避できます（ファイル<code>luaconf.h</code>を参照）。ただし、これらの互換性オプションはすべて将来削除されます。多くの場合、互換性の問題は、これらの互換性オプションが削除されたときに発生します。したがって、機会があれば、すべての互換性オプションをオフにしてコンパイルされたLuaのバージョンでコードをテストするようにしてください。これにより、Luaの新しいバージョンへの移行が容易になります。</p><p>Luaのバージョンでは、定数の数値や関数をマクロとして実装するなど、プログラムのソースコードの変更を意味しない方法で、C APIを常に変更できます。したがって、異なるLuaバージョン間でバイナリが互換性があると想定しないでください。新しいバージョンを使用する場合は、常にLua APIのクライアントを再コンパイルしてください。</p><p>同様に、Luaのバージョンでは、プリコンパイルされたチャンクの内部表現を常に変更できます。プリコンパイルされたチャンクは、異なるLuaバージョン間では互換性がありません。</p><p>公式ディストリビューションの標準パスは、バージョン間で変更される可能性があります。</p><h2>8.1 – <a name="8.1">言語の非互換性</a></h2>
<ul>

<li>算術演算およびビット演算における文字列の数値への強制型変換が、コア言語から削除されました。文字列ライブラリは、文字列メタメソッドを使用して、算術演算（ただしビット演算は除く）に対して同様の処理を行います。ただし、以前のバージョンとは異なり、新しい実装では、文字列内の数値の暗黙的な型が保持されます。たとえば、<code>"1" + "2"</code>の結果は、浮動小数点数ではなく整数になりました。</li>

<li>オーバーフローするリテラル10進整数定数は、ラップアラウンドせずに浮動小数点数として読み取られます。古い動作（ラップアラウンド付きの整数として読み取る）が必要な場合は、このような定数に16進数表記を使用できます。</li>

<li><code>__lt</code>メタメソッドを使用して<code>__le</code>をエミュレートすることが削除されました。必要な場合、このメタメソッドを明示的に定義する必要があります。</li>

<li>整数に対する数値の<b>for</b>ループのセマンティクスが一部詳細に変更されました。特に、制御変数がラップアラウンドすることはありません。</li>

<li><b>goto</b>のラベルは、同じ名前のラベルが表示されている場所では宣言できません。たとえ、この他のラベルが囲んでいるブロックで宣言されていても同様です。</li>

<li>オブジェクトをファイナライズするとき、Luaは関数ではない<code>__gc</code>メタメソッドを無視しません。値が存在する場合、任意の値が呼び出されます。（呼び出し可能でない値は、ファイナライザの呼び出し時に他のエラーと同様に警告を生成します。）</li>

</ul>




<h2>8.2 – <a name="8.2">ライブラリの非互換性</a></h2>
<ul>

<li>関数 <a href="#pdf-print"><code>print</code></a> は、引数をフォーマットするために <a href="#pdf-tostring"><code>tostring</code></a> を呼び出しません。代わりに、この機能はハードコードされています。値をどのように出力するかを変更するには、<code>__tostring</code> を使用する必要があります。</li>

<li>関数 <a href="#pdf-math.random"><code>math.random</code></a> によって使用される擬似乱数ジェネレータは、現在、ややランダムなシードで開始されます。さらに、異なるアルゴリズムを使用しています。</li>

<li><a href="#pdf-utf8"><code>utf8</code></a> ライブラリのデコード関数は、デフォルトではサロゲートを有効なコードポイントとして受け入れません。これらの関数に追加のパラメータを指定することで、より寛容にすることができます。</li>

<li>関数 <a href="#pdf-collectgarbage"><code>collectgarbage</code></a> のオプション "<code>setpause</code>" と "<code>setstepmul</code>" は非推奨になりました。これらを設定するには、新しいオプション "<code>incremental</code>" を使用する必要があります。</li>

<li>関数 <a href="#pdf-io.lines"><code>io.lines</code></a> は、現在、1つではなく4つの値を返します。これは、<code>load(io.lines(filename, "L"))</code> のように、オプションのパラメータを持つ別の関数の唯一の引数として使用する場合に問題になる可能性があります。この問題を修正するには、呼び出しを括弧で囲んで、結果の数を1つに調整できます。</li>

</ul>




<h2>8.3 – <a name="8.3">APIの非互換性</a></h2>


<ul>

<li>フルユーザーデータは、現在、任意の数の関連付けられたユーザー値を持つことができます。したがって、関数 <code>lua_newuserdata</code>, <code>lua_setuservalue</code>, および <code>lua_getuservalue</code> は、追加の引数を持つ <a href="#lua_newuserdatauv"><code>lua_newuserdatauv</code></a>, <a href="#lua_setiuservalue"><code>lua_setiuservalue</code></a>, および <a href="#lua_getiuservalue"><code>lua_getiuservalue</code></a> に置き換えられました。<p>互換性のために、古い名前は、1つのユーザー値を想定するマクロとして引き続き機能します。ただし、ユーザー値がゼロのユーザーデータは、メモリ効率が良いことに注意してください。</p></li>

<li>関数 <a href="#lua_resume"><code>lua_resume</code></a> に追加のパラメータが追加されました。この出力パラメータは、コルーチンによってyieldまたは返されたスタックのトップにある値の数を返します。(以前のバージョンでは、これらの値はスタック全体でした。)</li>

<li>関数 <a href="#lua_version"><code>lua_version</code></a> は、バージョン番号のアドレスではなく、バージョン番号を返します。Luaコアは、同じコアの独自の静的コピーを使用しているライブラリで正しく動作するはずであるため、同じアドレス空間を使用しているかどうかを確認する必要はありません。</li>

<li>定数 <code>LUA_ERRGCMM</code> は削除されました。ファイナライザのエラーは伝播されず、代わりに警告が生成されます。</li>

<li>関数 <a href="#lua_gc"><code>lua_gc</code></a> のオプション <code>LUA_GCSETPAUSE</code> と <code>LUA_GCSETSTEPMUL</code> は非推奨になりました。これらを設定するには、新しいオプション <code>LUA_GCINC</code> を使用する必要があります。</li>

</ul>





</body>
</html>
