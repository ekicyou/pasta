# Requirements Document

## Project Description (Input)
pastaエンジンは初期化時にシリアライズディレクトリの絶対・相対パスを与える仕様になっているか。エンジンが把握する永続化データをシリアライズパスから読み込むか。テスト用の永続化ファイルディレクトリは存在するか。テスト用永続化ディレクトリの内容はテストコードが書き換えないように、テスト時に作成されるテンポラリディレクトリ（tempfileクレートを導入するとよい）に展開されるか。エンジンはdrop時にシリアライズパスに永続化データを保存するか。関連するテストは整備されているか。

## Introduction
Pastaエンジンに永続化ディレクトリパスの管理機能を実装します。エンジンは初期化時に指定された永続化ディレクトリパスを保持し、Runeランタイムコンテキストを通じてRuneスクリプトからアクセス可能にします。Runeは標準でTOMLシリアライズ機能を持っているため、永続化の実装（何をいつどう保存するか）はRuneスクリプト側に委ねます。エンジンインスタンス自体の状態は永続化しません（`pasta-engine-independence`により各インスタンスは独立）。テスト環境では、元のテストデータを保護するために一時ディレクトリを使用します。

## Requirements

### Requirement 1: エンジン初期化時の永続化パス指定
**Objective:** 開発者として、PastaEngineの初期化時に永続化ディレクトリパスを指定できるようにしたい。Runeスクリプトがファイル永続化を行う際の基準パスとして使用するため。

#### Acceptance Criteria
1. When PastaEngineを初期化する際に永続化ディレクトリの絶対パスを引数として与える場合、the PastaEngine shall そのパスをRuneスクリプトに提供する永続化パスとして保持する
2. When PastaEngineを初期化する際に永続化ディレクトリの相対パスを引数として与える場合、the PastaEngine shall カレントディレクトリを基準としてパスを解決し、絶対パスに変換して保持する
3. When 永続化ディレクトリパスが指定されない場合（`None`または`Option::None`）、the PastaEngine shall 永続化パスなしで初期化し、Runeスクリプトからの永続化関数呼び出し時にエラーを返す
4. If 指定された永続化ディレクトリパスが無効または存在しない場合、then the PastaEngine shall 適切なエラーを返し、エンジンの初期化を失敗させる
5. The PastaEngine shall 設定された永続化ディレクトリパスをエンジンのライフタイム全体で保持し、Runeランタイムからアクセス可能にする

### Requirement 2: 永続化パスのRuneスクリプトへの提供
**Objective:** Runeスクリプト開発者として、永続化ディレクトリの絶対パスをRuneスクリプトから取得できるようにしたい。Runeの標準ファイルI/O機能やTOMLシリアライズ機能を使用して、自由に永続化を実装できるようにするため。

#### Acceptance Criteria
1. The PastaEngine shall ラベル関数実行時（`vm.execute(hash, args)`）にコンテキスト構造体またはハッシュマップを引数として渡し、永続化ディレクトリパスを含める
2. When 永続化パスが設定されている場合、the PastaEngine shall コンテキスト引数の`persistence_path`フィールドに絶対パス文字列を設定する
3. When 永続化パスが設定されていない場合（`None`）、the PastaEngine shall コンテキスト引数の`persistence_path`フィールドに空文字列を設定する
4. The Runeスクリプト shall ラベル関数の第1引数としてコンテキストを受け取り、`ctx.persistence_path`（または`ctx["persistence_path"]`）でパスにアクセスする
5. The トランスパイラ shall 生成するRuneラベル関数のシグネチャを`pub fn label_name(ctx) { ... }`形式にする
6. The PastaEngine shall 永続化パスの取得に関するドキュメントをRuneスクリプト開発者向けに提供する（コンテキスト引数の使用例、TOML保存例を含む）

### Requirement 3: テスト用永続化ディレクトリの管理
**Objective:** テストエンジニアとして、テスト実行時に元のテストデータを保護しながら永続化機能を検証したい。テストごとに独立した一時ディレクトリを使用できるようにするため。

#### Acceptance Criteria
1. When テストコードがテスト用永続化ディレクトリを準備する場合、the テストフレームワーク shall tempfileクレートを使用して一時ディレクトリを作成する
2. When テスト開始時にテスト用固定データが必要な場合、the テストコード shall リポジトリ内の固定テストデータディレクトリから一時ディレクトリへファイルをコピーする
3. While テスト実行中の場合、the PastaEngine shall 一時ディレクトリ内でのみ永続化データの読み書きを行い、元のテストデータディレクトリを変更しない
4. When テスト終了時、the テストフレームワーク shall 一時ディレクトリとその内容を自動的に削除する
5. The テストコード shall リポジトリ内のテスト用固定データディレクトリ（例: `tests/fixtures/persistence/`）を参照し、このディレクトリはバージョン管理に含める

### Requirement 4: エンジン内部での永続化パス管理
**Objective:** pasta stdlib開発者として、エンジンインスタンスが永続化パスを安全に保持し、Runeランタイムに提供できるようにしたい。複数インスタンスの独立性を保ちながらパスを管理できるようにするため。

#### Acceptance Criteria
1. The PastaEngine shall 永続化ディレクトリパスを`Option<PathBuf>`として内部フィールドに保持する
2. When エンジンインスタンスが作成される場合、the PastaEngine shall 永続化パスを絶対パス形式に正規化し、所有権によって管理する
3. The PastaEngine shall 永続化パスの提供方法がスレッドセーフであり、複数エンジンインスタンスが独立して動作できることを保証する（インスタンスごとに異なるパスを保持可能）
4. When エンジンインスタンスが破棄される場合、the PastaEngine shall 永続化パスも含めすべてのデータが所有権により自動解放されることを保証する
5. The PastaEngine shall 永続化パスの設定がエンジン初期化後に変更されないことを保証する（イミュータブル）

### Requirement 5: Runeスクリプトでの永続化実装ガイダンス
**Objective:** Runeスクリプト開発者として、永続化ディレクトリを使用したデータ永続化の実装方法を理解したい。Runeの標準機能を活用して安全に永続化を実装できるようにするため。

#### Acceptance Criteria
1. The pastaプロジェクト shall Runeスクリプトでの永続化実装例をドキュメントまたはサンプルコードとして提供する（TOMLシリアライズを使用した保存・読み込み例）
2. The ドキュメント shall Runeの標準ファイルI/O機能（`std::fs`相当）を使用したファイル読み書きの方法を説明する
3. The ドキュメント shall パストラバーサル攻撃を防ぐためのファイル名サニタイズのベストプラクティスを説明する（`../`の除去、絶対パス結合の推奨など）
4. The ドキュメント shall Runeの`toml`モジュール（または相当機能）を使用したデータシリアライズの例を提供する
5. The ドキュメント shall 永続化ディレクトリが設定されていない場合（空文字列またはNone）の処理例を提供する

### Requirement 6: テストカバレッジ
**Objective:** QAエンジニアとして、永続化パス管理機能が正しく動作し、エッジケースも含めて検証されていることを確認したい。リグレッションを防止するため。

#### Acceptance Criteria
1. The プロジェクト shall 絶対パス・相対パスの両方を使用したエンジン初期化テストを含む
2. The プロジェクト shall 永続化パスなし（`None`）でエンジンを初期化し、Runeスクリプトからパス取得時に空文字列または`None`が返されることを検証するテストを含む
3. The プロジェクト shall Runeスクリプトから永続化パスを取得し、そのパスを使用してファイル読み書きが正常に動作することを検証するテストを含む
4. The プロジェクト shall Runeスクリプトからファイル書き込み・読み込みを行い、TOMLシリアライズ・デシリアライズが正常に機能することを検証するテストを含む
5. The プロジェクト shall 一時ディレクトリ（tempfileクレート使用）を使用し、テスト終了後に自動削除されることを検証するテストを含む
6. The プロジェクト shall 複数のエンジンインスタンスが異なる永続化ディレクトリを使用し、互いに干渉しないことを検証するテストを含む
7. The プロジェクト shall 永続化ディレクトリが存在しない場合のエンジン初期化エラーを検証するテストを含む

### Requirement 7: エラーハンドリングとロギング
**Objective:** 運用担当者として、永続化パス管理のエラーや警告が適切にログ出力されることを確認したい。問題の診断と対処を容易にするため。

#### Acceptance Criteria
1. When エンジン初期化時に永続化ディレクトリパスが指定され、そのパスが存在しない場合、the PastaEngine shall `error!` レベルでエラー詳細（パス）をログ出力し、初期化エラーを返す
2. When エンジン初期化時に永続化ディレクトリパスが指定され、正常に設定された場合、the PastaEngine shall `info!` レベルで設定されたパスをログ出力する
3. When 永続化パスなし（`None`）でエンジンが初期化された場合、the PastaEngine shall `debug!` レベルで永続化パスが設定されていないことをログ出力する
4. When Runeスクリプトから永続化パスが取得される場合、the PastaEngine shall `debug!` レベルでパス取得をログ出力する（高頻度の場合は省略可）
5. The PastaEngine shall すべての永続化パス関連ログに構造化フィールド（`path`, `error`, `operation`など）を含める
6. The ドキュメント shall Runeスクリプト側でのファイルI/Oエラーハンドリングのベストプラクティスを説明する（try-catchパターン、エラーログ出力など）