# Gap Analysis: lua55-manual-consistency

## 1. 現状調査

### 1.1 対象アセット

| ファイル | サイズ | 行数 | 説明 |
|---------|-------|------|------|
| 06-standard-libraries.md | 110KB | 1669行 | 最大ファイル、セクション重複問題あり |
| 03-language.md | 61KB | 846行 | 大規模ファイル |
| 02-basic-concepts.md | 49KB | 289行 | 中規模 |
| 04-c-api.md | 25KB | 181行 | 中規模 |
| index.md | 25KB | 441行 | 索引ページ、リンク切れ問題 |
| 05-auxiliary-library.md | 22KB | 449行 | 中規模 |
| GLOSSARY.md | 9KB | 272行 | 付録 |
| 07-standalone.md | 8KB | 188行 | 小規模 |
| 08-incompatibilities.md | 7KB | 102行 | 小規模 |
| 09-complete-syntax.md | 6KB | 242行 | 小規模 |
| README.md | 5KB | 144行 | エントリーポイント |
| 01-introduction.md | 3KB | 29行 | 最小ファイル |
| LICENSE.md | 3KB | 76行 | 付録 |

### 1.2 現状のパターン分析

#### ヘッダー構造（3パターン混在）

| パターン | 使用ファイル | 構造 |
|---------|-------------|------|
| **A: HTMLコメント + ナビリンク + セパレータ** | 01, 06 | ✓ メタデータあり、✓ ナビあり |
| **B: ナビリンクのみ** | 02, 03, 04 | × メタデータなし、✓ ナビあり |
| **C: blockquoteメタデータ + セパレータ** | 05, 07, 08, 09 | △ 異なる形式のメタデータ、× ナビなし |

#### メタデータ形式（2パターン混在）

**パターン1: HTMLコメント形式**（01, 06章）
```html
<!--
  原文: https://www.lua.org/manual/5.5/manual.html#N
  参考: https://lua.dokyumento.jp/manual/5.4/manual.html#N
  翻訳日: 2026-01-29
  レビュー: AI Claude Opus 4.5
-->
```

**パターン2: blockquote形式**（05, 07, 08, 09章）
```markdown
> **Source**: Lua 5.5 Reference Manual - Chapter N
> **Translation**: AI-generated ...
> **Glossary**: See [GLOSSARY.md](GLOSSARY.md) for terminology
```

#### ナビゲーションリンク形式（2パターン混在）

**パターン1**（01章）:
```markdown
[← 目次](./README.md) | [2章 基本概念 →](./02-basic-concepts.md)
```

**パターン2**（02, 03, 04章）:
```markdown
[← 前へ: N-1 – タイトル](前.md) | [目次](./README.md) | [次へ: N+1 – タイトル →](次.md)
```

**なし**（05, 06, 07, 08, 09章）: ナビゲーションリンク欠落

### 1.3 6章セクション重複の詳細

| セクション | 重複回数 | パート分割 |
|-----------|---------|-----------|
| 6.2 – 基本関数 | 5回 | パートA〜E |
| 6.4 – モジュール | 2回 | パートA〜B |
| 6.5 – 文字列操作 | 4回 | パートA〜D（+ サブセクション6.5.1, 6.5.2） |
| 6.8 – 数学関数 | 5回 | パートA〜E（最初のパートは「パート」なし） |
| 6.9 – 入出力機能 | 4回 | パートA〜D（最初のパートは「パート」なし） |
| 6.10 – オペレーティングシステム機能 | 2回 | パートA〜B（最初のパートは「パート」なし） |
| 6.11 – デバッグライブラリ | 3回 | パートA〜C（最初のパートは「パート」なし） |

**合計31個のセクション見出し**（本来11個であるべき）

### 1.4 index.md / README.md の役割問題

| 項目 | README.md | index.md |
|-----|-----------|----------|
| タイトル | Lua 5.5 リファレンスマニュアル日本語版 | Lua 5.5 リファレンスマニュアル |
| 目次 | 簡易目次（章概要形式） | 詳細目次（セクションリンク付き） |
| 索引 | なし | Lua関数・C API・型の索引あり |
| 付録リンク | あり | なし |
| ナビから参照 | 一貫して参照される | 参照されない |

**問題**: README.mdの目次にはアンカーリンクがなく、index.mdの詳細目次と重複している。

## 2. 要件とのギャップマッピング

| 要件 | 現状 | ギャップ | 優先度 |
|-----|------|---------|-------|
| **Req 1**: ヘッダー統一 | 3パターン混在 | 05-09章でナビなし、フォーマット不統一 | High |
| **Req 2**: メタデータ統一 | 2形式混在 | HTMLコメント形式に統一必要 | Medium |
| **Req 3**: 6章セクション重複 | 31見出し（本来11） | パート分割を解消し単一見出しに | High |
| **Req 4**: index/README整理 | 役割曖昧 | 役割明確化、コンテンツ再配置 | Medium |
| **Req 5**: index.mdリンク切れ | アンカーID不一致の可能性 | 6章修正後に全リンク検証必要 | High |
| **Req 6**: 付録整合性 | GLOSSARY/LICENSEにナビなし | ナビリンク追加 | Low |
| **Req 7**: 段階的作業 | - | 作業計画策定 | - |

## 3. 実装アプローチオプション

### Option A: 最小修正アプローチ
**説明**: 各ファイルの既存構造を維持しつつ、欠落部分のみ追加

**作業内容**:
- 05-09章にナビゲーションリンク追加
- 6章のパート見出しを削除し、関数定義は維持
- index.mdのリンクを検証・修正

**Trade-offs**:
- ✅ 変更量が最小、リスク低
- ✅ 既存コンテンツへの影響が少ない
- ❌ メタデータ形式の不統一が残る
- ❌ 根本的な整合性問題が残る可能性

### Option B: 完全統一アプローチ
**説明**: 全ファイルを統一フォーマットに再構成

**作業内容**:
- 全ファイルにHTMLコメントメタデータを追加
- 全ファイルに統一ナビゲーションリンクを追加
- 6章を完全に再構成（パート分割解消）
- README.md/index.mdの役割を明確に分離

**Trade-offs**:
- ✅ 完全な整合性が確保される
- ✅ 将来のメンテナンスが容易
- ❌ 変更量が大きい（特に6章110KB）
- ❌ 作業時間が長い

### Option C: 段階的ハイブリッドアプローチ（推奨）
**説明**: 優先度の高い問題から段階的に修正、各段階でバリデーション

**フェーズ分割**:
1. **Phase 1**: ナビゲーションリンク統一（05-09章、付録）
2. **Phase 2**: 6章セクション重複解消（最大の問題）
3. **Phase 3**: index.mdリンク検証・修正
4. **Phase 4**: メタデータ形式統一（オプション）
5. **Phase 5**: README.md/index.md役割整理

**Trade-offs**:
- ✅ リスク分散、段階的進捗確認可能
- ✅ 問題発生時のロールバックが容易
- ✅ 優先度に応じた柔軟な対応
- ❌ 全体完了まで時間がかかる
- ❌ 中間状態での整合性問題

## 4. 工数・リスク評価

### 工数見積もり

| 作業 | 見積もり | 根拠 |
|-----|---------|------|
| Phase 1: ナビリンク統一 | S (1-2時間) | 6ファイル、単純な追加 |
| Phase 2: 6章セクション解消 | L (1-2日) | 110KB、31見出し→11見出し、アンカー影響大 |
| Phase 3: index.mdリンク検証 | M (半日) | 約200リンク検証、6章修正依存 |
| Phase 4: メタデータ統一 | S (1-2時間) | 8ファイル、テンプレート適用 |
| Phase 5: README/index整理 | M (半日) | 役割定義、コンテンツ移動 |

**合計**: M-L（3-5日）

### リスク評価

| リスク | レベル | 軽減策 |
|-------|-------|--------|
| 6章アンカーID変更によるリンク切れ | High | Phase 2完了後にPhase 3で検証 |
| 大規模ファイル編集ミス | Medium | Gitでの差分確認、段階的コミット |
| 意図しないコンテンツ削除 | Medium | バックアップ、変更前後の行数比較 |

## 5. 設計フェーズへの推奨事項

### 推奨アプローチ
**Option C: 段階的ハイブリッドアプローチ**

### 理由
1. 6章が110KBと大きく、一括修正はリスクが高い
2. 段階的な進捗確認がRequirement 7の要件に合致
3. 各フェーズ間でバリデーションを挟むことで品質確保

### 設計フェーズで決定すべき事項
1. **ナビゲーションリンクの統一フォーマット**: パターン1 or パターン2の選択
2. **メタデータ形式**: HTMLコメント or blockquote の選択
3. **6章のアンカーID命名規則**: パート接尾辞削除後のID形式
4. **README.md / index.md の最終的な役割分担**

### Research Needed（調査事項）
- 現在のindex.md内リンクのうち、どれだけが有効か（自動検証が望ましい）
- GitHub/VS Code上でのMarkdownアンカーID生成規則の確認

## 6. 出力チェックリスト

- [x] 要件とアセットのマッピング（ギャップタグ付き）
- [x] Option A/B/C とトレードオフ
- [x] 工数（S/M/L/XL）とリスク（High/Medium/Low）
- [x] 設計フェーズへの推奨事項
