# Requirements Document

## Project Description (Input)
「＞シーン」だけで、ローカルとグローバルの全候補を分岐候補とする、単語辞書と全く同じ仕様にする

## Introduction
Call文（＞シーン）のシーン解決スコープを、単語検索（＠単語）と同じ「ローカル＋グローバル統合検索」仕様に統一します。現在、単語検索は現在のグローバルシーン内のローカル単語＋グローバル単語の全候補から前方一致で検索してランダム選択しますが、Call文は `＞シーン`（ローカルのみ）と `＞＊シーン`（グローバルのみ）を明示的に区別する仕様になっています。この不一貫性を解消し、利用者の学習コスト削減と記述簡潔化を実現します。

## Requirements

### Requirement 1: スコープ統合検索
**Objective:** パスタスクリプト利用者として、Call文（＞シーン）を単語参照（＠単語）と同じスコープ解決ルールで記述したい。これにより、一貫性のある仕様を習得でき、記述時の認知負荷が軽減される。

#### Acceptance Criteria
1. When Call文 `＞シーン名` が実行される場合、pasta エンジンは現在のグローバルシーン内のローカルシーン＋全グローバルシーンの両方から前方一致候補を収集する
2. When 前方一致候補が複数存在する場合、pasta エンジンはすべての候補（ローカル＋グローバル）を統合した集合からランダムに1つ選択する
3. When 単語検索 `＠単語名` が実行される場合、pasta エンジンは現在のグローバルシーン内のローカル単語＋グローバル単語から前方一致候補を収集する（既存仕様の再確認）
4. The pasta エンジンは、Call文と単語検索の両方で同一のスコープ解決ロジック（ローカル＋グローバル統合検索）を適用する

### Requirement 2: グローバルシーンプレフィックスの廃止
**Objective:** パスタスクリプト利用者として、グローバルシーン呼び出し時に `＊` プレフィックスを記述する必要をなくしたい。これにより、記述が簡潔になり、シーン呼び出しの統一性が向上する。

#### Acceptance Criteria
1. When Call文 `＞シーン名` が記述された場合、pasta パーサーは `＊` プレフィックスの有無に関わらず同じ構文として受理する
2. When トランスパイラーが Call文を処理する場合、pasta トランスパイラーは現在のグローバルシーンコンテキストをRuneコード生成時に引数として渡す
3. The pasta エンジンは、`＞＊シーン名` 構文を非推奨（deprecated）として扱い、警告なしで `＞シーン名` と同等に処理する
4. The SPECIFICATION.mdは、Call文のターゲット形式からパターン1（グローバルシーン参照 `＊シーン名`）を削除し、パターン2（統合スコープ検索 `シーン名`）に統合される

### Requirement 3: ランタイム解決の一貫性
**Objective:** pasta 開発者として、LabelTableのシーン検索ロジックを単語検索と同じ2段階検索＋マージパターンに統一したい。これにより、実装の一貫性が保たれ、保守性が向上する。

#### Acceptance Criteria
1. When pasta ランタイムがシーン検索を実行する場合、LabelTableは `find_scene_merged(module_name, prefix)` メソッドを使用する
2. The `find_scene_merged` メソッドは、以下の2段階検索を実行する：(1) ローカル検索：`:{module_name}:{prefix}` で前方一致、(2) グローバル検索：`{prefix}` で前方一致（ただし `:` で始まるキーを除外）
3. The `find_scene_merged` メソッドは、両方の検索結果をマージした候補リストを返す
4. The pasta ランタイムは、マージされた候補リストからランダムに1つのシーンを選択して実行する

### Requirement 4: 既存テストの互換性保持
**Objective:** pasta 開発者として、既存のテストケースが新しいスコープ解決ロジックでも正常に動作することを確認したい。これにより、回帰を防ぎ、品質を維持する。

#### Acceptance Criteria
1. When 既存のテストケースが `＞＊シーン名` 構文を使用している場合、pasta エンジンは `＞シーン名` と同等に処理し、テストは成功する
2. When 既存のテストケースが `＞シーン名` でローカルシーン呼び出しを期待している場合、新しいスコープ解決ロジックはローカル候補を含むため、テストは成功する
3. If 既存のテストケースでグローバル候補の追加により挙動が変化する場合、pasta 開発者はテストケースを更新し、変更理由をコメントで明記する
4. The pasta エンジンは、`cargo test --all` で全テストが成功することを保証する

### Requirement 5: SPECIFICATION.md の更新
**Objective:** pasta ドキュメント利用者として、更新された Call 仕様を SPECIFICATION.md で確認したい。これにより、正確な仕様理解と正しいスクリプト記述が可能になる。

#### Acceptance Criteria
1. The SPECIFICATION.md の「4. Call の詳細仕様」セクションは、パターン1（グローバルシーン参照）を削除し、パターン2を「ローカル＋グローバル統合検索」に更新される
2. The SPECIFICATION.md の「10.3 単語参照」セクションに記載されたスコープ解決ルールが、Call 仕様でも同様に適用されることが明記される
3. When 利用者が SPECIFICATION.md の Call 仕様を読む場合、「`＞シーン名` で現在のグローバルシーン内のローカルシーン＋全グローバルシーンから前方一致検索」という説明が含まれる
4. The SPECIFICATION.md は、破壊的変更として `＞＊シーン名` 構文の非推奨化を明記する（ただし、互換性のため引き続きサポート）
