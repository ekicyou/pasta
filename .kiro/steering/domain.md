# Domain Knowledge Steering

## Pastaスクリプトエンジンのドメイン概念

このドキュメントは、Pastaスクリプトエンジンの中核となるドメイン概念と実装上の重要な知見を記録します。

---

## ラベル（Label）

### 定義
Pastaスクリプトの基本単位。対話の一塊を表す。

### 種類
- **グローバルラベル**: `＊ラベル名` - プロジェクト全体からアクセス可能
- **ローカルラベル**: `＊＊ラベル名` - 親ラベル内でのみアクセス可能

### 重複ラベル
同名のラベルを複数定義可能。実行時にランダムに1つが選択される（会話のバリエーション実現）。

### ラベルID
トランスパイル時に各ラベルに一意のID（連番）が付与され、`ラベル名_連番`形式のRune関数に変換される。

### 前方一致検索
ラベル名の前方一致により候補を列挙し、ランダム選択可能（`LabelTable::find_by_prefix`）。

---

## トランスパイル（Transpilation）

### 2パス方式
1. **Pass 1**: AST解析、ラベル登録、依存関係解決
2. **Pass 2**: Runeコード生成、最適化

### モジュール構造化
各グローバルラベルは`pub mod ラベル名_連番`としてモジュール化される：
- `pub fn __start__(ctx)`: エントリーポイント関数
- `pub fn ラベル名_連番(ctx)`: ローカルラベル関数

### アクター変数
最後に発言したスピーカーを追跡する`__actor`変数が自動生成され、スピーカー省略時の解決に使用される。

---

## Yield伝搬問題

### 問題
RuneはネストしたGenerator関数のyieldを親関数に透過的に伝搬しない。単純な関数呼び出し`label(ctx)`では、呼び出し先のyieldイベントが全て失われる。

### 解決方針（pasta-yield-propagation仕様）
1. **Generator変換**: 呼び出し先関数もGenerator化
2. **手動yield伝搬**: `for event in callee_gen { yield event; }`パターンでイベントを転送
3. **Call文**: サブルーチン呼び出し後に元の場所に戻る
4. **Jump文**: ジャンプ先で実行継続、戻らない

### 実装戦略
Transpilerレイヤーで適切なyield伝搬コードを生成する。

---

## 変数管理

### スコープ
- **ローカル変数**: `＠変数名` - ラベル実行中のみ有効
- **グローバル変数**: `＠＊変数名` - アプリケーション実行中有効
- **システム変数**: `＠＊＊変数名` - セッション間で永続化

### 実装
`VariableManager`が3層スコープを管理し、優先順位：ローカル → グローバル → システム。

---

## 制御フロー

### 宣言的アプローチ
Pasta DSLは命令型制御構文（if/while）を持たない。代わりに：
- **Call文** (`＞label`): ラベル呼び出し、実行後復帰
- **Jump文** (`－label`): ラベルジャンプ、復帰なし
- **Runeブロック**: 複雑なロジックをRune言語で記述

### 条件分岐の実現
Runeブロック内で条件判定し、変数に次のラベル名を設定、Jump文で遷移。

### ループの実現
Runeブロック内でwhile/forループを実装し、yieldで出力。

---

## IR（Intermediate Representation）

### ScriptEvent
Pastaエンジンの出力形式。以下のイベント型：
- `Talk { speaker, content }`: 発言
- `Wait { duration }`: ウェイト（マーカーのみ）
- `BeginSync`, `SyncPoint`, `EndSync`: 同期制御（マーカーのみ）
- `SetVariable { scope, name, value }`: 変数設定
- `Error { message }`: エラー

### マーカー型イベント
Wait、Sync関連イベントはタイミング制御ロジックを含まず、areka層が実際の制御を実装する。

---

## さくらスクリプトエスケープ

### エスケープ透過
Pastaは以下のさくらスクリプトエスケープシーケンスを**そのまま**IR出力に含める（解釈はareka層）：
- `\\s[表情ID]`: 表情変更
- `\\h`: 目を閉じる
- `\\w数字`: ウェイト
- `\\n`: 改行
- `\\_w[数字]`: 待機
- `\\![raise, キャラクター名]`: キャラクター切り替え

### 設計意図
エンジン層はレンダリングロジックを持たず、UI層（areka）が解釈・描画する。

---

## イベントハンドリング

### イベントラベル命名規則
`On<イベント名>`形式のラベルがイベントハンドラとして認識される：
- `OnStartup`: アプリ起動時
- `OnShutdown`: 終了時
- `OnClick`: クリック時
- `OnDoubleClick`: ダブルクリック時

### 大文字小文字非区別
イベント名のマッチングは大文字小文字を区別しない（`OnClick`, `onclick`, `ONCLICK`すべて同等）。

---

## ラベル属性とフィルタリング

### 属性定義
ラベル内で`＠属性名：値`形式で属性を付与：
```pasta
＊挨拶
    ＠time：morning
    さくら：おはようございます！
```

### フィルタ実行
`PastaEngine::execute_label_with_filters`で属性フィルタを指定し、条件に合うラベルのみ実行候補とする。

---

## Runeブロック統合

### ローカル関数定義
Pasta DSL内で` ```rune ... ``` `ブロックを使用し、Rune関数を定義可能（実験的機能）。

### 呼び出し方法
- DSL会話行から: `＠関数名` or `＠関数名（引数）`
- Call行から: `＞関数名`

### コンテキスト引数
第一引数に`ctx`（キャラクター構造体）が渡される。

---

## パフォーマンス最適化

### パース結果キャッシュ
`ParseCache`が同一スクリプトのパース結果をメモリキャッシュし、再パースを回避。

### ラベル検索
`LabelTable`はHashMapベースでO(1)検索を実現。

### 前方一致検索
`fast_radix_trie`クレートによるRadix Tree実装で高速前方一致検索。

### 重複ラベル
事前グルーピングにより、ランダム選択を高速化。

---

## エラーハンドリング

### 構造化エラー型
`thiserror`による`PastaError`定義：
- `ParseError`: 文法エラー（ファイル名、行番号、カラム位置含む）
- `LabelNotFound`: 未定義ラベル呼び出し
- `RuntimeError`: 実行時エラー

### エラー伝搬
`Result<T, PastaError>`による統一的なエラー処理。

---

## テスト戦略

### レイヤーごとのユニットテスト
- Parser: 文法パース単体
- Transpiler: AST → Rune変換単体
- Runtime: Rune VM実行単体
- Engine: 統合E2Eテスト

### Fixture駆動テスト
`tests/fixtures/`配下のPastaスクリプトを使用した統合テスト。

### UI層独立性検証
`engine_independence_test.rs`でタイミング制御・レンダリングロジックが含まれないことを確認。

---

## 将来実装予定

### 単語定義DSL（pasta-word-definition-dsl）
前方一致による単語ジャンプテーブル実装。ラベル同様に単語keyでランダム呼び出し。

### ラベル継続（pasta-label-continuation）
複数ラベルの連鎖実行機構。

### インライン多段解決（pasta-conversation-inline-multi-stage-resolution）
変数展開、関数呼び出し、ラベル参照の複合解決。

### SHIORI.DLL統合
Windows DLLとしてコンパイルし、伺か互換レイヤーを提供。

### MCP Server統合
LLMとの連携機構。

---

## arekaエコシステム統合

### 位置付け
Pastaは`areka`デスクトップマスコットアプリケーションのスクリプトエンジンとして設計されている。

### 分離原則
- **Pasta**: スクリプト解析・IR生成のみ
- **areka**: UI描画・タイミング制御・イベントディスパッチ

### 統合仕様
`ukagaka-desktop-mascot`メタ仕様配下の32子仕様により段階的統合：
- `areka-P0-script-engine`: Pasta統合基盤（完了）
- `areka-P0-package-manager`: ゴーストパッケージ管理
- `areka-P0-persistence`: 状態永続化
- `areka-P0-mcp-server`: MCP統合
- `wintf-P0-*`: UI Widget統合（画像、イベント、タイプライター、バルーン、アニメーション）

---

このドメイン知識は、完了仕様11件・進行中仕様9件の分析から抽出されました。新機能開発時は本ドキュメントを参照し、既存アーキテクチャとの整合性を確認してください。
