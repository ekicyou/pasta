# Pasta DSL文法ステアリング

## 権威的仕様書

**開発時は必ず参照**: `/SPECIFICATION.md`（全11章、1,210行）

パーサー・トランスパイラー・ランタイムの実装判断はすべてこの仕様書に基づく。

---

## マーカー一覧（全角/半角両対応）

| マーカー | 全角 | 半角 | 用途 |
|---------|------|------|------|
| グローバルラベル | `＊` | `*` | ラベル定義 |
| ローカルラベル | `・` | `-` | サブラベル定義 |
| 属性 | `＆` | `&` | メタデータ |
| 単語/関数 | `＠` | `@` | 単語定義・参照・関数呼び出し |
| 変数 | `＄` | `$` | 変数宣言・参照 |
| Call | `＞` | `>` | ラベル呼び出し |
| コメント | `＃` | `#` | コメント行 |
| コロン | `：` | `:` | 区切り |

---

## ドメイン概念

### ラベル（Label）
- **グローバルラベル**: `＊ラベル名` - プロジェクト全体からアクセス可能
- **ローカルラベル**: `・ラベル名` - 親ラベル内でのみアクセス可能
- **重複ラベル**: 同名で複数定義可能、実行時にランダム選択
- **前方一致検索**: `LabelTable::find_by_prefix`でランダム候補選択

### 変数スコープ
- **ローカル変数**: `＄変数名` - ラベル内のみ有効
- **グローバル変数**: `＄＊変数名` - セッション中有効
- **システム変数**: `＄＊＊変数名` - 永続化対象

### 制御フロー
- **Call文** (`＞label`): サブルーチン呼び出し、実行後復帰
- **Runeブロック**: 複雑なロジックをRune言語で記述

---

## 基本パターン

```pasta
＊会話                    # グローバルラベル
＆priority：10            # 属性
  ＠greeting：こんにちは おはよう  # ローカル単語定義
  Alice：＠greeting！\n    # アクション行（単語参照 + Sakura改行）
  ＄count：1              # 変数代入
  ＞次の会話              # Call（ローカルラベル）
  ・次の会話              # ローカルラベル
    Bob：続きです
```

### Runeブロック
````pasta
＊計算
```rune
fn calculate(ctx) {
    let result = 10 + 20;
    result
}
```
  Alice：結果は ＠calculate() です
````

---

## IR出力（ScriptEvent）

| イベント | 用途 |
|---------|------|
| `Talk { speaker, content }` | 発言 |
| `Wait { duration }` | ウェイトマーカー |
| `BeginSync`, `SyncPoint`, `EndSync` | 同期制御マーカー |
| `SetVariable { scope, name, value }` | 変数設定 |
| `Error { message }` | エラー |

**設計原則**: Wait/Sync関連はマーカーのみ、areka層が制御を実装。

---

## さくらスクリプト

Pastaは以下をそのままIR出力に含める（解釈はareka層）：
- `\\s[表情ID]`: 表情変更
- `\\w数字`: ウェイト
- `\\n`: 改行
- `\\_w[数字]`: 待機

---

## 破壊的変更（2025-12 適用済み）

1. **Jump（？）廃止** → Call（＞）を使用
2. **Sakura エスケープ**: 半角 `\` のみ（全角 `＼` 不可）
3. **Sakura 括弧**: 半角 `[]` のみ（全角 `［］` 不可）
4. **text_part**: `$` を除外（インライン変数参照が正常動作）
