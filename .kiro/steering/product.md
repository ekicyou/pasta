# Product Steering
Memories of pasta twine together—now and then a knot, yet always a delight.

## プロジェクト概要
**pasta**は、「伺か」のようなデスクトップマスコットなどを実現するためのスクリプトエンジンです。「パスタスクリプト」DSLを解釈し、runeスクリプト言語をバックエンドとした「ゴースト」基盤になるように設計されています。

## ビジョン
会話の記録というのは、長い長い一本の糸であり、パスタのように絡み合うことで意外性という面白さを提供できると考えます。

設計思想として前方一致によるランダムジャンプを主軸にすることで、ゴースト会話を記述可能なスクリプトエンジンを提供します。また、シナリオ型ゲームエンジンとしても流用可能なデータ構造を提供し、エンジンとして一定の地位を確立することを目指します。

## 目標
- **行指向文法**: 冒頭インデント＋キーワードにより、行属性が決定する。コード内runeブロックのみ例外とする。
- **前方一致によるラベルのランダムJump、Call**: ラベル名の前方一致により、ジャンプ先候補を列挙する。列挙候補はシャッフルされ、同じ検索キーでjump/callされたときに毎回異なるラベルが呼び出される。
- **前方一致による単語のランダムJump、Call**: 単語keyの前方一致により、一致する単語を列挙する。列挙候補はシャッフルされ、同じ検索キーで単語呼び出しされたときに毎回異なるラベルが呼び出される。
- **SHIORI.DLLのリリース**: 主要な構成要素について、SHIORI.DLLインターフェースを実装して公開する。従来の伺かユーザーにもリーチする。
- **arekaエコシステムへの投入**: 次世代デスクトップマスコットプラットフォームとして`areka`アプリを計画している。arekaで利用されるゴーストエンジンとして、pastaを投入する。

## コアバリュー
- **日本語フレンドリー**:  主要なDSLキーワードとしてローマ字入力モードで簡便に使える全角文字を採用し、タイプ量を削減する。
- **UNICODE識別子**: ラベル名などはrust/runeで変数名・関数名としてそのまま転用可能なUNICODE識別子を採用する。これにより一般的な日本語による識別子が登録可能となる。
- **yield型エンジン**: すべての出力はyieldによる継続出力を基本とする。チェイントークなど、出力側で中断・再開するような構造に対しても自然に対応可能とする。
- **runeトランスパイル**: 「パスタスクリプト」DSLはrune言語に2passトランスパイルされ、実行する。DSL側からrune関数を呼び出す仕組みを用意し、DSLで実現が難しい複雑な制御をrune側で実行できるようにする。runeトランスパイル結果はキャッシュファイルとして残し、複雑な機能を実装するときの参考にできるようにする。

## ターゲットユーザー
- デスクトップマスコットの掛け合いを記述したいユーザー。
- シナリオ型ゲームなどのゲームエンジンが必要なユーザー。

## 機能の優先順位

### Phase 0: 一次設計の再構築（進行中）⚠️
**現状**: 過去11仕様は完了扱いだが、実装品質が要件定義意図を満たしておらず、**大規模な差し戻し・再設計中**

- [ ] 「パスタスクリプト」DSL設計の見直し
- [ ] ２パストランスパイル設計の再検討
- [ ] ラベルジャンプテーブル設計の修正
- [ ] 宣言的制御フロー（Call/Jump文）の再実装
- [ ] UI層独立性の正確な実現

**課題**:
- DSL文法の曖昧性・不完全性
- トランスパイル結果の品質問題
- ラベルテーブル設計の不備
- Yield伝搬問題（Call/Jump文が動作しない）🔴
- 要件と実装の乖離

**過去の「完了」仕様**: 11件（実装品質不十分、再評価必要）

### Phase 1: 基盤確立（未達）
Phase 0の再構築が完了するまで、基盤確立とは言えない状態。

### Phase 2: コア機能実装（保留）
- [ ] **P0**: Call/Jump文のyield伝搬修正（`pasta-yield-propagation`）🔴
- [ ] **P0**: Runeブロックローカル関数呼び出し（`pasta-local-rune-calls`）
- [ ] **P1**: 単語ジャンプテーブルの実装（`pasta-word-definition-dsl`）
- [ ] **P1**: Call解決優先度明確化（`pasta-call-resolution-priority`）

**進行中仕様**: 9件（Phase 0完了後に着手）

### Phase 3: 高度機能（計画中）
- [ ] ラベル継続チェーン（`pasta-label-continuation`）
- [ ] インライン多段解決（`pasta-conversation-inline-multi-stage-resolution`）
- [ ] rune側ランタイムを拡充し、使い勝手を向上させる
- [ ] イベントハンドリングの拡充

### Phase 4: エコシステム統合（将来）
- [ ] SHIORI.DLLとしてのコンパイル
- [ ] arekaへの投入（`ukagaka-desktop-mascot`メタ仕様 - 32子仕様管理中）
- [ ] MCPまたはLLMとの連携（`areka-P0-mcp-server`）

**現在地**: Phase 0（一次設計再構築中）- **基盤未確立**
