# Pest定義との整合性分析

## 提示要件と現在のpest定義の比較

ユーザーが提示したキーワード定義について、現在のpast.pest定義との乖離を分析した結果。

---

## ✅ 一致している項目

### 1. 行指向文法
- **要件**: 行頭の数文字により行属性が確定
- **pest定義**: `top_level_line`、`label_body_line`、`local_label_body_line`で実装
- **状態**: 一致 ✅

### 2. Rune code block の複数行構成
- **要件**: rune コードブロックは複数行にわたりコードブロックを形成
- **pest定義**: `rune_block_content`で`rune_start`～`rune_end`を複数行でサポート
- **状態**: 一致 ✅

### 3. 空白の定義
- **要件**: `WHITE_SPACE`から改行`\r\n`を除外した1つ以上の連続
- **pest定義**: 
  ```plaintext
  WHITESPACE = _{ " " | "\t" | "\u{3000}" | "\u{00A0}" | ... }
  ```
  改行を除外している
- **状態**: 一致 ✅

### 4. 識別子
- **要件**: `{ XID_START - XID_CONTINUE* }`
- **pest定義**: `ident = @{ !ident_forbidden ~ XID_START ~ XID_CONTINUE* }`で実装
- **状態**: 一致 ✅（ただし`ident_forbidden`で予約語を除外）

### 5. グローバルラベル
- **要件**: 「＊」 または 「*」
- **pest定義**: `global_label_marker = { "＊" | "*" }`
- **状態**: 一致 ✅

### 6. ローカルラベル
- **要件**: 「・」 または 「-」
- **pest定義**: `local_label_marker = { "・" | "-" }`
- **状態**: 一致 ✅

### 7. 属性
- **要件**: 「＆」 または 「&」
- **pest定義**: `amp_marker = { "＆" | "&" }`
- **状態**: 一致 ✅

### 8. 単語登録・呼び出し
- **要件**: 「＠」 または 「@」
- **pest定義**: `at_marker = { "＠" | "@" }`
- **状態**: 一致 ✅

### 9. アクター名と会話文の区切り文字
- **要件**: 「：」 または 「:」
- **pest定義**: `colon = { "：" | ":" }`
- **状態**: 一致 ✅

### 10. Rune コードブロック開始
- **要件**: 「```rune」
- **pest定義**: `rune_start = { "```rune" | "```" }`
- **状態**: ほぼ一致 ⚠️（ただし下記参照）

### 11. Rune コードブロック終了
- **要件**: 「```」
- **pest定義**: `rune_end = { "```" }`
- **状態**: 一致 ✅

---

## ⚠️ 乖離・曖昧性

### Issue 1: Rune Start の曖昧性（中-軽度）

**問題**: 要件では「```rune」と明示されているが、pest定義では：
```plaintext
rune_start = { "```rune" | "```" }
```
単なる「```」でもマッチしてしまう。

**影響**: 
- 「```rune」で開始する必要があるのか、それとも「```」でよいのか不明確
- GRAMMAR.md では「```rune」と記述されているはず（確認必要）
- 現在の実装では、バックティック3つのみでも rune ブロックが開始される可能性

**推奨対応**: 
- 設計段階で「```rune」を必須にするか、「```」も許可するかを決定
- 現在の実装が意図的なのか、バグなのかを確認

---

### Issue 2: 追加の演算子と文字（新規）

**問題**: 要件定義に記載されていないが、pest定義に実装されている要素：

1. **Call/Jump マーカー**
   - `call_marker = { "＞" | ">" }`
   - `jump_marker = { "？" | "?" }`
   - 要件では「キーワード定義」に含まれていない

2. **変数スコープマーカー**
   - `global_label_marker`が変数スコープ宣言にも使用：`＄＊var_name`
   - 要件では独立した要素として定義されていない

3. **演算子群**
   - 加減乗除剰余: `+`, `＋`, `-`, `－`, `*`, `＊`, `×`, `/`, `／`, `÷`, `%`, `％`
   - 代入演算子: `＝`, `=`
   - 括弧: `（`, `(`, `）`, `)`
   - 要件に記載されていない

4. **Sakura スクリプト エスケープ**
   - `sakura_escape = { "\\" | "＼" }`
   - 複雑なコマンド構文（`[0]`, `[raise,event]` など）
   - 要件に記載されていない

5. **文字列リテラル**
   - 日本語: `「」`
   - 英語: `""`
   - 要件に記載されていない

**影響**: 
- 要件定義が実装より抽象的（必要な構成要素をすべて網羅していない）
- 完全なキーワード定義のためには、これらの要素も列挙する必要がある

**推奨対応**:
- 要件定義を以下のように拡張検討：
  - **制御フロー**: Call（`＞`）、Jump（`？`）
  - **変数**: スコープ修飾子（`＊`）、代入（`＝`）
  - **リテラル**: 文字列（`「」`、`""`）、数値
  - **演算**: 算術演算子（完全リスト）
  - **Sakura**: エスケープ（`\`、`＼`）とコマンド形式

---

### Issue 3: Word Definition の呼び出し形式

**要件**:
```
単語登録、単語呼び出し：「＠」または「@」
```

**pest定義**:
- 単語登録: `＠word_name：value1　value2`（グローバル）
- 単語呼び出し: `＠func_name(...)`（関数形式）、`＠var_name`（変数参照形式）

**曖昧性**: 
- 「＠」は登録にも呼び出しにも使用されるが、実装では文脈により異なる
- 要件では登録と呼び出しの区別が明確でない

**推奨対応**:
- 要件を以下のように細分化：
  - 「＠」登録形式: `＠word_name：value`
  - 「＠」参照形式: `＠word_name`（変数参照）
  - 「＠」呼び出し形式: `＠func_name(args)`（関数呼び出し）

---

### Issue 4: 文字列値の区切り文字

**要件**:
```
単語登録：＠word_name：value1　value2
```

**pest定義**:
```plaintext
word_separator = { "　" | "\t" }
```

**観察**:
- 要件では「　」（全角スペース）と明示
- pest定義では「　」 または タブをサポート
- 一致している ✅

---

## 📋 Summary：要件定義の改定提案

### 追加すべきキーワード定義

```markdown
### キーワード（改定版）

#### 基本要素
- 空白：`WHITE_SPACE` から `\r\n` を除外した1つ以上の連続
- 識別子：`{ XID_START ~ XID_CONTINUE* }`

#### ラベル・マーカー
- グローバルラベル：「＊」 または 「*」
- ローカルラベル：「・」 または 「-」
- 属性：「＆」 または 「&」

#### 制御フロー
- Call マーカー：「＞」 または 「>」
- Jump マーカー：「？」 または 「?」

#### 単語・変数・関数
- 単語登録・参照：「＠」 または 「@」
- 変数スコープ修飾：「＊」 または 「*」（グローバル変数のみ）
- 変数宣言：「＄」 または 「$」
- 代入演算子：「＝」 または 「=」

#### 音声・会話
- アクター名と会話文の区切り：「：」 または 「:」
- Sakura スクリプト エスケープ：「\」 または 「＼」

#### Rune コードブロック
- 開始：「```rune」（要確認：「```」だけでも可か？）
- 終了：「```」

#### 演算子
- 加算：「+」 または 「＋」
- 減算：「-」 または 「－」
- 乗算：「*」 または 「＊」 または 「×」
- 除算：「/」 または 「／」 または 「÷」
- 剰余：「%」 または 「％」

#### リテラル区切
- 日本語文字列：「」（左右鉤括弧）
- 英語文字列：「"」（ダブルクォート）
- 括弧：「（」「）」 または 「(」「)」

#### 単語値の区切
- 全角スペース：「　」 または タブ「\t」
```

---

## 📌 Action Items（設計フェーズの検討事項）

### A: Rune Start の仕様確認（Req 1 関連）
- [ ] 「```rune」を必須にするのか、「```」だけでも許可するのか決定
- [ ] GRAMMAR.md での記述を確認
- [ ] 既存テストでの使用例を確認

### B: 要件定義の拡張（Req 2 関連）
- [ ] 上記「キーワード（改定版）」に基づき、要件定義を更新するか判定
- [ ] 不要と判定すれば、何か理由をメモする

### C: Sakura スクリプトの仕様（Req 5-8 関連）
- [ ] Sakura コマンドの5パターンをドキュメント化する必要があるか確認
- [ ] GRAMMAR.md に記載されているか確認

### D: 変数スコープの仕様（Req 2 関連）
- [ ] グローバル変数宣言「＄＊var_name」の形式は最終確定か
- [ ] ローカル変数のスコープ規則を明確化

---

## 🔍 pest 定義の品質メモ

**肯定的な点**:
- Unicode対応が包括的（日本語、半角/全角対応）
- エッジケース処理が考慮されている（例：sakura_command の複数パターン）
- コメント化が良好

**改善提案**:
- `rune_start` の定義が曖昧（仕様確認が必要）
- インライン要素（`at_marker` 参照）のコメント不足
- 変数スコープ規則がコメントに明示されていない

