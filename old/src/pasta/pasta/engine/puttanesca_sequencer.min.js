(function(){define(["engine/jsutil","jquery","modernizr"],function(l,m){var o,q,r,a,b,c,d,e,f,g,h,i,j,k,n,p,s,t,u,v;
b=function(w){return w
};
u="（［｛「『([{｢";
c="、。，．・？！゛゜ヽヾゝゞ々）］｝」』!),.:;?]}｡｣､･ﾞﾟ‥…";
d=b("、  ，                                  ,        ､       ");
e=b("        ・                                        ･  ‥…");
f=b("            ！                        !                  ");
g=b("  。  ．  ？                               .?  ｡         ");
i="、。，．,.";
n=120;
v={a:n*1,b:n*3,c:n*1.5,d:n*3.5,e:n*4.5,period:n*5,section:n*5,talk:20000};
t=300;
s=400;
j=function(w){var x;
x=function(y){return(y.indexOf(w))>-1
};
if(w===" "){return"normal"
}else{if(x(u)){return"start"
}else{if(x(c)){if(x(d)){return"end1"
}else{if(x(e)){return"end2"
}else{if(x(f)){return"end3"
}else{if(x(g)){return"end4"
}else{return"end"
}}}}}}}};
k=function(w){var x;
x=j(w);
switch(x){case"end":return"b";
case"end1":return"b";
case"end2":return"c";
case"end3":return"d";
case"end4":return"e";
default:return"a"
}};
a=function(w,x){$("<div>").attr({id:w}).appendTo(x);
return $("div#"+w)[0]
};
p=void 0;
h=function(){if(p!=null){return p
}p=$("div#scrapArea")[0];
if(p!=null){return p
}p=a("scrapArea","body");
return p
};
r=(function(){var x;
x=0;
function w(A,y,z){this.parent=A;
this.areaClass=y;
this.index=z!=null?z:x++;
this.id=""+this.parent+"-"+this.index;
console.log("[SectionAreaItem<"+this.id+">::constructor]");
this.area=$(a(this.id,this.parent));
this.area.addClass(this.areaClass);
this.area.addClass("waiting");
this.isShow=true;
this.hide()
}w.prototype.remove=function(){this.area.remove();
console.log("[SectionAreaItem<"+this.id+">::remove]")
};
w.prototype.show=function(){console.log("[SectionAreaItem<"+this.id+">::show]");
this.setIsShow(true)
};
w.prototype.hide=function(){console.log("[SectionAreaItem<"+this.id+">::hide]");
this.setIsShow(false)
};
w.prototype.setIsShow=function(y){if(y===this.isShow){return
}this.isShow=y;
if(this.isShow){this.area.removeClass("hidden")
}else{this.area.addClass("hidden")
}};
w.prototype.append=function(y){this.area.append(y)
};
return w
})();
q=(function(){function w(x){this.id=x;
this.resetNextAreaClass()
}w.prototype.resetNextAreaClass=function(){return this.areaClassIndex=-1
};
w.prototype.getNextAreaClass=function(){this.areaClassIndex++;
if(this.areaClassIndex>=areaItems.length){this.areaClassIndex=0
}return areaItems[this.areaClassIndex]
};
w.prototype.startSection=function(x){var y;
if(x==null){x=this.getNextAreaClass()
}return y=new r
};
w.prototype.append=function(x){};
return w
})();
o=(function(){var x,y;
x=0;
y=0;
function w(G,F){var C,D,E,H,z,A,B=this;
this.startTime=G!=null?G:window.Date.now();
this.sectionAreas=F!=null?F:["area1","area2"];
this.scrapClass="scrap"+(++y);
console.log("スクラップ追加",[this.scrapClass]);
$("#"+this.scrapClass).remove();
this.scrapArea=$("<div />");
this.scrapArea.attr({id:this.scrapClass,"class":"scrap"});
this.scrapArea.appendTo(h());
this.playDeferred=$.Deferred();
this.playedDeferred=$.Deferred();
this.closedDeferred=$.Deferred();
this.closeingDeferred=$.Deferred();
this.playDeferred.fail(function(){return B.playedDeferred.reject()
});
this.closeingDeferred.always(function(){var L,M,N,I,J,K;
B.playDeferred.reject();
B.playedDeferred.reject();
M=1;
L=function(){M--;
console.log("終了チェック",[M]);
if(M>0){return
}B.scrapArea.remove();
console.log("終了！");
return B.closedDeferred.resolve()
};
K=B.areaCloseAnimes;
for(I=0,J=K.length;
I<J;
I++){N=K[I];
M++;
N.promise().always(L);
N.reject()
}M--;
return L()
});
this.nextArea={};
for(C=z=0,A=this.sectionAreas.length;
0<=A?z<A:z>A;
C=0<=A?++z:--z){D=C+1;
if(D>=this.sectionAreas.length){D=0
}E=this.sectionAreas[C];
H=this.sectionAreas[D];
this.nextArea[E]=H
}this.p=void 0;
this.area=void 0;
this.areaClass=void 0;
this.areaCloseAnimes=[]
}w.prototype.state=function(){if(this.closedDeferred.state()!=="pending"){return"close"
}if(this.closeingDeferred.state()!=="pending"){return"closeing"
}if(this.playedDeferred.state()!=="pending"){return"played"
}return"play"
};
w.prototype.playedPromise=function(){return this.playedDeferred.promise()
};
w.prototype.closedPromise=function(){return this.closedDeferred.promise()
};
w.prototype.played=function(z){return this.playDeferred.resolve(z)
};
w.prototype.close=function(z){return this.closeingDeferred.reject(z)
};
w.prototype.closeScrap=function(){this.endSection();
return this.calcWait(this.scrapArea)
};
w.prototype.calcWait=function(z){var A,B,C,D,E;
if(z==null){z=this.scrapArea
}D=void 0;
E=0;
B=function(F,G){return F.attr({"data-wait-ms":G})
};
A=function(){if(!(D!=null)){return
}B(D,E);
D=void 0;
E=0
};
$("span.waiting",z).each(function(){var F,G,H;
F=$(this);
H=F.data("waitType");
G=v[H];
if(!(G!=null)){G=0
}B(F,G);
return;
if(H==="c"){A();
B(F,G);
return
}if(G<E){A()
}B(F,n);
D=F;
E=G
});
C=0;
$("span.waiting",z).each(function(){var F,G;
F=$(this);
F.textHide();
G=F.data("waitMs");
F.attr("data-start-time",C);
return C+=G
});
return console.log("[会話",[this.scrapClass],"] 終了")
};
w.prototype.run=function(){var E,z,A,B,C,D;
D=Date.now();
console.log(isodate.format(new Date(D)),": !!START!!");
C=0;
z=0;
E=this;
A=$("span.waiting",this.scrapArea);
B=A.length-1;
A.each(function(){var F,G,H,I,J,K,L,M,N;
G=$(this);
M=G.data("startTime");
L=G.text();
N=D+M;
J=z++;
H=G.data("emote");
I=function(){return E.playedDeferred.resolve()
};
K=I;
F=$.Deferred();
F.done(function(){var O;
if(E.state()!=="play"){return
}if((O=$.emote)!=null){if(typeof O[H]==="function"){O[H]()
}}G.textShow(t);
if(J===B){E.playedDeferred.resolve()
}});
E.playDeferred.done(function(){return F.resolve()
});
$.timestamp(N,true).done(function(){return F.resolve()
});
C=M;
return true
});
return this.playDeferred
};
w.prototype.endSection=function(){var z;
if(!(this.area!=null)){return
}z=this.p;
this.endPeriod();
if(z!=null){this.addChar(z,"section")
}console.log("[セクション",[this.areaID],"] 終了");
this.area=void 0
};
w.prototype.section=function(A){var B,C,D,E,z=this;
this.areaClass=A!=null?A:this.nextSectionArea();
this.endSection();
console.log("[セクション",[this.areaClass],"] 開始");
E=$("<div />");
E.attr({id:"section"+(++x),"class":"section "+this.areaClass+" waiting"});
E.appendTo(this.scrapArea);
this.area=E[0];
C=$.Deferred();
B=function(){var F,G;
G={top:"-16px",opacity:0};
F={duration:s,easing:"easeInQuad"};
return E.animate(G,F).promise().done(function(){E.remove();
return C.reject()
})
};
D=$.Deferred();
D.always(B);
D.promise=C.promise;
this.areaCloseAnimes.push(D)
};
w.prototype.nextSectionArea=function(){var z;
z=this.nextArea[this.areaClass];
if(!z){return this.sectionAreas[0]
}return z
};
w.prototype.endPeriod=function(z){if(!(this.p!=null)){return
}console.log("段落閉じる：",[this.p]);
this.addChar(this.p,"period");
this.p.appendTo(this.area);
this.p=void 0
};
w.prototype.period=function(z){this.endPeriod();
this.p=$("<p />").addClass(z);
console.log("段落：",[this.p])
};
w.prototype.emote=function(A){var z;
if(!(this.p!=null)){period(this.defaultActor)
}console.log("表情:",[A]);
z=$("<span />");
z.attr({"data-emote":A,"class":"waiting"});
z.appendTo(this.p)
};
w.prototype.talk=function(C){var B,z,A;
if(!(this.p!=null)){period(this.defaultActor)
}console.log("会話:",[C]);
for(z=0,A=C.length;
z<A;
z++){B=C[z];
this.addChar(this.p,k(B),B)
}};
w.prototype.addChar=function(B,C,z){var A;
A=$("<span />");
if(z!=null){A.text(z)
}A.attr({"data-wait-type":C,"class":"waiting"});
return A.appendTo(B)
};
w.prototype.br=function(){if(!(this.p!=null)){period(this.defaultActor)
}console.log("改行:");
$("<br />").appendTo(this.p)
};
return w
})();
return o
})
}).call(this);