[← 前へ: 7 – スタンドアロン](07-standalone.md) | [目次](./README.md) | [次へ: 9 – 完全な構文 →](09-complete-syntax.md)

---

# 8 – 以前のバージョンとの非互換性

> **Source**: Lua 5.5 Reference Manual - Chapter 8 (Incompatibilities with the Previous Version)
> **Translation**: AI-generated from Lua 5.5 English source
> **Glossary**: See [GLOSSARY.md](GLOSSARY.md) for terminology

---

ここでは、Lua 5.4からLua 5.5にプログラムを移行する際に発生する可能性のある非互換性をリストします。

適切なオプションを使用してLuaをコンパイルすることにより、いくつかの非互換性を回避できます（ファイル`luaconf.h`を参照）。ただし、これらの互換性オプションはすべて将来削除されます。多くの場合、互換性の問題は、これらの互換性オプションが削除されたときに発生します。したがって、機会があれば、すべての互換性オプションをオフにしてコンパイルされたLuaのバージョンでコードをテストするようにしてください。これにより、Luaの新しいバージョンへの移行が容易になります。

Luaのバージョンでは、定数の数値や関数をマクロとして実装するなど、プログラムのソースコードの変更を意味しない方法で、C APIを常に変更できます。したがって、異なるLuaバージョン間でバイナリが互換性があると想定しないでください。新しいバージョンを使用する場合は、常にLua APIのクライアントを再コンパイルしてください。

同様に、Luaのバージョンでは、プリコンパイルされたチャンクの内部表現を常に変更できます。プリコンパイルされたチャンクは、異なるLuaバージョン間では互換性がありません。

公式ディストリビューションの標準パスは、バージョン間で変更される可能性があります。

---

## 8.1 – 言語の非互換性

- **`global`が予約語に**:
  `global`という単語は予約語になりました。通常の名前として使用しないでください。

- **forループの制御変数が読み取り専用に**:
  **for**ループの制御変数は読み取り専用になりました。変更する必要がある場合は、ループ本体内に同じ名前のローカル変数を宣言してください。

- **`__call`メタメソッドのチェーン制限**:
  `__call`メタメソッドのチェーンは最大15オブジェクトまでです。

- **nilエラーオブジェクトの置換**:
  エラーにおいて、エラーオブジェクトとしての**nil**は文字列メッセージに置き換えられます。

---

## 8.2 – ライブラリの非互換性

- **ガベージコレクションパラメータの設定方法変更**:
  ガベージコレクションのパラメータは、オプション"`incremental`"と"`generational`"では設定されなくなりました。代わりに、新しいオプション"`param`"を使用します。さらに、パラメータ自体にもいくつかの変更がありました。

---

## 8.3 – APIの非互換性

- **lua_call等の結果数制限**:
  `lua_call`および関連する関数において、必要な結果の数（`nresults`）の最大値は250です。より大きな値が本当に必要な場合は、`LUA_MULTRET`を使用してからスタックサイズを調整してください。以前は、この制限は未規定でした。

- **lua_newstateに第3パラメータ追加**:
  `lua_newstate`は第3パラメータを持つようになりました。これは文字列のハッシュ化のためのシードです。

- **lua_resetthread非推奨**:
  関数`lua_resetthread`は非推奨になりました。これは`from`が`NULL`である`lua_closethread`と同等です。

- **lua_setcstacklimit非推奨**:
  関数`lua_setcstacklimit`は非推奨になりました。この呼び出しは単純に削除できます。

- **lua_dumpの動作変更**:
  関数`lua_dump`は、writer関数への呼び出しを通じてスタックを保持する方法を変更しました。（これは以前のバージョンでは未規定でした。）また、ダンプの終了を通知するために、writer関数を1回追加で呼び出します。

- **GCパラメータ設定オプション変更**:
  ガベージコレクションのパラメータは、オプション`LUA_GCINC`と`LUA_GCGEN`では設定されなくなりました。代わりに、新しいオプション`LUA_GCPARAM`を使用します。さらに、パラメータ自体にもいくつかの変更がありました。

- **lua_pushvfstringのエラー報告方法変更**:
  関数`lua_pushvfstring`は、エラーを発生させる代わりに報告するようになりました。

---

## Lua 5.5 非互換性まとめ

### 言語レベル

| 変更点 | 影響 | 対処法 |
|--------|------|--------|
| `global`が予約語 | 変数名として使用不可 | 別の名前を使用 |
| for制御変数が読み取り専用 | ループ内で変更不可 | ループ本体でローカル変数を宣言 |
| `__call`チェーン最大15 | 深い呼び出しチェーンが制限 | 設計を見直す |
| nilエラーが文字列に置換 | エラーハンドリングに影響 | nil以外のエラーオブジェクトを使用 |

### ライブラリレベル

| 変更点 | 影響 | 対処法 |
|--------|------|--------|
| `collectgarbage`パラメータ | `"incremental"`等でパラメータ設定不可 | `"param"`オプションを使用 |

### APIレベル

| 変更点 | 影響 | 対処法 |
|--------|------|--------|
| `nresults`最大250 | 250以上の戻り値取得不可 | `LUA_MULTRET`を使用 |
| `lua_newstate`第3引数 | シグネチャ変更 | シードパラメータを追加 |
| `lua_resetthread`非推奨 | 関数削除予定 | `lua_closethread`を使用 |
| `lua_setcstacklimit`非推奨 | 関数削除予定 | 呼び出しを削除 |
| `lua_dump`動作変更 | writer関数の呼び出しパターン変更 | 終了シグナルを処理 |
| `LUA_GCINC/GCGEN`変更 | パラメータ設定方法変更 | `LUA_GCPARAM`を使用 |
| `lua_pushvfstring`変更 | エラー報告方法変更 | 戻り値を確認 |

---

> **Note**: Lua 5.4からLua 5.5への移行では、主に`global`キーワードの予約語化と
> ガベージコレクションAPIの変更に注意が必要です。
