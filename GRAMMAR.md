# Pasta DSL Grammar Reference

Pasta DSLは、里々/さとりにインスパイアされた対話スクリプト記述言語です。このドキュメントでは、Pasta DSLの文法とその使用方法について説明します。

> **権威的仕様書**: 実装判断の根拠は [SPECIFICATION.md](SPECIFICATION.md) を参照してください。本ドキュメントは学習用のクイックリファレンスです。

## 目次

1. [基本構文](#基本構文)
2. [シーン定義](#シーン定義)
3. [アクション行（発言文）](#アクション行発言文)
4. [属性](#属性)
5. [変数](#変数)
6. [制御構文](#制御構文)
7. [単語定義と参照](#単語定義と参照)
8. [さくらスクリプト](#さくらスクリプト)
9. [Runeコードブロック](#runeコードブロック)
10. [コメント](#コメント)
11. [リテラル型](#リテラル型)

---

## 基本構文

### ファイル構造

Pastaスクリプトは**行指向文法**です。行頭の数文字により行属性が確定します。

```
ファイル
├─ グローバル単語定義 (＠)
├─ グローバルシーン (＊)
│   ├─ 属性行 (＆)
│   ├─ ローカル単語定義 (＠)
│   ├─ アクション行
│   ├─ 変数代入 (＄)
│   ├─ Call行 (＞)
│   ├─ ローカルシーン (・)
│   └─ Runeブロック
└─ コメント行 (＃)
```

### マーカー一覧（全角/半角両対応）

| マーカー | 全角 | 半角 | 用途 |
|---------|------|------|------|
| グローバルシーン | `＊` | `*` | シーン定義 |
| ローカルシーン | `・` | `-` | サブシーン定義 |
| 属性 | `＆` | `&` | メタデータ |
| 単語/関数 | `＠` | `@` | 単語定義・参照・関数呼び出し |
| 変数 | `＄` | `$` | 変数宣言・参照 |
| Call | `＞` | `>` | シーン呼び出し |
| コメント | `＃` | `#` | コメント行 |
| コロン | `：` | `:` | 区切り |

### 空白

- 空白文字は、UnicodeのWhite_Spaceカテゴリの文字から、改行コード`\r``\n`を除いたものとします
- 半角スペース、全角スペース、タブなどが含まれます

### インデント

- シーン配下のステートメントは**インデント**（空白文字）で字下げします
- インデントレベルが一貫している必要は**ありません**
- **インデントの有無**のみで判定します（深さは判定不要）

---

## シーン定義

### グローバルシーン

グローバルシーンは、行頭が`＊`（全角アスタリスク）または`*`で始まります。

```pasta
＊挨拶
    さくら：こんにちは！
    うにゅう：やあ！
```

### ローカルシーン

ローカルシーンは、親シーン内でのみアクセス可能で、インデント＋`・`または`-`で始まります。

```pasta
＊メインメニュー
    さくら：何をしますか？

    ・選択肢1
        さくら：選択肢1が選ばれました

    ・選択肢2
        さくら：選択肢2が選ばれました
```

### シーンの重複（前方一致によるランダム選択）

同じ名前のシーンを複数定義できます。実行時にランダムに1つが選択されます。

```pasta
＊挨拶
    さくら：おはよう！

＊挨拶
    さくら：こんにちは！

＊挨拶
    さくら：こんばんは！
```

シーン呼び出しは**前方一致**で候補を列挙します：

- `＞挨拶` では「挨拶」で始まるすべてのシーンが候補
- 候補からランダムに選択されます

### 予約パターン

`__*__` パターン（例：`__start__`）はシステム予約です。使用できません。

---

## アクション行（発言文）

### 基本形式

```
アクター名：アクション内容
```

例：
```pasta
＊会話
    さくら：今日はいい天気だね
    うにゅう：そうだね、散歩に行こうか
```

### アクターの省略

一度アクターを指定すると、次の発言でアクターを省略できます。

```pasta
＊長い会話
    さくら：今日はね
    ：とてもいい天気なんだ
    ：だから散歩に行こうと思ってるんだ

    うにゅう：いいね！
    ：一緒に行こう！
```

### インライン要素

アクション行内に埋め込み可能な要素：

| 要素 | 構文 | 説明 |
|------|------|------|
| 通常テキスト | `こんにちは` | 任意の文字列 |
| 単語参照 | `＠word_name` | 登録済み単語からランダム選択 |
| ＠エスケープ | `＠＠` | リテラルの「＠」を1文字出力 |
| 変数参照 | `＄var_name` | 変数値を展開 |
| 関数呼び出し | `＠func_name()` | Rune関数を呼び出し |
| Sakuraスクリプト | `\n`, `\w8`, `\s[0]` | 表情・タイミング制御 |

### 行継続

複数行にわたるアクション：

```pasta
＊長文
    さくら：長い台詞は
        複数行に分けて
        記述できます
```

継続行はインデント付きで、行マーカー（＄＠＞＆＊・）で始めてはなりません。

---

## 属性

### 属性の設定

属性は、`＆属性名：値`の形式で設定します。**シーン定義の直後にのみ**記載できます。

```pasta
＊会話
    ＆author：Alice
    ＆genre：comedy
    さくら：こんにちは！
```

### 配置ルール

- グローバルシーンの直後：グローバルシーンに属性を付与
- ローカルシーンの直後：ローカルシーンに属性を付与
- アクション行や変数代入行の後には配置**できません**

```pasta
＊選択肢
    ＆priority：high
    ・選択肢1
        ＆difficulty：3
        さくら：選択肢1です
```

---

## 変数

### 変数宣言と代入

変数は、`＄変数名：値`の形式で設定します。

```pasta
＊初期化
    ＄score：100
    ＄ユーザー：太郎
    ＄is_active：true
```

### 変数スコープ

| スコープ | 宣言 | 参照 | 有効範囲 |
|---------|------|------|---------|
| ローカル | `＄var_name＝値` | `＄var_name` | 一連のシーンが終わるまで |
| グローバル | `＄＊var_name＝値` | `＄＊var_name` | 永続的 |

### 変数参照

会話行の中で`＄変数名`とすると、変数の内容が展開されます。

```pasta
＊表示
    ＄ユーザー：太郎
    さくら：＄ユーザー　さん、こんにちは！
```

### 式（Expression）のサポート

**Pasta DSLでは式を記述できます**。変数代入、関数引数などで式を使用できます：

```pasta
# ✅ 許可される構文
＄score＝100                    # リテラル値
＄value＝＠word_name            # 単語参照
＄new_var＝＄old_var            # 変数参照
＄result＝＠calculate()         # 関数呼び出し
＄sum＝＄a + ＄b                 # 算術式
＄calc＝（＄x + ＄y）* 2        # 括弧による優先順位制御
```

### 対応演算子

| 種別 | 演算子（全角/半角） |
|------|-------------------|
| 加算 | `+` / `＋` |
| 減算 | `-` / `－` |
| 乗算 | `*` / `＊` / `×` |
| 除算 | `/` / `／` / `÷` |
| 剰余 | `%` / `％` |

複雑な演算や条件判定が必要な場合は、Runeブロックで関数を定義することも可能です。

詳細は SPECIFICATION.md 1.3節を参照。

---

## 制御構文

Pasta DSLは**宣言的言語**であり、命令型制御構文（if/while等）は含みません。コントロールフローは**Call文**と**シーン定義**で実現します。

> **破壊的変更 (Phase 1)**: Jump文（`？`）は廃止されました。すべての制御フローにはCall文（`＞`）を使用してください。

### Call文（サブルーチン呼び出し）

Call文は他のシーンを呼び出し、実行後に元の場所に戻ります。

```pasta
＊メイン
    さくら：自己紹介を始めます
    ＞自己紹介
    さくら：自己紹介が終わりました

    ・自己紹介
        さくら：私はさくらです
```

### Callターゲットの形式

| 形式 | 構文 | 説明 |
|------|------|------|
| シーン参照 | `＞シーン名` | アクションスコープから参照できるローカル・グローバルシーン全てから選択 |
| 動的ターゲット | `＞＄変数名` | 変数値をシーン名として解決 |

```pasta
＊スタート
    ＞次のステップ              # シーン参照（ローカル・グローバルシーンから選択）

    ・次のステップ
        さくら：次のステップに来ました
```

### 条件分岐の実現

条件分岐はRuneブロック内で実装し、`pasta::call()` を使用して分岐します。

````pasta
＊メイン
    ＄スコア：75

```rune
fn 分岐判定(ctx, args) {
    let スコア = ctx.var.スコア;
    let label =
        if スコア >= 90 { "優秀" }
        else if スコア >= 50 { "合格" }
        else { "不合格" };
    for a in crate::pasta::call(ctx, label, #{}, ()) { yield a; }
}
```

    ＞＠分岐判定

    ・優秀
        さくら：優秀です！

    ・合格
        さくら：合格です

    ・不合格
        さくら：不合格です
````

---

## 単語定義と参照

### 概要

単語定義は、テキストのバリエーションをランダムに選択するための機能です。定義された単語群からランダムに1つを選択することで、会話に自然な多様性を持たせることができます。

### グローバル単語定義

ファイルの先頭（シーン定義の前）にインデントなしで`＠単語キー：値1　値2　値3`形式で登録します。グローバル単語定義はファイル全体から参照可能です。

```pasta
# グローバル単語定義（ファイル先頭）
＠挨拶朝：おはよう　ハロー　Good morning
＠挨拶昼：こんにちは

＊メイン
    さくら：＠挨拶朝　！
```

### ローカル単語定義

グローバルシーン内でインデントありで登録します。**シーンの先頭**に配置し、会話行より前に定義してください。

```pasta
＊メイン
    ＠挨拶朝：Hello　Good morning
    さくら：＠挨拶朝　！
```

> **Note**: ローカル単語定義は、そのグローバルシーン内でのみ参照可能です。

### スコープと優先順位

単語参照時の検索順序：

1. **ローカル単語辞書** - 現在のシーン内で定義された単語
2. **グローバル単語辞書** - ファイル先頭で定義された単語

同名の単語がローカルとグローバルの両方に存在する場合、**マージ**されて候補プールが統合されます。

```pasta
＠挨拶：グローバル挨拶

＊メイン
    ＠挨拶：ローカル挨拶
    さくら：＠挨拶　！  # 「グローバル挨拶」または「ローカル挨拶」が選ばれる
```

### 単語の呼び出し（インライン参照）

会話行の中で`＠単語キー`とすると、一致する単語からランダムに1つ選択されます。

```pasta
＠挨拶朝：おはよう　ハロー
＠挨拶昼：こんちわ
＊メイン
    ＠挨拶朝：Hello
    さくら：＠挨拶昼　。
    うにゅう：＠挨拶　。
```

- `＠挨拶昼` → 候補は「こんちわ」のみ
- `＠挨拶` → 前方一致により候補は「おはよう、ハロー、こんちわ、Hello」

### 前方一致検索

単語参照は**前方一致**で候補を検索します。これにより、関連する単語群を一括で参照できます。

```pasta
＠挨拶：こんにちは　ハロー
＠挨拶_朝：おはよう　グッドモーニング
＠挨拶_夕：こんばんは　Good evening

＊会話
    さくら：＠挨拶　       # 全9候補からランダム選択
    さくら：＠挨拶_朝　    # 「おはよう」「グッドモーニング」から選択
    さくら：＠挨拶_夕　    # 「こんばんは」「Good evening」から選択
```

前方一致の動作：
- `＠挨` → 「挨拶」「挨拶_朝」「挨拶_夕」すべてにマッチ
- `＠挨拶_朝` → 「挨拶_朝」のみにマッチ

### Call/Jump文からの分離

**重要**: Call文（`＞`）は**シーン辞書のみ**を検索し、単語辞書は参照しません。同様に、単語参照（`＠`）はシーン辞書を参照しません。

```pasta
＠挨拶：こんにちは  # 単語定義

＊挨拶              # シーン定義
    さくら：やあ！

＊メイン
    さくら：＠挨拶　   # 単語辞書から「こんにちは」を取得
    ＞挨拶           # シーン参照（「挨拶」シーンを呼び出し）
```

### 未定義単語の参照

存在しない単語キーを参照した場合、**空文字列**が返されます（エラーにはなりません）。ログに警告メッセージが出力されます。

```pasta
＊テスト
    さくら：＠存在しない単語　  # 空文字列として展開される
```

### ＠エスケープ

`＠＠`と書くと、リテラルの「＠」が1文字出力されます。

```pasta
＊メール
    さくら：メールは user＠＠example.com 　です
```

### 引用符エスケープ

単語値に引用符を含める場合は、二重の括弧を使用します：

```pasta
＠会話：「「セリフ」」  # 実行時に「セリフ」として展開される
```

- 外側の`「」`は単語値の区切り
- 内側の`「」`はリテラルの引用符として保持される

---

## さくらスクリプト

Pastaは、さくらスクリプトのエスケープシーケンスを**そのまま**IR出力に含めます。解釈はareka層が行います。

> **破壊的変更 (Phase 1)**: さくらスクリプトのエスケープは**半角のみ**サポートされます。
> - バックスラッシュ: `\` のみ（`＼` は不可）
> - 括弧: `[` と `]` のみ（`［` と `］` は不可）

### 字句構造

```
sakura_command   ::= "\" ~ sakura_token ~ bracket_content?
sakura_token     ::= [!_a-zA-Z0-9]+
bracket_content  ::= "[" ~ bracket_chars ~ "]"
bracket_chars    ::= ( "\\]" | [^\]] )*
```

### 使用例

```pasta
＊表情変更
    さくら：\s[0]こんにちは！
    さくら：\s[4]元気だよ
    さくら：\s[1]\w8それで\w8ね...

＊改行とウェイト
    さくら：最初の行\n次の行\n\w9最後の行

＊ブラケットエスケープ
    さくら：配列参照\s[a\]b]
```

### 角括弧内のエスケープ

- `\]` で `]` を文字として含める
- カンマを含む値はダブルクォートで囲む: `\![raise,OnTest,"100,2"]`
- ダブルクォートを含める場合は二重にする: `\![call,ghost,"the ""Name"""]`

---

## Runeコードブロック

Runeブロックを使用して、ローカル関数を定義できます。

### 構文

````pasta
＊シーン名
```rune
fn 関数名(ctx, args) {
    # Runeコード
}
```
````

または `rune` 接尾辞なし:

````pasta
＊シーン名
```
fn 関数名(ctx, args) {
    # Runeコード
}
```
````

### 制約

- **関数定義のみ許可**: `fn ...` で始まる関数定義のみ記述可能
- **ステートメント不可**: `let x = 10;` などの直接的なステートメントは許可されません
- **インデント不要**: Runeブロックはインデントなしで記述可能（直前のグローバルシーンに属します）

### 例

````pasta
＊計算
```rune
fn calculate(ctx, args) {
    let result = 10 + 20;
    result
}

fn greet(ctx, args) {
    yield ctx.emit_text("こんにちは！");
}
```
    さくら：計算結果は＠calculate()　です
````

---

## コメント

### 行コメント

`#` または `＃` から行末までがコメントとして扱われます。

```pasta
＊テスト
    # これはコメントです
    さくら：これは実行されます
    ＃ 全角シャープでもOK
```

コメント行はあらゆる位置に配置可能で、構造・セマンティクスに影響しません。

---

## リテラル型

### 型変換ルール

リテラル値は以下の優先順位で型変換されます：

| 優先度 | 値 | 型 |
|-------|-----|-----|
| 1 | `true` / `false` | bool |
| 2 | `「...」` | String（引用符あり） |
| 3 | 小数点を含む数値 | f64 |
| 4 | 小数点なしの数値 | i64 |
| 5 | その他 | String |

### 文字列リテラル

```pasta
# 日本語文字列
＄greeting：「こんにちは」

# 英語文字列
＄message："Hello, World!"
```

空白を含む文字列は引用符で囲む必要があります。

---

## エラーハンドリング

### パースエラー

文法エラーが発生すると、行番号とカラム位置を含むエラーが返されます。

```
Parse error at <script>:5:10: Expected ':' after speaker name
```

### シーン未発見エラー

存在しないシーンを実行しようとすると、`LabelNotFound`エラーが返されます。

```
Label not found: 存在しないシーン名
```

### ランタイムエラー

実行中のエラーは`ScriptEvent::Error`として yield されます。

---

## 参考資料

- [SPECIFICATION.md](SPECIFICATION.md) - 権威的仕様書（全11章）
- [サンプルスクリプト](examples/)
- [API ドキュメント](https://docs.rs/pasta)

---

**Pasta DSL** - 里々/さとりにインスパイアされた、シンプルで強力な対話スクリプト言語
