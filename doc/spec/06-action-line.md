# 6. アクション行（Action Line）

## 6.1 基本構文

```
actor ： action [NEWLINE continuation_line*]
```

## 6.2 Actor（アクター）

**形式**: コロン前のテキスト（任意の非改行文字）

**説明**: アクター名を指定。会話テキストだけでなく、Sakuraスクリプトによる表情指定など、アクション全般を制御。

**例**:
```
Alice：...
キャラクターA：...
```

## 6.3 Action（アクション）

アクション内容は通常テキストと**インライン要素**の組み合わせで構成される。

### インライン要素

アクション行内に埋め込み可能な要素：

| 要素                 | 構文                 | 説明                         |
| -------------------- | -------------------- | ---------------------------- |
| 通常テキスト         | `こんにちは`         | 任意の文字列                 |
| 単語参照             | `＠word_name`        | 登録済み単語からランダム選択 |
| 単語参照（動的）     | `＠＄var_name`       | 変数値を単語名として参照     |
| ＠エスケープ         | `＠＠`               | リテラルの「＠」を1文字出力  |
| 変数参照             | `＄var_name`         | 変数値を展開                 |
| 関数呼び出し         | `＠func_name()`      | Lua関数を呼び出し            |
| 関数呼び出し（引数） | `＠func（x：10）`    | 名前付き引数で呼び出し       |
| Sakura スクリプト    | `\n`, `\w8`, `\s[0]` | 表情・タイミング制御         |

Sakura スクリプトはアクション行のインライン要素の一つであり、詳細は [Chapter 7: Sakura スクリプト仕様](07-sakura-script.md) を参照。

**インライン判定ルール**: 行を左から右へ走査し、マーカー文字列（例：`\`、`＠`、`＄`）で分岐して各インライン要素を最長一致で切り出す。いずれのインライン要素構文にも一致しない場合のみ、残余を通常テキストとして確定する。

**例**:
```
Alice：こんにちは、＄player_name　さん！\w8
Bob：今日の天気は＠weather_words　ですね\n
Carol：＠greet（time：morning）
```

**重要**: 変数宣言（`＄var：value`）は専用の変数宣言行で行う。アクション内では変数参照（`＄var`）のみ可能。

### インライン要素の区切り文字

**目的**: アクション内のインライン要素（＠、＄）の終端と区切りの扱いを定義する。

#### 空白による区切り

インライン要素の識別子認識において、空白は**トークン区切り**として利用できる。

```
＠挨拶　みんな！         → 単語参照「挨拶」+ 通常テキスト「みんな！」
＠挨拶　　　　みんな！   → 同じ出力（空白数は無関係）
＄name　さん            → 変数参照「name」+ 通常テキスト「さん」
```

**ルール**:
- 空白はトークン区切りとして認識され、空白数に関わらず1トークンとして扱う
- トークン区切りの空白は出力に含まれない
- 空白がない場合は最長一致で識別子を切り出す（識別子に含まれない文字が現れるまで）

#### 空白なしの場合（最長一致）

空白で区切られない場合、識別子（前述の「識別子（Identifier）」定義に従う）として認識できない文字が現れるまでを**最長一致**で切り出す。

```
＠挨拶、みんな！   → インライン単語「＠挨拶」 + 通常テキスト「、みんな！」
＄name!          → 変数参照「＄name」 + 通常テキスト「!」
＠weather_wordsですね → 最長一致により識別子「＠weather_wordsですね」として扱われる（意図しない吸収の例）
※ 正しく分割したい場合は区切りを入れる：
  - 空白で分割: 「＠weather_words　ですね」
  - 非識別子記号で分割: 「＠weather_words、ですね」（読点「、」は識別子に含まれない）
```

**備考**: インライン要素の一覧は 6.3 を参照。行継続のルールは 6.4 を参照。

---

## 6.4 行継続

複数行にわたるアクション：

```
Alice：長い台詞は
  複数行に分けて
  記述できます
```

**構文**:
```
continuation_line ::= INDENT ~ !(statement_marker) ~ content
statement_marker ::= "＄" | "＠" | "＞" | "＆" | "＊" | "・"
```

**セマンティクス**: インデント付き行は前行の続きとして連結

**制約**: 継続行は行マーカー（＄＠＞＆＊・）で始めてはならない。これらで始まる場合は別の行種として解釈される。

---

## 6.5 改行

### 6.5.1 概要

アクション行のテキスト内における改行の取り扱いを定義する。

### 6.5.2 正規の改行（Sakura）

- Sakura スクリプトの `\n` は常に「改行」として解釈する（[Chapter 7](07-sakura-script.md) 参照）。
- 出力時に改行文字として挿入される。

### 6.5.3 糖衣構文（継続行内の空行）

- 6.4 で定義される「行継続」領域において、インデントのみで内容のない行（空白だけ、または純粋な空行）を「改行」として解釈する。
- 連続する空行は、その数に応じた連続改行として出力される。

**文法追加**:
```
continuation_line_newline ::= INDENT ~ NEWLINE
```

**セマンティクス**:
- `continuation_line_newline` は 1 改行として動作する。
- 空白（INDENT）は出力には含まれない（[2.1](02-markers.md) の原則継承）。

**例**:
```
Alice：１行目。
  １行目の続き。
  
  ２行目。
```
→ 出力は「１行目。\n２行目。」（空行が 1 改行として解釈）

### 6.5.4 非継続領域の空行

- 継続行以外（インデントなしの空行、シーン直後の空行など）は、改行としては解釈しない。レイアウト目的の空白として無視する。

**備考**:
- 詳細な整形やタイミング制御は Sakura スクリプトのコマンド（例：`\w`）を推奨。
- 改行仕様は 6.4（行継続）と併せて適用される。

---

**関連章**:
- [Chapter 2: キーワード・マーカー定義](02-markers.md) - 識別子の定義
- [Chapter 7: Sakura スクリプト仕様](07-sakura-script.md) - インラインコマンド
- [Chapter 9: 変数・スコープ](09-variables.md) - 変数参照
- [Chapter 10: 単語定義](10-words.md) - 単語参照
