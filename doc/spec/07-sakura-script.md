# 7. Sakura スクリプト仕様

## 7.1 概要

Sakura スクリプトは、アクション行内にインラインで埋め込まれる「\」から始まるコマンドトークンです。Pasta はコマンドの種類や意味を解釈しません。必要なのは**コマンド記述ルール（字句構造）**のみで、検出後はそのまま透過します。

## 7.2 エスケープ文字

```pest
エスケープ ::= "\""
```

**重要**: 厳密に半角バックスラッシュ（\）のみ。全角は不可。

## 7.3 コマンドの字句構造（簡略版）

- 目的: 「\」から始まるコマンドの最小必要ルールのみ定義します。コマンドの意味は解釈しません（未知トークンも受理）。

**構文（字句）**:
```pest
sakura_command   ::= "\" ~ sakura_token ~ bracket_content?
sakura_token     ::= [!\-+*?&_a-zA-Z0-9]+     // 数字開始可、'!' と '_' を含めたASCIIトークン + ukadoc記号文字
bracket_content  ::= "[" ~ bracket_chars ~ "]"
bracket_chars    ::= ( "\\]" | [^\]] )* // 非エスケープな ']' で閉じる。 '\]' は文字 ']'。
```

**説明**:
- `sakura_token` は ASCII 英数字 + `_` + `!` + `-` + `+` + `*` + `?` + `&` の連続。先頭が数字でもよい。
- 角括弧内容は**非ネスト**前提で、最初の「非エスケープな `]`」で閉じます（`\]`は内容文字として扱う）。
- 角括弧内で `,` や `"` を値に含めるための ukadoc の**引用規則**（第2引数以降の `"..."`、内部 `"` を二重にする）はそのまま透過します。Pasta は中身を構文解析しません。

**制約と代替方針**:
- Pasta はさくらスクリプトの複雑な構文（入れ子、特殊な引数構成、高度なエスケープの相互作用）を検出・解釈しません。
- そのような複雑さが必要な場合は、Lua 関数を呼び出して必要なトークン列（さくらスクリプトを含む文字列）を生成し、アクション行へ挿入する運用を推奨します。
- 例: `＠emit_complex_sakura()` が `"\![embed,OnTalk]"` 等の文字列を返し、それをアクションに連結して使用する。

## 7.4 文字種（簡略）

- コマンドトークンは**ASCII**（英数字・`_`・`!`・`-`・`+`・`*`・`?`・`&`）を対象とします。
- 括弧は**半角**の `[` と `]` を対象とします（全角括弧はコマンド括弧として扱わない）。
- エスケープは**半角**バックスラッシュ `\` のみ（全角不可）。

### 7.4.1 `sakura_token` 文字クラスの同期箇所

`sakura_token` の文字クラスを変更する場合、以下の4箇所を**必ず同時に**更新すること:

| # | ファイル | 場所 | 形式 |
|---|---------|------|------|
| 1 | `doc/spec/07-sakura-script.md` | §7.3 sakura_token定義 | EBNF文字クラス |
| 2 | `GRAMMAR.md` | sakura_token定義 | EBNF文字クラス |
| 3 | `crates/pasta_core/src/parser/grammar.pest` | sakura_idルール | Pest ordered choice |
| 4 | `crates/pasta_lua/src/sakura_script/tokenizer.rs` | SAKURA_TAG_PATTERN | Rust regex文字クラス |

## 7.5 使用例

```pasta
Alice：こんにちは\w8。\n返事してください。
Bob：\![happy]了解しました。
```

---

**関連章**:
- [Chapter 2: キーワード・マーカー定義](02-markers.md) - エスケープ文字
- [Chapter 6: アクション行](06-action-line.md) - インライン要素
- [Chapter 12: 未確定事項](12-future.md) - Sakuraスクリプト括弧内のエスケープ（12.16）
