# 2. キーワード・マーカー定義

## 2.1 基本要素

### 改行（NEWLINE）

```pest
改行 ::= "\r\n" | "\n" | "\r"
```

**セマンティクス**:
- 行の終わりを明示する
- 行指向文法では改行により行属性が確定する
- すべての行要素は改行で終わる

### 空白（WHITE_SPACE 文字クラス）

Pasta では空白をトークンとして扱う可能性があるため、Pest の `WHITE_SPACE` 文字クラスを使用します。ただし、Pasta は行指向文法であるため、改行文字（`\r`, `\n`）は空白から除外します。

**重要**: これは Pest の WHITESPACE ルール（トークン自動スキップ）ではなく、明示的に処理される文字クラスです。

**構成** (改行を除外):
- 半角スペース：` `（U+0020）
- タブ：`\t`（U+0009）
- 全角スペース：`　`（U+3000）
- その他 Unicode 空白：U+00A0, U+1680, U+2000-U+200A, U+202F, U+205F

**セマンティクス**:
- 空白が許可される文脈において、1つ以上の連続白文字（改行を除く）はすべて消費されて、1つの「空白」トークンとして扱われます
- 改行は意図的に除外され、行の区切り文字として機能します
- 空白は有効なトークン区切り文字であり、Pest の自動スキップ対象ではありません

### コロン（Colon）

```pest
コロン ::= "：" | ":"
```

**セマンティクス**: キー・値ペア形式（key ： value）の汎用区切り文字

**設計原則**: コロンは**キー：バリュー関係**を表す場合にのみ使用します。比較・フィルター条件には比較演算子（＝、＞、＜など）を使用します。

**用途**:
- 変数代入：`＄var_name ： value`
- 単語定義：`＠word_name ： value1、value2`
- 属性定義：`＆key ： value`
- アクション行：`actor ： action`
- 引数リスト（関数呼び出し）：`＠func（arg1：value1　arg2：value2）`

### 識別子（Identifier）

```pest
識別子 ::= { XID_START ~ XID_CONTINUE* }
```

**XID_START**: Unicode Identifier Start
- ASCII: `a-z`, `A-Z`, `_`
- 日本語: 平仮名、カタカナ、漢字、ハングル等

**XID_CONTINUE**: Unicode Identifier Continue
- XID_START の全て + ASCII digits + 結合記号

**制約**:
- 予約パターン `__*__` は未使用（システム予約）
- 例：`__start__`, `__word_test__`

**切り出し規則（最長一致）**:
- 空白による区切りが無い場合、識別子は「識別子に含まれない文字」が現れるまでを最長一致で切り出す
- 例：`＠挨拶、みんな！` → 識別子は「挨拶」、以降は通常テキスト「、みんな！」

### インデント（Indent）

```pest
インデント ::= WHITE_SPACE+
```

**セマンティクス**: 行頭に存在する1つ以上の連続した空白文字。行がグローバルレベルか下層レベルかを区別します。

**重要**: インデントの有無のみが判定基準です。
- インデント深さの判定は**不要**。深さを測定・比較する必要はありません
- 単純な「有（any positive indent）/ 無（no indent）」のバイナリ判定で十分

**用途**:
- インデントなし = グローバルレベル（グローバルシーン、グローバル単語定義など）
- インデントあり（深さ問わず） = 下層レベル（グローバルシーン直下のすべての行）

**定義の参照**: [2.1 空白（WHITE_SPACE 文字クラス）](#空白white_space-文字クラス)に定義されるWHITE_SPACE文字クラスを使用。

**例**:
```pasta
＊会話               ← インデントなし（グローバルレベル）
  ＆author：Alice    ← インデントあり（下層レベル）
  ・選択肢1         ← インデントあり（下層レベル）
  Alice：おはよう    ← インデントあり（下層レベル）
```

---

## 2.2 シーン・マーカー

### グローバルシーン（Global Label Marker）

```text
グローバルシーンマーカー ::= "＊" | "*"
使用例: ＊会話 或いは *conversation
```

### ローカルシーン（Local Label Marker）

```text
ローカルシーンマーカー ::= "・" | "-"
使用例: ・選択肢1 或いは -choice1
```

### アクター辞書（Actor Dictionary Marker）

```text
アクター辞書マーカー ::= "％" | "%"
使用例: ％さくら
```

**セマンティクス**: アクター辞書の定義またはアクタースコープの指定に使用します。詳細は [Chapter 11: アクター辞書](11-actor-dictionary.md) を参照。

### 属性（Attribute Marker）

```text
属性マーカー ::= "＆" | "&"
使用例: ＆author：Alice
```

---

## 2.3 変数・関数

### 単語登録・参照・呼び出し（At Marker）

```pest
マーカー ::= "＠" | "@"
```

**3つの用法**:

| 用法                     | 構文                                    | 説明                         |
| ------------------------ | --------------------------------------- | ---------------------------- |
| 単語登録                 | `＠word_name：value1、value2`           | グローバル単語辞書に登録     |
| 単語参照                 | `＠word_name`                           | 登録済み単語値を参照         |
| 単語参照（動的）         | `＠＄var_name`                          | 変数値を単語名として間接参照 |
| 関数呼び出し             | `＠func_name()`                         | 関数を呼び出し（引数なし）   |
| 関数呼び出し（引数付き） | `＠func_name（arg1：val1　arg2：val2）` | 名前付き引数で呼び出し       |

### 変数宣言・代入（Dollar Marker）

```text
マーカー ::= "＄" | "$"
使用例: ＄my_var ： 10
```

### 変数スコープ修飾子

```text
スコープ修飾 ::= グローバルシーンマーカー
使用例: ＄＊global_var  （グローバル変数）
       ＄local_var      （ローカル変数）
```

---

## 2.4 制御フロー

### Call マーカー

```pest
Callマーカー ::= "＞" | ">"
```

**セマンティクス**: 指定シーンを呼び出し、実行後に戻る

**構文**:
```pasta
＞call_target [＆filter1＝value1＆filter2＝value2...] [arg_list]
```

詳細は [Chapter 4: Call の詳細仕様](04-call-spec.md) を参照

---

## 2.5 音声・会話

### Sakura スクリプト エスケープ

```pest
エスケープ ::= "\"
```

**重要**: Sakura スクリプトは半角ベースの記法です。エスケープ文字は厳密に半角バックスラッシュ（\）のみを使用します。

詳細は [Chapter 7: Sakura スクリプト仕様](07-sakura-script.md) を参照

---

## 2.6 Lua コードブロック

### ブロック開始

```pest
開始マーカー ::= "```" | "```lua"
```

**重要**: lua 接尾辞は任意。接尾辞を付ける場合、許可される値は「lua」のみ。

### ブロック終了

```pest
終了マーカー ::= "```"
```

**セマンティクス**: 複数行にわたり Lua VM へ直接実行されるコード

**インデント**: Lua ブロックはインデント不要です。構造上は直前のグローバルシーンに属します（インデントの有無に関わらずグローバルシーン配下として扱われます）。

**処理モデル**:
- **パーサー層（Pest）**: Luaブロックの内容は透過的に処理されます。開始マーカー `\`\`\`` または `\`\`\`lua` と終了マーカー `\`\`\`` の間をそのまま抽出するのみで、内部の文法は検証しません。
- **トランスパイラー層**: 抽出されたLuaコード文字列が、「**Lua関数定義のみからなる正式なコード**」として成立することを検証・コンパイルします。ステートメント（変数宣言、代入、制御フローなど）は許可されません。
- **許可される内容**: 関数定義（`function ...`）のみ。例：`function on_event() ... end`, `function update_state() ... end`
- **許可されない内容**: `local x = 10` のような変数宣言、直接的なステートメント、トップレベルの式など。
- **エラーハンドリング**: Lua文法に誤りがある場合、または関数定義以外のコードが含まれる場合、**トランスパイラー層以降でコンパイルエラーが発生**します。パーサー層ではエラーとなりません。

**例**:
````pasta
＊会話
```lua
function on_init(ctx)
  ctx:flag("talked", true)
end
function on_event(ctx)
  for i = 0, 9 do
    coroutine.yield(ctx:event("loop", i))
  end
end
```
````

または：
````pasta
＊会話
```
function update_state(ctx)
  ctx.score = ctx.score + 1
end
```
````

---

## 2.7 演算子

**設計原則**: すべての演算子は全角・半角の両方の形式を許容します。両者は同等に扱われます。

### 算術演算子

| 演算 | 全角        | 半角  | 備考                             |
| ---- | ----------- | ----- | -------------------------------- |
| 加算 | 「＋」      | 「+」 |                                  |
| 減算 | 「－」      | 「-」 | 数値の負号と区別注意             |
| 乗算 | 「＊」「×」 | 「*」 | 「＊」はシーンマーカーと同じ文字 |
| 除算 | 「／」「÷」 | 「/」 |                                  |
| 剰余 | 「％」      | 「%」 |                                  |

### 比較演算子

**セマンティクス**: 全角・半角は同等に扱われます。

| 演算                   | 全角     | 半角   | 備考                    |
| ---------------------- | -------- | ------ | ----------------------- |
| 等値                   | 「＝＝」 | 「==」 |                         |
| 不等                   | 「！＝」 | 「!=」 |                         |
| より小さい             | 「＜」   | 「<」  |                         |
| より大きい             | 「＞」   | 「>」  | Call マーカーと区別注意 |
| より小さいまたは等しい | 「＜＝」 | 「<=」 |                         |
| より大きいまたは等しい | 「＞＝」 | 「>=」 |                         |

### 括弧

| 種類   | 全角   | 半角  |
| ------ | ------ | ----- |
| 左括弧 | 「（」 | 「(」 |
| 右括弧 | 「）」 | 「)」 |

---

## 2.8 リテラル・文字列

### 日本語文字列

```
日本語文字列 ::= "「" ~ content ~ "」"
例: 「こんにちは」
```

### 英語文字列

```
英語文字列 ::= "\"" ~ content ~ "\""
例: "Hello"
```

**エスケープ**: バックスラッシュ `\` でエスケープ可能
- `\n` → 改行
- `\\` → バックスラッシュ
- `\"` → ダブルクォート

### 数値リテラル

```
数値 ::= ["-" | "－"] ~ 数字+ ~ ["." | "．" ~ 数字+]?

例:
  10
  -5
  3.14
  -2.5
```

**数字**: ASCII 数字（0-9）または全角数字（０-９）

---

## 2.9 単語値の区切り文字

### 区切り文字

```
区切り ::= 空白* ~ ("、" | "，" | ",") ~ 空白*
```

**セマンティクス**: 単語定義の値リストを区切る。読点（、）またはカンマ（，/,）を使用し、前後の空白は無視される。

**例**:
```
＠fruits：apple、banana、orange
＠numbers：1、2、3
＠挨拶：こんにちは、やあ、ハロー
```

注：全角読点「、」、全角カンマ「，」、半角カンマ「,」のいずれでも区切り文字として機能します。

---

## 2.10 コメント

### コメント行

```
コメント ::= "#" | "＃" ~ content ~ NEWLINE
```

**セマンティクス**: 行末までコメント（処理されない）

**例**:
```
# これはコメント
＃全角シャープでもOK
```

---

**関連章**:
- [Chapter 1: 文法モデルの基本原則](01-grammar-model.md) - 基本原則
- [Chapter 3: 行とブロック構造](03-block-structure.md) - ブロック構造
- [Chapter 4: Call の詳細仕様](04-call-spec.md) - Call 構文
