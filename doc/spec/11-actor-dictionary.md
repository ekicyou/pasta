# 11. アクター辞書（Actor Dictionary）

## 11.1 概要

アクター辞書（ActorScope）は、キャラクター（アクター）ごとに単語辞書を定義し、会話行で参照可能にする機能です。アクターごとの表情や表現のバリエーションを、アクター名を伴った単語参照として記述できます。

**設計目的**:
- アクターごとの表情や表現をアクター単位で管理
- 会話行でのアクター指定と表情参照を統合
- コードの可読性と保守性の向上

## 11.2 グローバルアクター辞書定義

**構文**:
```pasta
％actor_name
  ＠word_name：value1、value2、...
  ＠word_name2：value3、value4
  # （任意）Lua コードブロック
```

**セマンティクス**:
- ファイルレベル（インデントなし）で `％actor_name` を記述すると、グローバルアクター辞書を定義する
- アクター名の直下にインデントされた `＠word_name：values` 形式の行は、そのアクターに属する単語定義となる
- アクタースコープ内で Lua コードブロック（` ```lua ` ... ` ``` `）を配置可能（将来拡張用、現時点では使用例なし）

**例**（sample.pasta より）:
```pasta
＃アクター辞書
％さくら
  ＠通常　　　：\s[0]、\s[100]
  ＠照れ　　　：\s[1]
  ＠驚き　　　：\s[2]
  ＠ぐんにょり：\s[3]
  ＠怒り　　　：\s[4]

％うにゅう
  ＠通常　：\s[10]
  ＠刮目　：\s[11]
```

**構文上の注意**:
- アクター名には日本語・英語の識別子が使用可能
- 単語定義は必ずインデント（全角空白 `　` または半角空白）で開始する
- 値はカンマ（`、` / `，` / `,`）で区切り、複数の Sakura スクリプト値を指定可能

## 11.3 シーンスコープ内でのアクター指定

グローバルシーン内で `％actor_name、actor_name2` の形式でアクターを指定すると、そのシーン内の会話行でアクター名付き単語参照が有効になります。

**構文**:
```pasta
＊scene_name
  ％actor1、actor2
  actor1：＠通常　こんにちは
  actor2：＠通常　やあ
```

**セマンティクス**:
- シーン内で `％actor1、actor2` と記述すると、そのシーンで `actor1：` や `actor2：` のアクター名プレフィックスが使用可能になる
- `actor_name：` で始まる会話行では、そのアクターの単語辞書を優先的に参照する（詳細は [Chapter 6: アクション行](06-action-line.md) を参照）

**例**（sample.pasta より）:
```pasta
＊メイン
  ％さくら、うにゅう
  さくら：＠通常　こんにちは
  うにゅう：＠刮目　目を見開くうにゅう
```

## 11.4 アクタースコープと単語参照の統合

アクター辞書で定義された単語は、シーンスコープ内でアクター名プレフィックスを伴った会話行で参照されます。

**スコープ解決ルール**:
- `actor_name：＠word_name` の形式で参照する場合、まず `％actor_name` で定義された単語辞書から `word_name` を検索する
- アクター辞書に該当する単語が存在しない場合は、グローバル単語辞書およびローカル単語辞書にフォールバックする
- アクター辞書による単語参照は、グローバル・ローカル単語定義と同じ前方一致検索ルールに従う

**実装上の注意**:
- アクタースコープは `FileItem::ActorScope` AST ノードとして表現される
- ActorScope には `name: String`、`words: Vec<WordDef>`、`code_blocks: Vec<CodeBlock>` が含まれる
- パーサー層では ActorScope を構造化し、トランスパイラ層で会話行のアクター名プレフィックスと統合する

## 11.5 将来拡張（コードブロック）

アクタースコープ内に Lua コードブロックを配置する構文は定義されていますが、現時点では使用例がなく、将来の拡張として予約されています。

**予約構文**:
````pasta
％actor_name
  ＠word_name：value
  ```lua
  function on_actor_event(ctx)
    -- アクター固有のイベント処理
  end
  ```
````

**セマンティクス**（予定）:
- アクター固有のイベントハンドラーや状態管理関数をアクタースコープ内に定義
- 現時点では未実装であり、文法定義のみ存在

---

**関連章**:
- [Chapter 2: キーワード・マーカー定義](02-markers.md) - アクター辞書マーカー（％）
- [Chapter 6: アクション行](06-action-line.md) - アクター指定と発言
- [Chapter 10: 単語定義](10-words.md) - 単語参照の基本
