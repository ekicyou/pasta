# 12. 未確定事項・検討中の仕様

## 12.2 インライン単語参照の多段階解決（廃止）

- `＠＠word` のような多段階解決は採用しない。
- `＠＠` はリテラルの「＠」を出力するエスケープとしてのみ使用。
- 追加の解決が必要な場合は関数呼び出しで代替する。

## 12.3 チェーントーク（DSL非採用）

- チェーントーク専用の DSL 構文は採用しない。
- 代替: グローバルシーンにチェイン用シーンを定義し、`＞チェイン` などで呼び出してチェイン処理を行う。
- チェイン固有の出力や関数定義は、当該シーン配下（暗黙 __start__ 含む）に記述する。

## 12.4 ローカルシーンのパラメータ（将来検討）

- グローバルシーン、ローカルシーンともにパラメータ付き構文は現時点で未定義。
- 将来的に検討する可能性はあるが、現在は対応予定なし。
- 必要な場合は、変数経由でパラメータ相当の値を渡す運用で代替可能。

## 12.5 フィルター機能の詳細（初期版対応なし）

- フィルター機能は初期版では対応しない。
- 複数フィルターのOR/AND結合方法などは将来的に検討する可能性がある。
- 現在は構文のみ定義されているが（[4.2](04-call-spec.md#42-フィルター属性フィルター)参照）、セマンティクス実装は将来予定。

## 12.6 単語定義の値の型変換ルール（初期版）

- 単語は文字列のみを登録する（将来拡張は未定）。
- 値は「」で囲んだ空白を含む文字列、または空白を含まない文字列のいずれか。
- 数値は含めない（単語定義には [5.2](05-literals.md#52-型変換ルール) の型変換を適用しない）。
- 例:
  - `＠fruits：apple　banana　orange`（すべて文字列）
  - `＠greet： 「おはようございます」 「こんにちは」`（引用符で空白を含む文字列）
  - `＠numbers：1　2　3`（文字列として扱う）

## 12.7 動的単語参照（＠＄var_name）の実装スケジュール

- 文法予約のみ。現仕様の完全動作確認が完了するまでは着手しない。
- 優先度は低く、「忘れていなければいつか実装する」レベル。
- 未実装期間の扱いは、無視または警告ログで通知する方針を設計で検討。

## 12.8 Callの戻り値と変数代入（DSL非定義）

- 戻り値の定義はトランスパイラ/ランタイムの領域で扱う。DSLでは規定しない。
- すべての関数は yield によるトークン生成装置であり、戻り値は単一値ではなく yield による列挙値となる。
- 代入例（`＄result ： ＞some_label`）の可否は DSL 範囲外。必要ならランタイム設計でガイドを用意。

## 12.9 ローカル変数のスコープ詳細（トランスパイラ/ランタイム）

- すべての関数の第一引数には連想配列 `ctx` を渡す。
- `ctx.local` にローカル値、`ctx.global` にグローバル値を保存する方針。
- ローカル値は1回の会話セッション終了時にクリアされる。
- 具体的な可視性・寿命はトランスパイラ/ランタイム設計で確定。

## 12.10 属性値の型解釈

- 属性の `value` は [5.2](05-literals.md#52-型変換ルール) のリテラル型変換ルールに従う。
- フィルター（[4.2](04-call-spec.md#42-フィルター属性フィルター)）との比較演算の整合性はこの前提で設計。

## 12.11 前方一致時の複数候補選択ルール（DSL非定義）

- 候補選択アルゴリズムはトランスパイラ/ランタイムの領域。DSLでは規定しない。

## 12.12 引数リストの値の型解釈

- 引数の `value` は [5.2](05-literals.md#52-型変換ルール) のリテラル型変換ルールに従う。
- 引数内のインライン要素の可否は別途設計（現時点では文字列/リテラルのみ推奨）。

## 12.13 行継続のインデント深さ制約

- インデント深さは判定不要。
- 直前行がアクション行または継続行であれば継続として扱う。

## 12.14 コメント行の配置可能位置

- コメント行はあらゆる位置に配置可能。
- コメント行は DSL として無視される（構造・セマンティクスに影響しない）。

## 12.15 識別子と予約語の制限（DSL外）

- DSLとしての制限は設けない。
- 実質的に Lua 言語のキーワードは変数・関数として使用不可。
- パーサー層ではエラーにしないが、トランスパイラ/ランタイム層でコンパイルエラーになる。

## 12.16 Sakuraスクリプト括弧内のエスケープ（確定）

- 参照: 伺か ukadoc「さくらスクリプトのエスケープ」
  - https://ssp.shillest.net/ukadoc/manual/list_sakura_script.html#notes_escape
- 基本エスケープ（Sakura 側仕様）:
  - 「\」を文字として表示する場合は「\\」と記述する。
  - 環境変数タグの「%」を文字として扱う場合は「\%」と記述する。
- 角括弧引数内の閉じ括弧「]」の扱い:
  - 「スクウェアブラケット内に引数を持つタグ（例: \q[...], \![...], \s[...], \_b[...], など）のみ」で、「]」を文字として含めたい場合は「\]」と書ける（ukadoc 規定）。
  - Pasta パーサーは当該エスケープをそのまま透過し、Sakura 側の解釈に委ねる。
- 角括弧内で「,」を値として含めたい場合の書式:
  - 「複数の引数を持つタグの第2引数以降」で、その引数の内容として「,」を含めたい場合、当該引数全体をダブルクォートで囲う。例: `\![raise,OnTest,"100,2"]`（ukadoc 規定）。
- 引数にダブルクォート（"）を含めたい場合の書式:
  - 引数全体をダブルクォートで囲み、内部の `"` は二重にする。例: `\![call,ghost,"the ""MobileMaster"""]`（ukadoc 規定）。
- バックスラッシュの制約（Pasta 側再掲）:
  - Sakura スクリプトのエスケープは厳密に「半角バックスラッシュ（\）」のみを認める（[2.5](02-markers.md) / [7.2](07-sakura-script.md) の原則）。全角バックスラッシュは不可。
- 括弧のネストと「[」の扱い:
  - ukadoc では「[」のエスケープ規定はなく、閉じ括弧ではないため通常はそのまま記述できる。
  - ネスト構文（`[[...]]` 等）は Sakura の標準仕様に含まれない前提とし、Pasta は「非ネスト」を前提に `[...]` を字句的に1塊として透過処理する。
- 実装ポリシー（Pasta パーサー）:
  - 括弧内容の詳細は解釈しない。字句的に `[` から最初の非エスケープな `]` までを抽出し、`\]`・クォート規則の存在を妨げない。
  - [7.3](07-sakura-script.md) の `bracket_content` はこの前提で成立するものとする。
- テスト観点（例示）:
  - `\q[タイトル,ID]`（基本形）
  - `\q[タイトル,OnID,r0,r1]`（第2引数以降のカンマを含む値は引用で包める）
  - `\![raise,OnTest,"100,2"]`（カンマ含む第2引数）
  - `\![call,ghost,"the ""MobileMaster"""]`（ダブルクォートを値に含める）
  - `\s[0\]]`（括弧内で `]` を文字として含めるための `\]`）

## 12.17 ファイルエンコーディングとBOM

- エンコーディングは UTF-8 固定。
- BOM 無しでも動作すること。BOM は許容。

## 12.18 ファイルレベル属性の継承詳細

- ファイルレベル属性はグローバルシーンに継承されるが、グローバルシーン側で同一属性が定義されれば上書き。
- ファイルレベル属性はローカルシーンには影響しない。

## 12.19 空行の配置と解釈

- 意味のない位置における空行はコメント行と同じ扱い（無視）。
- 継続領域の空行は [6.5.3](06-action-line.md#653-糖衣構文継続行内の空行) の規則に従う。

## 12.20 全角・半角混在時の正規化

- パーサーレベルでは正規化（全角・半角の同等化）を行う。
- キーワード文字列は AST には現れないため正規化の影響は限定的。
- 例外: `＠＠` と `@@` は正規化しない（それぞれの意味を保持）。

---

**更新履歴**:

| 日付       | 版  | 変更                                          |
| ---------- | --- | --------------------------------------------- |
| 2025-12-18 | 1.0 | 初版作成（ひな形）                            |
| 2025-01-XX | 1.1 | Section 11「アクター辞書」追加、％マーカー文法化 |

---

**関連章**:
- [README.md](README.md) - 章一覧（インデックス）
- [Chapter 4: Call の詳細仕様](04-call-spec.md) - フィルター
- [Chapter 5: リテラル型](05-literals.md) - 型変換ルール
- [Chapter 7: Sakura スクリプト仕様](07-sakura-script.md) - エスケープ
