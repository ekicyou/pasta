# 3. 行とブロック構造

## 3.1 行（Line）の定義

Pasta は行指向文法です。各行は改行（NEWLINE）で終わり、行頭の文字（マーカー）により行の型が決定されます。

**行の構成**:
```
行 ::= [インデント] マーカー 内容 NEWLINE
または
行 ::= [インデント] 内容 NEWLINE  （属性行、発言行など）
```

## 3.2 行の種類

インデントの有無で、行の構造を二分類します。

### インデント不要の行構造（行頭にインデントなし）

| 行種               | マーカー                 | 説明                                                   | 例                        |
| ------------------ | ------------------------ | ------------------------------------------------------ | ------------------------- |
| グローバルシーン   | `＊` または `*`          | グローバルブロックを開始                               | `＊会話`                  |
| グローバル単語定義 | `＠` または `@`          | ファイル全体で参照可能な単語定義                       | `＠fruits：apple　banana` |
| Lua ブロック       | ``` ``` または ```lua``` | グローバルシーンに属する複数行コード（インデント不要） | ` ```lua ... ``` `        |
| コメント           | `#` または `＃`          | コメント（処理されない）                               | `# これはコメント`        |

### インデントが必要な行構造（行頭にインデントあり）

| 行種             | マーカー         | 説明                                       | 例                          |
| ---------------- | ---------------- | ------------------------------------------ | --------------------------- |
| ローカルシーン   | `・` または `-`  | グローバルシーン配下のローカルブロック開始 | `  ・選択肢1`               |
| 属性定義         | `＆` または `&`  | シーンにメタデータを付与                   | `  ＆author：Alice`         |
| 発言行           | （マーカーなし） | キャラクター発言                           | `  Alice：こんにちは`       |
| Call             | `＞` または `>`  | シーンを呼び出す                           | `  ＞シーン名`              |
| 変数代入         | `＄` または `$`  | 変数を宣言・代入                           | `  ＄my_var ： 10`          |
| ローカル単語定義 | `＠` または `@`  | 親シーン内で参照可能な単語定義             | `  ＠fruits：apple　banana` |

注記: コメント行はインデントあり・なしの両方で許容されます（意味解釈は常に「コメント」）。

## 3.3 ブロック構造

Pasta スクリプトは階層的なブロック構造を持ちます。

### グローバルブロック構造

```
グローバルブロック
  ├─ グローバル単語行（＠）*
  └─ グローバルシーンブロック（＊）+
```

**セマンティクス**:
- グローバル単語定義（0個以上）と グローバルシーンブロック（1個以上）で構成
- ファイルレベルのスコープを形成

### グローバルシーンブロック構造

```
＊グローバル名
  ＆属性行 *
  [暗黙ローカル開始ブロック(__start__)]
  ・ローカルシーンブロック *
```

**構成要素**:
1. **グローバルシーン行**: `＊グローバル名`（宣言）
2. **属性行**: ０個以上の `＆key：value` （グローバルシーン全体のメタデータ）
3. **暗黙ローカル開始ブロック**: Lua ブロック、発言行、制御フロー行、変数代入行を格納可能（ローカルシーン宣言なし）
4. **ローカルブロック**: ０個以上の明示的ローカルシーンブロック（`・ローカルシーン`）

**暗黙ローカル開始ブロック（`__start__`）**:
- ローカルシーン名が `__start__` に相当する特別なブロック
- ローカルシーン宣言行は不要（暗黙的に開始）
- Call でグローバルシーンを呼び出す際に、`__start__` ブロックが実行される
- Lua ブロックはここに格納可能

### ローカルブロック構造

```
・ローカル名
  [属性行 *]
  (変数代入行 | 会話行 | Call行)*
```

**構成要素**:
1. **ローカルシーン行**: `・ローカル名`（宣言）
2. **属性行**: ０個以上の `＆key：value` （ローカルシーン全体のメタデータ）
3. **コンテンツ行**: ０個以上の以下のいずれか
   - 変数代入行（`＄`）
   - アクション行（actor：action）
   - Call 行（`＞`）

**セマンティクス**:
- ローカルシーンの実行本体を構成
- Call 行は実行後に当ローカルブロック内で処理を継続

### Lua ブロックの配置

Lua ブロックは暗黙ローカル開始ブロック（`__start__`）内に配置されます。

````
＊グローバル名
  ```lua
  function on_event(ctx)
    for i = 0, 9 do
      coroutine.yield(ctx:event("loop", i))
    end
  end
  ```
  Alice：こんにちは
````

**処理順序**:
- グローバルシーンが Call の対象になると、暗黙 `__start__` が実行される
- 暗黙 `__start__` 内の Lua ブロック（存在する場合）が最初に実行
- その後、同一ブロック内の発言行、Call 行が順に実行

**制約**:
- Lua ブロックはインデント不要（配置上は直前のグローバルシーン配下）
- **関数定義のみ許可**：Lua ブロック内には `function ...` で始まる関数定義のみを記述可能。変数宣言（`local`）やトップレベルのステートメントは許可されません
- 複数の Lua ブロックが暗黙 `__start__` 内に存在する場合、上から順に関数が定義される
- パーサーは内部を解釈しません。**トランスパイラーが関数定義のみの正式なコード**として検証し、文法エラーまたは関数定義以外のコードが検出された場合、トランスパイラー層で報告されます

### 例

**例1: 属性 + 暗黙ローカルスタート + Lua関数定義**
````
＊会話
  ＆author：Alice
  ```lua
  function initialize(ctx)
    ctx:flag("talked", true)
  end
  ```
  こんにちは
````

**例2: 属性 + ローカルシーンブロック**
```
＊選択肢
  ＆genre：choice
  ・選択肢1
    Alice：選択肢1を選びました
  ・選択肢2
    Alice：選択肢2を選びました
```

**例3: 暗黙スタート + 明示ローカルシーン**
```
＊複合シーン
  Alice：シーンが開始されました
  ・分岐A
    Bob：Aを選びました
  ・分岐B
    Bob：Bを選びました
```

## 3.4 インデント（Indentation）

インデントは行の属するレベルを示します。

**インデント規則**:
- インデントなし = グローバルレベル（グローバルシーン、グローバル単語定義など）
- インデントあり = 下層レベル（グローバルシーン直下のすべての行：ローカルシーン、属性行、発言行など）
- 例外: Lua ブロックはインデント不要だが、構造上は直前のグローバルシーンに属する

**重要**:
- インデント深さの判定は**不要**です
- パーサーは「行頭に空白があるか・ないか」のバイナリチェックのみで十分
- インデント深さを測定・比較・検証する必要はありません

**例**:
```pasta
＊会話               ← インデントなし（グローバルレベル）
  ＆author：Alice    ← インデントあり（下層レベル）
  ・選択肢1         ← インデントあり（下層レベル）
  Alice：こんにちは ← インデントあり（下層レベル）

＠fruits：apple orange ← インデントなし（グローバルレベル）
```

---

**関連章**:
- [Chapter 1: 文法モデルの基本原則](01-grammar-model.md) - 行指向文法
- [Chapter 2: キーワード・マーカー定義](02-markers.md) - マーカー一覧
- [Chapter 4: Call の詳細仕様](04-call-spec.md) - 制御フロー
