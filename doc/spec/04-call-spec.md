# 4. Call の詳細仕様

## 4.1 Call ターゲットの形式

Call は以下の2パターンのターゲット形式をサポート：

### パターン1: シーン参照

```text
call_target ::= call_marker ~ id
例: ＞選択肢1
   >choice1
```

**セマンティクス**: 現在のグローバルシーンスコープから参照できるローカルシーン + グローバルシーン全てから、指定名で**前方一致検索**してシーンを呼び出す

**スコープ解決ルール**（[10.3 単語参照](10-words.md#103-単語参照)と同一仕様）:
- Call 文にスコープ修飾子は不要
- `＞scene_name` で、現在のグローバルシーンスコープ内のローカルシーン + グローバルシーンの全候補から検索
- 異なるグローバルシーンスコープでは、同じシーン名でも異なる候補が検索される（ローカルシーンが異なるため）
- 参照：[10.3 単語参照](10-words.md#103-単語参照)と共通のスコープ解決アルゴリズム

### パターン2: 動的ターゲット

```text
call_target ::= call_marker ~ var_ref
例: ＞＄target_label
   >$dynamic_choice
```

**セマンティクス**: 変数の値をシーン名として解決

### 4.1.3 前方一致によるターゲット解決

Call/単語検索において、ターゲットの候補列挙は**前方一致**で行われます。

**例**:
以下のグローバルシーンがあるとき：
```pasta
＊挨拶朝
＊挨拶昼
```

- `＞挨拶` では「挨拶朝」「挨拶昼」の両方が候補
- `＞挨拶朝` では「挨拶朝」のみが候補

**設計原則**: パーサーレベルではターゲット文字列を単に抽出するのみ。候補の列挙とランダム選択の詳細な挙動については、トランスパイラー・ランタイム層の実装に委ねられます。

### 4.1.4 スコープ解決アルゴリズム

Call 文と単語参照（`＠`）は、同一のスコープ解決アルゴリズムを使用します。

**2段階検索**:
1. **ローカル検索**: 現在のグローバルシーンスコープ内のローカルシーン/単語を、指定プレフィックスで前方一致検索
2. **グローバル検索**: すべてのグローバルシーン/単語を、指定プレフィックスで前方一致検索（ローカル専用エントリを除外）
3. **マージ**: 両検索結果を結合して候補リストを生成
4. **選択**: 候補リストからランダムに1つを選択（キャッシュベースの順次消費）

**例**:
```pasta
＊会話
  ＠返答
    ＠挨拶：こんにちは　おはよう

  ＊選択肢
    ―選択肢1

＊挨拶グローバル
  ―グローバル挨拶です
```

グローバルシーン「会話」内から `＞選択肢` を呼び出した場合：
- ローカル検索: `:会話_1:選択肢` で前方一致 → `会話/選択肢` がマッチ
- グローバル検索: `選択肢` で前方一致 → グローバルシーン「選択肢...」があればマッチ
- 両候補がマージされ、ランダム選択される

**参照**: 単語参照のスコープ解決については [10.3 単語参照](10-words.md#103-単語参照) を参照

---

## 4.2 フィルター（属性フィルター）

**構文**:
```text
filter_list ::= ("＆" ~ key ~ 比較演算子 ~ value)+
現在: ＆key＝value
将来: ＆score＞50　＆level＜10　など比較演算子ベースに拡張予定

例: ＞シーン名＆author＝Alice＆genre＝comedy
   ＠単語名＆category＝food＆season＝summer
```

**セマンティクス**: ターゲット選択時に属性で絞り込み（将来予約）

**適用範囲**: Callだけでなく、会話文内の単語呼び出し（＠）でも同様に使用可能。基本的な記述ルールは共通。

**設計原則**: フィルターは比較・条件判定のため、コロンではなく比較演算子（＝、＞、＜など）を使用

**現在**: フィルター機能は将来用に宣言; 現在は無視

---

## 4.3 引数リスト

**構文**:
```pest
arg_list ::= "（" ~ argument* ~ "）"
argument ::= 名前付き引数
名前付き引数 ::= name ~ "：" ~ value
区切り文字 ::= 空白（"　" | "\t" | " "）
```

**例**:
```pasta
＠関数呼び出し（引数１：値１　引数２：値２）
＠calculate（x：10　y：20）
```

**実装状態**:
- ASTレベルでの解釈は対応
- トランスパイラー層以降の実装は順次対応予定

---

**関連章**:
- [Chapter 2: キーワード・マーカー定義](02-markers.md) - Callマーカー
- [Chapter 3: 行とブロック構造](03-block-structure.md) - ブロック構造
- [Chapter 9: 変数・スコープ](09-variables.md) - 変数参照
- [Chapter 10: 単語定義](10-words.md) - スコープ解決アルゴリズム
